<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="CuteCumber - ‰Ω†ÁöÑÁßÅ‰∫∫ÂÅ•Â∫∑Á¥ÄÈåÑÂä©Êâã">
    
    <!-- iOS / PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="CuteCumber">
    <meta name="theme-color" content="#F8F9FA">
    
    <!-- Icons -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="icon" type="image/png" href="icons/icon-192.png">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <title>CuteCumber</title>

    <style>
        :root {
            --color-primary: #76C846;
            --color-bg: #F8F9FA;
            --color-text: #333333;
            --color-accent: #FF69B4;
            --color-danger: #FF4757;
            --color-gold: #FFD700;
            --color-input-bg: #FFFFFF;
            --color-border: #E5E7EB;
            --color-card-bg: #FFFFFF;
            --tab-height: 60px;
            --safe-area-bottom: env(safe-area-inset-bottom);
            --safe-area-top: env(safe-area-inset-top);
        }

        /* --- Global Reset --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            overscroll-behavior-y: none;
            user-select: none; -webkit-user-select: none;
            height: 100vh; height: 100dvh; width: 100vw;
            display: flex; flex-direction: column; overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Dark Mode Definitions */
        body.dark-mode {
            --color-bg: #121212;
            --color-text: #e0e0e0;
            --color-card-bg: #1e1e1e;
            --color-input-bg: #2c2c2c;
            --color-border: #333333;
            --theme-color: #121212; /* Sync meta theme color logic needed in JS if strictly required */
        }
        
        /* Dark Mode Specific Overrides */
        body.dark-mode .hero-section { box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        body.dark-mode #home-message { background: #252525; color: #aaa; border-left-color: var(--color-accent); }
        body.dark-mode .recent-card, body.dark-mode .diary-card, body.dark-mode .settings-card, body.dark-mode .metric-card, body.dark-mode .chart-container, body.dark-mode .year-item, body.dark-mode .form-panel { border-color: #333; }
        body.dark-mode .recent-icon-box { background: #333; }
        body.dark-mode .recent-date { color: #fff; }
        body.dark-mode .recent-location { background: #333; color: #bbb; }
        body.dark-mode .tab-item { color: #666; }
        body.dark-mode .tab-item.active { color: var(--color-primary); }
        body.dark-mode #tab-bar { background-color: rgba(30, 30, 30, 0.95); border-top: 1px solid #333; }
        body.dark-mode h1, body.dark-mode .calendar-title, body.dark-mode .detail-date, body.dark-mode .section-header, body.dark-mode .metric-value, body.dark-mode .unlock-title, body.dark-mode .system-modal-title { color: #fff; }
        body.dark-mode .form-label, body.dark-mode .metric-title, body.dark-mode .settings-title { color: #bbb; }
        body.dark-mode .modal-content-bottom, body.dark-mode .system-modal-content, body.dark-mode .unlock-modal-content, body.dark-mode .modal-content { background: #1e1e1e; color: #eee; }
        body.dark-mode .calendar-day { background: #252525; color: #fff; border-color: #333; }
        body.dark-mode .calendar-day.empty { background: transparent; border-color: transparent; }
        body.dark-mode .calendar-day.today { border-color: var(--color-accent); color: var(--color-accent); }
        body.dark-mode .calendar-day.has-record { background: rgba(118, 200, 70, 0.2); }
        body.dark-mode .detail-profile, body.dark-mode .detail-note-box, body.dark-mode .vid-detail-note { background: #252525; border-color: #333; color: #ddd; }
        body.dark-mode .video-card { background: #252525; border-color: #333; }
        body.dark-mode .video-card-title, body.dark-mode .vid-detail-title, body.dark-mode .detail-name, body.dark-mode .actor-name { color: #fff; }
        body.dark-mode .video-thumb-box { border-color: #333; background: #2c2c2c; }
        body.dark-mode .ach-card { background: #252525; border-color: #333; }
        body.dark-mode .ach-card.unlocked { background: linear-gradient(135deg, #2c2c2c 0%, #3a3a3a 100%); border-color: var(--color-gold); }
        body.dark-mode .ach-category-title { color: #bbb; }
        body.dark-mode .photo-placeholder { background: #333; }
        body.dark-mode .btn-close { background: #333; color: #fff; }
        body.dark-mode .view-toggle { background: #333; }
        body.dark-mode .toggle-btn { color: #888; }
        body.dark-mode .toggle-btn.active { background: #555; color: var(--color-primary); }
        body.dark-mode .ach-info-desc { background: #2c2c2c; color: #ddd; }
        body.dark-mode .btn-settings { background: rgba(50,50,50,0.8); color: #fff; }
        body.dark-mode .form-control { background-color: #2c2c2c; color: #fff; border-color: #444; }
        body.dark-mode select { background-color: #2c2c2c; color: #fff; }
        
        /* Search Input */
        .search-container { margin-bottom: 15px; }
        .search-input { 
            border-radius: 20px; 
            padding: 10px 15px; 
            font-size: 14px; 
            background-color: #f0f0f0; 
            border: none; 
            width: 100%;
            outline: none;
            transition: all 0.2s;
        }
        .search-input:focus { 
            background-color: #fff; 
            box-shadow: 0 0 0 2px var(--color-primary); 
        }
        /* Dark mode for search */
        body.dark-mode .search-input { 
            background-color: #2c2c2c; 
            color: #fff; 
        }
        body.dark-mode .search-input:focus { 
            background-color: #3a3a3a; 
        }

        img, canvas, svg { max-width: 100%; display: block; }

        #app-container {
            flex: 1; width: 100%; overflow-y: auto; overflow-x: hidden;
            -webkit-overflow-scrolling: touch; position: relative;
            padding-bottom: calc(var(--tab-height) + var(--safe-area-bottom) + 30px);
        }

        body.hide-tabs #app-container { padding-bottom: var(--safe-area-bottom); }

        section {
            display: none; width: 100%; padding: 20px;
            padding-top: calc(var(--safe-area-top) + 20px);
            animation: fadeIn 0.25s ease-out;
        }
        section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Components --- */
        h1 { font-size: 24px; font-weight: 800; margin-bottom: 20px; color: var(--color-text); line-height: 1.2; }
        .btn-base { border: none; cursor: pointer; border-radius: 12px; font-weight: bold; transition: transform 0.1s; display: flex; align-items: center; justify-content: center; font-size: 14px; padding: 12px; }
        .btn-base:active { transform: scale(0.96); }
        .btn-primary { background: var(--color-primary); color: white; box-shadow: 0 4px 10px rgba(118, 200, 70, 0.3); }
        .btn-accent { background: var(--color-accent); color: white; box-shadow: 0 4px 10px rgba(255, 105, 180, 0.3); }
        .btn-danger { background: #ffeaea; color: var(--color-danger); }
        .btn-gold { background: var(--color-gold); color: #875800; box-shadow: 0 4px 10px rgba(255, 215, 0, 0.3); }
        .btn-close { background: #eee; width: 32px; height: 32px; border-radius: 50%; border: none; font-size: 20px; color: #666; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;}
        .btn-outline { background: var(--color-card-bg); border: 1px solid var(--color-border); color: var(--color-text); }
        .btn-settings { position: absolute; top: calc(var(--safe-area-top) + 20px); left: 20px; width: 40px; height: 40px; background: rgba(255,255,255,0.8); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; z-index: 10; color: #555; }

        /* --- Toggle Switch CSS --- */
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; vertical-align: middle; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--color-primary); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* --- Forms --- */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 14px; font-weight: 600; color: #666; margin-bottom: 8px; }
        .form-control { width: 100%; padding: 14px; font-size: 16px; border: 1px solid var(--color-border); border-radius: 12px; background-color: var(--color-input-bg); color: var(--color-text); outline: none; -webkit-appearance: none; appearance: none; }
        .form-control:focus { border-color: var(--color-primary); }
        textarea.form-control { resize: none; min-height: 80px; font-family: inherit; }
        .photo-upload-label { display: flex; align-items: center; justify-content: center; width: 100%; padding: 12px; background: rgba(118, 200, 70, 0.1); border: 2px dashed var(--color-primary); border-radius: 12px; color: var(--color-primary); font-weight: bold; font-size: 14px; cursor: pointer; transition: all 0.2s; margin-top: 8px; }
        .photo-preview { width: 100%; height: auto; max-height: 200px; object-fit: contain; border-radius: 12px; margin-top: 10px; display: none; border: 1px solid var(--color-border); background: var(--color-bg); }
        .photo-preview.show { display: block; }

        /* --- Footer Nav --- */
        #tab-bar { position: fixed; bottom: 0; left: 0; right: 0; width: 100%; height: calc(var(--tab-height) + var(--safe-area-bottom)); background-color: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-top: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-around; align-items: flex-start; padding-top: 8px; padding-bottom: var(--safe-area-bottom); z-index: 1000; transition: transform 0.3s ease; }
        body.hide-tabs #tab-bar { transform: translateY(100%); }
        .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border: none; background: none; cursor: pointer; transition: all 0.2s ease; color: #999; height: 50px; }
        .tab-icon { font-size: 24px; margin-bottom: 2px; transition: transform 0.1s; }
        .tab-label { font-size: 10px; font-weight: 500; }
        .tab-item:active .tab-icon { transform: scale(0.9); }
        .tab-item.active { color: var(--color-primary); }
        .tab-item[data-target="driver"].active { color: var(--color-accent); }

        /* --- Home --- */
        .hero-section { background: var(--color-card-bg); border-radius: 24px; padding: 30px 24px; text-align: center; box-shadow: 0 4px 20px rgba(118, 200, 70, 0.15); margin-bottom: 20px; position: relative; overflow: hidden; min-height: 200px; display: flex; flex-direction: column; justify-content: center; }
        .hero-label { font-size: 14px; color: #888; letter-spacing: 1px; margin-bottom: 5px; font-weight: 600; }
        .hero-timer { font-size: 48px; font-weight: 900; color: var(--color-primary); font-variant-numeric: tabular-nums; line-height: 1.1; margin: 5px 0 15px 0; }
        #home-message { font-size: 15px; color: #555; line-height: 1.5; background: #f9fafb; padding: 12px 16px; border-radius: 12px; margin-top: 10px; font-style: italic; border-left: 4px solid var(--color-accent); text-align: left; }
        .recent-list-header { font-size: 14px; color: #999; font-weight: 600; margin-bottom: 10px; padding-left: 4px; }
        .recent-card { background: var(--color-card-bg); border-radius: 16px; padding: 16px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 12px rgba(0,0,0,0.04); margin-bottom: 12px; border: 1px solid var(--color-border); }
        .recent-icon-box { width: 48px; height: 48px; border-radius: 50%; background: #f3f4f6; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-right: 15px; flex-shrink: 0; }
        .recent-info { flex: 1; display: flex; flex-direction: column; justify-content: center; min-width: 0; }
        .recent-date { font-weight: 700; font-size: 16px; color: #333; margin-bottom: 4px; }
        .recent-meta { font-size: 12px; color: #888; display: flex; align-items: center; gap: 6px; }
        .recent-location { background: #f0f0f0; color: #666; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; white-space: nowrap; max-width: 80px; overflow: hidden; text-overflow: ellipsis; flex-shrink: 0; }

        /* --- Stats Layout --- */
        .stats-toggle-container { margin-bottom: 20px; position: sticky; top: 0; z-index: 90; }
        .stats-metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px; }
        .metric-card { background: var(--color-card-bg); padding: 16px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); text-align: center; border: 1px solid var(--color-border); display: flex; flex-direction: column; justify-content: center; min-height: 100px; }
        .metric-title { font-size: 11px; color: #888; font-weight: 600; margin-bottom: 4px; text-transform: uppercase; white-space: nowrap; }
        .metric-value { font-size: clamp(1.8rem, 6vw, 2.4rem); font-weight: 800; color: var(--color-primary); line-height: 1.1; }
        .metric-unit { font-size: 12px; color: #aaa; margin-left: 2px; font-weight: 500;}
        .chart-container { background: var(--color-card-bg); padding: 20px; padding-bottom: 30px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid var(--color-border); margin-bottom: 30px; position: relative; height: 350px; width: 100%; }
        .section-header { font-size: 16px; font-weight: bold; color: #333; margin-bottom: 15px; padding-left: 8px; border-left: 4px solid var(--color-primary); line-height: 1; }
        .empty-stats { text-align: center; padding: 60px 20px; color: #999; display: none; }
        .year-item { background: var(--color-card-bg); padding: 15px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); border: 1px solid var(--color-border); margin-bottom: 10px; }
        .year-info { display: flex; justify-content: space-between; font-weight: bold; color: var(--color-text); margin-bottom: 6px; font-size: 15px; }
        .year-bar-bg { height: 6px; background: var(--color-bg); border-radius: 3px; overflow: hidden; width: 100%; border: 1px solid var(--color-border); }
        .year-bar-fill { height: 100%; background: var(--color-primary); width: 0%; transition: width 1s ease-out; }
        
        .ach-category-title { font-size: 14px; font-weight: 800; color: #555; margin: 20px 0 10px 4px; display: flex; align-items: center; }
        .ach-category-title::before { content: ''; display: inline-block; width: 4px; height: 14px; background: var(--color-accent); margin-right: 8px; border-radius: 2px; }
        .ach-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 12px; padding-bottom: 40px; }
        .ach-card { background: var(--color-card-bg); border-radius: 12px; aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px; position: relative; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.1s; cursor: pointer; border: 2px solid transparent; }
        .ach-card:active { transform: scale(0.95); }
        .ach-card.locked { background: var(--color-bg); }
        .ach-card.locked .ach-icon { filter: grayscale(100%); opacity: 0.3; font-size: 32px; }
        .ach-card.locked .ach-title { color: #aaa; font-size: 10px; margin-top: 5px; }
        .ach-card.unlocked { background: linear-gradient(135deg, var(--color-card-bg) 0%, rgba(255, 215, 0, 0.1) 100%); border-color: var(--color-gold); box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2); }
        .ach-card.unlocked .ach-icon { font-size: 36px; animation: bounce 2s infinite; }
        .ach-card.unlocked .ach-title { font-weight: bold; color: #d48806; font-size: 11px; margin-top: 5px; text-align: center; width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
        .ach-info-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; color: #666; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .ach-info-label { font-weight: bold; }
        .ach-info-desc { background: #f9f9f9; padding: 15px; border-radius: 12px; font-size: 14px; line-height: 1.5; color: #555; font-style: italic; border-left: 4px solid var(--color-gold); }

        /* --- Modals --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px); }
        .modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
        .modal-overlay.bottom-sheet { align-items: flex-end; }
        .modal-content-bottom { background: var(--color-card-bg); width: 100%; border-radius: 24px 24px 0 0; padding: 24px; padding-bottom: max(24px, env(safe-area-inset-bottom)); max-height: 85vh; overflow-y: auto; animation: slideUp 0.3s ease-out; box-shadow: 0 -5px 25px rgba(0,0,0,0.1); color: var(--color-text); }
        .unlock-modal-content { background: var(--color-card-bg); width: 85%; max-width: 320px; border-radius: 24px; padding: 30px 20px; text-align: center; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; flex-direction: column; align-items: center; }
        .unlock-icon-wrapper { width: 80px; height: 80px; background: rgba(255, 215, 0, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; margin-bottom: 20px; border: 4px solid var(--color-gold); box-shadow: 0 0 20px rgba(255, 215, 0, 0.4); }
        .unlock-title { font-size: 20px; font-weight: 800; color: var(--color-text); margin-bottom: 10px; }
        .unlock-msg { font-size: 15px; color: #666; line-height: 1.5; margin-bottom: 25px; white-space: pre-wrap; }
        .unlock-confetti { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; border-radius: 24px; }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        #system-modal { z-index: 3000; }
        .system-modal-content { background: var(--color-card-bg); width: 85%; max-width: 300px; border-radius: 20px; padding: 24px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: popIn 0.2s ease-out; }
        .system-modal-title { font-size: 18px; font-weight: 700; color: var(--color-text); margin-bottom: 10px; }
        .system-modal-msg { font-size: 15px; color: #666; margin-bottom: 20px; line-height: 1.5; white-space: pre-wrap; }
        .system-modal-actions { display: flex; gap: 10px; justify-content: center; }

        .settings-header { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #eee; } .settings-card { background: var(--color-card-bg); border-radius: 16px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid var(--color-border); margin-bottom: 20px; } .settings-title { font-size: 14px; font-weight: 600; color: #888; text-transform: uppercase; margin-bottom: 15px; letter-spacing: 0.5px; border-left: 3px solid var(--color-primary); padding-left: 8px; } .settings-desc { font-size: 13px; color: #666; margin-bottom: 15px; line-height: 1.5; }
        .view-toggle { display: flex; background: var(--color-border); border-radius: 12px; padding: 4px; margin-bottom: 20px; flex-shrink: 0; }
        .toggle-btn { flex: 1; padding: 8px; border: none; background: transparent; border-radius: 8px; font-size: 13px; font-weight: 600; color: #666; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .toggle-btn.active { background: var(--color-card-bg); color: var(--color-primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; } .calendar-title { font-size: 18px; font-weight: 800; color: var(--color-text); } .calendar-nav-btn { background: none; border: none; padding: 5px 15px; font-size: 20px; color: var(--color-primary); cursor: pointer; } .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; } .calendar-day { aspect-ratio: 1; border-radius: 10px; background: var(--color-card-bg); display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 13px; font-weight: 500; color: var(--color-text); border: 1px solid transparent; cursor: pointer; } .calendar-day.today { border-color: var(--color-accent); color: var(--color-accent); font-weight: bold; } .calendar-day.has-record { background: rgba(118, 200, 70, 0.12); color: #2e7d32; } .calendar-drops { display: flex; gap: 2px; margin-top: 2px; height: 4px; } .drop-dot { width: 4px; height: 4px; background-color: var(--color-primary); border-radius: 50%; }
        .diary-card { background: var(--color-card-bg); border-radius: 16px; padding: 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid var(--color-border); margin-bottom: 12px; cursor: pointer; min-height: 80px; } .diary-left { display: flex; gap: 12px; align-items: center; flex: 1; overflow: hidden; min-width: 0; } .diary-date-box { display: flex; flex-direction: column; align-items: center; min-width: 45px; padding-right: 12px; border-right: 1px solid #f0f0f0; flex-shrink: 0; } .diary-day { font-size: 18px; font-weight: 800; color: var(--color-text); } .diary-time { font-size: 11px; color: #999; margin-top: 2px; } .diary-content { display: flex; flex-direction: column; justify-content: center; flex: 1; overflow: hidden; min-width: 0; } .diary-title { font-size: 16px; font-weight: bold; margin-bottom: 4px; display: flex; align-items: center; gap: 6px; } .diary-meta { font-size: 12px; color: #888; display: flex; align-items: center; gap: 4px; } .diary-note { font-size: 12px; color: #aaa; margin-top: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } .photo-thumbnail { width: 44px; height: 44px; object-fit: cover; border-radius: 8px; margin-right: 8px; border: 1px solid #eee; flex-shrink: 0; } .photo-placeholder { width: 44px; height: 44px; background: #eee; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #aaa; font-size: 18px; margin-right: 8px; flex-shrink: 0; } .action-group { display: flex; gap: 4px; flex-shrink: 0; } .btn-icon { padding: 8px; color: #ccc; background: none; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .driver-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; width: 100%; } .view-container { display: none; width: 100%; } .view-container.active { display: block; animation: fadeIn 0.2s ease-out; } 
        .actor-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding-bottom: 40px; width: 100%; } 
        .actor-card { display: flex; flex-direction: column; align-items: center; cursor: pointer; width: 100%; } .actor-avatar { width: 100%; aspect-ratio: 1; border-radius: 50%; object-fit: cover; background-color: #eee; border: 2px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 8px; flex-shrink: 0; } .actor-name { font-size: 12px; font-weight: 600; text-align: center; color: #333; width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; } .detail-profile { background: white; border-radius: 20px; padding: 20px; display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); position: relative; } .detail-avatar { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 12px; border: 3px solid white; } .detail-name { font-size: 20px; font-weight: 800; margin-bottom: 4px; } .detail-bio { font-size: 14px; color: #666; text-align: center; line-height: 1.4; max-width: 80%; white-space: pre-wrap; word-break: break-word; } .btn-edit-profile { position: absolute; top: 20px; right: 20px; width: 36px; height: 36px; background: #f0fdf4; color: var(--color-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; } 
        .video-list-container { display: flex; flex-direction: column; gap: 12px; } .video-card { background: var(--color-card-bg); border-radius: 12px; padding: 10px; display: flex; align-items: flex-start; gap: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.02); border: 1px solid var(--color-border); cursor: pointer; } .video-thumb-box { width: 80px; height: 60px; border-radius: 8px; background: #eee; flex-shrink: 0; overflow: hidden; display: flex; align-items: center; justify-content: center; border: 1px solid #e5e7eb; position: relative; } .video-thumb-img { width: 100%; height: 100%; object-fit: cover; } .video-card-info { flex: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; height: 60px; min-width: 0; } .video-card-title { font-size: 15px; font-weight: bold; color: #333; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } .video-card-note { font-size: 12px; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } .vid-detail-cover-box { width: 100%; height: 200px; background: #000; border-radius: 16px; overflow: hidden; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; } .vid-detail-cover { width: 100%; height: 100%; object-fit: contain; } .vid-detail-title { font-size: 20px; font-weight: 800; color: #333; margin-bottom: 12px; line-height: 1.3; } .vid-detail-note { background: var(--color-card-bg); padding: 16px; border-radius: 12px; border: 1px solid var(--color-border); font-size: 15px; color: #555; line-height: 1.6; white-space: pre-wrap; margin-bottom: 24px; word-break: break-word; } .vid-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; } .vid-main-action { grid-column: 1 / -1; } .detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; } .detail-date { font-size: 18px; font-weight: 800; color: #333; } .detail-photo-container { margin-bottom: 20px; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); width: 100%; } .detail-photo-full { width: 100%; display: block; object-fit: contain; max-height: 400px; background: #000; } .detail-info-row { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; } .detail-badge { background: var(--color-primary); color: white; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: bold; } .detail-location { color: #666; font-size: 14px; display: flex; align-items: center; gap: 4px; } .detail-note-box { background: var(--color-card-bg); padding: 15px; border-radius: 12px; color: #555; font-size: 15px; line-height: 1.6; margin-bottom: 25px; white-space: pre-wrap; border: 1px solid var(--color-border); word-break: break-word; } .detail-actions { display: flex; gap: 10px; }
        
        /* Hashtag Style */
        .actor-tag {
            display: inline-block;
            background-color: rgba(118, 200, 70, 0.15);
            color: var(--color-primary);
            font-size: 12px;
            font-weight: bold;
            padding: 4px 10px;
            border-radius: 15px;
            margin-right: 6px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .actor-tag:active { transform: scale(0.95); background-color: var(--color-primary); color: white; }
        /* Dark Mode for Tags */
        body.dark-mode .actor-tag { background-color: rgba(255, 255, 255, 0.1); color: var(--color-primary); }

        /* Video Tag Style */
        .video-tag {
            display: inline-block;
            background-color: rgba(0, 0, 0, 0.05);
            color: #666;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            margin-right: 4px;
            margin-top: 4px;
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.1);
        }
        body.dark-mode .video-tag { background-color: rgba(255, 255, 255, 0.1); color: #aaa; border-color: transparent; }
/* Multi-Select Tags Style */
        .selected-tags-container {
            display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; margin-bottom: 4px;
        }
        .selected-tag-chip {
            background: rgba(118, 200, 70, 0.15); color: var(--color-primary);
            padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: bold;
            display: flex; align-items: center; gap: 6px; cursor: default;
        }
        .selected-tag-chip .remove-tag {
            cursor: pointer; font-size: 16px; opacity: 0.6; display: flex; align-items: center;
        }
        .selected-tag-chip .remove-tag:hover { opacity: 1; }
        body.dark-mode .selected-tag-chip { background: rgba(255,255,255,0.1); }
        /* Suggestions Dropdown */
        .suggestions-dropdown {
            position: absolute;
            top: 100%; left: 0; right: 0;
            background: var(--color-input-bg);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            z-index: 100;
            max-height: 150px;
            overflow-y: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: none; /* È†êË®≠Èö±Ëóè */
        }
        .suggestion-item {
            padding: 12px 15px;
            border-bottom: 1px solid var(--color-border);
            font-size: 14px;
            color: var(--color-text);
            cursor: pointer;
        }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:active { background-color: rgba(0,0,0,0.05); color: var(--color-primary); }
        /* Dark Mode ÂæÆË™ø */
        body.dark-mode .suggestion-item:active { background-color: rgba(255,255,255,0.1); }

        /* --- Lock Screen UI --- */
        #lock-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--color-bg);
            z-index: 10000; /* ÊúÄÈ´òÂ±§Á¥ö */
            display: none; /* È†êË®≠Èö±Ëóè */
            flex-direction: column; align-items: center; justify-content: center;
            padding-bottom: 50px;
        }
        #lock-screen.active { display: flex; }
        .lock-title { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: var(--color-text); }
        .lock-dots { display: flex; gap: 15px; margin-bottom: 40px; }
        .lock-dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid var(--color-text); transition: all 0.2s; }
        .lock-dot.filled { background-color: var(--color-text); }
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; width: 280px; }
        .key-btn { 
            width: 70px; height: 70px; border-radius: 50%; 
            background: var(--color-input-bg); color: var(--color-text);
            font-size: 24px; font-weight: 500; border: 1px solid var(--color-border);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            margin: 0 auto;
            transition: transform 0.1s;
        }
        .key-btn:active { transform: scale(0.9); background: var(--color-border); }
        .key-btn.transparent { background: transparent; border: none; font-size: 16px; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } 100% { transform: translateX(0); } }

        /* Sort Bar */
        .sort-container {
            display: flex; align-items: center; justify-content: flex-end;
            padding: 0 4px; margin-bottom: 15px;
        }
        .sort-select {
            border: none; background: transparent;
            font-size: 13px; font-weight: bold; color: var(--color-primary);
            outline: none; cursor: pointer; text-align-last: right;
        }
        .sort-select option { color: #333; }
        /* Dark Mode */
        body.dark-mode .sort-select { color: var(--color-primary); }
        body.dark-mode .sort-select option { background: #2c2c2c; color: #fff; }

        /* Rank List Styles */
        .rank-section { margin-top: 30px; }
        .rank-list { display: flex; flex-direction: column; gap: 10px; }
        .rank-item { 
            display: flex; align-items: center; 
            background: var(--color-card-bg); padding: 12px; 
            border-radius: 12px; border: 1px solid var(--color-border);
            cursor: pointer; transition: transform 0.1s;
        }
        .rank-item:active { transform: scale(0.98); background-color: rgba(0,0,0,0.02); }
        .rank-num { 
            font-size: 16px; font-weight: 900; color: #ccc; width: 24px; text-align: center; margin-right: 8px; font-style: italic; 
        }
        .rank-num.top-1 { color: #FFD700; font-size: 20px; text-shadow: 0 1px 2px rgba(0,0,0,0.1); } 
        .rank-num.top-2 { color: #C0C0C0; font-size: 18px; } 
        .rank-num.top-3 { color: #CD7F32; font-size: 18px; } 
        
        .rank-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 12px; border: 1px solid #eee; flex-shrink: 0; }
        .rank-img.video-type { border-radius: 6px; width: 50px; height: 36px; } 
        
        .rank-info { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; }
        .rank-name { font-size: 14px; font-weight: bold; color: var(--color-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .rank-bar-bg { height: 4px; width: 100%; background: #f0f0f0; border-radius: 2px; margin-top: 6px; overflow: hidden; }
        .rank-bar-fill { height: 100%; background: var(--color-primary); border-radius: 2px; }
        .rank-count { font-size: 12px; font-weight: bold; color: #888; margin-left: 10px; }
        
        .btn-show-more {
            background: transparent; border: 1px dashed var(--color-border); 
            color: #888; width: 100%; padding: 10px; border-radius: 12px; 
            font-size: 13px; cursor: pointer; margin-top: 5px;
        }
        .btn-show-more:active { background: rgba(0,0,0,0.05); }

        /* Fix: Á¢∫‰øùË©≥ÊÉÖÈ†ÅÊ∞∏ÈÅ†ËìãÂú®ÂàóË°®È†Å (z-index 2000) ‰πã‰∏ä */
        #detail-modal {
            z-index: 2100 !important;
        }
        /* Fix: Á∑®ËºØÈ†ÅÈù¢ÂèàË¶ÅÊØîË©≥ÊÉÖÈ†ÅÊõ¥È´ò */
        #edit-record-modal {
            z-index: 2200 !important;
        }
        /* === V5.8 ÂÑ™ÂåñÔºöÂΩ±ÁâáÂàóË°®Ëàá‰∫∫Áâ©Ê™îÊ°àÁæéÂåñ === */
        
        /* 1. ÂΩ±ÁâáÂç°ÁâáÔºöÊîπÁÇ∫ÂΩàÊÄßÈ´òÂ∫¶ÔºåËß£Ê±∫Ê®ôÈ°åËàá Hashtag Ë¢´ÂàáÊéâÁöÑÂïèÈ°å */
        .video-card {
            height: auto !important; /* Âº∑Âà∂Ë¶ÜËìãËàäË®≠ÂÆö */
            min-height: 80px;
            padding: 12px;
            align-items: flex-start; /* Èù†‰∏äÂ∞çÈΩä */
        }
        
        .video-thumb-box {
            width: 90px;
            height: 68px;
        }

        .video-card-info {
            height: auto !important; /* Âº∑Âà∂Ë¶ÜËìãËàäË®≠ÂÆö */
            padding-top: 2px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .video-card-title {
            white-space: normal; /* ÂÖÅË®±ÊèõË°å */
            display: -webkit-box;
            -webkit-line-clamp: 2; /* ÊúÄÂ§öÈ°ØÁ§∫ÂÖ©Ë°å */
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.3;
            margin-bottom: 6px;
        }

        /* Êñ∞Â¢ûÔºöÂΩ±ÁâáÊ®ôÁ±§ÂÆπÂô® */
        .video-tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 4px;
        }

        /* 2. ‰∫∫Áâ©Ê™îÊ°àÔºöÁæéÂåñÊéíÁâà */
        .detail-profile {
            background: var(--color-card-bg);
            border-radius: 20px;
            padding: 25px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            border: 1px solid var(--color-border);
        }

        /* Êñ∞Â¢ûÔºöÁ∞°‰ªãÊñáÂ≠óÊ°Ü */
        .detail-bio-box {
            background: rgba(118, 200, 70, 0.08); /* Ê∑°Á∂†Ëâ≤ËÉåÊôØ */
            padding: 15px 20px;
            border-radius: 12px;
            margin-top: 15px;
            width: 100%;
            position: relative;
        }
        
        body.dark-mode .detail-bio-box {
            background: rgba(255, 255, 255, 0.05);
        }

        .detail-bio {
            text-align: justify; /* Â∑¶Âè≥Â∞çÈΩä */
            line-height: 1.6;
            white-space: pre-wrap;
            opacity: 0.9;
        }

        /* Êñ∞Â¢ûÔºö‰∫∫Áâ©Ê®ôÁ±§Áæ§ÁµÑ */
        .detail-tags-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
            width: 100%;
        }
        /* === Tier List Styles (ÊéíË°åÊ¶úÊ®£Âºè) === */
        .tier-wrapper { display: flex; flex-direction: column; gap: 4px; border: 1px solid #333; background: #000; border-radius: 8px; overflow: hidden; margin-top: 10px; }
        .tier-row { display: flex; min-height: 80px; background: #1a1a1a; border-bottom: 1px solid #000; }
        .tier-row:last-child { border-bottom: none; }
        .tier-label { width: 50px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 900; color: #fff; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); flex-shrink: 0; }
        .tier-content { flex: 1; display: flex; flex-wrap: wrap; align-items: center; padding: 5px; gap: 5px; background: #222; min-height: 80px; align-content: flex-start; }
        
        /* Á≠âÁ¥öÈ°èËâ≤ */
        .s-tier { background-color: #ff7f7f; color: #7c0000; }
        .a-tier { background-color: #ffbf7f; color: #7c4800; }
        .b-tier { background-color: #ffdf7f; color: #7c6800; }
        .c-tier { background-color: #ffff7f; color: #7c7c00; }
        .d-tier { background-color: #bfff7f; color: #357c00; }

        /* ÂæÖÂàÜÈ°ûÂçÄ */
        .tier-pool { 
            min-height: 120px; background: var(--color-card-bg); border: 2px dashed #ccc; 
            border-radius: 12px; padding: 10px; display: flex; flex-wrap: wrap; gap: 8px; 
            justify-content: center; align-items: flex-start; transition: background 0.2s; margin-bottom: 50px;
        }
        
        /* È†≠ÂÉèÊ®£Âºè */
        .tier-avatar { 
            width: 55px; height: 55px; border-radius: 8px; object-fit: cover; cursor: grab; 
            border: 2px solid transparent; transition: transform 0.1s; 
            -webkit-user-select: none; user-select: none; touch-action: none;
        }
        .tier-avatar:active { cursor: grabbing; transform: scale(1.1); border-color: white; z-index: 100; }
        
        /* Ê∑±Ëâ≤Ê®°Âºè‰øÆÊ≠£ */
        body.dark-mode .tier-pool { background: #2c2c2c; border-color: #555; }
        body.dark-mode #driver-view-tier h2 { color: #fff; }
    </style>
</head>
<body>

    <main id="app-container">
        <!-- Home -->
        <section id="home" class="active">
            <div class="btn-settings" onclick="goToSettings()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            </div>
            <div class="hero-section">
                <h1 id="welcome-text" style="font-size:18px; color:#555; margin-bottom:10px;">HelloÔºåÂ∏•Âì•</h1>
                <div class="hero-label">Ë∑ùÈõ¢‰∏äÊ¨°ÁôºÂ∞ÑÂ∑≤ÈÅé</div>
                <div id="hero-timer-display" class="hero-timer">--<small style="font-size:16px;">Â§©</small></div>
                <!-- Dynamic Message -->
                <div id="home-message">CuteCumber Èö®ÊôÇÂæÖÂëΩ„ÄÇ</div>
            </div>
            
            <div class="stats-metrics">
                <div class="metric-card">
                    <div class="metric-title">üìÖ Êú¨ÊúàÊà∞Á∏æ</div>
                    <div class="metric-value"><span id="month-count-display">0</span> <span class="metric-unit">Ê¨°</span></div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">üî• ÁõÆÂâçÈÄ£Êìä</div>
                    <div class="metric-value"><span id="home-streak-display">0</span> <span class="metric-unit">Â§©</span></div>
                </div>
            </div>

            <div class="recent-list-header">ËøëÊúüÊ¥ªÂãï</div>
            <div id="recent-list-container"></div>
        </section>

        <!-- Record -->
        <section id="record">
            <h1>Êñ∞Â¢ûÁ¥ÄÈåÑ</h1>
            <form id="record-form">
                <div class="form-group"><label class="form-label">ÊôÇÈñì</label><input type="datetime-local" id="input-timestamp" class="form-control" required></div>
                <div class="form-group"><label class="form-label">Ê®°Âºè</label><select id="input-type" class="form-control"><option value="Ëá™ÊÖ∞">üñêÔ∏è Ëá™ÊÖ∞</option><option value="ÂÅöÊÑõ">üë®‚Äç‚ù§Ô∏è‚Äçüë® ÂÅöÊÑõ</option><option value="Â§¢ÈÅ∫">üí§ Â§¢ÈÅ∫</option></select></div>
                <div class="form-group"><label class="form-label">Âú∞Èªû</label><input type="text" id="input-location" class="form-control" value="Ëá•ÂÆ§" list="location-list"></div>
                <div id="section-masturbation">
                    <div class="form-group" style="position:relative;">
                        <label class="form-label">What makes you cum? üë® (ÊºîÂì°)</label>
                        <input type="text" id="input-actor-search" class="form-control" placeholder="ÊêúÂ∞ã‰∏¶ÈªûÊìäÂä†ÂÖ•..." autocomplete="off">
                        <div id="selected-actors-box" class="selected-tags-container"></div>
                        <div id="actor-suggestions" class="suggestions-dropdown"></div>
                    </div>
                    <div class="form-group" style="position:relative;">
                        <label class="form-label">What makes you cum? üé• (ÂΩ±Áâá)</label>
                        <input type="text" id="input-video-search" class="form-control" placeholder="ÊêúÂ∞ãÂΩ±Áâá..." autocomplete="off">
                        <input type="hidden" id="input-video-data">
                        <div id="video-suggestions" class="suggestions-dropdown"></div>
                    </div>
                </div>

                <div id="section-sex" style="display:none;">
                    <div class="form-group" style="position:relative;">
                        <label class="form-label">ÊÄßÂ§•‰º¥ (Sexual Partners)</label>
                        <div style="display:flex; gap:8px; margin-bottom:8px; align-items: stretch;">
                            <div style="display:flex; flex-direction:column; gap:6px; flex:1;">
                                <input type="text" id="input-partner-name" class="form-control" placeholder="Ëº∏ÂÖ•ÂêçÂ≠ó..." autocomplete="off">
                                <input type="url" id="input-partner-url" class="form-control" placeholder="https:// (Ë≤º‰∏äÁÖßÁâáÈÄ£Áµê)" style="font-size:12px; padding:8px;">
                            </div>
                            <div style="display:flex; flex-direction:column; gap:6px; width:50px;">
                                <label for="input-partner-photo" class="btn-base btn-outline" style="height:100%; padding:0; display:flex; align-items:center; justify-content:center; margin:0;">üìÅ</label>
                                <input type="file" id="input-partner-photo" accept="image/*" style="display:none">
                                <button type="button" class="btn-base btn-primary" onclick="addPartnerToState('new')" style="height:100%; padding:0; display:flex; align-items:center; justify-content:center; margin:0;">+</button>
                            </div>
                        </div>
                        <img id="preview-partner-photo" style="width:40px; height:40px; border-radius:50%; object-fit:cover; display:none; margin-bottom:8px; border:2px solid var(--color-primary);">
                        
                        <div id="selected-partners-box" class="selected-tags-container"></div>
                        <div id="partner-suggestions" class="suggestions-dropdown"></div>
                    </div>
                </div>
                <div class="form-group"><label class="form-label">ÂÇôË®ª (ÈÅ∏Â°´)</label><textarea id="input-note" class="form-control"></textarea></div>
                <div class="form-group"><label class="form-label">ÁÖßÁâá (ÈÅ∏Â°´)</label><label for="input-photo" class="photo-upload-label">üì∑ ÈÅ∏ÊìáÁÖßÁâá</label><input type="file" id="input-photo" accept="image/*" style="display:none"><img id="preview-photo" class="photo-preview"></div>
                <button type="submit" class="btn-base btn-accent" style="width:100%">ÁôºÂ∞ÑÁ¢∫Ë™çÔºÅüöÄ</button>
            </form>
        </section>

        <!-- Diary -->
        <section id="diary">
            <h1>Êó•Ë®ò</h1>
            <div class="view-toggle"><button class="toggle-btn active" onclick="switchDiaryView('calendar')">üìÖ Êó•ÊõÜÊ®°Âºè</button><button class="toggle-btn" onclick="switchDiaryView('list')">üìù ÂàóË°®Ê®°Âºè</button></div>
            <div id="diary-view-calendar" style="display:block;"><div class="calendar-header"><button class="calendar-nav-btn" onclick="changeMonth(-1)">‚Äπ</button><div class="calendar-title" id="calendar-title">YYYY/MM</div><button class="calendar-nav-btn" onclick="changeMonth(1)">‚Ä∫</button></div><div class="calendar-grid"><div class="weekday-label">Êó•</div><div class="weekday-label">‰∏Ä</div><div class="weekday-label">‰∫å</div><div class="weekday-label">‰∏â</div><div class="weekday-label">Âõõ</div><div class="weekday-label">‰∫î</div><div class="weekday-label">ÂÖ≠</div><div id="calendar-days-container" style="display:contents"></div></div></div>
            <div id="diary-view-list" style="display:none;">
                 <!-- Diary Search Bar -->
                <div id="diary-search-bar" class="search-container" style="margin-bottom: 15px;">
                    <input type="text" id="diary-search-input" class="search-input" placeholder="üîç ÊêúÂ∞ãÂÇôË®ª„ÄÅÂú∞ÈªûÊàñÈ°ûÂûã..." oninput="filterDiary()">
                </div>
                <div id="diary-list-content"></div>
            </div>
        </section>

        <!-- Stats -->
        <section id="stats">
            <h1>Êï∏Êìö</h1>
            <div class="view-toggle stats-toggle-container">
                <button class="toggle-btn active" onclick="switchStatsView('charts')">üìä ÂúñË°®ÂàÜÊûê</button>
                <button class="toggle-btn" onclick="switchStatsView('achievements')">üèÜ ÊàêÂ∞±ÁçéÁ´†</button>
            </div>
            <!-- View 1: Charts -->
            <div id="stats-view-charts">
                <div id="stats-content" style="display:none;">
                    <div class="stats-metrics">
                        <div class="metric-card" style="grid-column: span 2; background: linear-gradient(135deg, var(--color-card-bg) 0%, rgba(118, 200, 70, 0.05) 100%); border-color: var(--color-primary);">
                            <div class="metric-title" style="font-size:13px; color:var(--color-primary);">üèÜ Ê≠∑Âè≤Á∏ΩË®à</div>
                            <div class="metric-value" style="font-size:3rem;"><span id="stat-total">0</span><span class="metric-unit">Ê¨°</span></div>
                        </div>

                        <div class="metric-card"><div class="metric-title">üìÖ ‰ªäÂπ¥Á¥ØÁ©ç</div><div class="metric-value"><span id="stat-year">0</span><span class="metric-unit">Ê¨°</span></div></div>
                        <div class="metric-card"><div class="metric-title">üî• ÊúÄÈï∑ÈÄ£Êìä</div><div class="metric-value"><span id="stat-streak">0</span><span class="metric-unit">Â§©</span></div></div>
                        <div class="metric-card"><div class="metric-title">üßò ÊúÄÈï∑Á¶ÅÊÖæ</div><div class="metric-value"><span id="stat-abstinence">0</span><span class="metric-unit">Â§©</span></div></div>
                        
                        <div class="metric-card"><div class="metric-title">üñêÔ∏è Ëá™ÊÖ∞Á∏ΩË®à</div><div class="metric-value"><span id="stat-type-m">0</span><span class="metric-unit">Ê¨°</span></div></div>
                        <div class="metric-card"><div class="metric-title">üë®‚Äç‚ù§Ô∏è‚Äçüë® ÂÅöÊÑõÁ∏ΩË®à</div><div class="metric-value"><span id="stat-type-s">0</span><span class="metric-unit">Ê¨°</span></div></div>
                        <div class="metric-card"><div class="metric-title">üí§ Â§¢ÈÅ∫Á∏ΩË®à</div><div class="metric-value"><span id="stat-type-w">0</span><span class="metric-unit">Ê¨°</span></div></div>
                    </div>
                    <div class="chart-container"><div class="section-header">ÁîüÁêÜÈÄ±ÊúüÂàÜÊûê</div><canvas id="weeklyChart"></canvas></div>
                    <div id="yearly-stats-container"><div class="section-header" style="margin-top:30px;">üìú Ê≠∑Âπ¥Êà∞Á∏æÂõûÈ°ß</div><div id="yearly-list"></div></div>
                    
                    <div id="favorites-stats-container" style="margin-top:30px;">
                        <div class="section-header" style="font-size:18px; color:var(--color-accent); border-left-color:var(--color-accent); margin-bottom:20px;">
                            ‚òÅÔ∏è Èõ≤Á´ØÊÉÖ‰∫∫
                        </div>

                        <div class="rank-section">
                            <div class="section-header" style="font-size:14px; border-left:none; padding-left:0; color:#888;">üèÜ ÊúÄÊÑõËá®Âπ∏ (Top Actors)</div>
                            <div id="top-actors-list" class="rank-list"></div>
                        </div>
                        <div class="rank-section">
                            <div class="section-header" style="font-size:14px; border-left:none; padding-left:0; color:#888;">üìº ÂøÖÁúãÁ∂ìÂÖ∏ (Top Videos)</div>
                            <div id="top-videos-list" class="rank-list"></div>
                        </div>
                    </div>
                    <div id="partners-stats-container" style="margin-top:30px;">
                        <div class="section-header" style="font-size:18px; color:#E91E63; border-left-color:#E91E63; margin-bottom:20px;">
                            üë® ÊúÄ‰Ω≥Êà∞Âèã
                        </div>

                        <div class="rank-section">
                            <div id="top-partners-list" class="rank-list"></div>
                        </div>
                    </div>
                    <div class="rank-section" style="margin-top:20px;">
                            <div class="section-header" style="font-size:14px; border-left:none; padding-left:0; color:#888;">üåç ÂúãÊ∞ëÂ§ñ‰∫§ (Diplomacy Map)</div>
                            <div id="map-wrapper" style="position:relative; width:100%; height:350px; border-radius:12px; overflow:hidden; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                
                <div id="map-scroll-container" style="width:100%; height:100%; overflow:auto; -webkit-overflow-scrolling:touch;">
                    <div id="diplomacy-map" style="width:100%; height:100%;"></div>
                </div>

                <div class="map-controls" style="position:absolute; bottom:15px; right:15px; display:flex; flex-direction:column; gap:8px; z-index:100;">
                    <button class="btn-base" onclick="updateMapZoom(0.5)" style="width:36px; height:36px; padding:0; background:rgba(255,255,255,0.95); box-shadow:0 2px 8px rgba(0,0,0,0.2); color:#333; font-weight:900; font-size:18px; border:1px solid #eee;">+</button>
                    <button class="btn-base" onclick="updateMapZoom(-0.5)" style="width:36px; height:36px; padding:0; background:rgba(255,255,255,0.95); box-shadow:0 2px 8px rgba(0,0,0,0.2); color:#333; font-weight:900; font-size:18px; border:1px solid #eee;">-</button>
                </div>
            </div>
                        </div>
                </div>
                <div id="stats-empty" class="empty-stats"><div style="font-size:40px;margin-bottom:10px;">üìâ</div><p>Á¥ØÁ©ç‰∏ÄÈªûÊï∏ÊìöÂÜç‰æÜÂêßÔºÅ</p></div>
            </div>
            <!-- View 2: Achievements -->
            <div id="stats-view-achievements" style="display:none;">
                <div id="ach-list-container"></div>
            </div>
        </section>

        <!-- Driver -->
        <section id="driver" class="tab-content">
        <div id="driver-view-list" class="view-container active">
            
            <div class="driver-header" style="flex-direction:column; align-items:flex-start; gap:10px; margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                    <h1 style="color:var(--color-accent);margin:0;">Êî∂ËóèÊ´É</h1>
                    
                    <div style="display:flex; align-items:center;">
                         <button id="driver-dice-btn" class="btn-base btn-gold" onclick="rollTheDice()" style="padding:8px 12px; font-size:16px; margin-right:8px;">üé≤</button>
                         <button class="btn-base btn-primary" onclick="openTierList()" style="padding:8px 12px; font-size:16px; background:#444;">üèÜ</button>
                    </div>
                </div>
                
                <div class="view-toggle" style="width:100%;">
                    <button class="toggle-btn active" onclick="switchDriverMode('actor')">‚òÅÔ∏è Èõ≤Á´ØÊÉÖ‰∫∫</button>
                    <button class="toggle-btn" onclick="switchDriverMode('partner')">üíû ÊÄßÂ§•‰º¥</button>
                </div>
            </div>

            <div id="driver-action-bar" style="display:flex; justify-content:flex-end; margin-bottom:10px;">
                <button class="btn-base btn-primary" onclick="openAddActorForm()" style="font-size:13px;padding:8px 12px;">+ Êñ∞Â¢ûÊºîÂì°</button>
            </div>

            <div id="driver-search-bar" style="display:flex; align-items:center; background:#fff; padding:10px 15px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.05); margin-bottom:10px; border:1px solid #eee;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2" style="margin-right:10px;"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <input type="text" id="driver-search-input" placeholder="ÊêúÂ∞ãÂßìÂêç„ÄÅÁâπÂæµ..." oninput="filterDriverList()" style="border:none; outline:none; font-size:16px; width:100%; background:transparent; color:#333;">
            </div>

            <div class="filter-bar" style="display:flex; justify-content:flex-end; margin-bottom:15px;">
                <select id="driver-sort-select" class="form-control" onchange="filterDriverList()" style="width:auto; padding-right:30px; margin:0; font-size:14px;">
                    <option value="updated">üïí ÊúÄÂæåÊõ¥Êñ∞</option>
                    <option value="name">üî§ ÂßìÂêç (A-Z)</option>
                    <option value="count">üé¨ ÂΩ±ÁâáÊï∏Èáè</option>
                </select>
            </div>

            <div id="actor-grid" class="actor-grid"></div>
            <div id="partner-grid" class="actor-grid" style="display:none;"></div>
            
            <div id="empty-msg" class="empty-state" style="display:none;">
                <div style="font-size:40px;margin-bottom:10px;">üï∏Ô∏è</div>
                <div style="color:#999;">Êâæ‰∏çÂà∞Á¨¶ÂêàÁöÑË≥áÊñô</div>
            </div>
        </div>
        <div id="driver-view-detail" class="view-container">
                <div style="margin-bottom:15px;">
                    <button class="btn-base btn-outline" onclick="showDriverList()" style="width:auto; padding:8px 12px; display:inline-flex; align-items:center; gap:5px;">
                        <span>‚Äπ</span> ËøîÂõûÂàóË°®
                    </button>
                </div>
                
                <div id="detail-profile-container"></div>

                <div class="section-header" style="margin-top:20px; font-size:15px; border-left-color:var(--color-accent);">
                    üìº Êî∂ËóèÂΩ±Áâá
                </div>
                <div id="video-list-container" class="video-list-container"></div>
            </div>
            <div id="driver-view-detail" class="view-container">
            </div>

        <div id="driver-view-tier" class="view-container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <button class="btn-base btn-outline" onclick="closeTierList()" style="width:auto; padding:8px 12px;">‚Äπ ËøîÂõûÂàóË°®</button>
                <h2 style="margin:0; font-size:18px; color:#333;">üèÜ ÊéíË°åÊ¶ú</h2>
                <button class="btn-base btn-primary" onclick="saveTierList()" style="font-size:12px; padding:6px 10px;">üíæ ÂÑ≤Â≠ò</button>
            </div>
            
            <div id="tier-container" class="tier-wrapper">
                <div class="tier-row"><div class="tier-label s-tier">S</div><div class="tier-content" ondrop="drop(event, 'S')" ondragover="allowDrop(event)"></div></div>
                <div class="tier-row"><div class="tier-label a-tier">A</div><div class="tier-content" ondrop="drop(event, 'A')" ondragover="allowDrop(event)"></div></div>
                <div class="tier-row"><div class="tier-label b-tier">B</div><div class="tier-content" ondrop="drop(event, 'B')" ondragover="allowDrop(event)"></div></div>
                <div class="tier-row"><div class="tier-label c-tier">C</div><div class="tier-content" ondrop="drop(event, 'C')" ondragover="allowDrop(event)"></div></div>
                <div class="tier-row"><div class="tier-label d-tier">D</div><div class="tier-content" ondrop="drop(event, 'D')" ondragover="allowDrop(event)"></div></div>
            </div>

            <div class="section-header" style="margin-top:20px; font-size:14px; color:#888;">ÂæÖÂàÜÈ°û (Êú™ÂàÜÁ¥ö)</div>
            <div id="tier-pool" class="tier-pool" ondrop="drop(event, 'unranked')" ondragover="allowDrop(event)"></div>
            <div style="text-align:center; color:#aaa; font-size:12px; margin-top:-40px; margin-bottom: 20px;">Èï∑ÊåâÈ†≠ÂÉèÂç≥ÂèØÁßªÂãï</div>
        </div>
        </section>  <section id="settings">
    </section>

        <!-- Settings -->
        <section id="settings">
            <div class="settings-header">
                <button class="btn-close" style="width:36px;height:36px;" onclick="exitSettings()">‚Äπ</button>
                <h1 style="margin:0;">ÂÄã‰∫∫Ë®≠ÂÆö</h1>
            </div>

            <!-- Card 1: User Profile -->
            <div class="settings-card">
                <div class="settings-title">‰ΩøÁî®ËÄÖË≥áË®ä</div>
                <div class="form-group">
                    <label class="form-label">ËÄÅÂè∏Ê©ü‰ª£Ëôü</label>
                    <input type="text" id="setting-nickname" class="form-control" placeholder="Â∏•Âì•">
                </div>
                <div class="form-group">
                    <label class="form-label">ÁîüÊó•</label>
                    <input type="date" id="setting-birthday" class="form-control">
                </div>
                <button class="btn-base btn-primary" style="width:100%" onclick="saveUserProfile()">üíæ ÂÑ≤Â≠òÂÄã‰∫∫Ë≥áÊñô</button>
            </div>

            <!-- Card 2: Security (New) -->
            <div class="settings-card">
                <div class="settings-title">ÂÆâÂÖ®ÊÄß</div>
                <div class="form-group" style="display:flex; justify-content:space-between; align-items:center;">
                    <label class="form-label" style="margin:0;">üîí ÂïüÂãïÂØÜÁ¢ºÈéñ</label>
                    <label class="switch">
                        <input type="checkbox" id="passcode-toggle" onchange="togglePasscodeSwitch()">
                        <span class="slider round"></span>
                    </label>
                </div>
                <button id="btn-change-passcode" class="btn-base btn-outline" style="width:100%; display:none;" onclick="startChangePasscode()">‰øÆÊîπÂØÜÁ¢º</button>
            </div>

            <!-- Card 3: App Settings -->
            <div class="settings-card">
                <div class="settings-title">Â§ñËßÄ</div>
                <div class="form-group" style="display:flex; justify-content:space-between; align-items:center;">
                    <label class="form-label" style="margin:0;">üåô Ê∑±Ëâ≤Ê®°Âºè</label>
                    <label class="switch">
                        <input type="checkbox" id="dark-mode-toggle" onchange="toggleDarkMode()">
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>

            <!-- Card 4: Data Management -->
            <div class="settings-card">
                <div class="settings-title">Ë≥áÊñôÁÆ°ÁêÜ</div>
                <p class="settings-desc">ÊâÄÊúâË≥áÊñôÈÉΩÂÑ≤Â≠òÂú®ÊÇ®ÁöÑÁÄèË¶ΩÂô®‰∏≠„ÄÇË´ãÂÆöÊúüÂåØÂá∫ÂÇô‰ªΩÔºå‰ª•ÂÖçË≥áÊñôÈÅ∫Â§±„ÄÇ</p>
                <div style="display:flex; flex-direction:column; gap:10px;">
                    <button class="btn-base btn-outline" onclick="exportData()">üì§ ÂåØÂá∫ÂÇô‰ªΩ (JSON)</button>
                    <button class="btn-base btn-outline" onclick="document.getElementById('import-file').click()">üì• ÂåØÂÖ•ÂÇô‰ªΩ (JSON)</button>
                    <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(this)">
                    <button class="btn-base btn-danger" style="margin-top:10px;" onclick="resetData()">üóëÔ∏è Ê∏ÖÁ©∫ÊâÄÊúâË≥áÊñô</button>
                </div>
            </div>
            <div style="text-align:center; color:#aaa; font-size:12px; margin-top:20px;">CuteCumber v5.7<br>Made with ‚ù§Ô∏è</div>
        </section>
    </main>

    <!-- System Modal -->
    <div id="system-modal" class="modal-overlay">
        <div class="system-modal-content">
            <h3 class="system-modal-title" id="sys-title">ÊèêÁ§∫</h3>
            <div class="system-modal-msg" id="sys-msg"></div>
            <div class="system-modal-actions" id="sys-actions"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="achievement-modal" class="modal-overlay"><div class="unlock-modal-content"><div class="unlock-icon-wrapper"><span id="unlock-icon">üèÜ</span></div><div class="unlock-title" id="unlock-title">ÊàêÂ∞±Ëß£Èéñ</div><div class="unlock-msg" id="unlock-msg"></div><button class="btn-base btn-gold" style="width:100%" onclick="closeAchievementModal()">Êî∂‰∏ãÊ¶ÆËÄÄ</button><div class="unlock-confetti"></div></div></div>
    <div id="achievement-detail-modal" class="modal-overlay bottom-sheet">
        <div class="modal-content-bottom">
            <div class="detail-header" style="border:none;"><button class="btn-close" style="margin-left:auto;" onclick="closeAchDetailModal()">√ó</button></div>
            <div style="text-align:center; margin-bottom:20px;">
                <div style="font-size:60px; margin-bottom:10px;" id="ad-icon"></div>
                <div style="font-size:24px; font-weight:800; color:#d48806;" id="ad-title"></div>
                <div style="font-size:14px; color:#999; margin-top:5px;" id="ad-desc"></div>
            </div>
            <div class="ach-info-row"><span class="ach-info-label">ÈÅîÊàêÊó•Êúü</span><span id="ad-date"></span></div>
            <div class="ach-info-desc" id="ad-msg"></div>
        </div>
    </div>
    
    <!-- Random Picker Modal -->
    <div id="random-modal" class="modal-overlay">
        <div class="unlock-modal-content" style="max-width: 300px;">
            <div style="text-align:right; width:100%; margin-bottom:-20px;">
                <button class="btn-close" onclick="closeRandomModal()" style="display:inline-flex;">√ó</button>
            </div>
            <div class="unlock-title" style="margin-top:20px; font-size:16px; color:#888;">ÂëΩÈÅãÁöÑÈÅ∏ÊìáÊòØ...</div>
            <div id="random-result-container" style="margin: 20px 0;">
            </div>
            <button id="btn-random-go" class="btn-base btn-primary" style="width:100%">ÂâçÂæÄÊü•Áúã üöÄ</button>
        </div>
    </div>

    <!-- Edit Record Modal -->
    <div id="edit-record-modal" class="modal-overlay bottom-sheet">
        <div class="modal-content-bottom">
            <h3 style="margin:0 0 20px 0;font-size:20px;">Á∑®ËºØÁ¥ÄÈåÑ</h3>
            <form id="edit-record-form">
                <div class="form-group"><label class="form-label">ÊôÇÈñì</label><input type="datetime-local" id="edit-timestamp" class="form-control" required></div>
                <div class="form-group"><label class="form-label">Ê®°Âºè</label><select id="edit-type" class="form-control"><option value="Ëá™ÊÖ∞">üñêÔ∏è Ëá™ÊÖ∞ (DIY)</option><option value="ÂÅöÊÑõ">üíû ÂÅöÊÑõ (Sex)</option><option value="Â§¢ÈÅ∫">üí§ Â§¢ÈÅ∫ (Wet Dream)</option></select></div>
                <div class="form-group"><label class="form-label">Âú∞Èªû</label><input type="text" id="edit-location" class="form-control" list="location-list"></div>
                <div id="edit-section-masturbation">
                    <div class="form-group" style="position:relative;">
                        <label class="form-label">What makes you cum? üë® (ÊºîÂì°)</label>
                        <input type="text" id="edit-actor-search" class="form-control" placeholder="ÊêúÂ∞ã‰∏¶Âä†ÂÖ•..." autocomplete="off">
                        <div id="edit-selected-actors-box" class="selected-tags-container"></div>
                        <div id="edit-actor-suggestions" class="suggestions-dropdown"></div>
                    </div>
                    <div class="form-group" style="position:relative;">
                        <label class="form-label">What makes you cum? üé• (ÂΩ±Áâá)</label>
                        <input type="text" id="edit-video-search" class="form-control" placeholder="ÊêúÂ∞ãÂΩ±Áâá..." autocomplete="off">
                        <input type="hidden" id="edit-video-data">
                        <div id="edit-video-suggestions" class="suggestions-dropdown"></div>
                    </div>
                </div>

                <div id="edit-section-sex" style="display:none;">
                    <div class="form-group" style="position:relative;">
                        <label class="form-label">ÊÄßÂ§•‰º¥ (Sexual Partners)</label>
                        <div style="display:flex; gap:8px; margin-bottom:8px; align-items: stretch;">
                            <div style="display:flex; flex-direction:column; gap:6px; flex:1;">
                                <input type="text" id="edit-input-partner-name" class="form-control" placeholder="Ëº∏ÂÖ•ÂêçÂ≠ó..." autocomplete="off">
                                <input type="url" id="edit-input-partner-url" class="form-control" placeholder="https:// (Ë≤º‰∏äÁÖßÁâáÈÄ£Áµê)" style="font-size:12px; padding:8px;">
                            </div>
                            <div style="display:flex; flex-direction:column; gap:6px; width:50px;">
                                <label for="edit-input-partner-photo" class="btn-base btn-outline" style="height:100%; padding:0; display:flex; align-items:center; justify-content:center; margin:0;">üìÅ</label>
                                <input type="file" id="edit-input-partner-photo" accept="image/*" style="display:none">
                                <button type="button" class="btn-base btn-primary" onclick="addPartnerToState('edit')" style="height:100%; padding:0; display:flex; align-items:center; justify-content:center; margin:0;">+</button>
                            </div>
                        </div>
                        <img id="edit-preview-partner-photo" style="width:40px; height:40px; border-radius:50%; object-fit:cover; display:none; margin-bottom:8px; border:2px solid var(--color-primary);">
                        
                        <div id="edit-selected-partners-box" class="selected-tags-container"></div>
                        <div id="edit-partner-suggestions" class="suggestions-dropdown"></div>
                    </div>
                </div>
                <div class="form-group"><label class="form-label">ÂÇôË®ª</label><textarea id="edit-note" class="form-control"></textarea></div>
                <div class="form-group"><label class="form-label">ÁÖßÁâá</label><label for="edit-input-photo" class="photo-upload-label">üì∑ Êõ¥Êèõ/‰∏äÂÇ≥ÁÖßÁâá</label><input type="file" id="edit-input-photo" accept="image/*" style="display:none"><img id="edit-preview-photo" class="photo-preview"></div>
                <div style="display:flex;gap:10px;margin-top:20px;"><button type="button" class="btn-base" style="background:#eee;color:#666;flex:1" onclick="closeEditModal()">ÂèñÊ∂à</button><button type="submit" class="btn-base btn-primary" style="flex:1">ÂÑ≤Â≠òËÆäÊõ¥</button></div>
            </form>
        </div>
    </div>

    <div id="detail-modal" class="modal-overlay bottom-sheet"><div class="modal-content-bottom"><div style="display:flex;justify-content:space-between;margin-bottom:15px;"><span id="detail-date-time" style="font-size:18px;font-weight:800;"></span><button class="btn-close" onclick="closeDetailModal()">√ó</button></div><div id="detail-photo-container" style="margin-bottom:20px;border-radius:16px;overflow:hidden;display:none;"><img id="detail-photo" style="width:100%;"></div><div style="display:flex;gap:10px;margin-bottom:15px;"><span id="detail-type" style="background:var(--color-primary);color:white;padding:4px 10px;border-radius:6px;font-size:12px;font-weight:bold;"></span><span id="detail-location" style="color:#666;font-size:14px;"></span></div><div id="detail-note-box" style="background:white;padding:15px;border-radius:12px;border:1px solid #eee;color:#555;font-size:15px;line-height:1.6;margin-bottom:25px;white-space:pre-wrap;display:none;"></div><div id="detail-empty-note" style="color:#aaa;font-style:italic;margin-bottom:20px;display:none">ÁÑ°ÂÇôË®ª</div><div style="display:flex;gap:10px;"><button id="detail-edit-btn" class="btn-base" style="background:#eee;flex:1;color:#333">Á∑®ËºØ</button><button id="detail-delete-btn" class="btn-base btn-danger" style="flex:1;">Âà™Èô§</button></div></div></div>
    <div id="daily-list-modal" class="modal-overlay bottom-sheet"><div class="modal-content-bottom"><div style="display:flex;justify-content:space-between;margin-bottom:15px;"><span id="daily-list-date" style="font-size:18px;font-weight:800;"></span><button class="btn-close" onclick="closeDailyListModal()">√ó</button></div><div style="color:#666;font-size:14px;margin-bottom:15px;">ÂÖ± <span id="daily-count" style="font-weight:bold;color:var(--color-primary)"></span> Á≠ÜÁ¥ÄÈåÑ</div><div id="daily-list-container" style="display:flex;flex-direction:column;gap:10px;"></div></div></div>
    <div id="actor-form-modal" class="modal-overlay bottom-sheet"><div class="modal-content-bottom"><h3 id="actor-form-title" style="margin:0 0 20px 0;font-size:20px;">Âª∫Á´ãÊñ∞Ê™îÊ°à</h3><form id="actor-form"><div class="form-group"><label class="form-label">ÂßìÂêç</label><input type="text" id="actor-name" class="form-control" required></div><div class="form-group"><label class="form-label">È†≠ÂÉè (Ë≤ºÁ∂≤ÂùÄ Êàñ ‰∏äÂÇ≥)</label><input type="url" id="actor-avatar-url" class="form-control" placeholder="https://..."><label for="actor-file-input" class="photo-upload-label">üìÅ ‰∏äÂÇ≥Êú¨Âú∞ÂúñÁâá</label><input type="file" id="actor-file-input" accept="image/*" style="display:none"><img id="actor-preview" class="photo-preview"></div><div class="form-group"><label class="form-label">ÂÄã‰∫∫Á∂≤Á´ô / X (Twitter)</label><input type="url" id="actor-website" class="form-control" placeholder="https://twitter.com/..."></div><div class="form-group" style="position:relative;"><label class="form-label">Ê®ôÁ±§ (Hashtag)</label><input type="text" id="actor-tags" class="form-control" placeholder="#Â∑®Â±å #Daddy (Áî®Á©∫ÁôΩÂàÜÈöî)" autocomplete="off"><div id="tag-suggestions" class="suggestions-dropdown"></div></div><div class="form-group"><label class="form-label">Á∞°‰ªã</label><textarea id="actor-bio" class="form-control" rows="5" placeholder="Á∞°‰ªã (ÈÅ∏Â°´)"></textarea></div><div style="display:flex;gap:10px;margin-top:20px;"><button type="button" class="btn-base" style="background:#eee;color:#666;flex:1" onclick="closeActorFormModal()">ÂèñÊ∂à</button><button type="submit" id="actor-form-submit" class="btn-base btn-primary" style="flex:1">ÂÑ≤Â≠ò</button></div></form></div></div>
    <div id="video-form-modal" class="modal-overlay bottom-sheet"><div class="modal-content-bottom"><h3 id="video-form-title" style="margin:0 0 20px 0;font-size:20px;">ÂΩ±ÁâáË≥áË®ä</h3><form id="video-form"><div class="form-group"><label class="form-label">Ê®ôÈ°å</label><input type="text" id="video-title" class="form-control" required></div><div class="form-group"><label class="form-label">ÈÄ£Áµê</label><input type="url" id="video-url" class="form-control" placeholder="https://..." required></div><div class="form-group"><label class="form-label">Â∞ÅÈù¢ (Ë≤ºÁ∂≤ÂùÄ Êàñ ‰∏äÂÇ≥)</label><input type="url" id="video-thumb-url" class="form-control" placeholder="https://..."><label for="video-file-input" class="photo-upload-label">üìÅ ‰∏äÂÇ≥Â∞ÅÈù¢Âúñ</label><input type="file" id="video-file-input" accept="image/*" style="display:none"><img id="video-preview" class="photo-preview"></div><!-- Video Tags --><div class="form-group" style="position:relative;"><label class="form-label">Ê®ôÁ±§ (Hashtag)</label><input type="text" id="video-tags" class="form-control" placeholder="#cum #bukkake (Áî®Á©∫ÁôΩÂàÜÈöî)" autocomplete="off"><div id="video-tag-suggestions" class="suggestions-dropdown"></div></div><div class="form-group"><label class="form-label">ÂÇôË®ª</label><textarea id="video-note" class="form-control"></textarea></div><div style="display:flex;gap:10px;margin-top:20px;"><button type="button" class="btn-base" style="background:#eee;color:#666;flex:1" onclick="closeVideoFormModal()">ÂèñÊ∂à</button><button type="submit" id="video-form-submit" class="btn-base btn-primary" style="flex:1">ÂÑ≤Â≠ò</button></div></form></div></div>
    <div id="video-detail-modal" class="modal-overlay bottom-sheet"><div class="modal-content-bottom"><div style="display:flex;justify-content:flex-end;margin-bottom:10px;"><button class="btn-close" onclick="closeVideoDetail()">√ó</button></div><div id="vid-detail-cover-box" class="vid-detail-cover-box" style="display:none"><img id="vid-detail-cover" class="vid-detail-cover"></div><div id="vid-detail-title" class="vid-detail-title"></div><div id="vid-detail-note" class="vid-detail-note" style="display:none"></div><div class="vid-actions"><button id="vid-btn-edit" class="btn-base" style="background:#eee;color:#333;">‚úèÔ∏è Á∑®ËºØ</button><button id="vid-btn-delete" class="btn-base btn-danger">üóëÔ∏è Âà™Èô§</button><button id="vid-btn-watch" class="btn-base btn-accent vid-main-action">üöÄ ÂâçÂæÄËßÄÁúã</button></div></div></div>
<div id="partner-detail-modal" class="modal-overlay bottom-sheet">
        <div class="modal-content-bottom">
            <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
                <button class="btn-close" onclick="closePartnerDetail()">√ó</button>
            </div>
            
            <div style="text-align:center; margin-bottom:20px;">
                <img id="pd-avatar" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:3px solid white; box-shadow:0 4px 15px rgba(0,0,0,0.1); margin-bottom:15px;">
                <div style="display:flex; align-items:center; justify-content:center; gap:8px;">
                    <div id="pd-name" style="font-size:22px; font-weight:800; color:#333;"></div>
                    <div id="pd-flag" style="font-size:22px;"></div>
                </div>
                <div id="pd-meta" style="font-size:13px; color:#888; margin-top:5px;"></div>
                <div id="pd-stats" style="margin-top:15px; display:inline-block; background:rgba(255,105,180,0.1); color:var(--color-accent); padding:6px 15px; border-radius:20px; font-weight:bold; font-size:14px;">
                    Á¥ØÁ©çÊ¨°Êï∏Ôºö0 Ê¨°
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-bottom:25px;">
                <button class="btn-base" style="flex:1; background:#f0f0f0; color:#333;" onclick="openPartnerEditForm()">‚úèÔ∏è Á∑®ËºØ</button>
                <button class="btn-base btn-danger" style="flex:1;" onclick="deleteCurrentPartner()">üóëÔ∏è Âà™Èô§</button>
            </div>

            <div class="section-header" style="font-size:15px; margin-bottom:15px;">üìú Êà∞ÂΩπÁ¥ÄÈåÑ</div>
            <div id="pd-history-list" style="display:flex; flex-direction:column; gap:10px; max-height:300px; overflow-y:auto;"></div>
        </div>
    </div>

    <div id="partner-form-modal" class="modal-overlay bottom-sheet">
        <div class="modal-content-bottom">
            <h3 style="margin:0 0 20px 0;font-size:20px;">Á∑®ËºØÂ§•‰º¥Ë≥áÊñô</h3>
            <form id="partner-edit-form">
                <div class="form-group"><label class="form-label">ÂßìÂêç</label><input type="text" id="pf-name" class="form-control" required></div>
                <div class="form-group">
                    <label class="form-label">ÁÖßÁâá</label>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <img id="pf-preview" class="photo-preview" style="width:60px; height:60px; display:block; object-fit:cover; border-radius:50%; margin:0;">
                        <div style="flex:1;">
                            <input type="url" id="pf-url" class="form-control" placeholder="Ë≤º‰∏äÁÖßÁâáÈÄ£Áµê..." style="margin-bottom:5px;">
                            <label for="pf-file" class="btn-base btn-outline" style="padding:6px; font-size:12px; width:100%;">Êàñ ‰∏äÂÇ≥Ê™îÊ°à</label>
                            <input type="file" id="pf-file" accept="image/*" style="display:none">
                        </div>
                    </div>
                </div>
                <div class="form-group" style="position:relative;">
                    <label class="form-label">ÂúãÁ±ç (ÊêúÂ∞ã)</label>
                    <input type="text" id="pf-nation-search" class="form-control" placeholder="Ëº∏ÂÖ•ÈóúÈçµÂ≠ó (Â¶Ç: Âè∞ÁÅ£, Jap...)" autocomplete="off">
                    <input type="hidden" id="pf-nation-data"> <div id="pf-nation-suggestions" class="suggestions-dropdown"></div>
                </div>
                <div class="form-group"><label class="form-label">‰∫∫Á®Æ / ÂÇôË®ª</label><textarea id="pf-race" class="form-control" placeholder="‰æãÂ¶ÇÔºöÊãâ‰∏ÅË£î, Ê∑∑Ë°Ä..."></textarea></div>
                
                <div style="display:flex;gap:10px;margin-top:20px;">
                    <button type="button" class="btn-base" style="background:#eee;color:#666;flex:1" onclick="document.getElementById('partner-form-modal').classList.remove('active')">ÂèñÊ∂à</button>
                    <button type="submit" class="btn-base btn-primary" style="flex:1">ÂÑ≤Â≠ò</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Lock Screen -->
    <div id="lock-screen">
        <div class="lock-title" id="lock-title">Ëº∏ÂÖ•ÂØÜÁ¢º</div>
        <div class="lock-dots" id="lock-dots">
            <div class="lock-dot"></div><div class="lock-dot"></div><div class="lock-dot"></div><div class="lock-dot"></div>
        </div>
        <div class="keypad">
            <div class="key-btn" onclick="pressKey(1)">1</div><div class="key-btn" onclick="pressKey(2)">2</div><div class="key-btn" onclick="pressKey(3)">3</div>
            <div class="key-btn" onclick="pressKey(4)">4</div><div class="key-btn" onclick="pressKey(5)">5</div><div class="key-btn" onclick="pressKey(6)">6</div>
            <div class="key-btn" onclick="pressKey(7)">7</div><div class="key-btn" onclick="pressKey(8)">8</div><div class="key-btn" onclick="pressKey(9)">9</div>
            <div class="key-btn transparent" onclick="cancelPasscode()">ÂèñÊ∂à</div><div class="key-btn" onclick="pressKey(0)">0</div><div class="key-btn transparent" onclick="deleteKey()">‚å´</div>
        </div>
    </div>

    <nav id="tab-bar">
        <button class="tab-item active" data-target="home"><span class="tab-icon">üè†</span><span class="tab-label">È¶ñÈ†Å</span></button>
        <button class="tab-item" data-target="record"><span class="tab-icon">ü•í</span><span class="tab-label">Á¥ÄÈåÑ</span></button>
        <button class="tab-item" data-target="diary"><span class="tab-icon">üìñ</span><span class="tab-label">Êó•Ë®ò</span></button>
        <button class="tab-item" data-target="stats"><span class="tab-icon">üìä</span><span class="tab-label">Êï∏Êìö</span></button>
        <button class="tab-item" data-target="driver"><span class="tab-icon">üóÑÔ∏è</span><span class="tab-label">Êî∂ËóèÊ´É</span></button>
    </nav>
    
    <datalist id="location-list"></datalist>

    <!-- PWA Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => {
                        console.log('SW registered!', reg);
                        // Optional: Check for updates
                        reg.onupdatefound = () => {
                            const installingWorker = reg.installing;
                            installingWorker.onstatechange = () => {
                                if (installingWorker.state === 'installed') {
                                    if (navigator.serviceWorker.controller) {
                                        console.log('New content is available; please refresh.');
                                    } else {
                                        console.log('Content is cached for offline use.');
                                    }
                                }
                            };
                        };
                    })
                    .catch(err => console.log('SW registration failed', err));
            });
        }
    </script>

    <script>
        const RECORD_KEY = 'cuteCumberData';
        const ACTOR_KEY = 'cuteCumberActors';
        const ACH_KEY = 'cuteCumberUnlocked';
        const PROFILE_KEY = 'cuteCumberProfile';
        
        let ejaculationRecords = [];
        let actorProfiles = [];
        let unlockedAchievements = [];
        let userProfile = { nickname: '', birthday: '' };
        
        let currentActorId = null;
        let editingActorId = null;
        let editingVideoId = null;
        let editingRecordId = null;
        
        let currentCalendarDate = new Date();
        let tempRecordPhoto = "";
        let tempActorAvatar = "";
        let tempVideoThumb = "";
        // --- Multi-Select Logic ---
        let tempActorsList = []; // [ {id, name}, ... ] (For Record Form)
        let editTempActorsList = []; // (For Edit Form)
        // --- Partner Logic ---
        let tempPartnerList = []; // [{name, photo}]
        let editTempPartnerList = [];
        let currentPartnerPhoto = ""; // Êö´Â≠òÊ≠£Âú®Ëº∏ÂÖ•ÁöÑÈÇ£‰ΩçÂ§•‰º¥ÁöÑÁÖßÁâá
        const PARTNER_KEY = 'cuteCumberPartners';
        let partnerProfiles = [];
        let currentPartnerName = null; // Áî®ÊñºÁ∑®ËºØ/Êü•ÁúãË©≥ÊÉÖ
        
        // ÂÆåÊï¥ÂúãÂÆ∂ÂàóË°® (Ê∂µËìãÂÖ®ÁêÉ‰∏ªË¶ÅÂúãÂÆ∂ËàáÂú∞ÂçÄ - Âê´ ISO ‰ª£Á¢ºÁâà)
        const COUNTRY_LIST = [
            // --- Êù±‰∫û ---
            {n:"Âè∞ÁÅ£",f:"üáπüáº",c:"TW"}, {n:"Êó•Êú¨",f:"üáØüáµ",c:"JP"}, {n:"ÈüìÂúã",f:"üá∞üá∑",c:"KR"}, {n:"‰∏≠Âúã",f:"üá®üá≥",c:"CN"}, {n:"È¶ôÊ∏Ø",f:"üá≠üá∞",c:"HK"}, {n:"Êæ≥ÈñÄ",f:"üá≤üá¥",c:"MO"}, {n:"ËíôÂè§",f:"üá≤üá≥",c:"MN"}, {n:"ÂåóÈüì",f:"üá∞üáµ",c:"KP"},
            
            // --- Êù±Âçó‰∫û ---
            {n:"Ê≥∞Âúã",f:"üáπüá≠",c:"TH"}, {n:"Ë∂äÂçó",f:"üáªüá≥",c:"VN"}, {n:"Ëè≤ÂæãË≥ì",f:"üáµüá≠",c:"PH"}, {n:"È¶¨‰æÜË•ø‰∫û",f:"üá≤üáæ",c:"MY"}, {n:"Êñ∞Âä†Âù°",f:"üá∏üá¨",c:"SG"}, {n:"Âç∞Â∞º",f:"üáÆüá©",c:"ID"}, 
            {n:"Êü¨ÂüîÂØ®",f:"üá∞üá≠",c:"KH"}, {n:"Á∑¨Áî∏",f:"üá≤üá≤",c:"MM"}, {n:"ÂØÆÂúã",f:"üá±üá¶",c:"LA"}, {n:"Ê±∂Ëêä",f:"üáßüá≥",c:"BN"}, {n:"Êù±Â∏ùÊ±∂",f:"üáπüá±",c:"TL"},
            
            // --- Âçó‰∫û ---
            {n:"Âç∞Â∫¶",f:"üáÆüá≥",c:"IN"}, {n:"Â∑¥Âü∫ÊñØÂù¶",f:"üáµüá∞",c:"PK"}, {n:"Â≠üÂä†Êãâ",f:"üáßüá©",c:"BD"}, {n:"ÊñØÈáåËò≠Âç°",f:"üá±üá∞",c:"LK"}, {n:"Â∞ºÊ≥äÁàæ",f:"üá≥üáµ",c:"NP"}, {n:"‰∏ç‰∏π",f:"üáßüáπ",c:"BT"}, {n:"È¶¨ÁàæÂú∞Â§´",f:"üá≤üáª",c:"MV"},
            
            // --- ÁæéÊ¥≤ (ÂåóÁæé/‰∏≠Áæé/ÂçóÁæé) ---
            {n:"ÁæéÂúã",f:"üá∫üá∏",c:"US"}, {n:"Âä†ÊãøÂ§ß",f:"üá®üá¶",c:"CA"}, {n:"Â¢®Ë•øÂì•",f:"üá≤üáΩ",c:"MX"}, {n:"Â∑¥Ë•ø",f:"üáßüá∑",c:"BR"}, {n:"ÈòøÊ†πÂª∑",f:"üá¶üá∑",c:"AR"}, {n:"Êô∫Âà©",f:"üá®üá±",c:"CL"}, 
            {n:"Âì•ÂÄ´ÊØî‰∫û",f:"üá®üá¥",c:"CO"}, {n:"ÁßòÈ≠Ø",f:"üáµüá™",c:"PE"}, {n:"ÂßîÂÖßÁëûÊãâ",f:"üáªüá™",c:"VE"}, {n:"ÂéÑÁìúÂ§ö",f:"üá™üá®",c:"EC"}, {n:"ÁéªÂà©Á∂≠‰∫û",f:"üáßüá¥",c:"BO"}, {n:"Â∑¥ÊãâÂú≠",f:"üáµüáæ",c:"PY"}, {n:"ÁÉèÊãâÂú≠",f:"üá∫üáæ",c:"UY"},
            {n:"Âè§Â∑¥",f:"üá®üá∫",c:"CU"}, {n:"ÁâôË≤∑Âä†",f:"üáØüá≤",c:"JM"}, {n:"Â∑¥ÊãøÈ¶¨",f:"üáµüá¶",c:"PA"}, {n:"Âì•ÊñØÂ§ßÈªéÂä†",f:"üá®üá∑",c:"CR"}, {n:"Â§öÊòéÂ∞ºÂä†",f:"üá©üá¥",c:"DO"}, {n:"Êµ∑Âú∞",f:"üá≠üáπ",c:"HT"}, {n:"Ë≤ùÈáåÊñØ",f:"üáßüáø",c:"BZ"},
            {n:"ÂÆèÈÉΩÊãâÊñØ",f:"üá≠üá≥",c:"HN"}, {n:"Ëñ©ÁàæÁì¶Â§ö",f:"üá∏üáª",c:"SV"}, {n:"Â∞ºÂä†ÊãâÁìú",f:"üá≥üáÆ",c:"NI"}, {n:"ÁìúÂú∞È¶¨Êãâ",f:"üá¨üáπ",c:"GT"},
            
            // --- Ê≠êÊ¥≤ (Ë•øÊ≠ê/ÂåóÊ≠ê/ÂçóÊ≠ê/Êù±Ê≠ê) ---
            {n:"Ëã±Âúã",f:"üá¨üáß",c:"GB"}, {n:"Ê≥ïÂúã",f:"üá´üá∑",c:"FR"}, {n:"Âæ∑Âúã",f:"üá©üá™",c:"DE"}, {n:"Áæ©Â§ßÂà©",f:"üáÆüáπ",c:"IT"}, {n:"Ë•øÁè≠Áâô",f:"üá™üá∏",c:"ES"}, {n:"Ëë°ËêÑÁâô",f:"üáµüáπ",c:"PT"},
            {n:"Ëç∑Ëò≠",f:"üá≥üá±",c:"NL"}, {n:"ÊØîÂà©ÊôÇ",f:"üáßüá™",c:"BE"}, {n:"ÁëûÂ£´",f:"üá®üá≠",c:"CH"}, {n:"Â•ßÂú∞Âà©",f:"üá¶üáπ",c:"AT"}, {n:"ÁëûÂÖ∏",f:"üá∏üá™",c:"SE"}, {n:"Êå™Â®Å",f:"üá≥üá¥",c:"NO"}, {n:"Ëä¨Ëò≠",f:"üá´üáÆ",c:"FI"}, {n:"‰∏πÈ∫•",f:"üá©üá∞",c:"DK"}, {n:"ÂÜ∞Â≥∂",f:"üáÆüá∏",c:"IS"},
            {n:"ÊÑõÁàæËò≠",f:"üáÆüá™",c:"IE"}, {n:"Â∏åËáò",f:"üá¨üá∑",c:"GR"}, {n:"ÂúüËÄ≥ÂÖ∂",f:"üáπüá∑",c:"TR"}, {n:"‰øÑÁæÖÊñØ",f:"üá∑üá∫",c:"RU"}, {n:"ÁÉèÂÖãËò≠",f:"üá∫üá¶",c:"UA"}, {n:"Ê≥¢Ëò≠",f:"üáµüá±",c:"PL"}, {n:"Êç∑ÂÖã",f:"üá®üáø",c:"CZ"}, {n:"ÂåàÁâôÂà©",f:"üá≠üá∫",c:"HU"},
            {n:"ÁæÖÈ¶¨Â∞º‰∫û",f:"üá∑üá¥",c:"RO"}, {n:"‰øùÂä†Âà©‰∫û",f:"üáßüá¨",c:"BG"}, {n:"Â°ûÁàæÁ∂≠‰∫û",f:"üá∑üá∏",c:"RS"}, {n:"ÂÖãÁæÖÂüÉË•ø‰∫û",f:"üá≠üá∑",c:"HR"}, {n:"ÊñØÊ¥õ‰ºêÂÖã",f:"üá∏üá∞",c:"SK"}, {n:"ÊñØÊ¥õÁ∂≠Â∞º‰∫û",f:"üá∏üáÆ",c:"SI"},
            {n:"ÊÑõÊ≤ôÂ∞º‰∫û",f:"üá™üá™",c:"EE"}, {n:"ÊãâËÑ´Á∂≠‰∫û",f:"üá±üáª",c:"LV"}, {n:"Á´ãÈô∂ÂÆõ",f:"üá±üáπ",c:"LT"}, {n:"ÁôΩ‰øÑÁæÖÊñØ",f:"üáßüáæ",c:"BY"}, {n:"ÁõßÊ£ÆÂ†°",f:"üá±üá∫",c:"LU"}, {n:"Êë©Á¥çÂì•",f:"üá≤üá®",c:"MC"}, {n:"Ê¢µËíÇÂ≤°",f:"üáªüá¶",c:"VA"}, {n:"È¶¨Áàæ‰ªñ",f:"üá≤üáπ",c:"MT"},
            
            // --- Â§ßÊ¥ãÊ¥≤ ---
            {n:"Êæ≥Ê¥≤",f:"üá¶üá∫",c:"AU"}, {n:"Á¥êË•øËò≠",f:"üá≥üáø",c:"NZ"}, {n:"ÊñêÊøü",f:"üá´üáØ",c:"FJ"}, {n:"Â∑¥Â∏É‰∫ûÁ¥êÂπæÂÖß‰∫û",f:"üáµüá¨",c:"PG"}, {n:"Â∏õÁêâ",f:"üáµüáº",c:"PW"}, {n:"ÈóúÂ≥∂",f:"üá¨üá∫",c:"GU"},
            
            // --- ‰∏≠‰∫û/Ë•ø‰∫û (‰∏≠Êù±) ---
            {n:"Ê≤ôÁÉèÂú∞ÈòøÊãâ‰ºØ",f:"üá∏üá¶",c:"SA"}, {n:"ÈòøËÅØÈÖã",f:"üá¶üá™",c:"AE"}, {n:"‰ºäÊúó",f:"üáÆüá∑",c:"IR"}, {n:"‰ºäÊãâÂÖã",f:"üáÆüá∂",c:"IQ"}, {n:"‰ª•Ëâ≤Âàó",f:"üáÆüá±",c:"IL"}, {n:"Âç°ÈÅî",f:"üá∂üá¶",c:"QA"}, {n:"ÁßëÂ®ÅÁâπ",f:"üá∞üáº",c:"KW"},
            {n:"Á¥ÑÊó¶",f:"üáØüá¥",c:"JO"}, {n:"ÈªéÂ∑¥Â´©",f:"üá±üáß",c:"LB"}, {n:"ÈòøÊõº",f:"üá¥üá≤",c:"OM"}, {n:"ËëâÈñÄ",f:"üáæüá™",c:"YE"}, {n:"Â∑¥Êûó",f:"üáßüá≠",c:"BH"}, {n:"ÊïòÂà©‰∫û",f:"üá∏üáæ",c:"SY"}, {n:"‰∫ûÂ°ûÊãúÁÑ∂",f:"üá¶üáø",c:"AZ"}, {n:"ÂìàËñ©ÂÖã",f:"üá∞üáø",c:"KZ"}, {n:"ÁÉèËå≤Âà•ÂÖã",f:"üá∫üáø",c:"UZ"},
            
            // --- ÈùûÊ¥≤ ---
            {n:"ÂüÉÂèä",f:"üá™üá¨",c:"EG"}, {n:"ÂçóÈùû",f:"üáøüá¶",c:"ZA"}, {n:"Êë©Ê¥õÂì•",f:"üá≤üá¶",c:"MA"}, {n:"Â•àÂèäÂà©‰∫û",f:"üá≥üá¨",c:"NG"}, {n:"ËÇØ‰∫û",f:"üá∞üá™",c:"KE"}, {n:"Ë°£Á¥¢ÊØî‰∫û",f:"üá™üáπ",c:"ET"}, {n:"Ëø¶Á¥ç",f:"üá¨üá≠",c:"GH"},
            {n:"Âù¶Â∞öÂ∞º‰∫û",f:"üáπüáø",c:"TZ"}, {n:"ÈòøÁàæÂèäÂà©‰∫û",f:"üá©üáø",c:"DZ"}, {n:"Á™ÅÂ∞ºË•ø‰∫û",f:"üáπüá≥",c:"TN"}, {n:"ÁÉèÂπ≤ÈÅî",f:"üá∫üá¨",c:"UG"}, {n:"ÂñÄÈ∫•ÈöÜ",f:"üá®üá≤",c:"CM"}, {n:"Â°ûÂÖßÂä†Áàæ",f:"üá∏üá≥",c:"SN"}, {n:"Ë±°ÁâôÊµ∑Â≤∏",f:"üá®üáÆ",c:"CI"}, {n:"È¶¨ÈÅîÂä†ÊñØÂä†",f:"üá≤üá¨",c:"MG"}
        ];
        const DEFAULT_AVATAR = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23cccccc'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E`;
        let myChart = null;
        
        // --- Callbacks ---
        let sysConfirmCallback = null;
        let onAchievementClose = null;

        // --- Passcode Logic ---
        let passcodeBuffer = "";
        let passcodeMode = "UNLOCK"; // UNLOCK, SET, CONFIRM, DISABLE
        let tempPasscode = ""; // For confirmation step

        window.pressKey = function(num) {
            if (passcodeBuffer.length < 4) {
                passcodeBuffer += num;
                updateDots();
                if (passcodeBuffer.length === 4) {
                    setTimeout(checkPasscode, 100);
                }
            }
        };

        window.deleteKey = function() {
            passcodeBuffer = passcodeBuffer.slice(0, -1);
            updateDots();
        };
        
        window.cancelPasscode = function() {
            // Âè™ÊúâÂú®Ë®≠ÂÆöÊ®°Âºè‰∏ãÂèØ‰ª•ÂèñÊ∂àÔºåËß£ÈéñÊ®°Âºè‰∏ã‰∏çËÉΩÂèñÊ∂à
            if (passcodeMode === 'SET' || passcodeMode === 'CONFIRM' || passcodeMode === 'DISABLE') {
                 closeLockScreen();
                 // Â¶ÇÊûúÊòØÂèñÊ∂àË®≠ÂÆöÔºåÊääÈñãÈóúÂàáÂõûÂéüÊú¨ÁãÄÊÖã
                 const toggle = document.getElementById('passcode-toggle');
                 const hasPass = !!localStorage.getItem('cuteCumberPasscode');
                 if(toggle) toggle.checked = hasPass;
            }
        };

        function updateDots() {
            const dots = document.querySelectorAll('.lock-dot');
            dots.forEach((dot, idx) => {
                if (idx < passcodeBuffer.length) dot.classList.add('filled');
                else dot.classList.remove('filled');
            });
        }

        function showLockScreen(mode, title) {
            passcodeMode = mode;
            passcodeBuffer = "";
            updateDots();
            document.getElementById('lock-title').textContent = title;
            document.getElementById('lock-screen').classList.add('active');
            
            // ÊéßÂà∂ÂèñÊ∂àÊåâÈàïÈ°ØÁ§∫ (Ëß£ÈéñÊôÇ‰∏çËÉΩÂèñÊ∂à)
            const cancelBtn = document.querySelector('.key-btn.transparent'); 
            if(mode === 'UNLOCK') cancelBtn.style.visibility = 'hidden';
            else cancelBtn.style.visibility = 'visible';
        }

        function closeLockScreen() {
            document.getElementById('lock-screen').classList.remove('active');
            passcodeBuffer = "";
        }

        function checkPasscode() {
            const saved = localStorage.getItem('cuteCumberPasscode');
            
            if (passcodeMode === 'UNLOCK') {
                if (passcodeBuffer === saved) {
                    closeLockScreen();
                } else {
                    shakeLock();
                }
            } else if (passcodeMode === 'SET') {
                tempPasscode = passcodeBuffer;
                showLockScreen('CONFIRM', 'Ë´ãÂÜçÊ¨°Ëº∏ÂÖ•‰ª•Á¢∫Ë™ç');
            } else if (passcodeMode === 'CONFIRM') {
                if (passcodeBuffer === tempPasscode) {
                    localStorage.setItem('cuteCumberPasscode', passcodeBuffer);
                    closeLockScreen();
                    updatePasscodeUI();
                    showAlert('ÂØÜÁ¢ºÈéñÂ∑≤Ë®≠ÂÆöÔºÅ');
                } else {
                    showAlert('ÂØÜÁ¢º‰∏çÁõ∏Á¨¶ÔºåË´ãÈáçÊñ∞Ë®≠ÂÆö');
                    showLockScreen('SET', 'Ë®≠ÂÆöÊñ∞ÂØÜÁ¢º');
                }
            } else if (passcodeMode === 'DISABLE') {
                if (passcodeBuffer === saved) {
                    localStorage.removeItem('cuteCumberPasscode');
                    closeLockScreen();
                    updatePasscodeUI();
                    showAlert('ÂØÜÁ¢ºÈéñÂ∑≤ÈóúÈñâ');
                } else {
                    shakeLock();
                }
            }
        }

        function shakeLock() {
            const dots = document.getElementById('lock-dots');
            dots.style.animation = 'shake 0.3s';
            setTimeout(() => { 
                dots.style.animation = ''; 
                passcodeBuffer = ""; 
                updateDots(); 
            }, 300);
        }
        
        // UI Helpers
        window.togglePasscodeSwitch = function() {
            const toggle = document.getElementById('passcode-toggle');
            const hasPass = !!localStorage.getItem('cuteCumberPasscode');
            
            if (toggle.checked && !hasPass) {
                showLockScreen('SET', 'Ë®≠ÂÆöÊñ∞ÂØÜÁ¢º');
            } else if (!toggle.checked && hasPass) {
                showLockScreen('DISABLE', 'Ëº∏ÂÖ•ËàäÂØÜÁ¢º‰ª•ÈóúÈñâ');
            }
        };
        
        window.startChangePasscode = function() {
            showLockScreen('SET', 'Ë®≠ÂÆöÊñ∞ÂØÜÁ¢º');
        };

        function updatePasscodeUI() {
            const hasPass = !!localStorage.getItem('cuteCumberPasscode');
            const toggle = document.getElementById('passcode-toggle');
            const changeBtn = document.getElementById('btn-change-passcode');
            if(toggle) toggle.checked = hasPass;
            if(changeBtn) changeBtn.style.display = hasPass ? 'block' : 'none';
        }

        // --- Random Picker Logic ---
        window.rollTheDice = function() {
            if (actorProfiles.length === 0) {
                showAlert("Êî∂ËóèÊ´ÉÊòØÁ©∫ÁöÑÔºåÂÖàÊñ∞Â¢û‰∏ÄÈªûË≥áÊñôÂêßÔºÅ");
                return;
            }

            // ÈúáÂãïÂõûÈ•ã
            if(navigator.vibrate) navigator.vibrate(50);

            // Ê±∫ÂÆöÈ°ûÂûã (0: Actor, 1: Video)
            // Â¶ÇÊûúÂÆåÂÖ®Ê≤íÊúâÂΩ±ÁâáÔºåÂº∑Âà∂ÈÅ∏ Actor
            const allVideos = actorProfiles.flatMap(a => a.videos || []);
            let type = (Math.random() > 0.5 && allVideos.length > 0) ? 'video' : 'actor';

            const container = document.getElementById('random-result-container');
            const goBtn = document.getElementById('btn-random-go');
            let resultHtml = '';

            if (type === 'actor') {
                // Èö®Ê©üÈÅ∏‰∫∫
                const actor = actorProfiles[Math.floor(Math.random() * actorProfiles.length)];
                const img = actor.avatar || DEFAULT_AVATAR;
                resultHtml = `
                    <img src="${img}" style="width:100px; height:100px; border-radius:50%; object-fit:cover; margin:0 auto 15px auto; border:3px solid white; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
                    <div style="font-size:20px; font-weight:bold; color:var(--color-text);">${actor.name}</div>
                    <div style="font-size:13px; color:#888; margin-top:5px;">(‰∫∫Áâ©Ê™îÊ°à)</div>
                `;
                goBtn.onclick = () => {
                    closeRandomModal();
                    showDriverDetail(actor.id);
                };
            } else {
                // Èö®Ê©üÈÅ∏ÂΩ±Áâá
                // ÂÖàÈö®Ê©üÈÅ∏‰∏ÄÂÄãÊúâÂΩ±ÁâáÁöÑ‰∫∫Áâ©
                const actorsWithVideos = actorProfiles.filter(a => a.videos && a.videos.length > 0);
                const actor = actorsWithVideos[Math.floor(Math.random() * actorsWithVideos.length)];
                const video = actor.videos[Math.floor(Math.random() * actor.videos.length)];
                
                let imgHtml = '<div style="width:100%; height:120px; background:#eee; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:40px;">üé¨</div>';
                if(video.thumbnail) {
                    imgHtml = `<img src="${video.thumbnail}" style="width:100%; height:120px; object-fit:cover; border-radius:12px; border:1px solid #eee;">`;
                }

                resultHtml = `
                    ${imgHtml}
                    <div style="font-size:16px; font-weight:bold; color:var(--color-text); margin-top:15px; line-height:1.3;">${video.title}</div>
                    <div style="font-size:12px; color:var(--color-primary); margin-top:5px;">‰∏ªÊºî: ${actor.name}</div>
                `;
                goBtn.onclick = () => {
                    closeRandomModal();
                    // Áõ¥Êé•ÊâìÈñãÂΩ±ÁâáË©≥ÊÉÖ
                    // Ê≥®ÊÑèÔºöÈÄôË£°ÈúÄË¶ÅÂàáÊèõÂà∞Ë©≤‰∫∫Áâ©ÁöÑË©≥ÊÉÖÈ†ÅÔºå‰∏¶ÊâìÈñãÂΩ±Áâá Modal
                    showDriverDetail(actor.id);
                    setTimeout(() => {
                        openVideoDetail(actor.id, video.id);
                    }, 300);
                };
            }

            container.innerHTML = resultHtml;
            document.getElementById('random-modal').classList.add('active');
        };

        window.closeRandomModal = function() {
            document.getElementById('random-modal').classList.remove('active');
        };

        const ACHIEVEMENTS_DATA = [
            // Category A: Count (ÂñÆ‰∫∫ÂâØÊú¨)
            { id: 'count_1', icon: 'üê£', title: 'ÂàùÂá∫ËåÖÂª¨', desc: 'Áî®Êà∂È¶ñÊ¨°Á¥ÄÈåÑ', msg: 'Ê≠°Ëøé‰Ω†ÔºåËÄÅÂè∏Ê©ü„ÄÇ', type: 'count', thres: 1, category: 'A', catTitle: 'ÂñÆ‰∫∫ÂâØÊú¨' },
            { id: 'count_50', icon: 'üçº', title: 'È§äÊ®ÇÂ§ö', desc: 'Á¥ØË®àËá™ÊÖ∞ 50 Ê¨°', msg: 'ÊÅ≠ÂñúÔºå‰Ω†Â∑≤Á∂ìÁîüÁî¢‰∫Ü‰∏ÄÁì∂È§äÊ®ÇÂ§öÁöÑÈáè„ÄÇ', type: 'count', thres: 50, category: 'A', catTitle: 'ÂñÆ‰∫∫ÂâØÊú¨' },
            { id: 'count_100', icon: 'üßª', title: 'Ë°õÁîüÁ¥ôÊÆ∫Êâã', desc: 'Á¥ØË®àËá™ÊÖ∞ 100 Ê¨°', msg: 'Âú∞ÁêÉ‰∏äÁöÑÊ®πÊú®Ê≠£Âú®ÁÇ∫‰Ω†Âì≠Ê≥£„ÄÇ', type: 'count', thres: 100, category: 'A', catTitle: 'ÂñÆ‰∫∫ÂâØÊú¨' },
            { id: 'count_300', icon: '‚öíÔ∏è', title: 'ÊñØÂ∑¥ÈÅîÁöÑÈÄÜË•≤', desc: 'Á¥ØË®àËá™ÊÖ∞ 300 Ê¨°', msg: '300 ÁôºÁöÑÊÑèÂøóÔºÅ‰ªäÊôöÔºåÂ∫äÈÇä‰∏ÄÊà∞ÂÜçÊà∞ÔºÅ', type: 'count', thres: 300, category: 'A', catTitle: 'ÂñÆ‰∫∫ÂâØÊú¨' },
            { id: 'count_500', icon: 'ü§ñ', title: 'ÁÑ°ÊÉÖÁöÑÁôºÂ∞ÑÊ©üÂô®', desc: 'Á¥ØË®àËá™ÊÖ∞ 500 Ê¨°', msg: '‰Ω†Â∑≤Á∂ìÊ≤íÊúâÊÑüÊÉÖÔºåÂÖ®ÊòØÊäÄÂ∑ß„ÄÇ', type: 'count', thres: 500, category: 'A', catTitle: 'ÂñÆ‰∫∫ÂâØÊú¨' },
            { id: 'count_1000', icon: 'üí™', title: 'ÂÇ≥Ë™™‰∏≠ÁöÑÈ∫íÈ∫üËáÇ', desc: 'Á¥ØË®àËá™ÊÖ∞ 1000 Ê¨°', msg: '‰Ω†ÁöÑÊÖ£Áî®ÊâãÂ∑≤Á∂ìË∂ÖË∂ä‰∫Ü‰∫∫È°ûÊ•µÈôêÔºåÂèØ‰ª•ÊìäÁ©øÈãºÊùø‰∫ÜÂêßÔºü', type: 'count', thres: 1000, category: 'A', catTitle: 'ÂñÆ‰∫∫ÂâØÊú¨' },
            
            // Category B: Special Dates (ÁâπÂà•ÁöÑ‰∏ÄÂ§©)
            { id: 'special_bday', icon: 'üéÇ', title: 'Áç®Ëá™ÂêπË†üÁá≠', desc: 'ÁîüÊó•Áï∂Â§©Ëá™ÊÖ∞', msg: 'Ë®±ÂÄãÈ°òÂêß...ÁÑ∂ÂæåË¶™ÊâãÂØ¶ÁèæÂÆÉ„ÄÇÁ•ù‰Ω†ÁîüÊó•Âø´Ê®ÇÔºÅ', type: 'special', isBday: true, category: 'B', catTitle: 'ÁâπÂà•ÁöÑ‰∏ÄÂ§©' },
            { id: 'special_newyear', icon: 'üéÜ', title: 'Êê∂È†≠È¶ô', desc: 'Happy New Year„ÄÇ', msg: 'ÈõñÁÑ∂Ê≤íÊúâÁÖôÁÅ´Ôºå‰ΩÜ‰Ω†Ëá™Â∑±Êîæ‰∫Ü‰∏ÄÁôºÊÖ∂Á•ù„ÄÇÂ•ΩÁöÑÈñãÂßãÊòØÊàêÂäüÁöÑ‰∏ÄÂçäÔºü', type: 'special', date: '01-01', category: 'B', catTitle: 'ÁâπÂà•ÁöÑ‰∏ÄÂ§©' },
            { id: 'special_leap', icon: 'üó°Ô∏è', title: 'ÂõõÂπ¥Á£®‰∏ÄÂäç', desc: 'Âú® 2/29 Ëá™ÊÖ∞', msg: 'È§äÂÖµÂçÉÊó•ÔºåÁî®Âú®‰∏ÄÊôÇ„ÄÇÈÄô‰∏ÄÁôºÔºåË∑®Ë∂ä‰∫ÜÂ•ßÊûóÂåπÂÖãÁöÑÈÄ±Êúü„ÄÇ', type: 'special', date: '02-29', category: 'B', catTitle: 'ÁâπÂà•ÁöÑ‰∏ÄÂ§©' },
            { id: 'special_val', icon: 'üíî', title: 'Â≠§ÂÇ≤ÁöÑÁãº', desc: 'Âú®ÊÉÖ‰∫∫ÁØÄËá™ÊÖ∞', msg: 'ÈÄô‰∏ÄÂ§©ÔºåÊâãÊòØ‰Ω†ÊúÄÂ•ΩÁöÑÊÉÖ‰∫∫„ÄÇ', type:'special' , date:'02-14' , category:'B' , catTitle:'ÁâπÂà•ÁöÑ‰∏ÄÂ§©'},
            { id: 'special_halloween', icon: 'üéÉ', title: 'Ëê¨ËÅñÂ§úÁöÑÂ≠§Áç®', desc: 'Âú®Ëê¨ËÅñÁØÄËá™ÊÖ∞', msg: 'Áî®ÈõôÊâãÂ•ΩÂ•ΩÊêóËõã‰∏Ä‰∏ã„ÄÇ', type:'special' , date:'10-31' , category:'B' , catTitle:'ÁâπÂà•ÁöÑ‰∏ÄÂ§©'},
            { id: 'special_xmas', icon: 'üéÑ', title: 'ÁôΩËâ≤ËÅñË™ïÁØÄ', desc: 'Âú®ËÅñË™ïÁØÄ(Âπ≥ÂÆâÂ§ú)Ëá™ÊÖ∞', msg: 'Jingle bells, Jingle balls... Âç≥‰Ωø‰∏ç‰∏ãÈõ™Ôºå‰Ω†‰πüÂâµÈÄ†‰∫ÜËá™Â∑±ÁöÑÁæéÊôØ„ÄÇ', type: 'special', dates: ['12-24', '12-25'], category: 'B', catTitle: 'Â§©ÊôÇÂú∞Âà©' },
            { id: 'special_nye', icon: 'üßπ', title: 'Âπ¥ÁµÇÂ§ßÊéÉÈô§', desc: 'Âú®Ë∑®Âπ¥Â§úËá™ÊÖ∞', msg: 'ËàäÁöÑ‰∏çÂéªÔºåÊñ∞ÁöÑ‰∏ç‰æÜ„ÄÇÊää‰ªäÂπ¥ÁöÑÁÖ©ÊÉ±ÔºàÂíåÂ∫´Â≠òÔºâÈÄöÈÄöÊ∏ÖÁ©∫ÔºåÊ∫ñÂÇôËøéÊé•ÊòéÂπ¥ÂêßÔºÅ', type: 'special', date: '12-31', category: 'B', catTitle: 'ÁâπÂà•ÁöÑ‰∏ÄÂ§©' },

            // Category C: Abstinence (Ëã¶Ë°åÂÉßÊ®°Âºè)
            { id: 'abs_3', icon: 'ü§ê', title: 'Âøç‰∏ÄÊôÇÈ¢®Âπ≥Êµ™Èùú', desc: 'ÈÄ£Á∫å 3 Â§©Êú™Áôº', msg: 'Êâç‰∏âÂ§©ËÄåÂ∑≤Ôºå‰∏çË¶ÅÈú≤Âá∫ÈÇ£È∫ºÁóõËã¶ÁöÑË°®ÊÉÖ„ÄÇ', type: 'abs', thres: 3, category: 'C', catTitle: 'Ëã¶Ë°åÂÉßÊ®°Âºè' },
            { id: 'abs_5', icon: 'ü•õ', title: 'ÁÖâ‰π≥Â§ß‰∫®', desc: 'ÈÄ£Á∫å 5 Â§©Êú™Áôº', msg: '‰∫îÂ§©‰∫ÜÔºå‰Ω†ÁöÑÁâõÂ•∂ÊòØ‰∏çÊòØÂ∑≤Á∂ìÁ©çÊªø‰∫Ü', type: 'abs', thres: 5, category: 'C', catTitle: 'Ëã¶Ë°åÂÉßÊ®°Âºè' },
            { id: 'abs_7', icon: 'üßò', title: '‰∏ÄÈÄ±Á¶™Â∏´', desc: 'ÈÄ£Á∫å 7 Â§©Êú™Áôº', msg: '‰∏ÄÈÄ±Êú™ÁôºÔºå‰Ω†ÁöÑÊÑèÂøóÂäõÈñãÂßãÂ±ïÁèæ„ÄÇ', type: 'abs', thres: 7, category: 'C', catTitle: 'Ëã¶Ë°åÂÉßÊ®°Âºè' },
            { id: 'abs_14', icon: 'üßô', title: 'È≠îÊ≥ïÂ∏´Â≠∏Âæí', desc: 'ÈÄ£Á∫å 14 Â§©Êú™Áôº', msg: 'ÂÖ©ÈÄ±ÈÅîÊàêÔºÅÊìöË™™‰øùÊåÅÂà∞30Â§©Â∞±ËÉΩÊàêÁÇ∫È≠îÊ≥ïÂ∏´„ÄÇ', type: 'abs', thres: 14, category: 'C', catTitle: 'Ëã¶Ë°åÂÉßÊ®°Âºè' },
            { id: 'abs_30', icon: '‚ú®', title: 'Â§ßË≥¢ËÄÖ', desc: 'ÈÄ£Á∫å 30 Â§©Êú™Áôº', msg: '', type:'abs' , thres:'30' , category:'C' , catTitle:'Ëã¶Ë°åÂÉßÊ®°Âºè' },
            // Category D: Streak (ÁÅ´ÂäõÂÖ®Èñã)
            { id: 'streak_3', icon: 'üî•', title: '‰∏çÁü•Áñ≤ÂÄ¶', desc: 'ÈÄ£Á∫å 3 Â§©Á¥ÄÈåÑ', msg: 'ÈÄ£Á∫å‰∏âÂ§©ÔºåÁúã‰æÜÂ∞ç‰Ω†‰æÜË™™Â§™ÂÆπÊòì‰∫Ü„ÄÇ', type: 'streak', thres: 3, category: 'D', catTitle: 'ÁÅ´ÂäõÂÖ®Èñã' },
            { id: 'streak_5', icon: 'üêÇ', title: 'Á≤æÂäõÈÅéÂâ©', desc: 'ÈÄ£Á∫å 5 Â§©Á¥ÄÈåÑ', msg: 'ÈÄ±‰∏ÄÂà∞ÈÄ±‰∫îÂÖ®Âã§ÊâìÂç°ÔºåÈÄôÊØÖÂäõË¶ÅÊòØÁî®Âú®Â∑•‰Ωú‰∏äÂ∞±Â•Ω‰∫Ü„ÄÇ', type: 'streak', thres: 5, category: 'D', catTitle: 'ÁÅ´ÂäõÂÖ®Èñã' },
            { id: 'streak_7', icon: 'üé∏', title: 'Â§úÂ§úÁ¨ôÊ≠å', desc: 'ÈÄ£Á∫å 7 Â§©Á¥ÄÈåÑ', msg: '‰∏ÄÈÄ±‰∏ÉÂ§©ÁÑ°‰ºëÔºåË∫´È´îÊå∫‰∏çÈåØÁöÑÔºÅ', type: 'streak', thres: 7, category: 'D', catTitle: 'ÁÅ´ÂäõÂÖ®Èñã' },
            { id: 'streak_14', icon: 'üçå', title: '‰∫åÂë®ÁõÆ', desc: 'ÈÄ£Á∫å 14 Â§©Á¥ÄÈåÑ', msg: 'ÂÖ©ÈÄ±‰∫Ü... ÂÖÑÂºüÔºåË®òÂæóË£úÂÖÖÊ∞¥ÂàÜÔºåÂêÉÈªûÈ¶ôËïâÔºü', type: 'streak', thres: 14, category: 'D', catTitle: 'ÁÅ´ÂäõÂÖ®Èñã' },
            { id: 'streak_30', icon: 'üßë‚Äçüéì', title: 'ÂÖ®Âã§Áçé', desc: 'ÈÄ£Á∫å 30 Â§©Á¥ÄÈåÑ', msg: 'ÈÄ£Á∫å‰∏ÄÂÄãÊúàÔºüÔºÅÊÅ≠ÂñúÁç≤ÂæóÂÖ®Âã§ÁçéÔºÅ', type: 'streak', thres: 30, category: 'D', catTitle: 'ÁÅ´ÂäõÂÖ®Èñã' },

            // Category E: Human Connection (‰∫∫Ëàá‰∫∫ÁöÑÈÄ£Áµê) - NEW
            { id: 'sex_1', icon: 'ü§ì', title: 'Á§æ‰∫§Ê®°Âºè', desc: 'Á¥ØË®àÂÅöÊÑõ 1 Ê¨°', msg: '‰∫∫Ëàá‰∫∫ÁöÑÈÄ£ÁµêÂæû‰ªäÂ§©ÈñãÂßã„ÄÇ', type: 'sex_count', thres: 1, category: 'E', catTitle: '‰∫∫Ëàá‰∫∫ÁöÑÈÄ£Áµê' },
            { id: 'sex_10', icon: 'üî∞', title: 'ÂØ¶ÁøíÈßïÈßõ', desc: 'Á¥ØË®àÂÅöÊÑõ 10 Ê¨°', msg: 'Ë®òÂæóÁπ´Â•ΩÂÆâÂÖ®Â∏∂ÔºåÊ≥®ÊÑèË°åËªäÂÆâÂÖ®„ÄÇ', type: 'sex_count', thres: 10, category: 'E', catTitle: '‰∫∫Ëàá‰∫∫ÁöÑÈÄ£Áµê' },
            { id: 'sex_100', icon: '‚öîÔ∏è', title: 'Áôæ‰∫∫Êñ¨...ÂóéÔºü', desc: 'Á¥ØË®àÂÅöÊÑõ 100 Ê¨°', msg: 'Á¥ØÁ©ç‰∫Ü‰∏ÄÁôæÂ†¥Êà∞ÂΩπ„ÄÇ‰∏çÁÆ°Â∞çÊâãÊòØÂêå‰∏ÄÂÄãÈÇÑÊòØ‰∏ÄÁôæÂÄãÔºå‰Ω†ÈÉΩÊòØËã±ÈõÑ„ÄÇ', type: 'sex_count', thres: 100, category: 'E', catTitle: '‰∫∫Ëàá‰∫∫ÁöÑÈÄ£Áµê' },
            { id: 'sex_loyalty', icon: 'üê¥', title: 'Â∞àÊÉÖÁ®ÆÈ¶¨', desc: 'Á¥ØË®àËàáÂêå‰∏Ä‰ΩçÊÄßÂ§•‰º¥Ë∂ÖÈÅé 10 Ê¨°', msg: 'Âº±Ê∞¥‰∏âÂçÉÔºå‰Ω†Âè™Âèñ‰∏ÄÁì¢... ÁÑ∂ÂæåÁãÇÂñùÁåõÂñù„ÄÇÁúüÊÑõÁÑ°Ë™§ÔºÅ', type: 'sex_same_partner', thres: 11, category: 'E', catTitle: '‰∫∫Ëàá‰∫∫ÁöÑÈÄ£Áµê' },
            { id: 'sex_harem', icon: '‚è±Ô∏è', title: 'ÊôÇÈñìÁÆ°ÁêÜÂ§ßÂ∏´', desc: 'Á¥ØË®à 10 ‰Ωç‰∏çÂêåÁöÑÊÄßÂ§•‰º¥', msg: '‰Ω†ÁöÑÈÄöË®äÈåÑÊòØ‰∏çÊòØÂæàÁ≤æÂΩ©ÔºüË®òÂæó‰∏çË¶ÅÂè´ÈåØÂêçÂ≠óÔºåÈÄôÊòØÈÅé‰æÜ‰∫∫ÁöÑÂª∫Ë≠∞„ÄÇ', type: 'sex_unique_partners', thres: 10, category: 'E', catTitle: '‰∫∫Ëàá‰∫∫ÁöÑÈÄ£Áµê' },
            { id: 'sex_diplomat', icon: 'üåç', title: 'ÂúãÊ∞ëÂ§ñ‰∫§ÂÆò', desc: 'Á¥ØË®à 10 ÂÄã‰∏çÂêåÂúãÁ±çÁöÑÊÄßÂ§•‰º¥', msg: 'Ëá¥ÂäõÊñº‰øÉÈÄ≤Ë∑®ÂúãÊñáÂåñÁöÑ„ÄéÊ∑±ÂÖ•„Äè‰∫§ÊµÅÔºåË´æË≤ùÁàæÂíåÂπ≥ÁçéÊáâË©≤È†íÁµ¶‰Ω†„ÄÇ', type: 'sex_unique_nations', thres: 10, category: 'E', catTitle: '‰∫∫Ëàá‰∫∫ÁöÑÈÄ£Áµê' }
        ];

        // --- 2. Core Helper Functions (Moved to Global Scope) ---
        window.compressImage = function(f){return new Promise((res,rej)=>{const r=new FileReader();r.readAsDataURL(f);r.onload=e=>{const i=new Image();i.src=e.target.result;i.onload=()=>{const c=document.createElement('canvas');let w=i.width,h=i.height,m=600;if(w>h){if(w>m){h*=m/w;w=m;}}else{if(h>m){w*=m/h;h=m;}}c.width=w;c.height=h;const x=c.getContext('2d');x.drawImage(i,0,0,w,h);res(c.toDataURL('image/jpeg',0.6));};i.onerror=rej;};r.onerror=rej;});}
        window.setupImageUpload = function(id,pid,cb){const el=document.getElementById(id);if(el)el.addEventListener('change',async(e)=>{if(e.target.files[0]){try{const b64=await compressImage(e.target.files[0]);const p=document.getElementById(pid);p.src=b64;p.classList.add('show');if(cb)cb(b64);}catch(err){showAlert("ÂúñÁâáÂ§±Êïó");}}});}
        window.getNowInputValue = function(){const n=new Date();n.setMinutes(n.getMinutes()-n.getTimezoneOffset());return n.toISOString().slice(0,16);}
        window.getRelativeTime = function(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffInSeconds = Math.floor((now - past) / 1000);
            if (diffInSeconds < 60) return 'ÂâõÂâõ';
            const diffInMinutes = Math.floor(diffInSeconds / 60);
            if (diffInMinutes < 60) return `${diffInMinutes} ÂàÜÈêòÂâç`;
            const diffInHours = Math.floor(diffInMinutes / 60);
            if (diffInHours < 24) return `${diffInHours} Â∞èÊôÇÂâç`;
            const diffInDays = Math.floor(diffInHours / 24);
            if (diffInDays < 7) return `${diffInDays} Â§©Ââç`;
            return past.toLocaleDateString();
        }

        // --- 3. System Modal Functions (Global) ---
        window.showAlert = function(msg) {
            document.getElementById('sys-title').textContent = "ÊèêÁ§∫";
            document.getElementById('sys-msg').textContent = msg;
            const acts = document.getElementById('sys-actions');
            acts.innerHTML = `<button class="btn-base btn-primary" onclick="closeSystemModal()" style="flex:1">Á¢∫ÂÆö</button>`;
            document.getElementById('system-modal').classList.add('active');
        }

        window.showConfirm = function(msg, onYes) {
            document.getElementById('sys-title').textContent = "Á¢∫Ë™ç";
            document.getElementById('sys-msg').textContent = msg;
            const acts = document.getElementById('sys-actions');
            sysConfirmCallback = onYes;
            acts.innerHTML = `<button class="btn-base" onclick="closeSystemModal()" style="background:#eee;color:#666;flex:1">ÂèñÊ∂à</button><button class="btn-base btn-danger" onclick="confirmSystemModal()" style="flex:1">Á¢∫ÂÆö</button>`;
            document.getElementById('system-modal').classList.add('active');
        }

        window.confirmSystemModal = function() {
            const cb = sysConfirmCallback;
            // Clear callback first
            sysConfirmCallback = null; 
            closeSystemModal();
            // Use setTimeout to ensure the first modal closes before any new action
            if(cb) setTimeout(cb, 100); 
        }

        window.closeSystemModal = function() {
            document.getElementById('system-modal').classList.remove('active');
        }

        // --- 4. Data Logic & Saving (Global) ---
        window.loadAllData = function() {
            try { ejaculationRecords = JSON.parse(localStorage.getItem(RECORD_KEY)) || []; } catch(e) { ejaculationRecords = []; }
            try { actorProfiles = JSON.parse(localStorage.getItem(ACTOR_KEY)) || []; } catch(e) { actorProfiles = []; }
            try { partnerProfiles = JSON.parse(localStorage.getItem(PARTNER_KEY)) || []; } catch(e) { partnerProfiles = []; }
            try { 
                let rawAch = JSON.parse(localStorage.getItem(ACH_KEY));
                if (rawAch && rawAch.length > 0 && typeof rawAch[0] === 'string') {
                    unlockedAchievements = rawAch.map(id => ({ id: id, date: 'Êú™Áü•Êó•Êúü' }));
                    saveAchData();
                } else {
                    unlockedAchievements = rawAch || [];
                }
            } catch(e) { unlockedAchievements = []; }
            try { userProfile = JSON.parse(localStorage.getItem(PROFILE_KEY)) || { nickname: '', birthday: '' }; } catch(e) { userProfile = { nickname: '', birthday: '' }; }
            
            const savedDarkMode = localStorage.getItem('cuteCumberDarkMode');
            const toggleEl = document.getElementById('dark-mode-toggle');
            if (savedDarkMode === 'true') {
                document.body.classList.add('dark-mode');
                if(toggleEl) toggleEl.checked = true;
            } else {
                document.body.classList.remove('dark-mode');
                if(toggleEl) toggleEl.checked = false;
            }
            updateProfileUI();
            updateLocationSuggestions();
            updatePasscodeUI();
            // Â¶ÇÊûúÊúâË®≠ÂØÜÁ¢ºÔºåÂïüÂãïÊôÇÈéñÂÆö
            if (localStorage.getItem('cuteCumberPasscode')) {
                showLockScreen('UNLOCK', 'Ë´ãËº∏ÂÖ•ÂØÜÁ¢º');
            }
        }
        function saveRecordData() { 
            localStorage.setItem(RECORD_KEY, JSON.stringify(ejaculationRecords)); 
            updateLocationSuggestions();
        }
        function saveActorData() { localStorage.setItem(ACTOR_KEY, JSON.stringify(actorProfiles)); }
        function savePartnerData() { localStorage.setItem(PARTNER_KEY, JSON.stringify(partnerProfiles)); }
        function saveAchData() { localStorage.setItem(ACH_KEY, JSON.stringify(unlockedAchievements)); }
        
        window.saveUserProfile = function() {
            userProfile.nickname = document.getElementById('setting-nickname').value;
            userProfile.birthday = document.getElementById('setting-birthday').value;
            localStorage.setItem(PROFILE_KEY, JSON.stringify(userProfile));
            updateProfileUI();
            checkAchievements();
            showAlert('ÂÄã‰∫∫Ë≥áÊñôÂ∑≤Êõ¥Êñ∞');
        }

        window.updateLocationSuggestions = function() {
            const listObj = document.getElementById('location-list');
            if (!listObj) return;
            
            // 1. Áµ±Ë®àÊâÄÊúâÂú∞ÈªûÂá∫ÁèæÊ¨°Êï∏
            const locationCounts = {};
            ejaculationRecords.forEach(r => {
                if (r.location) {
                    const loc = r.location.trim();
                    if (loc) locationCounts[loc] = (locationCounts[loc] || 0) + 1;
                }
            });

            // 2. ËΩâÁÇ∫Èô£Âàó‰∏¶‰æùÁÖßÈ†ªÁéáÊéíÂ∫è (Áî±È´òÂà∞‰Ωé)
            const sortedLocations = Object.keys(locationCounts).sort((a, b) => locationCounts[b] - locationCounts[a]);

            // 3. Âä†ÂÖ•È†êË®≠ÈÅ∏È†Ö (Â¶ÇÊûúÊ≠∑Âè≤Á¥ÄÈåÑÊ≤íÊúâÔºåÁ¢∫‰øùÊúâÂü∫Êú¨ÈÅ∏È†Ö)
            const defaultLocs = ['Ëá•ÂÆ§', 'ÂªÅÊâÄ', 'Êµ¥ÂÆ§', 'È£ØÂ∫ó'];
            defaultLocs.forEach(d => {
                if (!sortedLocations.includes(d)) sortedLocations.push(d);
            });

            // 4. Ê∏≤ÊüìÂà∞ datalist
            listObj.innerHTML = sortedLocations.map(loc => `<option value="${loc}"></option>`).join('');
        };

        function updateProfileUI() {
            const greeting = userProfile.nickname ? `HelloÔºå${userProfile.nickname}` : `HelloÔºåÂ∏•Âì•`;
            document.getElementById('welcome-text').textContent = greeting;
            document.getElementById('setting-nickname').value = userProfile.nickname || '';
            document.getElementById('setting-birthday').value = userProfile.birthday || '';
        }

        window.toggleDarkMode = function() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('cuteCumberDarkMode', isDark);
            if(document.getElementById('stats-view-charts').style.display === 'block') {
                calculateStats(); // Redraw chart
            }
        }

        // --- 5. Stats & Charts (Global) ---
        function renderChart(data) { 
            const ctx = document.getElementById('weeklyChart').getContext('2d'); 
            if (myChart) myChart.destroy(); 
            // Detect dark mode from body class
            const isDark = document.body.classList.contains('dark-mode');
            const tickColor = isDark ? '#cccccc' : '#666666';
            const gridColor = isDark ? '#444444' : '#eeeeee';
            myChart = new Chart(ctx, { 
                type: 'bar', 
                data: { 
                    labels: ['ÈÄ±Êó•', 'ÈÄ±‰∏Ä', 'ÈÄ±‰∫å', 'ÈÄ±‰∏â', 'ÈÄ±Âõõ', 'ÈÄ±‰∫î', 'ÈÄ±ÂÖ≠'], 
                    datasets: [{ data: data, backgroundColor: 'rgba(118, 200, 70, 0.8)', borderColor: '#76C846', borderWidth: 1, borderRadius: 4 }] 
                }, 
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1, color: tickColor }, grid: { color: gridColor } }, x: { grid: { display: false }, ticks: { color: tickColor } } } } 
            }); 
        }

        window.calculateStats = function() {
            // 1. Á©∫Ë≥áÊñôÊ™¢Êü•
            if (ejaculationRecords.length === 0) { 
                document.getElementById('stats-empty').style.display = 'block'; 
                document.getElementById('stats-content').style.display = 'none'; 
                return; 
            } else { 
                document.getElementById('stats-empty').style.display = 'none'; 
                document.getElementById('stats-content').style.display = 'block'; 
            }

            // 2. Ë≥áÊñôÊéíÂ∫è (Ëàä -> Êñ∞)
            const sorted = [...ejaculationRecords].sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            // 3. Âü∫Á§éË®àÊï∏
            document.getElementById('stat-total').textContent = sorted.length;
            const countM = sorted.filter(r => r.type === 'Ëá™ÊÖ∞').length;
            const countS = sorted.filter(r => r.type === 'ÂÅöÊÑõ').length;
            const countW = sorted.filter(r => r.type === 'Â§¢ÈÅ∫').length;
            document.getElementById('stat-type-m').textContent = countM;
            document.getElementById('stat-type-s').textContent = countS;
            document.getElementById('stat-type-w').textContent = countW;
            // Áπ™Ë£ΩÂúãÊ∞ëÂ§ñ‰∫§Âú∞Âúñ
            setTimeout(() => {
                if(window.renderDiplomacyMap) window.renderDiplomacyMap();
            }, 100);
            // 4. ‰ªäÂπ¥Á¥ØÁ©ç
            const thisYearStr = new Date().getFullYear().toString();
            document.getElementById('stat-year').textContent = sorted.filter(r => r.timestamp.startsWith(thisYearStr)).length;
            
            // 5. Ê≠∑Âè≤ÊúÄÈï∑ÈÄ£Êìä
            const sortedDatesAsc = [...new Set(sorted.map(r => r.timestamp.split('T')[0]))].sort((a, b) => a.localeCompare(b));
            let maxStreak = 0;
            let tempStreak = 0;
            if (sortedDatesAsc.length > 0) {
                maxStreak = 1; tempStreak = 1;
                for(let i = 1; i < sortedDatesAsc.length; i++) {
                    const prev = new Date(sortedDatesAsc[i-1]);
                    const curr = new Date(sortedDatesAsc[i]);
                    const diffDays = Math.round((curr - prev) / (1000 * 60 * 60 * 24));
                    if (diffDays === 1) tempStreak++;
                    else tempStreak = 1;
                    if (tempStreak > maxStreak) maxStreak = tempStreak;
                }
            }
            document.getElementById('stat-streak').textContent = maxStreak;

            // 6. ÊúÄÈï∑Á¶ÅÊÖæ (‚ú® V5 Êñ∞Âπ¥ÁâπËµ¶ÁâàÔºö2026Ëµ∑ÁÆóÔºå‰ø°‰ªªÂπ¥ÂàùË£úÁôª ‚ú®)
            let maxAbstinence = 0;
            const DAY_MS = 1000 * 60 * 60 * 24;
            
            if (sorted.length > 1) {
                for (let i = 0; i < sorted.length - 1; i++) {
                    const older = sorted[i];
                    const newer = sorted[i+1];
                    const gapDays = (new Date(newer.timestamp) - new Date(older.timestamp)) / DAY_MS;

                    // ÂèñÂæóÂπ¥‰ªΩËàáË£úÁôªÁãÄÊÖã
                    const olderYear = new Date(older.timestamp).getFullYear();
                    const isOlderBackfill = Math.abs(older.id - new Date(older.timestamp).getTime()) > DAY_MS;

                    // ÈÇèËºØ‰øÆÊ≠£Ôºö
                    // 1. Â¶ÇÊûúÊòØ 2025 (Âê´) ‰ª•ÂâçÁöÑÁ¥ÄÈåÑ -> ‰∏ÄÂæã‰∏çË®àÁÆó (ÂàáÂâ≤ÈÅéÂéª)
                    // 2. Â¶ÇÊûúÊòØ 2026 (Âê´) ‰ª•ÂæåÁöÑÁ¥ÄÈåÑ -> ÂÖ®ÈÉ®‰ø°‰ªªÔºÅ(ÂåÖÂê´ÊÇ® 1/1-1/9 ÁöÑË£úÁôª)
                    
                    if (olderYear >= 2026) {
                        // 2026 Êñ∞ÊôÇ‰ª£Ôºö‰ø°‰ªªÊâÄÊúâË≥áÊñô
                        if (gapDays > maxAbstinence) maxAbstinence = gapDays;
                    } else {
                        // ËàäÊôÇ‰ª£ÔºöÂè™ÊúâÈùûË£úÁôªÁöÑÊâçÁÆó (‰ΩÜÂü∫Êú¨‰∏äÊÇ®Â∏åÊúõËàäÁöÑÈÉΩ‰∏çË¶ÅÁÆóÔºåÊâÄ‰ª•ÈÄôË£°ÊúÉËá™ÁÑ∂ÈÅéÊøæÊéâÊñ∑Â±§)
                        if (!isOlderBackfill) {
                           if (gapDays > maxAbstinence) maxAbstinence = gapDays;
                        }
                    }
                }
            }
            
            // Ë®àÁÆó„ÄåÊúÄÂæå‰∏ÄÊ¨°Âà∞ÁèæÂú®„Äç
            if (sorted.length > 0) {
                const lastRec = sorted[sorted.length-1];
                const lastDate = new Date(lastRec.timestamp);
                const lastYear = lastDate.getFullYear();
                const now = new Date();
                const diffCurrent = (now - lastDate) / DAY_MS;
                const isLastBackfill = Math.abs(lastRec.id - lastDate.getTime()) > DAY_MS;
                
                // ÂêåÊ®£ÈÇèËºØÔºö2026 Âπ¥‰ª•ÂæåÁöÑÊúÄÂæå‰∏ÄÁ≠ÜÔºåÂ∞±ÁÆóÊòØË£úÁôªÁöÑ‰πüÁÆóÊúâÊïàÁ¶ÅÊÖæ
                if (lastYear >= 2026) {
                    if (diffCurrent > maxAbstinence) maxAbstinence = diffCurrent;
                } else {
                    if (!isLastBackfill) {
                        if (diffCurrent > maxAbstinence) maxAbstinence = diffCurrent;
                    }
                }
            }
            document.getElementById('stat-abstinence').textContent = Math.floor(maxAbstinence);

            // 7. ÂúñË°®ËàáÂÖ∂‰ªñ
            const counts = [0,0,0,0,0,0,0]; 
            sorted.forEach(r => {
                const day = new Date(r.timestamp).getDay();
                counts[day]++;
            }); 
            renderChart(counts);

            const yearlyCounts = {}; 
            sorted.forEach(r => { 
                const y = r.timestamp.substring(0, 4);
                yearlyCounts[y] = (yearlyCounts[y] || 0) + 1; 
            });
            const yearlyArray = Object.keys(yearlyCounts).map(y => ({ year: y, count: yearlyCounts[y] })); 
            yearlyArray.sort((a, b) => b.year - a.year);
            
            const maxYearCount = Math.max(...yearlyArray.map(y => y.count), 1);
            const yList = document.getElementById('yearly-list'); 
            yList.innerHTML = '';
            yearlyArray.forEach(item => { 
                const percentage = (item.count / maxYearCount) * 100; 
                const div = document.createElement('div'); 
                div.className = 'year-item'; 
                div.innerHTML = `<div class="year-info"><span>${item.year}Âπ¥</span><span>${item.count} Ê¨°</span></div><div class="year-bar-bg"><div class="year-bar-fill" style="width: ${percentage}%"></div></div>`; 
                yList.appendChild(div); 
            });
            
            calculateFavorites(); 
        }
        // --- Google Map Logic (‰øÆÂæ©Áâà) ---
        let isGoogleChartsLoaded = false;
        try {
            google.charts.load('current', {
                'packages':['geochart'],
            });
            google.charts.setOnLoadCallback(() => { 
                isGoogleChartsLoaded = true; 
                // Â¶ÇÊûúËºâÂÖ•ÂÆåÊàêÊôÇÔºå‰ΩøÁî®ËÄÖÂâõÂ•ΩÂú®Êï∏ÊìöÈ†ÅÔºåÂ∞±È†Ü‰æøÁï´‰∏Ä‰∏ã
                if(document.getElementById('stats').classList.contains('active')) {
                    setTimeout(window.renderDiplomacyMap, 100);
                }
            });
        } catch(e) { console.log('Google Charts blocked'); }
        // --- Âú∞ÂúñÁ∏ÆÊîæÊéßÂà∂ÈÇèËºØ ---
        let currentMapScale = 1;

        window.updateMapZoom = function(delta) {
            // 1. Ë®àÁÆóÊñ∞ÁöÑÁ∏ÆÊîæÊØî‰æã (ÈôêÂà∂Âú® 1ÂÄç ~ 4ÂÄç ‰πãÈñì)
            currentMapScale += delta;
            if (currentMapScale < 1) currentMapScale = 1;
            if (currentMapScale > 4) currentMapScale = 4;

            // 2. Ë™øÊï¥Âú∞ÂúñÂÆπÂô®ÁöÑÂØ¶ÈöõÂ§ßÂ∞è (ÁôæÂàÜÊØî)
            const mapDiv = document.getElementById('diplomacy-map');
            if (mapDiv) {
                mapDiv.style.width = (currentMapScale * 100) + '%';
                mapDiv.style.height = (currentMapScale * 100) + '%';
            }

            // 3. Âº∑Âà∂ÈáçÁπ™Âú∞Âúñ (ËÆì Google Chart ÈÅ©ÊáâÊñ∞ÁöÑÂ§ßÂ∞èÔºå‰øùÊåÅÊ∏ÖÊô∞Â∫¶)
            if (window.renderDiplomacyMap) {
                window.renderDiplomacyMap();
            }
        };
        window.renderDiplomacyMap = function() {
            // 1. Âü∫Êú¨Ê™¢Êü•
            if (!isGoogleChartsLoaded || !window.partnerProfiles) return;
            
            // 2. Ê™¢Êü•ÂÆπÂô®ÊòØÂê¶ÂèØË¶ã (ÈóúÈçµ‰øÆÂæ©ÔºöÂ¶ÇÊûúÂú®Èö±ËóèÁãÄÊÖã‰∏ãÁπ™Ë£ΩÊúÉËÆäÁ©∫ÁôΩ)
            const mapContainer = document.getElementById('diplomacy-map');
            if (!mapContainer || mapContainer.offsetParent === null) return;

            // 3. Áµ±Ë®àÂêÑÂúã‰∫∫Êï∏ (ËΩâÊèõÁÇ∫ ISO ‰ª£Á¢º)
            const nationCounts = {};
            let hasData = false;

            partnerProfiles.forEach(p => {
                if (p.nation && p.nation.n) {
                    const name = p.nation.n;
                    const match = COUNTRY_LIST.find(country => country.n === name);
                    let code = match ? match.c : name;
                    if (name === 'Âè∞ÁÅ£') code = 'TW'; 
                    
                    nationCounts[code] = (nationCounts[code] || 0) + 1;
                    hasData = true;
                }
            });

            // 4. Ê∫ñÂÇôÊï∏Êìö
            const dataArray = [['Country', 'Partners']];
            Object.keys(nationCounts).forEach(code => {
                dataArray.push([code, nationCounts[code]]);
            });

            // Â¶ÇÊûúÂÆåÂÖ®Ê≤íË≥áÊñôÔºåÂ∞±‰∏çË¶ÅÁï´ÔºåÊàñËÄÖÁï´Á©∫Âú∞Âúñ
            // Google Charts Ëá≥Â∞ëÈúÄË¶Å Header row
            
            const data = google.visualization.arrayToDataTable(dataArray);

            const options = {
                backgroundColor: '#ffffff', 
                datalessRegionColor: '#f5f5f5',
                defaultColor: '#f5f5f5',
                colorAxis: {colors: ['#F8BBD0', '#E91E63']}, 
                tooltip: {textStyle: {color: '#333'}, showColorCode: true},
                legend: 'none',
                displayMode: 'regions', 
                keepAspectRatio: true,
                // ‰øÆÂæ©ÔºöÂä†‰∏ä width/height '100%' Á¢∫‰øùÂ°´Êªø
                width: '100%',
                height: '100%'
            };

            const chart = new google.visualization.GeoChart(mapContainer);
            chart.draw(data, options);
        };

        // ÂÑ™ÂåñË∑≥ËΩâÈÇèËºØ (Ëß£Ê±∫Êï∏ÊìöÈ†ÅÈªûÊìäÁÑ°ÂèçÊáâ)
        window.jumpToTarget = function(target) {
            // 1. ÈóúÈñâÊâÄÊúâ Modal
            closeDetailModal(); 
            document.getElementById('achievement-modal').classList.remove('active');
            
            // 2. ÂàáÊèõÂà∞Â∫ïÈÉ® "Driver" ÂàÜÈ†Å
            const driverTab = document.querySelector('.tab-item[data-target="driver"]');
            if(driverTab) driverTab.click();
            
            // 3. Âª∂ÈÅ≤Âü∑Ë°åÔºåÁ≠âÂæÖ Tab ÂàáÊèõÂãïÁï´ÂÆåÊàê
            setTimeout(() => {
                if (target.type === 'partner') {
                    // ÂàáÊèõÂà∞ÊÄßÂ§•‰º¥Ê®°Âºè -> ÊâìÈñãË©≥ÊÉÖ
                    if(window.switchDriverMode) window.switchDriverMode('partner');
                    setTimeout(() => {
                        if(window.showPartnerDetail) window.showPartnerDetail(target.name);
                    }, 50);
                    
                } else if (target.type === 'actor') {
                    // ÂàáÊèõÂà∞Èõ≤Á´ØÊÉÖ‰∫∫Ê®°Âºè -> ÊâìÈñãË©≥ÊÉÖ
                    if(window.switchDriverMode) window.switchDriverMode('actor');
                    setTimeout(() => {
                        if(window.showDriverDetail) showDriverDetail(target.id);
                    }, 50);
                    
                } else if (target.type === 'video') {
                    // ÂàáÊèõÂà∞Èõ≤Á´ØÊÉÖ‰∫∫Ê®°Âºè -> ÊâìÈñãË©≥ÊÉÖ -> ÊâìÈñãÂΩ±Áâá
                    if(window.switchDriverMode) window.switchDriverMode('actor');
                    setTimeout(() => {
                        if(window.showDriverDetail) showDriverDetail(target.parentId);
                        setTimeout(() => {
                            if(window.openVideoDetail) openVideoDetail(target.parentId, target.id);
                        }, 300); // Á≠âÂæÖË©≥ÊÉÖÈ†ÅÊ∏≤Êüì
                    }, 50);
                }
            }, 100);
        };
        function calculateFavorites() {
            // Êñ∞ÁâàÁµ±Ë®àÈÇèËºØÔºöÂêåÊôÇÊîØÊè¥Â§ö‰ΩçÊºîÂì° + ÂΩ±Áâá + ÊÄßÂ§•‰º¥
            const actorCounts = {}; 
            const videoCounts = {};
            const partnerCounts = {}; // Êñ∞Â¢ûÔºöÊÄßÂ§•‰º¥Ë®àÊï∏

            ejaculationRecords.forEach(r => {
                // 1. Áµ±Ë®àÊÄßÂ§•‰º¥
                if (r.partners && Array.isArray(r.partners)) {
                    r.partners.forEach(p => {
                        partnerCounts[p.name] = (partnerCounts[p.name] || 0) + 1;
                    });
                }

                // 2. Áµ±Ë®àÊºîÂì°ËàáÂΩ±Áâá (ÂéüÊú¨ÁöÑÈÇèËºØ)
                const relatedActorIds = new Set();
                if (r.usedActors && r.usedActors.length > 0) {
                    r.usedActors.forEach(a => relatedActorIds.add(a.id));
                }
                if (r.usedVideo) {
                    videoCounts[r.usedVideo.id] = (videoCounts[r.usedVideo.id] || 0) + 1;
                    if (r.usedVideo.parentId) relatedActorIds.add(r.usedVideo.parentId);
                }
                if (r.target) {
                    if (r.target.type === 'actor') {
                        relatedActorIds.add(r.target.id);
                    } else if (r.target.type === 'video') {
                        videoCounts[r.target.id] = (videoCounts[r.target.id] || 0) + 1;
                        if (r.target.parentId) relatedActorIds.add(r.target.parentId);
                    }
                }
                relatedActorIds.forEach(id => {
                    actorCounts[id] = (actorCounts[id] || 0) + 1;
                });
            });

            // --- Êï¥ÁêÜË≥áÊñô ---

            // A. ÊÄßÂ§•‰º¥ÊéíË°åÊ¶ú
            const partnerStats = [];
            Object.keys(partnerCounts).forEach(name => {
                // ÂòóË©¶Âæû partnerProfiles ÊâæÈ†≠ÂÉè
                const profile = partnerProfiles.find(p => p.name === name);
                const count = partnerCounts[name];
                
                // üí° ÈÅéÊøæÈÇèËºØÔºöÂ¶ÇÊûúÊÇ®Ë¶∫Âæó„ÄåÂè™Á¥Ñ1Ê¨°„ÄçÁöÑÊ≤íÊÑèÁæ©ÔºåÂèØ‰ª•Âú®ÈÄôË£°Êää‰∏ã‰∏ÄË°åËß£ÈñãË®ªËß£Ôºö
                // if (count < 2) return; 

                partnerStats.push({
                    data: { name: name }, // ÂÇ≥ÈÅûÂêçÂ≠ó‰æõË∑≥ËΩâ‰ΩøÁî®
                    type: 'partner',
                    count: count,
                    name: name,
                    img: (profile && profile.photo) ? profile.photo : "" // Â¶ÇÊûúÊúâÊ™îÊ°àÂ∞±Áî®ÁÖßÁâá
                });
            });

            // B. ÊºîÂì°ÊéíË°åÊ¶ú
            const actorsStats = [];
            actorProfiles.forEach(a => {
                const count = actorCounts[a.id] || 0;
                if (count > 0) {
                    actorsStats.push({ 
                        data: a, type: 'actor', count: count, name: a.name, img: a.avatar || DEFAULT_AVATAR 
                    });
                }
            });

            // C. ÂΩ±ÁâáÊéíË°åÊ¶ú
            const videosStats = [];
            actorProfiles.forEach(a => {
                if (a.videos) {
                    a.videos.forEach(v => {
                        const vCount = videoCounts[v.id] || 0;
                        if (vCount > 0) {
                            videosStats.push({ 
                                data: { ...v, parentId: a.id }, type: 'video', count: vCount, name: v.title, img: v.thumbnail || "" 
                            });
                        }
                    });
                }
            });

            // ÊéíÂ∫è (Ê¨°Êï∏Â§ö -> Â∞ë)
            partnerStats.sort((a,b) => b.count - a.count);
            actorsStats.sort((a,b) => b.count - a.count);
            videosStats.sort((a,b) => b.count - a.count);

            // Ê∏≤Êüì
            renderRankList('top-partners-list', partnerStats); // Êñ∞Â¢û
            renderRankList('top-actors-list', actorsStats);
            renderRankList('top-videos-list', videosStats);
        }
        function renderRankList(containerId, list) {
            const el = document.getElementById(containerId);
            el.innerHTML = '';
            if (list.length === 0) {
                el.innerHTML = '<div style="color:#999;font-size:13px;text-align:center;padding:10px;">Â∞öÁÑ°Ë≥áÊñô</div>';
                return;
            }

            const max = list[0].count;
            // È†êË®≠È°ØÁ§∫Ââç 5 Á≠Ü
            const initialShow = list.slice(0, 5);
            const hiddenItems = list.slice(5);

            initialShow.forEach((item, idx) => {
                el.appendChild(createRankItem(item, idx, max));
            });

            if (hiddenItems.length > 0) {
                const btn = document.createElement('button');
                btn.className = 'btn-show-more';
                btn.textContent = `üîΩ È°ØÁ§∫ÂÖ®ÈÉ® (ÈÇÑÊúâ ${hiddenItems.length} ‰Ωç)`;
                btn.onclick = () => {
                    hiddenItems.forEach((item, idx) => {
                        // idx + 5 Âõ†ÁÇ∫ÊòØÊé•Á∫åÁöÑÊéíÂêç
                        el.appendChild(createRankItem(item, idx + 5, max));
                    });
                    btn.remove(); // ÁßªÈô§ÊåâÈàï
                };
                el.appendChild(btn); // ÊåâÈàïÊîæÂú®ÊúÄÂæå
            }
        }

        function createRankItem(item, idx, max) {
            const div = document.createElement('div');
            div.className = 'rank-item';
            // ‰øÆÊ≠£ÔºöÂä†ÂÖ• name ÂèÉÊï∏ÔºåËÆìÊÄßÂ§•‰º¥Ë∑≥ËΩâËÉΩÊäìÂà∞ÂêçÂ≠ó
            div.onclick = () => jumpToTarget({ 
                type: item.type, 
                id: item.data.id, 
                parentId: item.data.parentId,
                name: item.data.name // ÈóúÈçµÔºöÂÇ≥ÈÅûÂêçÂ≠ó
            });
            
            const rankClass = idx < 3 ? `top-${idx+1}` : '';
            const imgClass = item.type === 'video' ? 'video-type' : '';
            const imgHtml = item.img ? `<img src="${item.img}" class="rank-img ${imgClass}">` : `<div class="rank-img ${imgClass}" style="background:#eee;display:flex;align-items:center;justify-content:center;">${item.type==='actor'?'üë§':'üé¨'}</div>`;
            const percent = (item.count / max) * 100;

            div.innerHTML = `
                <div class="rank-num ${rankClass}">${idx + 1}</div>
                ${imgHtml}
                <div class="rank-info">
                    <div class="rank-name">${item.name}</div>
                    <div class="rank-bar-bg"><div class="rank-bar-fill" style="width:${percent}%"></div></div>
                </div>
                <div class="rank-count">${item.count}Ê¨°</div>
            `;
            return div;
        }

        window.switchStatsView = function(view) {
            const c = document.getElementById('stats-view-charts');
            const a = document.getElementById('stats-view-achievements');
            const btns = document.querySelectorAll('.stats-toggle-container .toggle-btn');
            if(view==='charts'){
                c.style.display='block'; a.style.display='none';
                btns[0].classList.add('active'); btns[1].classList.remove('active');
                calculateStats();
            } else {
                c.style.display='none'; a.style.display='block';
                btns[0].classList.remove('active'); btns[1].classList.add('active');
                renderAchievements();
            }
        };

        window.goToSettings = function() {
            document.querySelectorAll('section.active').forEach(el => el.classList.remove('active'));
            document.getElementById('settings').classList.add('active');
            document.body.classList.add('hide-tabs');
        };

        window.exitSettings = function() {
            document.getElementById('settings').classList.remove('active');
            document.getElementById('home').classList.add('active');
            document.body.classList.remove('hide-tabs');
            updateHomeDisplay();
        };

        window.exportData = function() {
            const data = {
                records: ejaculationRecords,
                actors: actorProfiles,
                achievements: unlockedAchievements,
                profile: userProfile,
                version: '5.7',
                date: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cutecumber_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        };

        window.importData = function(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.records) localStorage.setItem(RECORD_KEY, JSON.stringify(data.records));
                    if (data.actors) localStorage.setItem(ACTOR_KEY, JSON.stringify(data.actors));
                    if (data.achievements) localStorage.setItem(ACH_KEY, JSON.stringify(data.achievements));
                    if (data.profile) localStorage.setItem(PROFILE_KEY, JSON.stringify(data.profile));
                    showAlert('Ë≥áÊñôÈÇÑÂéüÊàêÂäüÔºÅÊáâÁî®Á®ãÂºèÂ∞áÈáçÊñ∞ÂïüÂãï„ÄÇ');
                    setTimeout(() => location.reload(), 1500);
                } catch (err) {
                    showAlert('Ê™îÊ°àÊ†ºÂºèÈåØË™§ÔºåÁÑ°Ê≥ïÈÇÑÂéü„ÄÇ');
                }
            };
            reader.readAsText(file);
        };

        window.resetData = function() {
            showConfirm('Ë≠¶ÂëäÔºöÈÄôÂ∞áÊúÉÂà™Èô§ÊâÄÊúâÁ¥ÄÈåÑ„ÄÅËÄÅÂè∏Ê©üÊî∂ËóèÂíåÊàêÂ∞±ÔºÅ', () => {
                showConfirm('ÂÜçÊ¨°Á¢∫Ë™çÔºöÁúüÁöÑË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâË≥áÊñôÂóéÔºüÁÑ°Ê≥ïÂæ©ÂéüÔºÅ', () => {
                    localStorage.clear();
                    location.reload();
                });
            });
        };

        // --- Achievements Logic (V5ÔºöÊñ∞Âπ¥ÁâπËµ¶ + Ëá™ÂãïÂõûÊî∂Ê©üÂà∂) ---
        function checkAchievements(onFinished) {
            const sorted = [...ejaculationRecords].sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp));
            const count = sorted.length;
            
            const masturbationRecords = sorted.filter(r => r.type === 'Ëá™ÊÖ∞');
            const masturbationCount = masturbationRecords.length;
            const masturbationDates = masturbationRecords.map(r=>{const d=new Date(r.timestamp);return `${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;});
            const bday = userProfile.birthday ? userProfile.birthday.slice(5) : null; 

            // ÊÄßÂ§•‰º¥Áµ±Ë®à
            const sexRecords = sorted.filter(r => r.type === 'ÂÅöÊÑõ');
            const sexCount = sexRecords.length;
            const partnerCounts = {}; 
            const uniquePartners = new Set();
            sexRecords.forEach(r => {
                if(r.partners && Array.isArray(r.partners)) {
                    r.partners.forEach(p => {
                        partnerCounts[p.name] = (partnerCounts[p.name] || 0) + 1;
                        uniquePartners.add(p.name);
                    });
                }
            });
            let maxSamePartnerCount = 0;
            Object.values(partnerCounts).forEach(c => { if(c > maxSamePartnerCount) maxSamePartnerCount = c; });
            const uniqueNations = new Set();
            if (window.partnerProfiles) {
                uniquePartners.forEach(name => {
                    const profile = partnerProfiles.find(p => p.name === name);
                    if (profile && profile.nation && profile.nation.n) uniqueNations.add(profile.nation.n);
                });
            }
            const uniqueNationCount = uniqueNations.size;
            
            // --- Á¶ÅÊÖæË®àÁÆó (V5ÔºöÊñ∞Âπ¥ÁâπËµ¶Áâà - ËàáÊï∏ÊìöÈ†ÅÈÇèËºØÂêåÊ≠•) ---
            let maxAbs = 0;
            const DAY_MS = 86400000;
            if(sorted.length > 0){
                for(let i=0; i<sorted.length-1; i++){
                    const older = sorted[i];
                    const newer = sorted[i+1];
                    const gapDays = (new Date(newer.timestamp) - new Date(older.timestamp)) / DAY_MS;
                    
                    const olderYear = new Date(older.timestamp).getFullYear();
                    const isOlderBackfill = Math.abs(older.id - new Date(older.timestamp).getTime()) > DAY_MS;

                    // ÈÇèËºØÔºö2026 ÈñãÂßãÂÖ®Èù¢‰ø°‰ªªÔºå2025 ‰ª•ÂâçÂö¥Ê†ºÂ∞ÅÊÆ∫Ë£úÁôª
                    if (olderYear >= 2026) {
                        if(gapDays > maxAbs) maxAbs = gapDays;
                    } else {
                        if (!isOlderBackfill) {
                            if(gapDays > maxAbs) maxAbs = gapDays;
                        }
                    }
                }
                
                // ÊúÄÂæå‰∏ÄÊ¨°Âà∞ÁèæÂú®
                const lastRec = sorted[sorted.length-1];
                const lastYear = new Date(lastRec.timestamp).getFullYear();
                const isLastBackfill = Math.abs(lastRec.id - new Date(lastRec.timestamp).getTime()) > DAY_MS;
                const diffNow = (new Date() - new Date(lastRec.timestamp)) / DAY_MS;
                
                if (lastYear >= 2026) {
                    if(diffNow > maxAbs) maxAbs = diffNow;
                } else {
                    if (!isLastBackfill) {
                        if(diffNow > maxAbs) maxAbs = diffNow;
                    }
                }
            }
            // ------------------------------------

            // --- Á∏±ÊÖæÈÄ£ÊìäË®àÁÆó ---
            let maxStreak = 0;
            if (sorted.length > 0) {
                const uniqueDates = [...new Set(sorted.map(r => r.timestamp.split('T')[0]))].sort(); 
                let currentStreak = 0;
                if (uniqueDates.length > 0) {
                    maxStreak = 1; currentStreak = 1;
                    for (let i = 1; i < uniqueDates.length; i++) {
                        const prev = new Date(uniqueDates[i-1]);
                        const curr = new Date(uniqueDates[i]);
                        const diff = Math.round((curr - prev) / DAY_MS);
                        if (diff === 1) currentStreak++; else currentStreak = 1;
                        if (currentStreak > maxStreak) maxStreak = currentStreak;
                    }
                }
            }

            // ==========================================
            // üî• ÈóúÈçµ‰øÆÊ≠£ÔºöÊàêÂ∞±ÂõûÊî∂Ê©üÂà∂ (Auto-Relock) üî•
            // ==========================================
            const originalLength = unlockedAchievements.length;
            unlockedAchievements = unlockedAchievements.filter(u => {
                const achData = ACHIEVEMENTS_DATA.find(a => a.id === u.id);
                if (!achData) return true; // Êú™Áü•ÊàêÂ∞±‰øùÁïô

                // Ê™¢Êü•„ÄêËã¶Ë°åÂÉßÊ®°Âºè (Category C)„Äë
                // Â¶ÇÊûúÁõÆÂâçÁöÑÊúÄÈï∑Á¶ÅÊÖæÂ§©Êï∏ (maxAbs) Â∑≤Á∂ì‰∏çÈÅîÊ®ô‰∫ÜÔºåÂ∞±ÁÑ°ÊÉÖÁßªÈô§ÔºÅ
                if (achData.type === 'abs') {
                    return maxAbs >= achData.thres;
                }
                return true; // ÂÖ∂‰ªñÈ°ûÂûãÊö´‰∏çÂõûÊî∂
            });

            // Â¶ÇÊûúÊúâÊàêÂ∞±Ë¢´ÂõûÊî∂ÔºåÂÑ≤Â≠òËÆäÊõ¥‰∏¶Âà∑Êñ∞‰ªãÈù¢
            if (unlockedAchievements.length !== originalLength) {
                saveAchData();
                if(document.getElementById('stats-view-achievements').style.display === 'block') {
                    renderAchievements(); // Âº∑Âà∂Âà∑Êñ∞ÂàóË°®È°ØÁ§∫‰∏äÈéñÁãÄÊÖã
                }
            }
            // ==========================================

            let newUnlock = false;
            const unlockedIDs = unlockedAchievements.map(u => u.id); 
            let firstUnlockAch = null;

            // ÈÄôË£°Ë®òÂæóÂä†ÂÖ• 'E' È°ûÂà•
            const categories = ['A', 'B', 'C', 'D', 'E'];

            ACHIEVEMENTS_DATA.forEach(ach => {
                if(unlockedIDs.includes(ach.id)) return; 
                let pass = false;
                
                if(ach.type==='count') {
                    if (ach.id === 'count_1') { if (count >= ach.thres) pass = true; } 
                    else { if (masturbationCount >= ach.thres) pass = true; }
                }
                if(ach.type==='abs' && maxAbs>=ach.thres) pass=true;
                if(ach.type==='streak' && maxStreak >= ach.thres) pass = true;
                if(ach.type==='special') {
                    if(ach.date && masturbationDates.includes(ach.date)) pass=true;
                    if(ach.dates && ach.dates.some(d=>masturbationDates.includes(d))) pass=true;
                    if(ach.isBday && bday && masturbationDates.includes(bday)) pass=true;
                }
                // ÊÄßÂ§•‰º¥ÊàêÂ∞±
                if(ach.type==='sex_count' && sexCount >= ach.thres) pass = true;
                if(ach.type==='sex_same_partner' && maxSamePartnerCount >= ach.thres) pass = true;
                if(ach.type==='sex_unique_partners' && uniquePartners.size >= ach.thres) pass = true;
                if(ach.type==='sex_unique_nations' && uniqueNationCount >= ach.thres) pass = true;

                if(pass) {
                    const todayStr = new Date().toLocaleDateString();
                    unlockedAchievements.push({ id: ach.id, date: todayStr });
                    unlockedIDs.push(ach.id);
                    if (!firstUnlockAch) firstUnlockAch = ach; 
                    newUnlock = true;
                }
            });

            if(newUnlock) saveAchData();
            
            if(document.getElementById('stats-view-achievements').style.display === 'block') {
                renderAchievements(); 
            }

            if (firstUnlockAch) {
                onAchievementClose = onFinished;
                showUnlockModal(firstUnlockAch);
                return true; 
            } else {
                return false; 
            }
        }

        function renderAchievements() {
            const container = document.getElementById('ach-list-container'); 
            container.innerHTML='';
            // ‰øÆÊ≠£ÔºöÂä†ÂÖ• 'E' È°ûÂà•
            const categories = ['A', 'B', 'C', 'D', 'E'];
            const unlockedIDs = unlockedAchievements.map(u => u.id);

            categories.forEach(cat => {
                const items = ACHIEVEMENTS_DATA.filter(a => a.category === cat);
                if(items.length === 0) return;
                const titleDiv = document.createElement('div');
                titleDiv.className = 'ach-category-title';
                titleDiv.textContent = items[0].catTitle;
                container.appendChild(titleDiv);
                const gridDiv = document.createElement('div');
                gridDiv.className = 'ach-grid';
                items.forEach(ach => {
                    const unlockedObj = unlockedAchievements.find(u => u.id === ach.id);
                    const unlocked = !!unlockedObj;
                    const div = document.createElement('div');
                    div.className = `ach-card ${unlocked ? 'unlocked' : 'locked'}`;
                    const title = unlocked ? ach.title : '???';
                    div.innerHTML = `<div class="ach-icon">${ach.icon}</div><div class="ach-title">${title}</div>`;
                    div.onclick = () => {
                        if(unlocked) showAchievementDetail(ach, unlockedObj.date);
                        else showAlert(`üîí ‰∏äÈéñÁöÑÊàêÂ∞±\n\nÊèêÁ§∫Ôºö${ach.desc}`);
                    };
                    gridDiv.appendChild(div);
                });
                container.appendChild(gridDiv);
            });
        }

        function showAchievementDetail(ach, date) {
            document.getElementById('ad-icon').textContent = ach.icon;
            document.getElementById('ad-title').textContent = ach.title;
            document.getElementById('ad-desc').textContent = ach.desc;
            document.getElementById('ad-date').textContent = date || 'Êú™Áü•';
            document.getElementById('ad-msg').textContent = `"${ach.msg}"`;
            document.getElementById('achievement-detail-modal').classList.add('active');
        }
        window.closeAchDetailModal = function() { document.getElementById('achievement-detail-modal').classList.remove('active'); };

        function showUnlockModal(ach) {
            document.getElementById('unlock-icon').textContent = ach.icon;
            document.getElementById('unlock-title').textContent = `ÊàêÂ∞±Ëß£ÈéñÔºö${ach.title}`;
            document.getElementById('unlock-msg').textContent = ach.msg;
            document.getElementById('achievement-modal').classList.add('active');
            if(navigator.vibrate) navigator.vibrate([100,50,100]);
        }
        window.closeAchievementModal = function() { 
            document.getElementById('achievement-modal').classList.remove('active');
            if(onAchievementClose) {
                onAchievementClose();
                onAchievementClose = null;
            }
        };

        // --- Home Logic ---
        function getHomeMessage() {
            if (ejaculationRecords.length === 0) return "CuteCumber Èö®ÊôÇÂæÖÂëΩ„ÄÇ";
            const sorted = [...ejaculationRecords].sort((a,b)=>new Date(b.timestamp)-new Date(a.timestamp));
            const last = new Date(sorted[0].timestamp);
            const now = new Date();
            const todayStr = now.toDateString();
            const todayCount = sorted.filter(r => new Date(r.timestamp).toDateString() === todayStr).length;

            // 1. High Freq
            if (sorted.length >= 2) {
                const prev = new Date(sorted[1].timestamp);
                if ((last - prev) < 3600000) return "ÈñìÈöî‰∏çÂà∞‰∏ÄÂ∞èÊôÇÔºüÔºÅ‰Ω†ÁöÑË≥¢ËÄÖÊ®°ÂºèÂÜ∑ÂçªÊôÇÈñì‰πüÂ§™Áü≠‰∫ÜÂêßÔºå‰Ω©Êúç„ÄÇ";
            }
            if (todayCount >= 3) return "‰∏ÄÂ§©‰∏âÊ¨°ÔºüË´ãÁ´ãÂàªË£úÂÖÖÁâ°Ë†£„ÄÅÈãÖÁâáÊàñÈ¶ôËïâÔºåË∫´È´îË¶ÅÈ°ßÂïäÔºÅ";
            if (todayCount === 2) return "ÂìáÔºåÂèà‰∏ÄÁôºÔºå‰ªäÂ§©Á≤æÁ•ûÂæàÂ•ΩÂñîÔºü";

            // 2. Time based
            if (last.toDateString() === todayStr) {
                const h = last.getHours();
                const day = last.getDay(); // 0 Sun, 6 Sat
                if (day >= 1 && day <= 5 && h >= 12 && h < 13) return "Âçà‰ºëÊôÇÈñì‰πü‰∏çÊîæÈÅéÔºüÊôÇÈñìÁÆ°ÁêÜÂ§ßÂ∏´Â∞±ÊòØ‰Ω†„ÄÇ";
                if (h >= 6 && h < 9) return "‰∏ÄÊó•‰πãË®àÂú®ÊñºÊô®...ÂãÉÔºüÁúã‰æÜ‰Ω†ÈÜíÂæóÂæàÂæπÂ∫ï„ÄÇ";
                if (h >= 1 && h < 4) return "ÂáåÊô®ÈÇÑ‰∏çÁù°...ÊòØÂú®ÈáãÊîæÂ£ìÂäõÈÇÑÊòØÂñÆÁ¥îÂ§±Áú†ÔºüÊó©Èªû‰ºëÊÅØÂêß„ÄÇ";
            }
            
            // 3. Weekend Warrior (Simple check)
            const day = now.getDay();
            if ((day === 0 || day === 6) && todayCount >= 2) return "Âπ≥Êó•È§äÁîüÔºåÈÄ±Êú´ÂæÄÊ≠ªË£°Â∞ªÔºÅ";
            
            // Just for today count > 0 but no special cond
            if (todayCount > 0) {
                 const randomMsgs = ["‰ªäÂ§©‰πüÊòØÂÖÖÊªøÊ¥ªÂäõÁöÑ‰∏ÄÂ§©„ÄÇ", "CuteCumber Èö®ÊôÇÂæÖÂëΩ„ÄÇ", "Ë®òÂæóÂ§öÂñùÊ∞¥„ÄÇ", "‰øùÊåÅÂøÉÊÉÖÊÑâÂø´„ÄÇ"];
                 return randomMsgs[Math.floor(Math.random() * randomMsgs.length)];
            }

            return "‰ªäÂ§©ÈÇÑÊ≤íÂãïÈùúÂë¢ÔºåËìÑÂäõ‰∏≠Ôºü";
        }

        function updateHomeDisplay() {
            const t = document.getElementById('hero-timer-display');
            if (ejaculationRecords.length === 0) {
                t.innerHTML = '<span style="font-size:24px;">Â∞öÊú™ÈñãÂßãÁ¥ÄÈåÑ</span>';
                document.getElementById('home-message').textContent = getHomeMessage();
            } else {
                const s = [...ejaculationRecords].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)), d = new Date().getTime() - new Date(s[0].timestamp).getTime();
                if (d < 0) {
                    t.innerHTML = '00<small>ÂàÜ</small>';
                } else {
                    const da = Math.floor(d / 86400000), ho = Math.floor((d % 86400000) / 3600000), mi = Math.floor((d % 3600000) / 60000);
                    let h = '';
                    if (da > 0) h += `${da}<small>Â§©</small>${ho}<small>ÊôÇ</small>`;
                    else if (ho > 0) h += `${ho}<small>ÊôÇ</small>${mi}<small>ÂàÜ</small>`;
                    else h += `${mi}<small>ÂàÜ</small>`;
                    t.innerHTML = h;
                }
                document.getElementById('home-message').textContent = getHomeMessage();
            }
            const n = new Date();
            document.getElementById('month-count-display').textContent = ejaculationRecords.filter(r => new Date(r.timestamp).getMonth() === n.getMonth()).length;
            const rc = document.getElementById('recent-list-container'), rs = [...ejaculationRecords].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 3);
            rc.innerHTML = rs.length ? '' : '<div style="text-align:center;padding:20px;color:#ccc;">Êö´ÁÑ°Á¥ÄÈåÑ</div>';
            
            const typeEmoji = { 'Ëá™ÊÖ∞': 'üçÜ', 'ÂÅöÊÑõ': 'üçë', 'Â§¢ÈÅ∫': 'üí§' };
            const weekdays = ['ÈÄ±Êó•','ÈÄ±‰∏Ä','ÈÄ±‰∫å','ÈÄ±‰∏â','ÈÄ±Âõõ','ÈÄ±‰∫î','ÈÄ±ÂÖ≠'];

            rs.forEach(r => {
                const dateObj = new Date(r.timestamp);
                const md = `${dateObj.getMonth() + 1}/${dateObj.getDate()} ${weekdays[dateObj.getDay()]}`;
                const relTime = getRelativeTime(r.timestamp);
                const emoji = typeEmoji[r.type] || 'ü•í';
                const loc = r.location || 'Êú™Áü•';

                const div = document.createElement('div');
                div.className = 'recent-card';
                div.innerHTML = `<div class="recent-icon-box">${emoji}</div><div class="recent-info"><div class="recent-date">${md}</div><div class="recent-meta">${relTime}</div></div><div class="recent-location">üìç ${loc}</div>`;
                rc.appendChild(div);
            });
            
            // --- ‰øÆÊ≠£ÂæåÁöÑ„ÄåÁõÆÂâçÈÄ£Êìä„ÄçË®àÁÆóÈÇèËºØ (V2) ---
            // 1. Áõ¥Êé•ÂàáÂ≠ó‰∏≤ÊãøÊó•Êúü (YYYY-MM-DD)ÔºåÈÅøÂÖçÊôÇÂçÄËΩâÊèõË™§Â∑Æ
            const uniqueDates = [...new Set(ejaculationRecords.map(r => r.timestamp.split('T')[0]))]
                .sort((a, b) => b.localeCompare(a)); // ÈôçÂ∫èÔºöÊñ∞ -> Ëàä

            let currentStreak = 0;

            if (uniqueDates.length > 0) {
                // ÂèñÂæó„Äå‰ΩøÁî®ËÄÖÁï∂Âú∞„ÄçÁöÑ‰ªäÂ§©ËàáÊò®Â§©Êó•ÊúüÂ≠ó‰∏≤
                const now = new Date();
                const offset = now.getTimezoneOffset() * 60000; // ÂàÜÈêòËΩâÊØ´Áßí
                const localNow = new Date(now.getTime() - offset);
                
                const todayStr = localNow.toISOString().split('T')[0];
                const yesterday = new Date(localNow.getTime() - 86400000);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                
                const latestDate = uniqueDates[0];

                // Âè™ÊúâÁï∂ÊúÄÊñ∞Á¥ÄÈåÑÊòØ„Äå‰ªäÂ§©„ÄçÊàñ„ÄåÊò®Â§©„ÄçÊôÇÔºåÊâçË¶ñÁÇ∫ÈÄ£ÊìäÊúâÊïà
                if (latestDate === todayStr || latestDate === yesterdayStr) {
                    currentStreak = 1; // Ëá≥Â∞ëÊúâ 1 Â§©
                    
                    for (let i = 0; i < uniqueDates.length - 1; i++) {
                        const d1 = new Date(uniqueDates[i]);     // ËºÉÊñ∞
                        const d2 = new Date(uniqueDates[i+1]);   // ËºÉËàä (Ââç‰∏ÄÁ≠Ü)
                        
                        // Ë®àÁÆóÂ§©Êï∏Â∑Æ
                        const diffTime = Math.abs(d1 - d2);
                        const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

                        if (diffDays === 1) {
                            currentStreak++;
                        } else {
                            break; // ‰∏≠Êñ∑
                        }
                    }
                }
            }
            
            document.getElementById('home-streak-display').textContent = currentStreak;
        }

        window.switchDiaryView = function(v) {
            const c = document.getElementById('diary-view-calendar'), l = document.getElementById('diary-view-list'), b = document.querySelectorAll('.view-toggle .toggle-btn');
            if (v === 'calendar') {
                c.style.display = 'block';
                l.style.display = 'none';
                b[0].classList.add('active');
                b[1].classList.remove('active');
                renderCalendar();
            } else {
                c.style.display = 'none';
                l.style.display = 'block';
                b[0].classList.remove('active');
                b[1].classList.add('active');
                renderDiaryList();
            }
        };

        window.changeMonth = function(o) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + o);
            renderCalendar();
        };

        function renderCalendar() {
            const y = currentCalendarDate.getFullYear(), m = currentCalendarDate.getMonth();
            document.getElementById('calendar-title').textContent = `${y} Âπ¥ ${m + 1} Êúà`;
            const fd = new Date(y, m, 1).getDay(), dim = new Date(y, m + 1, 0).getDate(), c = document.getElementById('calendar-days-container');
            c.innerHTML = '';
            const t = new Date(), isCm = t.getFullYear() === y && t.getMonth() === m;
            for (let i = 0; i < fd; i++) c.appendChild(document.createElement('div'));
            for (let d = 1; d <= dim; d++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-day';
                if (isCm && d === t.getDate()) cell.classList.add('today');
                const dr = ejaculationRecords.filter(r => {
                    const rd = new Date(r.timestamp);
                    return rd.getFullYear() === y && rd.getMonth() === m && rd.getDate() === d;
                });
                if (dr.length > 0) {
                    cell.classList.add('has-record');
                    cell.innerHTML = `<span>${d}</span><div class="calendar-drops">${Array(Math.min(dr.length, 3)).fill('<div class="drop-dot"></div>').join('')}</div>`;
                    cell.onclick = () => dr.length === 1 ? openDetailModal(dr[0].id) : openDailyListModal(y, m, d, dr);
                } else {
                    cell.innerHTML = `<span>${d}</span>`;
                }
                c.appendChild(cell);
            }
        }

        // ÂÆöÁæ© filterDiary ËÆì HTML ÁöÑ oninput ÂèØ‰ª•ÂëºÂè´
        window.filterDiary = function() {
            renderDiaryList();
        };

        // Ê∏≤ÊüìÊó•Ë®òÂàóË°® (‰øÆÂæ©ÁâàÔºöËá™ÂãïËÆÄÂèñÂ§•‰º¥ÊúÄÊñ∞ÁÖßÁâá)
        window.renderDiaryList = function() {
            const c = document.getElementById('diary-list-content');
            c.innerHTML = '';
            
            // ÂèñÂæóÊêúÂ∞ãÈóúÈçµÂ≠ó
            const searchInput = document.getElementById('diary-search-input'); 
            const term = searchInput ? searchInput.value.trim().toLowerCase() : "";

            if (ejaculationRecords.length === 0) {
                c.innerHTML = '<div style="text-align:center;padding:60px 20px;color:#999;">üçÉ ÁôΩÁ¥ô‰∏ÄÂºµ</div>';
                return;
            }

            // 1. ÂÖàÊéíÂ∫è (Êñ∞ -> Ëàä)
            let list = [...ejaculationRecords].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // 2. ÂÜçÈÅéÊøæ (Â¶ÇÊûúÊúâÈóúÈçµÂ≠ó)
            if (term) {
                list = list.filter(r => {
                    let content = (r.type || "") + (r.location || "") + (r.note || "");
                    if (r.partners) content += r.partners.map(p => p.name).join(" ");
                    if (r.usedActors) content += r.usedActors.map(a => a.name).join(" ");
                    if (r.target && r.target.type === 'actor') content += r.target.name;
                    if (r.usedVideo) content += r.usedVideo.title;
                    if (r.target && r.target.type === 'video') content += r.target.name;
                    return content.toLowerCase().includes(term);
                });
            }

            if (list.length === 0) {
                c.innerHTML = '<div style="text-align:center;padding:40px;color:#ccc;">Êâæ‰∏çÂà∞Á¨¶ÂêàÁöÑÁ¥ÄÈåÑ üê¢</div>';
                return;
            }

            // 3. Ê∏≤ÊüìÂàóË°®
            list.forEach(r => {
                const dateObj = new Date(r.timestamp);
                const md = `${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
                const t = `${dateObj.getHours().toString().padStart(2, '0')}:${dateObj.getMinutes().toString().padStart(2, '0')}`;
                
                // --- ÂúñÁâáÈÇèËºØ‰øÆÊ≠£ (ÂÑ™ÂÖàÈ†ÜÂ∫è: Á¥ÄÈåÑÂúñ > Â§•‰º¥Âúñ(Âê´ÊúÄÊñ∞Ê™îÊ°àÂèçÊü•) > ÂΩ±ÁâáÂúñ > ÊºîÂì°Âúñ) ---
                let displayImg = r.photo; 

                if (!displayImg) {
                    // A. Â¶ÇÊûúÊòØÂÅöÊÑõÔºåÂÑ™ÂÖàÈ°ØÁ§∫Â§•‰º¥ÁÖßÁâá
                    if (r.type === 'ÂÅöÊÑõ' && r.partners && r.partners.length > 0) {
                        // 1. ÂÖàÁúãÁ¥ÄÈåÑÁï∂‰∏ãÊúâÊ≤íÊúâÂ≠òÁÖßÁâá
                        let pWithPhoto = r.partners.find(p => p.photo);
                        if (pWithPhoto) {
                            displayImg = pWithPhoto.photo;
                        } 
                        
                        // 2. Â¶ÇÊûúÁ¥ÄÈåÑË£°Ê≤íÁÖßÁâáÔºåÂéª„ÄåÊî∂ËóèÊ´É (partnerProfiles)„ÄçÊü•ÊúÄÊñ∞ÁÖßÁâá [ÈóúÈçµ‰øÆÂæ©]
                        if (!displayImg && window.partnerProfiles) {
                            // ÈÅçÊ≠∑ÈÄôÁ≠ÜÁ¥ÄÈåÑÁöÑÊâÄÊúâÂ§•‰º¥
                            for (let p of r.partners) {
                                // Âú®Êî∂ËóèÊ´ÉÊâæÈÄôÂÄãÂêçÂ≠ó
                                const profile = window.partnerProfiles.find(pf => pf.name === p.name);
                                if (profile && profile.photo) {
                                    displayImg = profile.photo;
                                    break; // ÊâæÂà∞‰∏ÄÂºµÂ∞±Áî®ÔºåÁÑ∂ÂæåÂÅúÊ≠¢
                                }
                            }
                        }
                    }
                    
                    // B. ÂΩ±Áâá
                    if (!displayImg && r.usedVideo) {
                         const owner = actorProfiles.find(a => a.id === r.usedVideo.parentId);
                         if (owner && owner.videos) {
                             const v = owner.videos.find(v => v.id === r.usedVideo.id);
                             if (v && v.thumbnail) displayImg = v.thumbnail;
                         }
                    } 
                    
                    // C. ÊºîÂì°
                    if (!displayImg && r.usedActors && r.usedActors.length > 0) {
                        const firstActor = actorProfiles.find(a => a.id === r.usedActors[0].id);
                        if (firstActor && firstActor.avatar) displayImg = firstActor.avatar;
                    }
                    
                    // D. ËàäË≥áÊñôÂÖºÂÆπ
                    if (!displayImg && r.target) {
                         const actorId = r.target.type === 'actor' ? r.target.id : r.target.parentId;
                         const actor = actorProfiles.find(a => a.id === actorId);
                         if (actor) {
                             if (r.target.type === 'video' && actor.videos) {
                                 const v = actor.videos.find(v => v.id === r.target.id);
                                 if (v && v.thumbnail) displayImg = v.thumbnail;
                                 else displayImg = actor.avatar;
                             } else { displayImg = actor.avatar; }
                         }
                    }
                }

                let ph = '<div class="photo-placeholder">üì∑</div>'; 
                if (displayImg && displayImg !== "") {
                    ph = `<img src="${displayImg}" class="photo-thumbnail" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">`;
                    ph += `<div class="photo-placeholder" style="display:none;">üì∑</div>`; 
                }

                // Ê∫ñÂÇôÊÄßÂ§•‰º¥Ë≥áË®äÂ≠ó‰∏≤
                let partnerInfo = "";
                if (r.type === 'ÂÅöÊÑõ' && r.partners && r.partners.length > 0) {
                    const namesHtml = r.partners.map(p => 
                        `<span style="cursor:pointer; text-decoration:underline; margin:0 2px; font-weight:bold;" onclick="navigateToPartner(event, '${p.name}')">${p.name}</span>`
                    ).join(', ');
                    
                    partnerInfo = `<span style="font-size:12px; font-weight:normal; color:var(--color-primary); margin-left:6px;">with ${namesHtml}</span>`;
                }

                const d = document.createElement('div');
                d.className = 'diary-card';
                d.onclick = () => openDetailModal(r.id);
                
                d.innerHTML = `<div class="diary-left"><div class="diary-date-box"><span class="diary-day">${md}</span><span class="diary-time">${t}</span></div>${ph}<div class="diary-content"><div class="diary-title">${r.type}${partnerInfo}</div><div class="diary-meta">üìç ${r.location}</div></div></div><div class="action-group"><button class="btn-icon delete" onclick="event.stopPropagation();deleteRecord(${r.id})"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div>`;
                c.appendChild(d);
            });
        };

        window.deleteRecord = function(id) {
            showConfirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜÁ¥ÄÈåÑÂóéÔºü‰∏ÄÊó¶Âà™Èô§Â∞áÁÑ°Ê≥ïÂæ©Âéü„ÄÇ', () => {
                ejaculationRecords = ejaculationRecords.filter(r => r.id !== id);
                saveRecordData();
                // Check if filter is active
                const searchInput = document.getElementById('diary-search-input');
                if(searchInput && searchInput.value.trim() !== '') {
                    window.filterDiary();
                } else {
                    renderDiaryList();
                }
                renderCalendar();
                updateHomeDisplay();
                calculateStats();
                checkAchievements();
            });
        };

        window.openDetailModal = function(id) {
            const r = ejaculationRecords.find(x => x.id === id);
            if (!r) return;
            const d = new Date(r.timestamp);
            document.getElementById('detail-date-time').textContent = `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${d.getMinutes().toString().padStart(2, '0')}`;
            
            // È°ØÁ§∫ÁÖßÁâá
            const pc = document.getElementById('detail-photo-container');
            if (r.photo) {
                document.getElementById('detail-photo').src = r.photo;
                pc.style.display = 'block';
            } else {
                pc.style.display = 'none';
            }
            
            document.getElementById('detail-type').textContent = r.type;
            document.getElementById('detail-location').textContent = r.location;
            
            // È°ØÁ§∫ÂÇôË®ª
            const nb = document.getElementById('detail-note-box'), en = document.getElementById('detail-empty-note');
            if (r.note) {
                nb.textContent = r.note;
                nb.style.display = 'block';
                en.style.display = 'none';
            } else {
                nb.style.display = 'none';
                en.style.display = 'block';
            }

            // --- ÈÄ£ÁµêÊåâÈàïÂçÄÂ°äÊ∏ÖÁêÜ (Ê∏ÖÈô§ËàäÁöÑÊåâÈàï) ---
            const existingLinks = document.querySelectorAll('.detail-dynamic-link');
            existingLinks.forEach(el => el.remove());

            const contentBottom = document.querySelector('#detail-modal .modal-content-bottom');
            const actionGroup = contentBottom.querySelector('.detail-actions') || contentBottom.lastElementChild;

            // --- A. È°ØÁ§∫ÊÄßÂ§•‰º¥ (Sex) ---
            if (r.type === 'ÂÅöÊÑõ' && r.partners && r.partners.length > 0) {
                const partnerDiv = document.createElement('div');
                partnerDiv.className = 'detail-dynamic-link'; // Ê®ôË®ò‰ª•‰æø‰∏ãÊ¨°Ê∏ÖÈô§
                partnerDiv.style.marginBottom = '15px';
                
                const title = document.createElement('div');
                title.textContent = 'üíû ÊÄßÂ§•‰º¥Ôºö';
                title.style.fontWeight = 'bold';
                title.style.color = 'var(--color-accent)';
                title.style.marginBottom = '8px';
                partnerDiv.appendChild(title);

                const container = document.createElement('div');
                container.style.display = 'flex';
                container.style.flexWrap = 'wrap';
                container.style.gap = '8px';

                r.partners.forEach(p => {
                    const chip = document.createElement('div');
                    chip.className = 'selected-tag-chip';
                    chip.style.background = 'rgba(255, 105, 180, 0.1)';
                    chip.style.color = '#333';
                    chip.style.cursor = 'default';
                    
                    let imgHtml = '';
                    if(p.photo) imgHtml = `<img src="${p.photo}" style="width:24px;height:24px;border-radius:50%;object-fit:cover;">`;
                    else imgHtml = '<span style="font-size:16px">üë§</span>';

                    chip.innerHTML = `${imgHtml} ${p.name}`;
                    container.appendChild(chip);
                });
                partnerDiv.appendChild(container);

                if (actionGroup) contentBottom.insertBefore(partnerDiv, actionGroup);
            }

            // --- B. È°ØÁ§∫ÈÖçËèúÈÄ£Áµê (Masturbation) ---
            // ÂÑ™ÂÖàÈ†ÜÂ∫èÔºöÂΩ±Áâá (usedVideo) > ÊºîÂì° (usedActors) > ËàäË≥áÊñô (target)
            let targetBtnData = null;

            if (r.usedVideo) {
                targetBtnData = {
                    type: 'video',
                    icon: 'üé¨',
                    name: r.usedVideo.title,
                    jumpTarget: { type: 'video', id: r.usedVideo.id, parentId: r.usedVideo.parentId }
                };
            } else if (r.usedActors && r.usedActors.length > 0) {
                // Â¶ÇÊûúÊúâÂ§öÂÄãÊºîÂì°ÔºåÂè™È°ØÁ§∫Á¨¨‰∏ÄÂÄã
                targetBtnData = {
                    type: 'actor',
                    icon: 'üë§',
                    name: r.usedActors[0].name + (r.usedActors.length > 1 ? ` Á≠â ${r.usedActors.length} ‰∫∫` : ''),
                    jumpTarget: { type: 'actor', id: r.usedActors[0].id }
                };
            } else if (r.target && r.target.id) {
                // ÂÖºÂÆπËàäË≥áÊñô
                targetBtnData = {
                    type: r.target.type,
                    icon: r.target.type === 'actor' ? 'üë§' : 'üé¨',
                    name: r.target.name || 'Êú™Áü•',
                    jumpTarget: r.target
                };
            }

            // Â¶ÇÊûúÊúâÊâæÂà∞ÈÖçËèúË≥áÊñôÔºåÂª∫Á´ãÈªëËâ≤ÊåâÈàï
            if (targetBtnData) {
                const linkBtn = document.createElement('button');
                linkBtn.className = 'btn-base detail-dynamic-link';
                linkBtn.style.cssText = 'background:#333; color:white; width:100%; margin-bottom:15px; display:flex; align-items:center; justify-content:center; gap:8px;';
                linkBtn.innerHTML = `<span>${targetBtnData.icon}</span> ÈÖçËèúÔºö${targetBtnData.name}`;
                linkBtn.onclick = () => jumpToTarget(targetBtnData.jumpTarget);
                
                if (actionGroup) contentBottom.insertBefore(linkBtn, actionGroup);
            }
            // ---------------------------

            document.getElementById('detail-edit-btn').onclick = () => {
                closeDetailModal();
                openEditRecordModal(r.id);
            };
            document.getElementById('detail-delete-btn').onclick = () => {
                showConfirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÁ≠ÜÁ¥ÄÈåÑÂóéÔºü‰∏ÄÊó¶Âà™Èô§Â∞áÁÑ°Ê≥ïÂæ©Âéü„ÄÇ', () => {
                    deleteRecordInternal(r.id);
                    closeDetailModal();
                    closeDailyListModal();
                });
            };
            document.getElementById('detail-modal').classList.add('active');
        };
        
        window.jumpToTarget = function(target) {
            // 1. Êö¥ÂäõÈóúÈñâÊâÄÊúâ Modal (ÂåÖÂê´Ë©≥ÊÉÖÈ†Å„ÄÅÊó•ÊõÜÊ∏ÖÂñÆ„ÄÅÊàêÂ∞±Ë¶ñÁ™óÁ≠â)
            document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active'));
            
            // 2. ÂàáÊèõ Tab Âà∞Êî∂ËóèÊ´É
            const driverTab = document.querySelector('.tab-item[data-target="driver"]');
            if(driverTab) driverTab.click();
            
            // 3. Âü∑Ë°åË∑≥ËΩâ
            setTimeout(() => {
                if (target.type === 'partner') {
                    // ÊÄßÂ§•‰º¥Ê®°Âºè
                    if(window.switchDriverMode) window.switchDriverMode('partner');
                    setTimeout(() => {
                        if(window.showPartnerDetail) window.showPartnerDetail(target.name);
                    }, 100);
                    
                } else if (target.type === 'actor') {
                    // Èõ≤Á´ØÊÉÖ‰∫∫Ê®°Âºè
                    if(window.switchDriverMode) window.switchDriverMode('actor');
                    showDriverDetail(target.id);
                    
                } else if (target.type === 'video') {
                    // ÂΩ±ÁâáÊ®°Âºè
                    if(window.switchDriverMode) window.switchDriverMode('actor');
                    showDriverDetail(target.parentId);
                    setTimeout(() => {
                        openVideoDetail(target.parentId, target.id);
                    }, 300);
                }
            }, 100); // Áµ¶‰∏ÄÈªûÊôÇÈñìËÆì Tab ÂàáÊèõÂãïÁï´ÂÆåÊàê
        };

        function deleteRecordInternal(id) {
            ejaculationRecords = ejaculationRecords.filter(r => r.id !== id);
            saveRecordData();
            // Refresh diary list if active
            const searchInput = document.getElementById('diary-search-input');
            if(searchInput && searchInput.value.trim() !== '') {
                window.filterDiary();
            } else {
                renderDiaryList();
            }
            renderCalendar();
            updateHomeDisplay();
            calculateStats();
            checkAchievements();
        }

        window.closeDetailModal = function() {
            document.getElementById('detail-modal').classList.remove('active');
        };

        window.openEditRecordModal = function(id) {
            const r = ejaculationRecords.find(x => x.id === id);
            if (!r) return;
            editingRecordId = id;
            document.getElementById('edit-timestamp').value = r.timestamp;
            document.getElementById('edit-type').value = r.type;
            document.getElementById('edit-location').value = r.location;
            // Restore Partners
            editTempPartnerList = [];
            if (r.partners) {
                editTempPartnerList = [...r.partners];
            }
            renderPartnerTags('edit');
            updateFormVisibility('edit-'); // Á¢∫‰øùÊ≠£Á¢∫È°ØÁ§∫Ê¨Ñ‰Ωç
            document.getElementById('edit-note').value = r.note || '';
            
            // Restore Actors
            editTempActorsList = [];
            if (r.usedActors) {
                editTempActorsList = [...r.usedActors];
            } else if (r.target && r.target.type === 'actor') {
                // ÂÖºÂÆπËàäË≥áÊñô
                editTempActorsList = [{ id: r.target.id, name: r.target.name }];
            }
            window['render_editTempActorsList']();

            // Restore Video
            if (r.usedVideo) {
                document.getElementById('edit-video-search').value = r.usedVideo.title;
                document.getElementById('edit-video-data').value = JSON.stringify(r.usedVideo);
            } else if (r.target && r.target.type === 'video') {
                // ÂÖºÂÆπËàäË≥áÊñô
                const vObj = { id: r.target.id, title: r.target.name, parentId: r.target.parentId };
                document.getElementById('edit-video-search').value = vObj.title;
                document.getElementById('edit-video-data').value = JSON.stringify(vObj);
            } else {
                document.getElementById('edit-video-search').value = "";
                document.getElementById('edit-video-data').value = "";
            }

            tempRecordPhoto = r.photo || "";
            const p = document.getElementById('edit-preview-photo');
            if (tempRecordPhoto) { p.src = tempRecordPhoto; p.classList.add('show'); } 
            else { p.src = ""; p.classList.remove('show'); }
            document.getElementById('edit-record-modal').classList.add('active');
        };

        window.closeEditModal = function() {
            document.getElementById('edit-record-modal').classList.remove('active');
            editingRecordId = null;
        };

        window.openDailyListModal = function(y, m, d, rs) {
            document.getElementById('daily-list-date').textContent = `${m + 1}/${d}`;
            document.getElementById('daily-count').textContent = rs.length;
            
            const c = document.getElementById('daily-list-container');
            c.innerHTML = ''; // ÈóúÈçµ‰øÆÂæ©ÔºöÂÖàÊ∏ÖÁ©∫ËàäË≥áÊñôÔºÅ
            
            rs.forEach(r => {
                const dateObj = new Date(r.timestamp);
                const t = `${dateObj.getHours().toString().padStart(2, '0')}:${dateObj.getMinutes().toString().padStart(2, '0')}`;
                
                // Ê∫ñÂÇôÈ°ØÁ§∫ÂÖßÂÆπ
                let contentInfo = r.type; // È†êË®≠È°ØÁ§∫È°ûÂûã
                
                // Â¶ÇÊûúÊòØÂÅöÊÑõÔºåÈ°ØÁ§∫Â§•‰º¥ÂêçÂ≠ó
                if (r.type === 'ÂÅöÊÑõ' && r.partners && r.partners.length > 0) {
                     const namesHtml = r.partners.map(p => 
                        `<span style="cursor:pointer; text-decoration:underline; margin:0 2px;" onclick="navigateToPartner(event, '${p.name}')">${p.name}</span>`
                     ).join(', ');
                     contentInfo += ` <span style="color:var(--color-primary);font-size:12px;">(with ${namesHtml})</span>`;
                }
                
                // Â¶ÇÊûúÊúâÈÖçËèú (ÂΩ±Áâá/ÊºîÂì°)ÔºåÈ°ØÁ§∫Âá∫‰æÜ
                if (r.usedVideo) {
                    contentInfo += ` <span style="color:#888;font-size:12px;">üé¨ ${r.usedVideo.title}</span>`;
                } else if (r.usedActors && r.usedActors.length > 0) {
                    contentInfo += ` <span style="color:#888;font-size:12px;">üë§ ${r.usedActors[0].name}</span>`;
                }

                const i = document.createElement('div');
                i.className = 'diary-card';
                i.style.padding = '12px'; //Á®çÂæÆË™øÊï¥ÈñìË∑ù
                i.onclick = () => openDetailModal(r.id);
                
                i.innerHTML = `
                    <div class="diary-left">
                        <div style="font-weight:bold; margin-right:15px; color:#333; min-width:40px;">${t}</div>
                        <div style="flex:1; overflow:hidden; text-overflow:ellipsis;">${contentInfo}</div>
                    </div>
                    <div style="color:#ccc;">‚Ä∫</div>
                `;
                c.appendChild(i);
            });
            
            document.getElementById('daily-list-modal').classList.add('active');
        };

        window.closeDailyListModal = function() {
            document.getElementById('daily-list-modal').classList.remove('active');
        };

        window.openAddActorForm = function() {
            editingActorId = null;
            tempActorAvatar = "";
            document.getElementById('actor-form-title').textContent = "Âª∫Á´ãÊñ∞Ê™îÊ°à";
            document.getElementById('actor-form').reset();
            
            // Á¢∫‰øù tags Ê¨Ñ‰ΩçÊ∏ÖÁ©∫
            document.getElementById('actor-tags').value = "";
            
            document.getElementById('actor-preview').src = "";
            document.getElementById('actor-preview').classList.remove('show');
            document.getElementById('actor-form-modal').classList.add('active');
        };

        window.openEditActorForm = function() {
            if (!currentActorId) return;
            const a = actorProfiles.find(x => x.id === currentActorId);
            editingActorId = currentActorId;
            document.getElementById('actor-form-title').textContent = "Á∑®ËºØÊ™îÊ°àË≥áÊñô";
            document.getElementById('actor-name').value = a.name;
            document.getElementById('actor-bio').value = a.bio || "";
            document.getElementById('actor-website').value = a.website || "";
            
            // Êñ∞Â¢ûÔºöËÆÄÂèñ tags ËΩâÁÇ∫Â≠ó‰∏≤ (‰ª•Á©∫ÁôΩÂàÜÈöî)
            document.getElementById('actor-tags').value = (a.tags || []).join(' ');

            tempActorAvatar = a.avatar || "";
            const p = document.getElementById('actor-preview'), u = document.getElementById('actor-avatar-url');
            if (tempActorAvatar.startsWith('data:')) {
                p.src = tempActorAvatar;
                p.classList.add('show');
                u.value = "";
            } else if (tempActorAvatar.startsWith('http')) {
                p.src = tempActorAvatar;
                p.classList.add('show');
                u.value = tempActorAvatar;
            } else {
                p.src = "";
                p.classList.remove('show');
                u.value = "";
            }
            document.getElementById('actor-form-modal').classList.add('active');
        };

        window.closeActorFormModal = function() {
            document.getElementById('actor-form-modal').classList.remove('active');
        };

        window.openVideoFormModal = function(vid = null) {
            const f = document.getElementById('video-form');
            f.reset();
            editingVideoId = vid;
            tempVideoThumb = "";
            const p = document.getElementById('video-preview'), u = document.getElementById('video-thumb-url');
            
            // Á¢∫‰øùÊ∏ÖÁ©∫ tags Ê¨Ñ‰Ωç
            document.getElementById('video-tags').value = "";

            if (vid) {
                const a = actorProfiles.find(x => x.id === currentActorId), v = a.videos.find(x => x.id === vid);
                document.getElementById('video-form-title').textContent = "Á∑®ËºØÂΩ±Áâá";
                document.getElementById('video-title').value = v.title;
                document.getElementById('video-url').value = v.url;
                document.getElementById('video-note').value = v.note || "";
                
                // Êñ∞Â¢ûÔºöËÆÄÂèñ tags ËΩâÂ≠ó‰∏≤
                document.getElementById('video-tags').value = (v.tags || []).join(' ');

                tempVideoThumb = v.thumbnail || "";
                if (tempVideoThumb.startsWith('data:')) {
                    p.src = tempVideoThumb;
                    p.classList.add('show');
                } else if (tempVideoThumb.startsWith('http')) {
                    p.src = tempVideoThumb;
                    p.classList.add('show');
                    u.value = tempVideoThumb;
                } else {
                    p.src = "";
                    p.classList.remove('show');
                }
            } else {
                document.getElementById('video-form-title').textContent = "Êñ∞Â¢ûÂΩ±Áâá";
                p.src = "";
                p.classList.remove('show');
            }
            document.getElementById('video-form-modal').classList.add('active');
        };

        window.closeVideoFormModal = function() {
            document.getElementById('video-form-modal').classList.remove('active');
        };
// --- Partner Logic Extensions ---

        // 1. ÂêåÊ≠•ÂäüËÉΩÔºöÂæûÁ¥ÄÈåÑ‰∏≠ "ÊíàÂèñ" Â§•‰º¥Âª∫Á´ãÊ™îÊ°à (‰øÆÂæ©Áâà)
        window.syncPartnersFromRecords = function() {
            // Á¢∫‰øù partnerProfiles Â∑≤ÂàùÂßãÂåñ
            if (!window.partnerProfiles) {
                try { 
                    window.partnerProfiles = JSON.parse(localStorage.getItem(PARTNER_KEY)) || []; 
                } catch(e) { 
                    window.partnerProfiles = []; 
                }
            }

            const seenPartners = {}; // key: name, val: photo

            // ÊéÉÊèèÊâÄÊúâÁ¥ÄÈåÑ
            ejaculationRecords.forEach(r => {
                if (r.partners && Array.isArray(r.partners)) {
                    r.partners.forEach(p => {
                        // Â¶ÇÊûúÈÄôÁ≠ÜÁ¥ÄÈåÑÊúâÁÖßÁâáÔºåÂÑ™ÂÖà‰ΩøÁî®
                        if (!seenPartners[p.name]) {
                            seenPartners[p.name] = p.photo;
                        } else if (!seenPartners[p.name] && p.photo) {
                            seenPartners[p.name] = p.photo;
                        }
                    });
                }
            });

            let changed = false;
            Object.keys(seenPartners).forEach(name => {
                let profile = partnerProfiles.find(p => p.name === name);
                
                if (!profile) {
                    // ÁôºÁèæÊñ∞Â§•‰º¥ -> Âª∫Á´ãÊ™îÊ°à
                    partnerProfiles.push({
                        id: Date.now() + Math.random(),
                        name: name,
                        photo: seenPartners[name] || "",
                        nation: null, 
                        race: "",
                        lastUpdated: Date.now()
                    });
                    changed = true;
                } else {
                    // Êó¢ÊúâÂ§•‰º¥ -> Ê™¢Êü•ÊòØÂê¶ÈúÄË¶ÅË£úÁÖßÁâáÊàñÊõ¥Êñ∞ÊôÇÈñì
                    let needUpdate = false;
                    if (!profile.photo && seenPartners[name]) {
                        profile.photo = seenPartners[name];
                        needUpdate = true;
                    }
                    // Á¢∫‰øùÊúâ lastUpdated Ê¨Ñ‰Ωç
                    if (!profile.lastUpdated) {
                        profile.lastUpdated = profile.id;
                        needUpdate = true;
                    }

                    if (needUpdate) {
                        profile.lastUpdated = Date.now();
                        changed = true;
                    }
                }
            });

            if (changed) {
                savePartnerData(); // ÂØ´ÂÖ• localStorage
            }
        };
// --- ÂÇ≥ÈÄÅÈñÄÔºöÂæûÊó•Ë®ò/Êó•ÊõÜË∑≥ËΩâÂà∞Â§•‰º¥Ë©≥ÊÉÖ (Èú∏ÈÅì‰øÆÊ≠£Áâà) ---
        window.navigateToPartner = function(e, name) {
            if(e) {
                e.stopPropagation();
                e.preventDefault();
            }
            
            // 1. Êö¥ÂäõÈóúÈñâÊâÄÊúâÂèØËÉΩÊìãË∑ØÁöÑ Modal (Êó•Ë®òË©≥ÊÉÖ„ÄÅÊó•ÊõÜÊ∏ÖÂñÆ„ÄÅÁ∑®ËºØÈ†Å...)
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.classList.remove('active');
            });

            // 2. ÂàáÊèõÂà∞Â∫ïÈÉ® "Driver" ÂàÜÈ†Å
            const driverTab = document.querySelector('.tab-item[data-target="driver"]');
            if(driverTab) driverTab.click();

            // 3. Âª∂ÈÅ≤Âü∑Ë°åÔºöÁ¢∫‰øùÂàÜÈ†ÅÂàáÊèõÂæåÔºå‰ªãÈù¢Â∑≤Ê∫ñÂÇôÂ•Ω
            setTimeout(() => {
                // ÂàáÊèõÂà∞ÊÄßÂ§•‰º¥Ê®°Âºè
                if(window.switchDriverMode) window.switchDriverMode('partner');
                
                // ÂÜçÂª∂ÈÅ≤‰∏ÄÈªûÈªûÊâìÈñãË©≥ÊÉÖÔºåÁ¢∫‰øùÂàóË°®Â∑≤Ê∏≤Êüì
                setTimeout(() => {
                    if(window.showPartnerDetail) window.showPartnerDetail(name);
                }, 100);
            }, 50);
        };
        // 2. ÂàáÊèõÊ®°Âºè (Èõ≤Á´ØÊÉÖ‰∫∫ vs ÊÄßÂ§•‰º¥) - ‰øÆÊ≠£Áâà
        window.switchDriverMode = function(mode) {
            const btns = document.querySelectorAll('.driver-header .toggle-btn');
            const actGrid = document.getElementById('actor-grid');
            const parGrid = document.getElementById('partner-grid');
            const actionBar = document.getElementById('driver-action-bar');
            const diceBtn = document.getElementById('driver-dice-btn'); 
            const sortSelect = document.getElementById('driver-sort-select'); 

            // Èò≤ÂëÜÊ©üÂà∂ÔºöÂ¶ÇÊûúÊâæ‰∏çÂà∞ÂÆπÂô®ÔºåÂ∞±‰∏≠Êñ∑‰ª•ÂÖçÂ†±ÈåØ
            if(!actGrid || !parGrid) return;

            if (mode === 'actor') {
                // --- ‚òÅÔ∏è Èõ≤Á´ØÊÉÖ‰∫∫Ê®°Âºè ---
                btns[0].classList.add('active'); btns[1].classList.remove('active');
                
                // ÈóúÈçµÔºöÈ°ØÁ§∫Èõ≤Á´ØÊÉÖ‰∫∫ÔºåÈö±ËóèÊÄßÂ§•‰º¥
                actGrid.style.display = 'grid'; 
                parGrid.style.display = 'none';
                
                // È°ØÁ§∫È™∞Â≠ê
                if(diceBtn) diceBtn.style.display = 'block';

                // Ë®≠ÂÆöÈõ≤Á´ØÊÉÖ‰∫∫ÊéíÂ∫è
                if(sortSelect) {
                    sortSelect.innerHTML = `
                        <option value="updated">üïí ÊúÄÂæåÊõ¥Êñ∞ (È†êË®≠)</option>
                        <option value="name">üî§ ÂßìÂêç (A-Z)</option>
                        <option value="count">üé¨ ÂΩ±ÁâáÊï∏Èáè (Â§öÂà∞Â∞ë)</option>
                    `;
                }
                if(actionBar) actionBar.innerHTML = `<button class="btn-base btn-primary" onclick="openAddActorForm()" style="font-size:13px;padding:8px 12px;">+ Êñ∞Â¢ûÊºîÂì°</button>`;
                
                renderActorList();
                filterDriverList(); 

            } else {
                // --- üíû ÊÄßÂ§•‰º¥Ê®°Âºè ---
                btns[0].classList.remove('active'); btns[1].classList.add('active');
                
                // ÈóúÈçµÔºöÈö±ËóèÈõ≤Á´ØÊÉÖ‰∫∫ÔºåÈ°ØÁ§∫ÊÄßÂ§•‰º¥
                actGrid.style.display = 'none'; 
                parGrid.style.display = 'grid';
                
                // Èö±ËóèÈ™∞Â≠ê
                if(diceBtn) diceBtn.style.display = 'none';

                // Ë®≠ÂÆöÊÄßÂ§•‰º¥ÊéíÂ∫è
                if(sortSelect) {
                    sortSelect.innerHTML = `
                        <option value="partner_updated">üïí ÊúÄÂæåÊõ¥Êñ∞ (È†êË®≠)</option>
                        <option value="partner_name">üî§ ÂßìÂêç (A-Z)</option>
                        <option value="partner_nation">üåç ÂúãÁ±ç</option>
                        <option value="partner_count">üî• ÊÄßÊÑõÊ¨°Êï∏</option>
                    `;
                }
                if(actionBar) actionBar.innerHTML = `<button class="btn-base btn-accent" onclick="showAlert('Âè™Ë¶ÅÂú®„ÄåÁ¥ÄÈåÑ„ÄçÈ†ÅÈù¢Êñ∞Â¢ûÂÅöÊÑõÁ¥ÄÈåÑÔºå\\nÂ§•‰º¥Â∞±ÊúÉËá™ÂãïÂá∫ÁèæÂú®ÈÄôË£°ÂõâÔºÅ')" style="font-size:13px;padding:8px 12px;opacity:0.8;">Â¶Ç‰ΩïÊñ∞Â¢ûÔºü</button>`;
                
                // ÂëºÂè´Ê∏≤Êüì (ÈÄôÊ≠•ÊúÄÈáçË¶ÅÔºåË≥áÊñôÊâçÊúÉÂá∫‰æÜ)
                renderPartnerGrid();
            }
        };

        // 2. Ê∏≤ÊüìÂ§•‰º¥ÂàóË°® (V2 Êô∫ÊÖßÊéíÂ∫èÁâà)
        window.renderPartnerGrid = function() {
            // 1. Âº∑Âà∂ÂêåÊ≠•Ë≥áÊñô
            if(window.syncPartnersFromRecords) window.syncPartnersFromRecords(); 
            
            const c = document.getElementById('partner-grid');
            if(!c) return;
            c.innerHTML = '';
            
            // 2. ËÆÄÂèñ‰ªãÈù¢Ë®≠ÂÆö
            const sortSelect = document.getElementById('driver-sort-select');
            const sortType = sortSelect ? sortSelect.value : 'partner_updated';
            const searchInput = document.getElementById('driver-search-input');
            const term = searchInput ? searchInput.value.trim().toLowerCase() : '';

            // 3. Áµ±Ë®àÊï∏Êìö (Ê¨°Êï∏ & ÊúÄÂæåÊà∞ÂΩπÊôÇÈñì)
            const stats = {};      // Ë®òÈåÑÊ¨°Êï∏
            const lastActive = {}; // Ë®òÈåÑÊúÄÂæå‰∏ÄÊ¨°ÁôºÁîüÁöÑÊôÇÈñì (Timestamp)

            ejaculationRecords.forEach(r => {
                if(r.partners && Array.isArray(r.partners)) {
                    // ÂèñÂæóÈÄôÁ≠ÜÁ¥ÄÈåÑÁöÑÊôÇÈñì
                    const recordTime = new Date(r.timestamp).getTime();
                    
                    r.partners.forEach(p => {
                        // Á¥ØÂä†Ê¨°Êï∏
                        stats[p.name] = (stats[p.name]||0) + 1;
                        
                        // Êõ¥Êñ∞Ë©≤Â§•‰º¥ÁöÑ„ÄåÊúÄÂæåÊà∞ÂΩπÊôÇÈñì„Äç (ÂèñÊúÄÂ§ßÂÄº)
                        if (!lastActive[p.name] || recordTime > lastActive[p.name]) {
                            lastActive[p.name] = recordTime;
                        }
                    });
                }
            });

            // 4. Ë§áË£Ω‰∏¶Âü∑Ë°åÊéíÂ∫è
            let sorted = [...partnerProfiles];

            sorted.sort((a, b) => {
                if (sortType === 'partner_name') {
                    // üî§ ÂßìÂêçÊéíÂ∫è (A-Z)
                    return a.name.localeCompare(b.name, 'zh-Hant');
                    
                } else if (sortType === 'partner_nation') {
                    // üåç ÂúãÁ±çÊéíÂ∫è (ÊúâÂúãÁ±çÁöÑÂú®ÂâçÔºåÊ≤íÂúãÁ±çÁöÑÂú®Âæå)
                    if (a.nation && !b.nation) return -1;
                    if (!a.nation && b.nation) return 1;
                    if (!a.nation && !b.nation) return 0;
                    return a.nation.n.localeCompare(b.nation.n, 'zh-Hant');
                    
                } else if (sortType === 'partner_count') {
                    // üî• Ê¨°Êï∏ÊéíÂ∫è (Â§ö -> Â∞ë)
                    return (stats[b.name]||0) - (stats[a.name]||0);
                    
                } else {
                    // üïí ÊúÄÂæåÊõ¥Êñ∞ (È†êË®≠) - ÊîπÁÇ∫„ÄåÊúÄËøëÊà∞ÂΩπÊôÇÈñì„Äç
                    // Â¶ÇÊûúÊúâÁ¥ÄÈåÑÊôÇÈñìÂ∞±Áî®Á¥ÄÈåÑÊôÇÈñìÔºåÊ≤íÊúâÂ∞±Áî®Ê™îÊ°àÂª∫Á´ãÊôÇÈñì
                    const timeA = lastActive[a.name] || a.lastUpdated || a.id || 0;
                    const timeB = lastActive[b.name] || b.lastUpdated || b.id || 0;
                    return timeB - timeA; // Êñ∞ -> Ëàä
                }
            });

            // 5. ÊêúÂ∞ãÈÅéÊøæ
            if (term) {
                sorted = sorted.filter(p => {
                    const nameMatch = p.name.toLowerCase().includes(term);
                    const nationMatch = p.nation ? p.nation.n.includes(term) : false;
                    const raceMatch = p.race ? p.race.toLowerCase().includes(term) : false;
                    return nameMatch || nationMatch || raceMatch;
                });
            }

            // 6. È°ØÁ§∫Á©∫ÁãÄÊÖã
            if (sorted.length === 0) {
                c.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#999;padding:40px;">Â∞öÁÑ°Á¨¶ÂêàÁöÑÊÄßÂ§•‰º¥Á¥ÄÈåÑ<br><small>ÂéªÊñ∞Â¢û‰∏ÄÁ≠Ü„ÄåÂÅöÊÑõ„ÄçÁ¥ÄÈåÑÔºå<br>ÈÄôË£°Â∞±ÊúÉËá™ÂãïÂª∫Á´ãÊ™îÊ°àÂõâÔºÅ</small></div>';
                return;
            }

            // 7. Áî¢ÁîüÂç°Áâá
            sorted.forEach(p => {
                const count = stats[p.name] || 0;
                const d = document.createElement('div');
                d.className = 'actor-card'; 
                d.onclick = () => showPartnerDetail(p.name);
                const s = p.photo || DEFAULT_AVATAR;
                const flag = p.nation ? p.nation.f : '';
                
                d.innerHTML = `
                    <div style="position:relative; width:100%;">
                        <img src="${s}" class="actor-avatar" style="border-color:var(--color-accent);" onerror="this.src='${DEFAULT_AVATAR}'">
                        <div style="position:absolute; bottom:10px; right:0; font-size:24px; text-shadow:0 2px 5px rgba(0,0,0,0.2); filter:drop-shadow(0 0 2px rgba(255,255,255,0.8));">${flag}</div>
                    </div>
                    <span class="actor-name">${p.name}</span>
                    <span style="font-size:11px; color:#999;">${count} Ê¨°</span>
                `;
                c.appendChild(d);
            });
        };

        // 4. Â§•‰º¥Ë©≥ÊÉÖ
        window.showPartnerDetail = function(name) {
            currentPartnerName = name;
            const p = partnerProfiles.find(x => x.name === name);
            if(!p) return;

            // Áµ±Ë®àÊï∏Êìö
            const history = ejaculationRecords.filter(r => r.partners && r.partners.some(pa => pa.name === name));
            history.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

            document.getElementById('pd-avatar').src = p.photo || DEFAULT_AVATAR;
            document.getElementById('pd-name').textContent = p.name;
            document.getElementById('pd-flag').textContent = p.nation ? p.nation.f : '';
            document.getElementById('pd-meta').textContent = (p.nation ? p.nation.n : 'ÂúãÁ±çÊú™Ë©≥') + (p.race ? ` ¬∑ ${p.race}` : '');
            document.getElementById('pd-stats').textContent = `Á¥ØÁ©çÊ¨°Êï∏Ôºö${history.length} Ê¨°`;

            const list = document.getElementById('pd-history-list');
            list.innerHTML = '';
            history.forEach(r => {
                const d = new Date(r.timestamp);
                const dateStr = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
                const div = document.createElement('div');
                div.className = 'diary-card'; // ÈáçÁî®Ê®£Âºè
                div.style.padding = '10px';
                div.style.minHeight = 'auto';
                div.onclick = () => { closePartnerDetail(); openDetailModal(r.id); };
                div.innerHTML = `<div style="font-weight:bold; color:#555;">${dateStr}</div><div style="font-size:13px; color:#888;">${r.location || 'Êú™Áü•Âú∞Èªû'}</div>`;
                list.appendChild(div);
            });

            document.getElementById('partner-detail-modal').classList.add('active');
        };
        window.closePartnerDetail = () => document.getElementById('partner-detail-modal').classList.remove('active');

        // 5. Á∑®ËºØÂ§•‰º¥ËàáÂúãÁ±çÊêúÂ∞ã
        // Âà™Èô§Â§•‰º¥ÂäüËÉΩ (Âº∑ÂäõÁâàÔºöÈÄ£ÂêåÊ≠∑Âè≤Á¥ÄÈåÑÁöÑÈóúËÅØ‰∏ÄËµ∑ÁßªÈô§)
        window.deleteCurrentPartner = function() {
            if(!currentPartnerName) return;
            
            showConfirm(`Á¢∫ÂÆöË¶ÅÂà™Èô§„Äå${currentPartnerName}„ÄçÂóéÔºü\n\nÊ≥®ÊÑèÔºöÈÄôÂ∞áÊúÉÂæûÊâÄÊúâÊ≠∑Âè≤Á¥ÄÈåÑ‰∏≠ÁßªÈô§ÈÄô‰ΩçÂ§•‰º¥ÁöÑÂêçÂ≠óÔºàÁ¥ÄÈåÑÊú¨Ë∫´ÊúÉ‰øùÁïôÔºâ„ÄÇ`, () => {
                
                // 1. ÂæûÊâÄÊúâÊ≠∑Âè≤Á¥ÄÈåÑ‰∏≠„ÄåËß£Èô§ÈóúËÅØ„Äç (Èò≤Ê≠¢Ëá™ÂãïÂêåÊ≠•ÊôÇÂæ©Ê¥ª)
                let recordModified = false;
                ejaculationRecords.forEach(r => {
                    if (r.partners && Array.isArray(r.partners)) {
                        const originalLen = r.partners.length;
                        // ÈÅéÊøæÊéâÈÄôÂÄã‰∫∫
                        r.partners = r.partners.filter(p => p.name !== currentPartnerName);
                        
                        if(r.partners.length !== originalLen) recordModified = true;
                    }
                });
                if(recordModified) saveRecordData();

                // 2. Âà™Èô§Â§•‰º¥Ê™îÊ°à
                partnerProfiles = partnerProfiles.filter(p => p.name !== currentPartnerName);
                savePartnerData();

                // 3. ÈóúÈñâË¶ñÁ™ó‰∏¶Êõ¥Êñ∞‰ªãÈù¢
                closePartnerDetail();
                renderPartnerGrid();
                
                // Â¶ÇÊûúÂú®Êï∏ÊìöÈ†ÅÔºå‰πüË¶ÅÂà∑Êñ∞‰∏Ä‰∏ã
                if(window.calculateStats) window.calculateStats();
                
                showAlert('Â§•‰º¥Ë≥áÊñôÂ∑≤Âà™Èô§ÔºåÊ≠∑Âè≤ÈóúËÅØÂ∑≤Ëß£Èô§„ÄÇ');
            });
        };
        window.openPartnerEditForm = function() {
            const p = partnerProfiles.find(x => x.name === currentPartnerName);
            if(!p) return;
            document.getElementById('partner-detail-modal').classList.remove('active'); // Êö´ÊôÇÈóúÈñâË©≥ÊÉÖ
            
            document.getElementById('pf-name').value = p.name;
            document.getElementById('pf-url').value = "";
            document.getElementById('pf-file').value = "";
            document.getElementById('pf-preview').src = p.photo || DEFAULT_AVATAR;
            
            document.getElementById('pf-race').value = p.race || "";
            
            // Ë®≠ÂÆöÂúãÁ±ç
            if(p.nation) {
                document.getElementById('pf-nation-search').value = p.nation.n;
                document.getElementById('pf-nation-data').value = JSON.stringify(p.nation);
            } else {
                document.getElementById('pf-nation-search').value = "";
                document.getElementById('pf-nation-data').value = "";
            }

            document.getElementById('partner-form-modal').classList.add('active');
        };

        // ÂúãÁ±çÊêúÂ∞ãÈÇèËºØ
        function setupCountrySearch() {
            const input = document.getElementById('pf-nation-search');
            const hidden = document.getElementById('pf-nation-data');
            const list = document.getElementById('pf-nation-suggestions');
            
            input.addEventListener('input', () => {
                const term = input.value.trim().toLowerCase();
                if(!term) { list.style.display = 'none'; return; }
                
                const matches = COUNTRY_LIST.filter(c => c.n.includes(term) || c.f.includes(term));
                if(matches.length > 0) {
                    list.innerHTML = matches.map(c => `
                        <div class="suggestion-item" onclick='selectCountry(${JSON.stringify(c)})'>
                            <span style="font-size:18px;margin-right:8px;">${c.f}</span> ${c.n}
                        </div>
                    `).join('');
                    list.style.display = 'block';
                } else { list.style.display = 'none'; }
            });

            window.selectCountry = (c) => {
                input.value = c.n;
                hidden.value = JSON.stringify(c);
                list.style.display = 'none';
            };
        }
        window.showDriverList = function() {
            document.getElementById('driver-view-list').classList.add('active');
            document.getElementById('driver-view-detail').classList.remove('active');
            currentActorId = null;
            renderActorList();
        };

        window.showDriverDetail = function(id) {
            currentActorId = id;
            document.getElementById('driver-view-list').classList.remove('active');
            document.getElementById('driver-view-detail').classList.add('active');
            renderActorDetail();
            document.getElementById('app-container').scrollTo(0, 0);
        };

        window.renderActorList = function() {
            const c = document.getElementById('actor-grid');
            c.innerHTML = '';
            
            // Search Logic
            const searchInput = document.getElementById('driver-search-input');
            const term = searchInput ? searchInput.value.trim().toLowerCase() : '';
            // Áµ±‰∏ÄÁöÑÁØ©ÈÅ∏ÂÖ•Âè£ (ÊêúÂ∞ãÊ°ÜËº∏ÂÖ• Êàñ ÊéíÂ∫èÊîπËÆäÊôÇ ÂëºÂè´)
        window.filterDriverList = function() {
            const btns = document.querySelectorAll('.driver-header .toggle-btn');
            // Ê™¢Êü•ÁèæÂú®ÊòØÂì™ÂÄãÊ®°Âºè‰∫ÆËµ∑ (Active)
            const isActorMode = btns[0].classList.contains('active');
            
            if (isActorMode) {
                renderActorList(); // ÂëºÂè´Èõ≤Á´ØÊÉÖ‰∫∫Ê∏≤Êüì (ÂÖßÈÉ®ÊúÉÂéªËÆÄÂèñÊêúÂ∞ãÊ°Ü)
            } else {
                renderPartnerGrid(); // ÂëºÂè´ÊÄßÂ§•‰º¥Ê∏≤Êüì (ÂÖßÈÉ®ÊúÉÂéªËÆÄÂèñÊêúÂ∞ãÊ°Ü)
            }
        };
            // Sort Logic
            const sortType = document.getElementById('driver-sort-select') ? document.getElementById('driver-sort-select').value : 'updated';
            
            actorProfiles.sort((a, b) => {
                if (sortType === 'name') {
                    return a.name.localeCompare(b.name, 'zh-Hant');
                } else if (sortType === 'count') {
                    return (b.videos ? b.videos.length : 0) - (a.videos ? a.videos.length : 0);
                } else {
                    // Default: updated
                    const timeA = a.lastUpdated || a.id;
                    const timeB = b.lastUpdated || b.id;
                    return timeB - timeA;
                }
            });
            
            // Save sorted order so it persists
            saveActorData();

            let filtered = actorProfiles;
            if (term) {
                filtered = actorProfiles.filter(a => {
                    const nameMatch = (a.name || '').toLowerCase().includes(term);
                    const bioMatch = (a.bio || '').toLowerCase().includes(term);
                    // ÊêúÂ∞ã‰∫∫Áâ© tags
                    const actorTagMatch = (a.tags || []).some(t => t.toLowerCase().includes(term));
                    // Êñ∞Â¢ûÔºöDeep Search - ÊêúÂ∞ã‰∫∫Áâ©Â∫ï‰∏ãÁöÑ„ÄåÂΩ±ÁâáÊ®ôÈ°å„ÄçÊàñ„ÄåÂΩ±ÁâáÊ®ôÁ±§„Äç
                    const videoMatch = (a.videos || []).some(v => 
                        (v.title && v.title.toLowerCase().includes(term)) ||
                        (v.tags && v.tags.some(vt => vt.toLowerCase().includes(term)))
                    );

                    return nameMatch || bioMatch || actorTagMatch || videoMatch;
                });
            }

            if (filtered.length === 0) {
                 if (actorProfiles.length === 0) {
                     c.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#999;padding:40px;">ÁÑ°‰∫∫Áâ©Ë≥áÊñô</div>';
                 } else {
                     c.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#999;padding:40px;">Êâæ‰∏çÂà∞Áõ∏ÈóúÁöÑ‰∫∫Áâ© üòØ</div>';
                 }
                return;
            }

            filtered.forEach(a => {
                const d = document.createElement('div');
                d.className = 'actor-card';
                d.onclick = () => showDriverDetail(a.id);
                const s = a.avatar || DEFAULT_AVATAR;
                d.innerHTML = `<img src="${s}" class="actor-avatar" onerror="this.src='${DEFAULT_AVATAR}'"><span class="actor-name">${a.name}</span>`;
                c.appendChild(d);
            });
        };

        window.renderActorDetail = function() {
            if (!currentActorId) return;
            const a = actorProfiles.find(x => x.id === currentActorId);
            if (!a) {
                showDriverList();
                return;
            }
            
            // Tags HTML
            let tagsHtml = '';
            if (a.tags && a.tags.length > 0) {
                tagsHtml = '<div style="margin-top:10px; display:flex; flex-wrap:wrap; justify-content:center;">' + 
                    a.tags.map(t => `<span class="actor-tag" onclick="searchByTag('${t}')">${t}</span>`).join('') + 
                    '</div>';
            }

            // Link HTML
            let linkHtml = '';
            if (a.website) {
                let safeUrl = a.website;
                if (!/^https?:\/\//i.test(safeUrl)) safeUrl = 'https://' + safeUrl;
                linkHtml = `
                    <a href="${safeUrl}" target="_blank" rel="noopener noreferrer" 
                       class="btn-base" 
                       style="background-color:#000; color:white; margin-top:15px; display:inline-flex; align-items:center; gap:6px; text-decoration:none; padding:8px 16px; border-radius:20px; font-size:13px;">
                        <span>üîó</span> ÂâçÂæÄÂÄã‰∫∫‰∏ªÈ†Å / X
                    </a>
                `;
            }

            const p = document.getElementById('detail-profile-container');
            const s = a.avatar || DEFAULT_AVATAR;
            
            p.innerHTML = `<div class="btn-edit-profile" onclick="openEditActorForm()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></div><img src="${s}" class="detail-avatar" onerror="this.src='${DEFAULT_AVATAR}'"><div class="detail-name">${a.name}</div><div class="detail-bio">${a.bio || 'Â∞öÁÑ°Á∞°‰ªã'}</div>${tagsHtml}${linkHtml}`;
            
            // --- ‰øÆÊ≠£ÔºöÂú®ÈÄôË£°Ë£ú‰∏ä„ÄåÊñ∞Â¢ûÂΩ±Áâá„ÄçÊåâÈàï ---
            // ÁÇ∫‰∫ÜÁæéËßÄÔºåÊàëÂÄëÁî® JS ÊèíÂÖ•ÊåâÈàïÂà∞Ê®ôÈ°åÊóÅÈÇäÔºåÊàñÊòØÁõ¥Êé•Âú®ÂàóË°®‰∏äÊñπÂä†‰∏ÄÂÄãÊåâÈàï
            // ÈÄôË£°Êé°Áî®Âú®ÂàóË°®ÂÆπÂô®ÂâçÊ∏ÖÁ©∫‰∏¶ÈáçÂª∫ÁöÑÊñπÂºè
            
            const vc = document.getElementById('video-list-container');
            vc.innerHTML = '';
            
            // ÊèíÂÖ•„ÄåÊñ∞Â¢ûÂΩ±Áâá„ÄçÊåâÈàï (ÊîæÂú®ÂàóË°®ÊúÄ‰∏äÈù¢)
            const addBtnDiv = document.createElement('div');
            addBtnDiv.style.marginBottom = '15px';
            addBtnDiv.style.textAlign = 'right';
            addBtnDiv.innerHTML = `<button class="btn-base btn-primary" onclick="openVideoFormModal()" style="font-size:13px; padding:6px 12px; display:inline-flex; align-items:center;">+ Êñ∞Â¢ûÂΩ±Áâá</button>`;
            vc.appendChild(addBtnDiv);

            if (!a.videos || a.videos.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.style.textAlign = 'center';
                emptyMsg.style.color = '#ccc';
                emptyMsg.style.padding = '10px';
                emptyMsg.textContent = 'Â∞öÁÑ°ÂΩ±ÁâáÔºåÂø´ÂéªÊñ∞Â¢û‰∏ÄÈÉ®ÂêßÔºÅ';
                vc.appendChild(emptyMsg);
            } else {
                a.videos.forEach(v => {
                    let vTagsHtml = '';
                    if (v.tags && v.tags.length > 0) {
                        vTagsHtml = '<div style="margin-top:4px;">' + 
                            v.tags.map(t => `<span class="video-tag" onclick="event.stopPropagation(); searchByTag('${t}')">${t}</span>`).join('') + 
                            '</div>';
                    }

                    const c = document.createElement('div');
                    c.className = 'video-card';
                    c.onclick = () => openVideoDetail(a.id, v.id);
                    if (!v.id) v.id = Date.now() + Math.random();
                    let th = `<div class="video-thumb-placeholder">üé¨</div>`;
                    if (v.thumbnail) th = `<img src="${v.thumbnail}" class="video-thumb-img" onerror="this.parentElement.innerHTML='<div class=\\'video-thumb-placeholder\\'>üé¨</div>'">`;
                    c.innerHTML = `<div class="video-thumb-box">${th}</div><div class="video-card-info"><div class="video-card-title">${v.title}</div><div class="video-card-note">${v.note || ''}</div>${vTagsHtml}</div><div style="color:#ccc;align-self:center;">‚Ä∫</div>`;
                    vc.appendChild(c);
                });
            }
        };

        window.deleteCurrentActor = function() {
            if(!currentActorId) return;
            showConfirm('Á¢∫ÂÆöË¶ÅÁßªÈô§ÈÄô‰Ωç‰∫∫Áâ©ÂóéÔºü\nÊâÄÊúâÁöÑÁ∞°‰ªãËàáÂΩ±ÁâáÊî∂ËóèÈÉΩÊúÉ‰∏Ä‰ΩµÊ∂àÂ§±„ÄÇ', () => {
                actorProfiles = actorProfiles.filter(a => a.id !== currentActorId);
                saveActorData();
                showDriverList();
            });
        };
        
        // Êñ∞Â¢û Tag ÊêúÂ∞ãÂáΩÂºè
        window.searchByTag = function(tag) {
            showDriverList(); // ËøîÂõûÂàóË°®
            const input = document.getElementById('driver-search-input');
            if(input) {
                input.value = tag; // Â°´ÂÖ• tag
                renderActorList(); // Ëß∏ÁôºÊêúÂ∞ã
            }
        };

        window.openVideoDetail = function(aid, vid, toggle = true) {
            const a = actorProfiles.find(x => x.id === aid), v = a.videos.find(x => x.id === vid);
            if (!v) return;
            // ËôïÁêÜÊ®ôÈ°å + Tags
            let tagsHtml = '';
            if (v.tags && v.tags.length > 0) {
                tagsHtml = '<div style="margin-bottom:12px;">' + 
                    v.tags.map(t => `<span class="actor-tag" style="font-size:11px; margin-right:4px;">${t}</span>`).join('') + 
                    '</div>';
            }
            document.getElementById('vid-detail-title').innerHTML = v.title + tagsHtml;

            const n = document.getElementById('vid-detail-note');
            if (v.note) {
                n.textContent = v.note;
                n.style.display = 'block';
            } else {
                n.style.display = 'none';
            }
            const c = document.getElementById('vid-detail-cover-box');
            if (v.thumbnail) {
                document.getElementById('vid-detail-cover').src = v.thumbnail;
                c.style.display = 'flex';
            } else {
                c.style.display = 'none';
            }
            document.getElementById('vid-btn-watch').onclick = () => {
                let u = v.url;
                if (!/^https?:\/\//i.test(u)) u = 'https://' + u;
                window.open(u, '_blank', 'noopener,noreferrer');
            };
            document.getElementById('vid-btn-edit').onclick = () => {
                closeVideoDetail();
                openVideoFormModal(v.id);
            };
            document.getElementById('vid-btn-delete').onclick = () => {
                showConfirm('Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÈÉ®ÂΩ±ÁâáÂóéÔºü', () => {
                    a.videos = a.videos.filter(x => x.id !== v.id);
                    saveActorData();
                    renderActorDetail();
                    closeVideoDetail();
                });
            };
            if (toggle) document.getElementById('video-detail-modal').classList.add('active');
        };

        window.closeVideoDetail = function() {
            document.getElementById('video-detail-modal').classList.remove('active');
        };
        // --- Partner Management System ---
        function updateFormVisibility(prefix = '') {
            const typeVal = document.getElementById(prefix === 'edit-' ? 'edit-type' : 'input-type').value;
            const secMast = document.getElementById(prefix === 'edit-' ? 'edit-section-masturbation' : 'section-masturbation');
            const secSex = document.getElementById(prefix === 'edit-' ? 'edit-section-sex' : 'section-sex');
            
            if (typeVal === 'Ëá™ÊÖ∞') {
                secMast.style.display = 'block';
                secSex.style.display = 'none';
            } else if (typeVal === 'ÂÅöÊÑõ') {
                secMast.style.display = 'none';
                secSex.style.display = 'block';
            } else {
                // Â§¢ÈÅ∫ÊàñÂÖ∂‰ªñÔºöÂÖ®ÈÉ®Èö±Ëóè
                secMast.style.display = 'none';
                secSex.style.display = 'none';
            }
        }

        function setupPartnerInput(mode) {
            // mode: 'new' or 'edit'
            const prefix = mode === 'new' ? '' : 'edit-';
            const inputName = document.getElementById(prefix + 'input-partner-name');
            const inputUrl = document.getElementById(prefix + 'input-partner-url'); // Êñ∞Â¢û
            const inputPhoto = document.getElementById(prefix + 'input-partner-photo');
            const imgPreview = document.getElementById(prefix + 'preview-partner-photo');
            const list = document.getElementById(prefix + 'partner-suggestions');

            // 1. Êú¨Âú∞Ê™îÊ°à‰∏äÂÇ≥Áõ£ËÅΩ
            inputPhoto.addEventListener('change', async (e) => {
                if(e.target.files[0]){
                    try {
                        const b64 = await compressImage(e.target.files[0]);
                        currentPartnerPhoto = b64;
                        imgPreview.src = b64;
                        imgPreview.style.display = 'block';
                        // Â¶ÇÊûúÊúâ‰∏äÂÇ≥Ê™îÊ°àÔºåÊ∏ÖÁ©∫ URL Ê¨Ñ‰Ωç‰ª•ÂÖçÊ∑∑Ê∑Ü
                        if(inputUrl) inputUrl.value = '';
                    } catch(err) { showAlert("ÂúñÁâáËôïÁêÜÂ§±Êïó"); }
                }
            });

            // 2. Á∂≤ÂùÄËº∏ÂÖ•Áõ£ËÅΩ (Êñ∞Â¢û)
            if (inputUrl) {
                inputUrl.addEventListener('input', () => {
                    const url = inputUrl.value.trim();
                    if (url) {
                        currentPartnerPhoto = url;
                        imgPreview.src = url;
                        imgPreview.style.display = 'block';
                        // Ê∏ÖÁ©∫Ê™îÊ°à input (ÈõñÁÑ∂Ë¶ñË¶∫‰∏äÁúã‰∏çÂà∞Ôºå‰ΩÜÈÇèËºØ‰∏äÈáçÁΩÆ)
                        inputPhoto.value = ''; 
                    }
                });
            }

            // 3. Ê≠∑Âè≤Á¥ÄÈåÑËá™ÂãïÂÆåÊàê (Autocomplete)
            inputName.addEventListener('input', () => {
                const term = inputName.value.trim().toLowerCase();
                if(term.length === 0) { list.style.display = 'none'; return; }

                const allPartners = new Set();
                ejaculationRecords.forEach(r => {
                    if(r.partners) {
                        r.partners.forEach(p => allPartners.add(p.name));
                    }
                });
                
                const matches = Array.from(allPartners).filter(n => n.toLowerCase().includes(term));
                
                if(matches.length > 0) {
                    list.innerHTML = matches.map(name => 
                        `<div class="suggestion-item" onclick="selectPartnerSuggestion('${name}', '${mode}')">üíû ${name}</div>`
                    ).join('');
                    list.style.display = 'block';
                } else {
                    list.style.display = 'none';
                }
            });

            document.addEventListener('click', (e) => {
                if(e.target !== inputName && e.target !== list) list.style.display = 'none';
            });
        }

        window.addPartnerToState = function(mode) {
            const prefix = mode === 'new' ? '' : 'edit-';
            const nameInput = document.getElementById(prefix + 'input-partner-name');
            const urlInput = document.getElementById(prefix + 'input-partner-url'); // Êñ∞Â¢û
            const name = nameInput.value.trim();
            
            if(!name) { showAlert('Ë´ãËº∏ÂÖ•Â§•‰º¥ÂêçÂ≠ó'); return; }
            
            // Â¶ÇÊûú currentPartnerPhoto ÊòØÁ©∫ÁöÑÔºå‰ΩÜ URL Ê¨Ñ‰ΩçÊúâÂÄºÔºåÂ∞±Áî® URL (ÈõôÈáç‰øùÈö™)
            if (!currentPartnerPhoto && urlInput && urlInput.value.trim()) {
                currentPartnerPhoto = urlInput.value.trim();
            }

            const newP = { name: name, photo: currentPartnerPhoto };
            
            if(mode === 'new') {
                tempPartnerList.push(newP);
                renderPartnerTags('new');
            } else {
                editTempPartnerList.push(newP);
                renderPartnerTags('edit');
            }
            
            // Reset Input
            nameInput.value = '';
            if(urlInput) urlInput.value = ''; // Ê∏ÖÁ©∫ URL
            currentPartnerPhoto = "";
            document.getElementById(prefix + 'preview-partner-photo').style.display = 'none';
            document.getElementById(prefix + 'input-partner-photo').value = ""; 
        };

        window.selectPartnerSuggestion = function(name, mode) {
            const prefix = mode === 'new' ? '' : 'edit-';
            document.getElementById(prefix + 'input-partner-name').value = name;
            document.getElementById(prefix + 'partner-suggestions').style.display = 'none';
            // ÂòóË©¶ÂæûÊ≠∑Âè≤Á¥ÄÈåÑÊâæÈÄô‰∫∫ÁöÑËàäÁÖßÁâá (ÈÅ∏Â°´)
            const history = ejaculationRecords.find(r => r.partners && r.partners.find(p => p.name === name && p.photo));
            if(history) {
                const p = history.partners.find(x => x.name === name);
                if(p && p.photo) {
                    currentPartnerPhoto = p.photo;
                    const img = document.getElementById(prefix + 'preview-partner-photo');
                    img.src = p.photo;
                    img.style.display = 'block';
                }
            }
        };

        window.addPartnerToState = function(mode) {
            const prefix = mode === 'new' ? '' : 'edit-';
            const nameInput = document.getElementById(prefix + 'input-partner-name');
            const name = nameInput.value.trim();
            
            if(!name) { showAlert('Ë´ãËº∏ÂÖ•Â§•‰º¥ÂêçÂ≠ó'); return; }
            
            const newP = { name: name, photo: currentPartnerPhoto };
            
            if(mode === 'new') {
                tempPartnerList.push(newP);
                renderPartnerTags('new');
            } else {
                editTempPartnerList.push(newP);
                renderPartnerTags('edit');
            }
            
            // Reset Input
            nameInput.value = '';
            currentPartnerPhoto = "";
            document.getElementById(prefix + 'preview-partner-photo').style.display = 'none';
            document.getElementById(prefix + 'input-partner-photo').value = ""; // clear file
        };

        window.renderPartnerTags = function(mode) {
            const prefix = mode === 'new' ? '' : 'edit-';
            const container = document.getElementById(prefix === '' ? 'selected-partners-box' : 'edit-selected-partners-box');
            const arr = mode === 'new' ? tempPartnerList : editTempPartnerList;
            
            container.innerHTML = arr.map((p, idx) => `
                <div class="selected-tag-chip" style="background: rgba(255, 105, 180, 0.15); color: var(--color-accent);">
                    ${p.photo ? `<img src="${p.photo}" style="width:20px;height:20px;border-radius:50%;object-fit:cover;">` : 'üë§'}
                    ${p.name}
                    <span class="remove-tag" onclick="removePartner(${idx}, '${mode}')">√ó</span>
                </div>
            `).join('');
        };

        window.removePartner = function(idx, mode) {
            if(mode === 'new') {
                tempPartnerList.splice(idx, 1);
                renderPartnerTags('new');
            } else {
                editTempPartnerList.splice(idx, 1);
                renderPartnerTags('edit');
            }
        };
        // --- New Split Search Logic ---
        
        // 1. ÊºîÂì°ÊêúÂ∞ãËàáÁÆ°ÁêÜ (ÊîØÊè¥Â§öÈÅ∏)
        function setupActorSelector(inputId, suggestionId, containerId, listVarName) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(suggestionId);
            const container = document.getElementById(containerId);
            
            if (!input || !list) return;

            // Ê∏≤ÊüìÂ∑≤ÈÅ∏ÊìáÁöÑÊ®ôÁ±§
            window['render_' + listVarName] = function() {
                const arr = (listVarName === 'tempActorsList') ? tempActorsList : editTempActorsList;
                container.innerHTML = arr.map(a => `
                    <div class="selected-tag-chip">
                        ${a.name}
                        <span class="remove-tag" onclick="removeActorFromList('${a.id}', '${listVarName}')">√ó</span>
                    </div>
                `).join('');
            };

            input.addEventListener('input', () => {
                const term = input.value.trim().toLowerCase();
                if (term.length === 0) { list.style.display = 'none'; return; }

                // ÊéíÈô§Â∑≤Á∂ìÈÅ∏ÈÅéÁöÑ‰∫∫
                const currentList = (listVarName === 'tempActorsList') ? tempActorsList : editTempActorsList;
                const currentIds = currentList.map(x => x.id);

                const matches = actorProfiles.filter(a => 
                    a.name.toLowerCase().includes(term) && !currentIds.includes(a.id)
                );

                if (matches.length > 0) {
                    list.innerHTML = matches.map(a => 
                        `<div class="suggestion-item" data-id="${a.id}" data-name="${a.name}">üë§ ${a.name}</div>`
                    ).join('');
                    list.style.display = 'block';

                    Array.from(list.children).forEach(div => {
                        div.onclick = () => {
                            const actor = { id: parseFloat(div.dataset.id), name: div.dataset.name };
                            if (listVarName === 'tempActorsList') tempActorsList.push(actor);
                            else editTempActorsList.push(actor);
                            
                            window['render_' + listVarName](); // Êõ¥Êñ∞Áï´Èù¢
                            input.value = ''; // Ê∏ÖÁ©∫Ëº∏ÂÖ•Ê°Ü
                            list.style.display = 'none';
                        };
                    });
                } else { list.style.display = 'none'; }
            });
            
            // ÈªûÊìäÂ§ñÈÉ®ÈóúÈñâ
            document.addEventListener('click', (e) => {
                if (e.target !== input && e.target !== list) list.style.display = 'none';
            });
        }

        window.removeActorFromList = function(id, listVarName) {
            const targetId = parseFloat(id);
            if (listVarName === 'tempActorsList') {
                tempActorsList = tempActorsList.filter(a => a.id !== targetId);
                window['render_tempActorsList']();
            } else {
                editTempActorsList = editTempActorsList.filter(a => a.id !== targetId);
                window['render_editTempActorsList']();
            }
        };

        // 2. ÂΩ±ÁâáÊêúÂ∞ã (ÂñÆÈÅ∏)
        function setupVideoSelector(inputId, suggestionId, hiddenId) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(suggestionId);
            const hidden = document.getElementById(hiddenId);

            input.addEventListener('input', () => {
                const term = input.value.trim().toLowerCase();
                if (term.length === 0) { list.style.display = 'none'; return; }

                const matches = [];
                actorProfiles.forEach(a => {
                    if (a.videos) {
                        a.videos.forEach(v => {
                            if (v.title.toLowerCase().includes(term)) {
                                matches.push({ ...v, parentName: a.name, parentId: a.id });
                            }
                        });
                    }
                });

                if (matches.length > 0) {
                    list.innerHTML = matches.map(v => 
                        `<div class="suggestion-item" data-json='${JSON.stringify(v)}'>üé¨ ${v.title} <small style="color:#aaa;">(${v.parentName})</small></div>`
                    ).join('');
                    list.style.display = 'block';

                    Array.from(list.children).forEach(div => {
                        div.onclick = () => {
                            const vData = JSON.parse(div.getAttribute('data-json'));
                            input.value = vData.title;
                            hidden.value = JSON.stringify({ id: vData.id, title: vData.title, parentId: vData.parentId });
                            list.style.display = 'none';
                        };
                    });
                } else { list.style.display = 'none'; }
            });

            document.addEventListener('click', (e) => {
                if (e.target !== input && e.target !== list) list.style.display = 'none';
            });
        }
        
        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            loadAllData(); updateHomeDisplay();
            setInterval(() => { if(document.getElementById('home').classList.contains('active')) updateHomeDisplay(); }, 60000);
            
            /// Setup New Selectors
        setupActorSelector('input-actor-search', 'actor-suggestions', 'selected-actors-box', 'tempActorsList');
        setupVideoSelector('input-video-search', 'video-suggestions', 'input-video-data');

        setupActorSelector('edit-actor-search', 'edit-actor-suggestions', 'edit-selected-actors-box', 'editTempActorsList');
        setupVideoSelector('edit-video-search', 'edit-video-suggestions', 'edit-video-data');
// Setup Partner Inputs
            setupPartnerInput('new');
            setupPartnerInput('edit');
            
            // Listen to Type Change
            const typeSelect = document.getElementById('input-type');
            const editTypeSelect = document.getElementById('edit-type');
            
            typeSelect.addEventListener('change', () => updateFormVisibility(''));
            editTypeSelect.addEventListener('change', () => updateFormVisibility('edit-'));
            
            // Init Visibility
            updateFormVisibility('');
            const tabs = document.querySelectorAll('.tab-item'); const sections = document.querySelectorAll('section');
            const timeInput = document.getElementById('input-timestamp'); timeInput.value = getNowInputValue();
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active')); sections.forEach(s => s.classList.remove('active'));
                    tab.classList.add('active'); const targetId = tab.getAttribute('data-target'); document.getElementById(targetId).classList.add('active'); document.getElementById('app-container').scrollTo(0, 0);
                    if(targetId==='home') updateHomeDisplay(); 
                    if(targetId==='diary'){renderCalendar();renderDiaryList();}
                    if(targetId==='driver') showDriverList();
                    if(targetId==='stats') { calculateStats(); checkAchievements(); } 
                    if(targetId==='record'){ timeInput.value = getNowInputValue(); tempRecordPhoto=""; document.getElementById('preview-photo').classList.remove('show'); document.getElementById('input-photo').value=""; }
                });
            });
            
            document.getElementById('record-form').addEventListener('submit', (e) => { 
                e.preventDefault(); 
                
                // Get Video Data
                const vidJson = document.getElementById('input-video-data').value;
                let videoObj = null;
                if(vidJson) { try { videoObj = JSON.parse(vidJson); } catch(e){} }
                
                // Get Actors Data (Clone array)
                const actorsArr = [...tempActorsList];
                const partnersArr = [...tempPartnerList];
                ejaculationRecords.unshift({ 
                    id: Date.now(), 
                    timestamp: document.getElementById('input-timestamp').value, 
                    type: document.getElementById('input-type').value, 
                    location: document.getElementById('input-location').value, 
                    note: document.getElementById('input-note').value, 
                    photo: tempRecordPhoto,
                    // Êñ∞Ë≥áÊñôÁµêÊßãÔºöÂàÜÈñãÂ≠ò
                    usedActors: actorsArr,
                    usedVideo: videoObj,partners: partnersArr
                }); 
                saveRecordData(); 
                
                const hasUnlocked = checkAchievements(() => { showAlert('Á¥ÄÈåÑÊàêÂäü üí¶'); });
                if (!hasUnlocked) { showAlert('Á¥ÄÈåÑÊàêÂäü üí¶'); }
                
                e.target.reset(); 
                // Clear fields
                tempActorsList = []; window['render_tempActorsList']();
                tempPartnerList = []; renderPartnerTags('new'); updateFormVisibility('');
                document.getElementById('input-video-data').value = "";
                document.getElementById('input-timestamp').value = getNowInputValue();
                tempRecordPhoto=""; document.getElementById('preview-photo').classList.remove('show'); document.querySelector('.tab-item[data-target="home"]').click(); 
            });
            
            document.getElementById('edit-record-form').addEventListener('submit', (e) => { 
                e.preventDefault(); 
                if(!editingRecordId)return; 
                const r = ejaculationRecords.find(rc=>rc.id===editingRecordId); 
                if(r){ 
                    r.timestamp=document.getElementById('edit-timestamp').value; 
                    r.type=document.getElementById('edit-type').value; 
                    r.location=document.getElementById('edit-location').value; 
                    r.note=document.getElementById('edit-note').value; 
                    r.photo=tempRecordPhoto; 
                    
                    // Update New Fields
                    const vidJson = document.getElementById('edit-video-data').value;
                    if(vidJson) { try { r.usedVideo = JSON.parse(vidJson); } catch(e){ r.usedVideo = null; } }
                    else if(document.getElementById('edit-video-search').value === "") { r.usedVideo = null; }
                    
                    r.usedActors = [...editTempActorsList];
                    r.partners = [...editTempPartnerList];
                    // Ê∏ÖÈô§ËàäÊ†ºÂºè‰ª•ÂÖçÊ∑∑Ê∑Ü
                    delete r.target;

                    saveRecordData(); renderDiaryList(); renderCalendar(); updateHomeDisplay(); checkAchievements(); closeEditModal(); showAlert('Â∑≤Êõ¥Êñ∞'); 
                } 
            });
            
            document.getElementById('actor-form').addEventListener('submit', (e) => { 
                e.preventDefault(); 
                const name = document.getElementById('actor-name').value; 
                const bio = document.getElementById('actor-bio').value; 
                const website = document.getElementById('actor-website').value;

                // Êñ∞Â¢ûÔºöËôïÁêÜ tags Â≠ó‰∏≤ËΩâÈô£ÂàóÔºåËá™ÂãïË£ú‰∏ä #
                const tagsStr = document.getElementById('actor-tags').value;
                const tags = tagsStr.split(/[\s,]+/) // Áî®Á©∫ÁôΩÊàñÈÄóËôüÂàáÂàÜ
                    .filter(t => t.trim() !== '')    // ÈÅéÊøæÁ©∫Â≠ó‰∏≤
                    .map(t => t.startsWith('#') ? t : '#' + t); // Ë£ú‰∏ä #

                const urlVal = document.getElementById('actor-avatar-url').value; 
                let finalAvatar = (urlVal && urlVal.trim()!=="") ? urlVal : tempActorAvatar; 
                
                if (editingActorId) { 
                    const actor = actorProfiles.find(a => a.id === editingActorId); 
                    if (actor) { 
                        actor.name = name; 
                        actor.avatar = finalAvatar; 
                        actor.bio = bio; 
                        actor.website = website; // ÂÑ≤Â≠ò website
                        actor.tags = tags; // ÂÑ≤Â≠ò tags
                        actor.lastUpdated = Date.now(); // Êõ¥Êñ∞ÊôÇÈñì
                        saveActorData(); renderActorDetail(); renderActorList(); 
                    } 
                } else { 
                    // Êñ∞Â¢û tags: tags
                    actorProfiles.unshift({ id: Date.now(), lastUpdated: Date.now(), name, avatar: finalAvatar, bio, website, tags: tags, videos: [] }); 
                    saveActorData(); renderActorList(); 
                } 
                closeActorFormModal(); 
            });

            document.getElementById('video-form').addEventListener('submit', (e) => { 
                e.preventDefault(); 
                const title = document.getElementById('video-title').value; 
                const url = document.getElementById('video-url').value; 
                const note = document.getElementById('video-note').value; 
                const urlVal = document.getElementById('video-thumb-url').value; 
                let finalThumb = (urlVal && urlVal.trim()!=="") ? urlVal : tempVideoThumb; 
                const actor = actorProfiles.find(a => a.id === currentActorId); 
                
                // Êõ¥Êñ∞Ë©≤‰∫∫Áâ©ÁöÑÊúÄÂæåÊõ¥Êñ∞ÊôÇÈñì
                actor.lastUpdated = Date.now();

                // Êñ∞Â¢ûÔºöËôïÁêÜ tags Â≠ó‰∏≤ËΩâÈô£Âàó
                const tagsStr = document.getElementById('video-tags').value;
                const tags = tagsStr.split(/[\s,]+/).filter(t => t.trim() !== '').map(t => t.startsWith('#') ? t : '#' + t);

                if (editingVideoId) { 
                    const v = actor.videos.find(v => v.id === editingVideoId); 
                    if (v) { 
                        v.title = title; 
                        v.url = url; 
                        v.thumbnail = finalThumb; 
                        v.note = note; 
                        v.tags = tags;
                    } 
                    
                    setTimeout(() => {
                        openVideoDetail(currentActorId, editingVideoId, true);
                    }, 100);
                } else { 
                    actor.videos.push({ id: Date.now(), title, url, thumbnail: finalThumb, note, tags }); 
                } 
                saveActorData(); 
                renderActorDetail(); 
                closeVideoFormModal(); 
            });

            // --- Hashtag Autocomplete Logic (Actor) ---
            setupCountrySearch(); // ÂïüÂãïÂúãÁ±çÊêúÂ∞ã

            // Â§•‰º¥Á∑®ËºØË°®ÂñÆÈÄÅÂá∫
            document.getElementById('partner-edit-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const p = partnerProfiles.find(x => x.name === currentPartnerName);
                if(!p) return;

                // Êõ¥Êñ∞ÂêçÂ≠ó (Ëã•ÊîπÂêçÔºåÈóúËÅØÁöÑÁ¥ÄÈåÑÊö´‰∏çÈÄ£ÂãïÔºåÈÄôÊúÉÊØîËºÉË§áÈõúÔºåÈÄôË£°ÂÉÖÊõ¥Êñ∞Ê™îÊ°à)
                // Âª∫Ë≠∞ÔºöÁ∞°ÂñÆËµ∑Ë¶ãÔºåÈÄôË£°ÂÖà‰∏çÂÖÅË®±ÊîπÂêçÂ≠óÔºåÊàñËÄÖÊîπÂêçÂæåÂè™Êõ¥Êñ∞Ê™îÊ°àÈ°ØÁ§∫
                const newName = document.getElementById('pf-name').value; 
                
                // ËôïÁêÜÁÖßÁâá
                const urlVal = document.getElementById('pf-url').value;
                const fileInput = document.getElementById('pf-file');
                let finalPhoto = p.photo;
                
                if (fileInput.files[0]) {
                    try { finalPhoto = await compressImage(fileInput.files[0]); } catch(e){}
                } else if (urlVal) {
                    finalPhoto = urlVal;
                }

                // ËôïÁêÜÂúãÁ±ç
                const nationData = document.getElementById('pf-nation-data').value;
                const nation = nationData ? JSON.parse(nationData) : null;

                // Êõ¥Êñ∞
                p.name = newName;
                p.photo = finalPhoto;
                p.nation = nation;
                p.race = document.getElementById('pf-race').value;
                
                // Â¶ÇÊûúÊîπ‰∫ÜÂêçÂ≠óÔºåÊõ¥Êñ∞ currentPartnerName ‰ª•‰æøÈáçÈñã Modal
                currentPartnerName = newName;

                savePartnerData();
                document.getElementById('partner-form-modal').classList.remove('active');
                showPartnerDetail(newName); // ÂõûÂà∞Ë©≥ÊÉÖÈ†Å
                renderPartnerGrid(); // Êõ¥Êñ∞ÂàóË°®
            });
            
            // È†êË¶ΩÂúñÁõ£ËÅΩ
            document.getElementById('pf-url').addEventListener('input', (e) => {
                if(e.target.value) document.getElementById('pf-preview').src = e.target.value;
            });
            document.getElementById('pf-file').addEventListener('change', async (e) => {
                if(e.target.files[0]) {
                    const b64 = await compressImage(e.target.files[0]);
                    document.getElementById('pf-preview').src = b64;
                }
            });
            const tagInput = document.getElementById('actor-tags');
            const tagList = document.getElementById('tag-suggestions');

            function getCommonTags() {
                const counts = {};
                // È†êË®≠Ê®ôÁ±§
                counts['#Daddy'] = 1; 
                counts['#Â∑®Â±å'] = 1;
                
                actorProfiles.forEach(a => {
                    if (a.tags) {
                        a.tags.forEach(t => counts[t] = (counts[t] || 0) + 1);
                    }
                });
                return Object.keys(counts).sort((a,b) => counts[b] - counts[a]);
            }

            function renderTagSuggestions(matches, currentWord) {
                tagList.innerHTML = matches.map(tag => `<div class="suggestion-item">${tag}</div>`).join('');
                
                Array.from(tagList.children).forEach(div => {
                    div.onclick = () => {
                        const fullTag = div.textContent;
                        const val = tagInput.value;
                        const cursor = tagInput.selectionStart;
                        const textBefore = val.slice(0, cursor);
                        const textAfter = val.slice(cursor);
                        const lastSpaceIndex = textBefore.lastIndexOf(' ');
                        const prefix = textBefore.slice(0, lastSpaceIndex + 1);
                        const newValue = prefix + fullTag + ' ' + textAfter;
                        
                        tagInput.value = newValue;
                        tagList.style.display = 'none';
                        tagInput.focus();
                    };
                });
            }

            if (tagInput && tagList) {
                tagInput.addEventListener('input', () => {
                    const val = tagInput.value;
                    const cursorPosition = tagInput.selectionStart;
                    const textBeforeCursor = val.slice(0, cursorPosition);
                    const words = textBeforeCursor.split(/\s+/);
                    const currentWord = words[words.length - 1];

                    if (currentWord.trim().length > 0) {
                        const allTags = getCommonTags();
                        const matches = allTags.filter(t => 
                            t.toLowerCase().includes(currentWord.toLowerCase()) || 
                            t.replace('#','').toLowerCase().includes(currentWord.toLowerCase())
                        );

                        if (matches.length > 0) {
                            renderTagSuggestions(matches, currentWord);
                            tagList.style.display = 'block';
                        } else {
                            tagList.style.display = 'none';
                        }
                    } else {
                        tagList.style.display = 'none';
                    }
                });

                document.addEventListener('click', (e) => {
                    if (e.target !== tagInput && e.target !== tagList) {
                        tagList.style.display = 'none';
                    }
                });
            }

            // --- Video Hashtag Logic ---
            function getVideoCommonTags() {
                const counts = { '#cum': 1, '#bukkake': 1 }; // È†êË®≠ÂÄº
                actorProfiles.forEach(a => {
                    if (a.videos) {
                        a.videos.forEach(v => {
                            if (v.tags) v.tags.forEach(t => counts[t] = (counts[t] || 0) + 1);
                        });
                    }
                });
                return Object.keys(counts).sort((a,b) => counts[b] - counts[a]);
            }

            const vidTagInput = document.getElementById('video-tags');
            const vidTagList = document.getElementById('video-tag-suggestions');

            if (vidTagInput && vidTagList) {
                vidTagInput.addEventListener('input', () => {
                    const val = vidTagInput.value;
                    const cursor = vidTagInput.selectionStart;
                    const textBefore = val.slice(0, cursor);
                    const words = textBefore.split(/\s+/);
                    const currentWord = words[words.length - 1];

                    if (currentWord.trim().length > 0) {
                        const allTags = getVideoCommonTags();
                        const matches = allTags.filter(t => 
                            t.toLowerCase().includes(currentWord.toLowerCase()) || 
                            t.replace('#','').toLowerCase().includes(currentWord.toLowerCase())
                        );
                        
                        if (matches.length > 0) {
                            vidTagList.innerHTML = matches.map(tag => `<div class="suggestion-item">${tag}</div>`).join('');
                            vidTagList.style.display = 'block';
                            
                            Array.from(vidTagList.children).forEach(div => {
                                div.onclick = () => {
                                    const fullTag = div.textContent;
                                    const currentVal = vidTagInput.value;
                                    const currentCursor = vidTagInput.selectionStart;
                                    const txtBefore = currentVal.slice(0, currentCursor);
                                    const txtAfter = currentVal.slice(currentCursor);
                                    const lastSpace = txtBefore.lastIndexOf(' ');
                                    const prefix = txtBefore.slice(0, lastSpace + 1);
                                    vidTagInput.value = prefix + fullTag + ' ' + txtAfter;
                                    vidTagList.style.display = 'none';
                                    vidTagInput.focus();
                                };
                            });
                        } else { vidTagList.style.display = 'none'; }
                    } else { vidTagList.style.display = 'none'; }
                });

                document.addEventListener('click', (e) => {
                    if (e.target !== vidTagInput && e.target !== vidTagList) {
                        vidTagList.style.display = 'none';
                    }
                });
            }
        });
        /* --- Tier List Logic (ÊéíË°åÊ¶úÂäüËÉΩ) --- */
    let currentTierMode = 'actor'; 

    // 1. ÈñãÂïüÊéíË°åÊ¶ú
    window.openTierList = function() {
        // Âà§Êñ∑ÁõÆÂâçÊòØ„ÄåÈõ≤Á´ØÊÉÖ‰∫∫„ÄçÈÇÑÊòØ„ÄåÊÄßÂ§•‰º¥„ÄçÊ®°Âºè
        const btns = document.querySelectorAll('.driver-header .toggle-btn');
        // Â¶ÇÊûúÁ¨¨‰∫åÈ°ÜÊåâÈàïÊúâ activeÔºå‰ª£Ë°®ÊòØ Partner Ê®°Âºè
        const isPartner = btns[1] && btns[1].classList.contains('active');
        
        currentTierMode = isPartner ? 'partner' : 'actor';
        
        // ÂàáÊèõÁï´Èù¢ÔºöÈö±ËóèÂàóË°®ÔºåÈ°ØÁ§∫ÊéíË°åÊ¶ú
        document.getElementById('driver-view-list').classList.remove('active');
        document.getElementById('driver-view-detail').classList.remove('active');
        document.getElementById('driver-view-tier').classList.add('active');
        
        // Êõ¥Êñ∞Ê®ôÈ°å
        document.querySelector('#driver-view-tier h2').textContent = 
            currentTierMode === 'actor' ? '‚òÅÔ∏è ÊÉÖ‰∫∫ÊéíË°åÊ¶ú' : 'üíû Â§•‰º¥ÊéíË°åÊ¶ú';

        renderTierList();
    };

    // 2. ÈóúÈñâÊéíË°åÊ¶ú
    window.closeTierList = function() {
        document.getElementById('driver-view-tier').classList.remove('active');
        document.getElementById('driver-view-list').classList.add('active');
    };

    // 3. Ê∏≤ÊüìÊéíË°åÊ¶úÁï´Èù¢
    window.renderTierList = function() {
        // Ê∏ÖÁ©∫Áï´Èù¢
        document.querySelectorAll('.tier-content').forEach(el => el.innerHTML = '');
        const pool = document.getElementById('tier-pool');
        pool.innerHTML = '';

        // ÂèñÂæóË≥áÊñô
        let data = currentTierMode === 'actor' ? actorProfiles : partnerProfiles;
        
        // Á¢∫‰øùÂ§•‰º¥Ë≥áÊñôÊúâÂêåÊ≠•
        if(currentTierMode === 'partner' && window.syncPartnersFromRecords) window.syncPartnersFromRecords();

        data.forEach(item => {
            const tier = item.tier || 'unranked'; // È†êË®≠ÁÇ∫Êú™ÂàÜÁ¥ö
            const img = item.avatar || item.photo || DEFAULT_AVATAR;
            const id = currentTierMode === 'actor' ? item.id : item.name;

            const imgEl = document.createElement('img');
            imgEl.src = img;
            imgEl.className = 'tier-avatar';
            imgEl.draggable = true;
            
            // Á∂ÅÂÆö‰∫ã‰ª∂ (ÊâãÊ©üÈï∑Êåâ / ÈõªËÖ¶ÊãñÊõ≥)
            imgEl.ontouchstart = (e) => handleTouchStart(e, id);
            imgEl.ondragstart = (e) => drag(e, id);
            imgEl.onclick = () => showAlert(`ÈÄôÊòØÔºö${item.name}`);

            // ÊîæÂÖ•Â∞çÊáâÁöÑÊ†ºÂ≠ê
            if (['S','A','B','C','D'].includes(tier)) {
                const map = {'S':0, 'A':1, 'B':2, 'C':3, 'D':4};
                const container = document.querySelectorAll('.tier-content')[map[tier]];
                if(container) container.appendChild(imgEl);
            } else {
                pool.appendChild(imgEl);
            }
        });
    };

    // --- ÊãñÊõ≥ÂäüËÉΩ (ÈõªËÖ¶Áâà) ---
    let draggedId = null;
    window.allowDrop = function(ev) { ev.preventDefault(); };
    window.drag = function(ev, id) { draggedId = id; ev.dataTransfer.setData("text", id); };
    window.drop = function(ev, targetTier) { ev.preventDefault(); updateTierData(draggedId, targetTier); };

    // --- Êõ¥Êñ∞Ë≥áÊñôÈÇèËºØ ---
    function updateTierData(id, targetTier) {
        let dataList = currentTierMode === 'actor' ? actorProfiles : partnerProfiles;
        let item = null;
        
        if (currentTierMode === 'actor') {
            item = dataList.find(x => x.id == id);
        } else {
            item = dataList.find(x => x.name === id);
        }

        if (item) {
            item.tier = targetTier;
            renderTierList(); // ÈáçÊñ∞Êï¥ÁêÜÁï´Èù¢
            saveTierList(true); // Ëá™ÂãïÂÑ≤Â≠ò
        }
    }

    // --- ÂÑ≤Â≠òÂäüËÉΩ ---
    window.saveTierList = function(silent = false) {
        if (currentTierMode === 'actor') saveActorData();
        else savePartnerData();
        if(!silent) showAlert('ÊéíË°åÊ¶úÂ∑≤ÂÑ≤Â≠òÔºÅ');
    };

    // --- ÊâãÊ©üÁâàÊìç‰Ωú (Èï∑ÊåâË∑≥Âá∫ÈÅ∏ÂñÆ) ---
    // Âõ† iPhone Â∞çÁ∂≤È†ÅÊãñÊõ≥ÊîØÊè¥Â∫¶‰∏ç‰Ω≥ÔºåÊîπÁî®Èï∑ÊåâÈÅ∏ÂñÆÊúÄÁ©©ÂÆö
    let touchTimer = null;
    function handleTouchStart(e, id) {
        // Èï∑Êåâ 0.5 ÁßíÂæåËß∏Áôº
        touchTimer = setTimeout(() => {
            showTierSelectModal(id);
        }, 500);
    }
    // Â¶ÇÊûúÊâãÊîæÈñãÔºåÂ∞±ÂèñÊ∂àË®àÊôÇ
    document.addEventListener('touchend', () => clearTimeout(touchTimer));

    function showTierSelectModal(id) {
        const tiers = ['S', 'A', 'B', 'C', 'D', 'unranked'];
        const btns = tiers.map(t => 
            `<button class="btn-base" onclick="updateTierData('${id}', '${t}');closeSystemModal()" style="margin:2px;width:45%;display:inline-block;background:#eee;">${t==='unranked'?'üëá ÁßªÂõû‰∏ãÊñπ':t+' Á¥ö'}</button>`
        ).join('');
        
        document.getElementById('sys-title').textContent = "ÁßªÂãïÂà∞Âì™ÂÄãÁ≠âÁ¥öÔºü";
        document.getElementById('sys-msg').innerHTML = ""; 
        document.getElementById('sys-actions').innerHTML = `<div style="text-align:center;">${btns}</div>`;
        document.getElementById('system-modal').classList.add('active');
    }
    </script>
</body>
</html>