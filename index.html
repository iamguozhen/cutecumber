<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="CuteCumber - ä½ çš„ç§äººå¥åº·ç´€éŒ„åŠ©æ‰‹">
    
    <!-- iOS / PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="CuteCumber">
    <meta name="theme-color" content="#F8F9FA">
    
    <!-- Icons -->
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="icon" type="image/png" href="icons/icon-192.png">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <title>CuteCumber</title>

    <style>
        :root {
            --color-primary: #76C846;
            --color-bg: #F8F9FA;
            --color-text: #333333;
            --color-accent: #FF69B4;
            --color-danger: #FF4757;
            --color-gold: #FFD700;
            --color-input-bg: #FFFFFF;
            --color-border: #E5E7EB;
            --color-card-bg: #FFFFFF;
            --tab-height: 60px;
            --safe-area-bottom: env(safe-area-inset-bottom);
            --safe-area-top: env(safe-area-inset-top);
        }

        /* --- Global Reset --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            overscroll-behavior-y: none;
            user-select: none; -webkit-user-select: none;
            height: 100vh; height: 100dvh; width: 100vw;
            display: flex; flex-direction: column; overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Dark Mode Definitions */
        body.dark-mode {
            --color-bg: #121212;
            --color-text: #e0e0e0;
            --color-card-bg: #1e1e1e;
            --color-input-bg: #2c2c2c;
            --color-border: #333333;
            --theme-color: #121212; /* Sync meta theme color logic needed in JS if strictly required */
        }
        
        /* Dark Mode Specific Overrides */
        body.dark-mode .hero-section { box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        body.dark-mode #home-message { background: #252525; color: #aaa; border-left-color: var(--color-accent); }
        body.dark-mode .recent-card, body.dark-mode .diary-card, body.dark-mode .settings-card, body.dark-mode .metric-card, body.dark-mode .chart-container, body.dark-mode .year-item, body.dark-mode .form-panel { border-color: #333; }
        body.dark-mode .recent-icon-box { background: #333; }
        body.dark-mode .recent-date { color: #fff; }
        body.dark-mode .recent-location { background: #333; color: #bbb; }
        body.dark-mode .tab-item { color: #666; }
        body.dark-mode .tab-item.active { color: var(--color-primary); }
        body.dark-mode #tab-bar { background-color: rgba(30, 30, 30, 0.95); border-top: 1px solid #333; }
        body.dark-mode h1, body.dark-mode .calendar-title, body.dark-mode .detail-date, body.dark-mode .section-header, body.dark-mode .metric-value, body.dark-mode .unlock-title, body.dark-mode .system-modal-title { color: #fff; }
        body.dark-mode .form-label, body.dark-mode .metric-title, body.dark-mode .settings-title { color: #bbb; }
        body.dark-mode .modal-content-bottom, body.dark-mode .system-modal-content, body.dark-mode .unlock-modal-content, body.dark-mode .modal-content { background: #1e1e1e; color: #eee; }
        body.dark-mode .calendar-day { background: #252525; color: #fff; border-color: #333; }
        body.dark-mode .calendar-day.empty { background: transparent; border-color: transparent; }
        body.dark-mode .calendar-day.today { border-color: var(--color-accent); color: var(--color-accent); }
        body.dark-mode .calendar-day.has-record { background: rgba(118, 200, 70, 0.2); }
        body.dark-mode .detail-profile, body.dark-mode .detail-note-box, body.dark-mode .vid-detail-note { background: #252525; border-color: #333; color: #ddd; }
        body.dark-mode .video-card { background: #252525; border-color: #333; }
        body.dark-mode .video-card-title, body.dark-mode .vid-detail-title, body.dark-mode .detail-name, body.dark-mode .actor-name { color: #fff; }
        body.dark-mode .video-thumb-box { border-color: #333; background: #2c2c2c; }
        body.dark-mode .ach-card { background: #252525; border-color: #333; }
        body.dark-mode .ach-card.unlocked { background: linear-gradient(135deg, #2c2c2c 0%, #3a3a3a 100%); border-color: var(--color-gold); }
        body.dark-mode .ach-category-title { color: #bbb; }
        body.dark-mode .photo-placeholder { background: #333; }
        body.dark-mode .btn-close { background: #333; color: #fff; }
        body.dark-mode .view-toggle { background: #333; }
        body.dark-mode .toggle-btn { color: #888; }
        body.dark-mode .toggle-btn.active { background: #555; color: var(--color-primary); }
        body.dark-mode .ach-info-desc { background: #2c2c2c; color: #ddd; }
        body.dark-mode .btn-settings { background: rgba(50,50,50,0.8); color: #fff; }
        body.dark-mode .form-control { background-color: #2c2c2c; color: #fff; border-color: #444; }
        body.dark-mode select { background-color: #2c2c2c; color: #fff; }
        
        /* Search Input */
        .search-container { margin-bottom: 15px; }
        .search-input { 
            border-radius: 20px; 
            padding: 10px 15px; 
            font-size: 14px; 
            background-color: #f0f0f0; 
            border: none; 
            width: 100%;
            outline: none;
            transition: all 0.2s;
        }
        .search-input:focus { 
            background-color: #fff; 
            box-shadow: 0 0 0 2px var(--color-primary); 
        }
        /* Dark mode for search */
        body.dark-mode .search-input { 
            background-color: #2c2c2c; 
            color: #fff; 
        }
        body.dark-mode .search-input:focus { 
            background-color: #3a3a3a; 
        }

        img, canvas, svg { max-width: 100%; display: block; }

        #app-container {
            flex: 1; width: 100%; overflow-y: auto; overflow-x: hidden;
            -webkit-overflow-scrolling: touch; position: relative;
            padding-bottom: calc(var(--tab-height) + var(--safe-area-bottom) + 30px);
        }

        body.hide-tabs #app-container { padding-bottom: var(--safe-area-bottom); }

        section {
            display: none; width: 100%; padding: 20px;
            padding-top: calc(var(--safe-area-top) + 20px);
            animation: fadeIn 0.25s ease-out;
        }
        section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Components --- */
        h1 { font-size: 24px; font-weight: 800; margin-bottom: 20px; color: var(--color-text); line-height: 1.2; }
        .btn-base { border: none; cursor: pointer; border-radius: 12px; font-weight: bold; transition: transform 0.1s; display: flex; align-items: center; justify-content: center; font-size: 14px; padding: 12px; }
        .btn-base:active { transform: scale(0.96); }
        .btn-primary { background: var(--color-primary); color: white; box-shadow: 0 4px 10px rgba(118, 200, 70, 0.3); }
        .btn-accent { background: var(--color-accent); color: white; box-shadow: 0 4px 10px rgba(255, 105, 180, 0.3); }
        .btn-danger { background: #ffeaea; color: var(--color-danger); }
        .btn-gold { background: var(--color-gold); color: #875800; box-shadow: 0 4px 10px rgba(255, 215, 0, 0.3); }
        .btn-close { background: #eee; width: 32px; height: 32px; border-radius: 50%; border: none; font-size: 20px; color: #666; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;}
        .btn-outline { background: var(--color-card-bg); border: 1px solid var(--color-border); color: var(--color-text); }
        .btn-settings { position: absolute; top: calc(var(--safe-area-top) + 20px); left: 20px; width: 40px; height: 40px; background: rgba(255,255,255,0.8); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; z-index: 10; color: #555; }

        /* --- Toggle Switch CSS --- */
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; vertical-align: middle; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--color-primary); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* --- Forms --- */
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 14px; font-weight: 600; color: #666; margin-bottom: 8px; }
        .form-control { width: 100%; padding: 14px; font-size: 16px; border: 1px solid var(--color-border); border-radius: 12px; background-color: var(--color-input-bg); color: var(--color-text); outline: none; -webkit-appearance: none; appearance: none; }
        .form-control:focus { border-color: var(--color-primary); }
        textarea.form-control { resize: none; min-height: 80px; font-family: inherit; }
        .photo-upload-label { display: flex; align-items: center; justify-content: center; width: 100%; padding: 12px; background: rgba(118, 200, 70, 0.1); border: 2px dashed var(--color-primary); border-radius: 12px; color: var(--color-primary); font-weight: bold; font-size: 14px; cursor: pointer; transition: all 0.2s; margin-top: 8px; }
        .photo-preview { width: 100%; height: auto; max-height: 200px; object-fit: contain; border-radius: 12px; margin-top: 10px; display: none; border: 1px solid var(--color-border); background: var(--color-bg); }
        .photo-preview.show { display: block; }

        /* --- Footer Nav --- */
        #tab-bar { position: fixed; bottom: 0; left: 0; right: 0; width: 100%; height: calc(var(--tab-height) + var(--safe-area-bottom)); background-color: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-top: 1px solid rgba(0,0,0,0.05); display: flex; justify-content: space-around; align-items: flex-start; padding-top: 8px; padding-bottom: var(--safe-area-bottom); z-index: 1000; transition: transform 0.3s ease; }
        body.hide-tabs #tab-bar { transform: translateY(100%); }
        .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border: none; background: none; cursor: pointer; transition: all 0.2s ease; color: #999; height: 50px; }
        .tab-icon { font-size: 24px; margin-bottom: 2px; transition: transform 0.1s; }
        .tab-label { font-size: 10px; font-weight: 500; }
        .tab-item:active .tab-icon { transform: scale(0.9); }
        .tab-item.active { color: var(--color-primary); }
        .tab-item[data-target="driver"].active { color: var(--color-accent); }

        /* --- Home --- */
        .hero-section { background: var(--color-card-bg); border-radius: 24px; padding: 30px 24px; text-align: center; box-shadow: 0 4px 20px rgba(118, 200, 70, 0.15); margin-bottom: 20px; position: relative; overflow: hidden; min-height: 200px; display: flex; flex-direction: column; justify-content: center; }
        .hero-label { font-size: 14px; color: #888; letter-spacing: 1px; margin-bottom: 5px; font-weight: 600; }
        .hero-timer { font-size: 48px; font-weight: 900; color: var(--color-primary); font-variant-numeric: tabular-nums; line-height: 1.1; margin: 5px 0 15px 0; }
        #home-message { font-size: 15px; color: #555; line-height: 1.5; background: #f9fafb; padding: 12px 16px; border-radius: 12px; margin-top: 10px; font-style: italic; border-left: 4px solid var(--color-accent); text-align: left; }
        .recent-list-header { font-size: 14px; color: #999; font-weight: 600; margin-bottom: 10px; padding-left: 4px; }
        .recent-card { background: var(--color-card-bg); border-radius: 16px; padding: 16px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 12px rgba(0,0,0,0.04); margin-bottom: 12px; border: 1px solid var(--color-border); }
        .recent-icon-box { width: 48px; height: 48px; border-radius: 50%; background: #f3f4f6; display: flex; align-items: center; justify-content: center; font-size: 24px; margin-right: 15px; flex-shrink: 0; }
        .recent-info { flex: 1; display: flex; flex-direction: column; justify-content: center; min-width: 0; }
        .recent-date { font-weight: 700; font-size: 16px; color: #333; margin-bottom: 4px; }
        .recent-meta { font-size: 12px; color: #888; display: flex; align-items: center; gap: 6px; }
        .recent-location { background: #f0f0f0; color: #666; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; white-space: nowrap; max-width: 80px; overflow: hidden; text-overflow: ellipsis; flex-shrink: 0; }
         
        /* === å¤©ä½¿èˆ‡æƒ¡é­”äº’å‹•å€ === */
        .duo-stage {
            display: flex; justify-content: space-between; align-items: flex-end;
            padding: 10px 20px; margin-bottom: 20px; height: 140px;
            background: transparent; position: relative;
        }
        .vs-icon {
            font-size: 20px; font-weight: 900; color: #ddd; opacity: 0.5;
            margin-bottom: 20px; font-style: italic;
        }
        
        .character {
            display: flex; flex-direction: column; align-items: center;
            width: 45%; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0.5; transform: scale(0.9); filter: grayscale(0.8);
            cursor: pointer; position: relative;
        }
        .avatar-wrapper { position: relative; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; }
        .avatar { font-size: 50px; z-index: 2; transition: transform 0.2s; }
        .character:active .avatar { transform: scale(0.9); }
        .char-name { font-size: 12px; font-weight: bold; margin-top: 5px; color: #999; }

        /* å°è©±æ¡† */
        .bubble {
            background: #fff; border-radius: 12px; padding: 8px 10px;
            font-size: 12px; color: #333; margin-bottom: 8px;
            position: absolute; bottom: 85px; width: 140px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); border: 1px solid #eee;
            opacity: 0; transform: translateY(10px) scale(0.8);
            transition: all 0.3s ease; pointer-events: none; z-index: 20;
            text-align: center; line-height: 1.4;
        }
        .bubble::after {
            content: ''; position: absolute; bottom: -6px; left: 50%; margin-left: -6px;
            width: 0; height: 0; border-left: 6px solid transparent;
            border-right: 6px solid transparent; border-top: 6px solid #fff;
        }

        /* æ´»èºç‹€æ…‹ (ç²å‹è€…) */
        .character.winning {
            opacity: 1; transform: scale(1.1); filter: grayscale(0);
        }
        .character.winning .bubble {
            opacity: 1; transform: translateY(0) scale(1);
        }
        .character.winning .avatar {
            animation: bounceChar 2s infinite;
        }

        /* å¤©ä½¿ç‰¹æ•ˆ */
        #char-angel.winning .halo {
            position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
            width: 40px; height: 10px; border-radius: 50%;
            border: 2px solid gold; box-shadow: 0 0 10px gold;
            animation: floatHalo 2s infinite ease-in-out;
        }
        #char-angel .bubble { border: 1px solid #76C846; color: #2e7d32; }

        /* æƒ¡é­”ç‰¹æ•ˆ */
        #char-demon.winning .fire {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, rgba(255,0,0,0.4) 0%, rgba(0,0,0,0) 70%);
            animation: pulseFire 1s infinite; z-index: 1; border-radius: 50%;
        }
        #char-demon .bubble { border: 1px solid #FF4757; color: #c0392b; }

        /* é»æ“Šæ™‚å¼·åˆ¶èªªè©±æ¨£å¼ */
        .character.talking .bubble { opacity: 1 !important; transform: translateY(0) scale(1) !important; z-index: 30; }

        @keyframes bounceChar { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes floatHalo { 0%, 100% { top: -10px; opacity: 0.5; } 50% { top: -15px; opacity: 1; } }
        @keyframes pulseFire { 0% { transform: scale(0.8); opacity: 0.5; } 50% { transform: scale(1.2); opacity: 0.8; } 100% { transform: scale(0.8); opacity: 0.5; } }
        
        /* Dark Mode */
        body.dark-mode .bubble { background: #333; color: #fff; border-color: #444 !important; }
        body.dark-mode .bubble::after { border-top-color: #333; }
        body.dark-mode .vs-icon { color: #444; }

        /* --- Stats Layout --- */
        .stats-toggle-container { margin-bottom: 20px; position: sticky; top: 0; z-index: 90; }
        .stats-metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px; }
        .metric-card { background: var(--color-card-bg); padding: 16px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); text-align: center; border: 1px solid var(--color-border); display: flex; flex-direction: column; justify-content: center; min-height: 100px; }
        .metric-title { font-size: 11px; color: #888; font-weight: 600; margin-bottom: 4px; text-transform: uppercase; white-space: nowrap; }
        .metric-value { font-size: clamp(1.8rem, 6vw, 2.4rem); font-weight: 800; color: var(--color-primary); line-height: 1.1; }
        .metric-unit { font-size: 12px; color: #aaa; margin-left: 2px; font-weight: 500;}
        .chart-container { background: var(--color-card-bg); padding: 20px; padding-bottom: 30px; border-radius: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid var(--color-border); margin-bottom: 30px; position: relative; height: 350px; width: 100%; }
        .section-header { font-size: 16px; font-weight: bold; color: #333; margin-bottom: 15px; padding-left: 8px; border-left: 4px solid var(--color-primary); line-height: 1; }
        .empty-stats { text-align: center; padding: 60px 20px; color: #999; display: none; }
        .year-item { background: var(--color-card-bg); padding: 15px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.03); border: 1px solid var(--color-border); margin-bottom: 10px; }
        .year-info { display: flex; justify-content: space-between; font-weight: bold; color: var(--color-text); margin-bottom: 6px; font-size: 15px; }
        .year-bar-bg { height: 6px; background: var(--color-bg); border-radius: 3px; overflow: hidden; width: 100%; border: 1px solid var(--color-border); }
        .year-bar-fill { height: 100%; background: var(--color-primary); width: 0%; transition: width 1s ease-out; }
        
        .ach-category-title { font-size: 14px; font-weight: 800; color: #555; margin: 20px 0 10px 4px; display: flex; align-items: center; }
        .ach-category-title::before { content: ''; display: inline-block; width: 4px; height: 14px; background: var(--color-accent); margin-right: 8px; border-radius: 2px; }
        .ach-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 12px; padding-bottom: 40px; }
        .ach-card { background: var(--color-card-bg); border-radius: 12px; aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 8px; position: relative; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: transform 0.1s; cursor: pointer; border: 2px solid transparent; }
        .ach-card:active { transform: scale(0.95); }
        .ach-card.locked { background: var(--color-bg); }
        .ach-card.locked .ach-icon { filter: grayscale(100%); opacity: 0.3; font-size: 32px; }
        .ach-card.locked .ach-title { color: #aaa; font-size: 10px; margin-top: 5px; }
        .ach-card.unlocked { background: linear-gradient(135deg, var(--color-card-bg) 0%, rgba(255, 215, 0, 0.1) 100%); border-color: var(--color-gold); box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2); }
        .ach-card.unlocked .ach-icon { font-size: 36px; animation: bounce 2s infinite; }
        .ach-card.unlocked .ach-title { font-weight: bold; color: #d48806; font-size: 11px; margin-top: 5px; text-align: center; width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
        .ach-info-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 13px; color: #666; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        .ach-info-label { font-weight: bold; }
        .ach-info-desc { background: #f9f9f9; padding: 15px; border-radius: 12px; font-size: 14px; line-height: 1.5; color: #555; font-style: italic; border-left: 4px solid var(--color-gold); }

        /* --- Modals --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px); }
        .modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
        .modal-overlay.bottom-sheet { align-items: flex-end; }
        .modal-content-bottom { background: var(--color-card-bg); width: 100%; border-radius: 24px 24px 0 0; padding: 24px; padding-bottom: max(24px, env(safe-area-inset-bottom)); max-height: 85vh; overflow-y: auto; animation: slideUp 0.3s ease-out; box-shadow: 0 -5px 25px rgba(0,0,0,0.1); color: var(--color-text); }
        .unlock-modal-content { background: var(--color-card-bg); width: 85%; max-width: 320px; border-radius: 24px; padding: 30px 20px; text-align: center; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.3); animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; flex-direction: column; align-items: center; }
        .unlock-icon-wrapper { width: 80px; height: 80px; background: rgba(255, 215, 0, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; margin-bottom: 20px; border: 4px solid var(--color-gold); box-shadow: 0 0 20px rgba(255, 215, 0, 0.4); }
        .unlock-title { font-size: 20px; font-weight: 800; color: var(--color-text); margin-bottom: 10px; }
        .unlock-msg { font-size: 15px; color: #666; line-height: 1.5; margin-bottom: 25px; white-space: pre-wrap; }
        .unlock-confetti { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; border-radius: 24px; }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        #system-modal { z-index: 3000; }
        .system-modal-content { background: var(--color-card-bg); width: 85%; max-width: 300px; border-radius: 20px; padding: 24px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: popIn 0.2s ease-out; }
        .system-modal-title { font-size: 18px; font-weight: 700; color: var(--color-text); margin-bottom: 10px; }
        .system-modal-msg { font-size: 15px; color: #666; margin-bottom: 20px; line-height: 1.5; white-space: pre-wrap; }
        .system-modal-actions { display: flex; gap: 10px; justify-content: center; }

        .settings-header { display: flex; align-items: center; gap: 15px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #eee; } .settings-card { background: var(--color-card-bg); border-radius: 16px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid var(--color-border); margin-bottom: 20px; } .settings-title { font-size: 14px; font-weight: 600; color: #888; text-transform: uppercase; margin-bottom: 15px; letter-spacing: 0.5px; border-left: 3px solid var(--color-primary); padding-left: 8px; } .settings-desc { font-size: 13px; color: #666; margin-bottom: 15px; line-height: 1.5; }
        .view-toggle { display: flex; background: var(--color-border); border-radius: 12px; padding: 4px; margin-bottom: 20px; flex-shrink: 0; }
        .toggle-btn { flex: 1; padding: 8px; border: none; background: transparent; border-radius: 8px; font-size: 13px; font-weight: 600; color: #666; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .toggle-btn.active { background: var(--color-card-bg); color: var(--color-primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; } .calendar-title { font-size: 18px; font-weight: 800; color: var(--color-text); } .calendar-nav-btn { background: none; border: none; padding: 5px 15px; font-size: 20px; color: var(--color-primary); cursor: pointer; } .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; text-align: center; } .calendar-day { aspect-ratio: 1; border-radius: 10px; background: var(--color-card-bg); display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 13px; font-weight: 500; color: var(--color-text); border: 1px solid transparent; cursor: pointer; } .calendar-day.today { border-color: var(--color-accent); color: var(--color-accent); font-weight: bold; } .calendar-day.has-record { background: rgba(118, 200, 70, 0.12); color: #2e7d32; } .calendar-drops { display: flex; gap: 2px; margin-top: 2px; height: 4px; } .drop-dot { width: 4px; height: 4px; background-color: var(--color-primary); border-radius: 50%; }
        /* === æ—¥æ›†ç†±åŠ›åœ–é…è‰² === */

/* åŸºç¤æ¨£å¼å¾®èª¿ */
.calendar-day {
    transition: background-color 0.2s, color 0.2s;
    border: 1px solid transparent; /* ä¿æŒé‚Šæ¡†ä½ç½® */
}

/* 1. è‡ªæ…°ç­‰ç´š (ç¶ è‰²ç³») */
/* 1æ¬¡ï¼šæ·ºç¶  */
.calendar-day.level-1 { 
    background-color: rgba(118, 200, 70, 0.25); 
    color: var(--color-text); 
}
/* 2æ¬¡ï¼šä¸­ç¶  (æ–‡å­—è®Šç™½ä»¥åˆ©é–±è®€) */
.calendar-day.level-2 { 
    background-color: rgba(118, 200, 70, 0.65); 
    color: #fff !important; 
    text-shadow: 0 1px 2px rgba(0,0,0,0.2);
}
/* 3æ¬¡ä»¥ä¸Šï¼šæ·±ç¶  (ä¸»è‰²) */
.calendar-day.level-3 { 
    background-color: var(--color-primary); /* #76C846 */
    color: #fff !important; 
    font-weight: 900;
    box-shadow: 0 2px 5px rgba(118, 200, 70, 0.4);
}

/* 2. åšæ„› (ç²‰ç´…è‰²) */
.calendar-day.type-sex {
    background-color: var(--color-accent); /* #FF69B4 */
    color: #fff !important;
    font-weight: 900;
    box-shadow: 0 2px 5px rgba(255, 105, 180, 0.4);
}

/* 3. å¤¢éº (æ·ºè—è‰²) */
.calendar-day.type-wet {
    background-color: #89CFF0; /* æ·ºå¤©ç©ºè— */
    color: #fff !important;
}

/* ç§»é™¤åŸæœ¬çš„é»é»æ¨£å¼ (å¦‚æœé‚„åœ¨çš„è©±å¯ä»¥åˆªé™¤ï¼Œæˆ–ç”¨é€™è¡Œéš±è—) */
.calendar-drops { display: none !important; }

/* === ğŸŒ™ æ·±è‰²æ¨¡å¼å°ˆç”¨è£œä¸ (è«‹è²¼åœ¨åŸæœ¬çš„ CSS ä¸‹æ–¹) === */

/* 1. åŸºç¤æ ¼å­ï¼šåŠ ä¸Šæ·±ç°é‚Šæ¡†ï¼Œè®“æ ¼å­åœ¨é»‘åº•ä¸­ç²’ç²’åˆ†æ˜ */
body.dark-mode .calendar-day {
    border: 1px solid #333; 
    color: #eee;
}

/* 2. è‡ªæ…°ç­‰ç´š (ç¶ è‰²ç³») - æ”¹ç”¨è¢å…‰ç¶ ï¼Œå¢åŠ é€šé€æ„Ÿ */
body.dark-mode .calendar-day.level-1 {
    background-color: rgba(118, 200, 70, 0.3); /* é™ä½é€æ˜åº¦ï¼Œéš±ç´„ç™¼å…‰ */
    color: #fff;
}
body.dark-mode .calendar-day.level-2 {
    background-color: rgba(118, 200, 70, 0.6); /* åŠ äº® */
    color: #fff !important;
    text-shadow: 0 0 5px rgba(0,0,0,0.8);      /* åŠ å¼·é™°å½±è®“å­—æ›´æ¸…æ¥š */
}
body.dark-mode .calendar-day.level-3 {
    background-color: #5cad2c;                 /* å¯¦å¿ƒæ·±ç¶  */
    box-shadow: 0 0 8px rgba(118, 200, 70, 0.6); /* å¢åŠ éœ“è™¹å…‰æšˆ */
}

/* 3. åšæ„› (ç²‰ç´…è‰²) - ç¨å¾®èª¿æ·±ï¼Œä¸¦å¢åŠ ç²‰ç´…å…‰æšˆ */
body.dark-mode .calendar-day.type-sex {
    background-color: #D1478D; 
    box-shadow: 0 0 8px rgba(255, 105, 180, 0.5);
}

/* 4. å¤¢éº (æ·ºè—è‰²) - ğŸ”¥ é€™æ˜¯æœ€éœ€è¦ä¿®çš„ */
/* åŸæœ¬çš„æ·ºè—å¤ªäº®ï¼Œé…ç™½å­—æœƒçœ‹ä¸åˆ°ã€‚æ”¹æˆã€Œæ·±å¤©ç©ºè—ã€ï¼Œå°æ¯”æ‰å¤  */
body.dark-mode .calendar-day.type-wet {
    background-color: #4A90E2; 
    color: #fff !important;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
}

/* 5. ç¢ºä¿ã€Œä»Šå¤©ã€çš„é»ƒè‰²åœˆåœˆåœ¨æ·±è‰²æ¨¡å¼ä¸‹å¤ æ˜é¡¯ */
body.dark-mode .calendar-day.today {
    border: 2px solid #FFD700;
    background-color: rgba(255, 215, 0, 0.15);
}
        /* === æ—¥è¨˜åˆ—è¡¨æ¨£å¼å„ªåŒ–ç‰ˆ (è«‹ç›´æ¥å–ä»£èˆŠçš„) === */

.diary-card { 
    background: var(--color-card-bg); 
    border-radius: 16px; 
    padding: 15px; 
    display: flex; 
    align-items: center; 
    justify-content: space-between; 
    box-shadow: 0 2px 8px rgba(0,0,0,0.03); 
    border: 1px solid var(--color-border); 
    margin-bottom: 12px; 
    cursor: pointer; 
    min-height: 80px; 
}

.diary-left { 
    display: flex; 
    gap: 12px; 
    align-items: center; 
    flex: 1; 
    overflow: hidden; 
    min-width: 0; 
    padding-top: 4px;    /* å„ªåŒ–ï¼šå¢åŠ ä¸€é»å‚ç›´ç©ºé–“ */
    padding-bottom: 4px;
}

.diary-date-box { 
    display: flex; 
    flex-direction: column; 
    align-items: center; 
    justify-content: center; /* å„ªåŒ–ï¼šç¢ºä¿å‚ç›´ç½®ä¸­ */
    width: 65px;             /* å„ªåŒ–ï¼šå›ºå®šå¯¬åº¦ï¼Œè§£æ±ºå°ä¸é½Šçš„å•é¡Œ */
    min-width: 65px;         /* å„ªåŒ–ï¼šé–æ­»å¯¬åº¦ */
    padding-right: 10px; 
    border-right: 2px solid #f0f0f0; /* å„ªåŒ–ï¼šç·šæ¢ç¨å¾®åŠ ç²—ä¸€é»é»æ¯”è¼ƒå¥½çœ‹ */
    flex-shrink: 0; 
}

.diary-day { 
    font-size: 16px;         /* å„ªåŒ–ï¼šç¨å¾®ç¸®å°ä»¥å…å¤ªæ“  */
    font-weight: 800; 
    color: var(--color-text); 
    font-variant-numeric: tabular-nums; /* å„ªåŒ–ï¼šæ•¸å­—ç­‰å¯¬è¨­å®šï¼Œè®“ 1 å’Œ 0 ä¸€æ¨£å¯¬ */
    text-align: center;
}

.diary-time { 
    font-size: 11px; 
    color: #999; 
    margin-top: 2px; 
}

.diary-content { 
    display: flex; 
    flex-direction: column; 
    justify-content: center; 
    flex: 1; 
    overflow: hidden; 
    min-width: 0; 
}

.diary-title { 
    font-size: 16px; 
    font-weight: bold; 
    margin-bottom: 4px; 
    display: flex; 
    flex-wrap: wrap;       /* å„ªåŒ–ï¼šå…è¨±æ¨™ç±¤æ›è¡Œ */
    align-items: center; 
    gap: 6px; 
    line-height: 1.4;      /* å„ªåŒ–ï¼šå¢åŠ è¡Œé«˜ */
    white-space: normal;   /* å„ªåŒ–ï¼šå…è¨±æ–‡å­—æ­£å¸¸æ›è¡Œ */
}

.diary-meta { 
    font-size: 12px; 
    color: #888; 
    display: flex; 
    align-items: center; 
    gap: 4px; 
}

.diary-note { 
    font-size: 12px; 
    color: #aaa; 
    margin-top: 4px; 
    white-space: nowrap; 
    overflow: hidden; 
    text-overflow: ellipsis; 
}

.photo-thumbnail { 
    width: 44px; 
    height: 44px; 
    object-fit: cover; 
    border-radius: 8px; 
    margin-right: 8px; 
    border: 1px solid #eee; 
    flex-shrink: 0; 
}

.photo-placeholder { 
    width: 44px; 
    height: 44px; 
    background: #eee; 
    border-radius: 8px; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    color: #aaa; 
    font-size: 18px; 
    margin-right: 8px; 
    flex-shrink: 0; 
}

.action-group { 
    display: flex; 
    gap: 4px; 
    flex-shrink: 0; 
}

.btn-icon { 
    padding: 8px; 
    color: #ccc; 
    background: none; 
    border: none; 
    cursor: pointer; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
}
        .driver-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; width: 100%; } .view-container { display: none; width: 100%; } .view-container.active { display: block; animation: fadeIn 0.2s ease-out; } 
        .actor-grid {
            display: grid;
            /* minmax(0, 1fr) æ˜¯é—œéµï¼å®ƒèƒ½é˜²æ­¢æ ¼å­è¢«éé•·çš„æ–‡å­—æ’çˆ† */
            grid-template-columns: repeat(3, minmax(0, 1fr)); 
            gap: 15px 10px; /* ä¸Šä¸‹é–“è· 15pxï¼Œå·¦å³é–“è· 10px */
            padding-bottom: 40px;
            width: 100%;
            align-items: start; /* è®“å¤§å®¶éƒ½åœ¨åŒä¸€æ¢èµ·è·‘ç·šå°é½Š */
        }
        .actor-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            width: 100%;
            position: relative; /* ç‚ºäº†è®“è£¡é¢çš„åœ‹æ——å¯ä»¥å®šä½ */
            overflow: hidden;   /* è¶…å‡ºç¯„åœçš„æ±è¥¿è—èµ·ä¾†ï¼Œä¸è¦å½±éŸ¿åˆ¥äºº */
        }
        .video-list-container { display: flex; flex-direction: column; gap: 12px; } .video-card { background: var(--color-card-bg); border-radius: 12px; padding: 10px; display: flex; align-items: flex-start; gap: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.02); border: 1px solid var(--color-border); cursor: pointer; } .video-thumb-box { width: 80px; height: 60px; border-radius: 8px; background: #eee; flex-shrink: 0; overflow: hidden; display: flex; align-items: center; justify-content: center; border: 1px solid #e5e7eb; position: relative; } .video-thumb-img { width: 100%; height: 100%; object-fit: cover; } .video-card-info { flex: 1; overflow: hidden; display: flex; flex-direction: column; justify-content: center; height: 60px; min-width: 0; } .video-card-title { font-size: 15px; font-weight: bold; color: #333; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } .video-card-note { font-size: 12px; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } .vid-detail-cover-box { width: 100%; height: 200px; background: #000; border-radius: 16px; overflow: hidden; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; } .vid-detail-cover { width: 100%; height: 100%; object-fit: contain; } .vid-detail-title { font-size: 20px; font-weight: 800; color: #333; margin-bottom: 12px; line-height: 1.3; } .vid-detail-note { background: var(--color-card-bg); padding: 16px; border-radius: 12px; border: 1px solid var(--color-border); font-size: 15px; color: #555; line-height: 1.6; white-space: pre-wrap; margin-bottom: 24px; word-break: break-word; } .vid-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; } .vid-main-action { grid-column: 1 / -1; } .detail-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; } .detail-date { font-size: 18px; font-weight: 800; color: #333; } .detail-photo-container { margin-bottom: 20px; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); width: 100%; } .detail-photo-full { width: 100%; display: block; object-fit: contain; max-height: 400px; background: #000; } .detail-info-row { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; } .detail-badge { background: var(--color-primary); color: white; padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: bold; } .detail-location { color: #666; font-size: 14px; display: flex; align-items: center; gap: 4px; } .detail-note-box { background: var(--color-card-bg); padding: 15px; border-radius: 12px; color: #555; font-size: 15px; line-height: 1.6; margin-bottom: 25px; white-space: pre-wrap; border: 1px solid var(--color-border); word-break: break-word; } .detail-actions { display: flex; gap: 10px; }
        
        /* Hashtag Style */
        .actor-tag {
            display: inline-block;
            background-color: rgba(118, 200, 70, 0.15);
            color: var(--color-primary);
            font-size: 12px;
            font-weight: bold;
            padding: 4px 10px;
            border-radius: 15px;
            margin-right: 6px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .actor-tag:active { transform: scale(0.95); background-color: var(--color-primary); color: white; }
        /* Dark Mode for Tags */
        body.dark-mode .actor-tag { background-color: rgba(255, 255, 255, 0.1); color: var(--color-primary); }

        /* Video Tag Style */
        .video-tag {
            display: inline-block;
            background-color: rgba(0, 0, 0, 0.05);
            color: #666;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            margin-right: 4px;
            margin-top: 4px;
            cursor: pointer;
            border: 1px solid rgba(0,0,0,0.1);
        }
        body.dark-mode .video-tag { background-color: rgba(255, 255, 255, 0.1); color: #aaa; border-color: transparent; }
/* Multi-Select Tags Style */
        .selected-tags-container {
            display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; margin-bottom: 4px;
        }
        .selected-tag-chip {
            background: rgba(118, 200, 70, 0.15); color: var(--color-primary);
            padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: bold;
            display: flex; align-items: center; gap: 6px; cursor: default;
        }
        .selected-tag-chip .remove-tag {
            cursor: pointer; font-size: 16px; opacity: 0.6; display: flex; align-items: center;
        }
        .selected-tag-chip .remove-tag:hover { opacity: 1; }
        body.dark-mode .selected-tag-chip { background: rgba(255,255,255,0.1); }
        /* Suggestions Dropdown */
        .suggestions-dropdown {
            position: absolute;
            top: 100%; left: 0; right: 0;
            background: var(--color-input-bg);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            z-index: 100;
            max-height: 150px;
            overflow-y: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: none; /* é è¨­éš±è— */
        }
        .suggestion-item {
            padding: 12px 15px;
            border-bottom: 1px solid var(--color-border);
            font-size: 14px;
            color: var(--color-text);
            cursor: pointer;
        }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-item:active { background-color: rgba(0,0,0,0.05); color: var(--color-primary); }
        /* Dark Mode å¾®èª¿ */
        body.dark-mode .suggestion-item:active { background-color: rgba(255,255,255,0.1); }

        /* --- Lock Screen UI --- */
        #lock-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--color-bg);
            z-index: 10000; /* æœ€é«˜å±¤ç´š */
            display: none; /* é è¨­éš±è— */
            flex-direction: column; align-items: center; justify-content: center;
            padding-bottom: 50px;
        }
        #lock-screen.active { display: flex; }
        .lock-title { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: var(--color-text); }
        .lock-dots { display: flex; gap: 15px; margin-bottom: 40px; }
        .lock-dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid var(--color-text); transition: all 0.2s; }
        .lock-dot.filled { background-color: var(--color-text); }
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; width: 280px; }
        .key-btn { 
            width: 70px; height: 70px; border-radius: 50%; 
            background: var(--color-input-bg); color: var(--color-text);
            font-size: 24px; font-weight: 500; border: 1px solid var(--color-border);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            margin: 0 auto;
            transition: transform 0.1s;
        }
        .key-btn:active { transform: scale(0.9); background: var(--color-border); }
        .key-btn.transparent { background: transparent; border: none; font-size: 16px; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } 100% { transform: translateX(0); } }

        /* Sort Bar */
        .sort-container {
            display: flex; align-items: center; justify-content: flex-end;
            padding: 0 4px; margin-bottom: 15px;
        }
        .sort-select {
            border: none; background: transparent;
            font-size: 13px; font-weight: bold; color: var(--color-primary);
            outline: none; cursor: pointer; text-align-last: right;
        }
        .sort-select option { color: #333; }
        /* Dark Mode */
        body.dark-mode .sort-select { color: var(--color-primary); }
        body.dark-mode .sort-select option { background: #2c2c2c; color: #fff; }

        /* Rank List Styles */
        .rank-section { margin-top: 30px; }
        .rank-list { display: flex; flex-direction: column; gap: 10px; }
        .rank-item { 
            display: flex; align-items: center; 
            background: var(--color-card-bg); padding: 12px; 
            border-radius: 12px; border: 1px solid var(--color-border);
            cursor: pointer; transition: transform 0.1s;
        }
        .rank-item:active { transform: scale(0.98); background-color: rgba(0,0,0,0.02); }
        .rank-num { 
            font-size: 16px; font-weight: 900; color: #ccc; width: 24px; text-align: center; margin-right: 8px; font-style: italic; 
        }
        .rank-num.top-1 { color: #FFD700; font-size: 20px; text-shadow: 0 1px 2px rgba(0,0,0,0.1); } 
        .rank-num.top-2 { color: #C0C0C0; font-size: 18px; } 
        .rank-num.top-3 { color: #CD7F32; font-size: 18px; } 
        
        .rank-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 12px; border: 1px solid #eee; flex-shrink: 0; }
        .rank-img.video-type { border-radius: 6px; width: 50px; height: 36px; } 
        
        .rank-info { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; }
        .rank-name { font-size: 14px; font-weight: bold; color: var(--color-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .rank-bar-bg { height: 4px; width: 100%; background: #f0f0f0; border-radius: 2px; margin-top: 6px; overflow: hidden; }
        .rank-bar-fill { height: 100%; background: var(--color-primary); border-radius: 2px; }
        .rank-count { font-size: 12px; font-weight: bold; color: #888; margin-left: 10px; }
        
        .btn-show-more {
            background: transparent; border: 1px dashed var(--color-border); 
            color: #888; width: 100%; padding: 10px; border-radius: 12px; 
            font-size: 13px; cursor: pointer; margin-top: 5px;
        }
        .btn-show-more:active { background: rgba(0,0,0,0.05); }

        /* Fix: ç¢ºä¿è©³æƒ…é æ°¸é è“‹åœ¨åˆ—è¡¨é  (z-index 2000) ä¹‹ä¸Š */
        #detail-modal {
            z-index: 2100 !important;
        }
        /* Fix: ç·¨è¼¯é é¢åˆè¦æ¯”è©³æƒ…é æ›´é«˜ */
        #edit-record-modal {
            z-index: 2200 !important;
        }
        /* === V5.8 å„ªåŒ–ï¼šå½±ç‰‡åˆ—è¡¨èˆ‡äººç‰©æª”æ¡ˆç¾åŒ– === */
        
        /* 1. å½±ç‰‡å¡ç‰‡ï¼šæ”¹ç‚ºå½ˆæ€§é«˜åº¦ï¼Œè§£æ±ºæ¨™é¡Œèˆ‡ Hashtag è¢«åˆ‡æ‰çš„å•é¡Œ */
        .video-card {
            height: auto !important; /* å¼·åˆ¶è¦†è“‹èˆŠè¨­å®š */
            min-height: 80px;
            padding: 12px;
            align-items: flex-start; /* é ä¸Šå°é½Š */
        }
        
        .video-thumb-box {
            width: 90px;
            height: 68px;
        }

        .video-card-info {
            height: auto !important; /* å¼·åˆ¶è¦†è“‹èˆŠè¨­å®š */
            padding-top: 2px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .video-card-title {
            white-space: normal; /* å…è¨±æ›è¡Œ */
            display: -webkit-box;
            -webkit-line-clamp: 2; /* æœ€å¤šé¡¯ç¤ºå…©è¡Œ */
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.3;
            margin-bottom: 6px;
        }

        /* æ–°å¢ï¼šå½±ç‰‡æ¨™ç±¤å®¹å™¨ */
        .video-tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 4px;
        }

        /* 2. äººç‰©æª”æ¡ˆï¼šç¾åŒ–æ’ç‰ˆ */
        .detail-profile {
            background: var(--color-card-bg);
            border-radius: 20px;
            padding: 25px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            border: 1px solid var(--color-border);
        }

        /* æ–°å¢ï¼šç°¡ä»‹æ–‡å­—æ¡† */
        .detail-bio-box {
            background: rgba(118, 200, 70, 0.08); /* æ·¡ç¶ è‰²èƒŒæ™¯ */
            padding: 15px 20px;
            border-radius: 12px;
            margin-top: 15px;
            width: 100%;
            position: relative;
        }
        
        body.dark-mode .detail-bio-box {
            background: rgba(255, 255, 255, 0.05);
        }

        .detail-bio {
            text-align: justify; /* å·¦å³å°é½Š */
            line-height: 1.6;
            white-space: pre-wrap;
            opacity: 0.9;
        }

        /* æ–°å¢ï¼šäººç‰©æ¨™ç±¤ç¾¤çµ„ */
        .detail-tags-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-top: 15px;
            width: 100%;
        }
        /* === Tier List Styles (æ’è¡Œæ¦œæ¨£å¼) === */
        .tier-wrapper { display: flex; flex-direction: column; gap: 4px; border: 1px solid #333; background: #000; border-radius: 8px; overflow: hidden; margin-top: 10px; }
        .tier-row { display: flex; min-height: 80px; background: #1a1a1a; border-bottom: 1px solid #000; }
        .tier-row:last-child { border-bottom: none; }
        .tier-label { width: 50px; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: 900; color: #fff; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); flex-shrink: 0; }
        .tier-content { flex: 1; display: flex; flex-wrap: wrap; align-items: center; padding: 5px; gap: 5px; background: #222; min-height: 80px; align-content: flex-start; }
        
        /* ç­‰ç´šé¡è‰² */
        .s-tier { background-color: #ff7f7f; color: #7c0000; }
        .a-tier { background-color: #ffbf7f; color: #7c4800; }
        .b-tier { background-color: #ffdf7f; color: #7c6800; }
        .c-tier { background-color: #ffff7f; color: #7c7c00; }
        .d-tier { background-color: #bfff7f; color: #357c00; }

        /* å¾…åˆ†é¡å€ */
        .tier-pool { 
            min-height: 120px; background: var(--color-card-bg); border: 2px dashed #ccc; 
            border-radius: 12px; padding: 10px; display: flex; flex-wrap: wrap; gap: 8px; 
            justify-content: center; align-items: flex-start; transition: background 0.2s; margin-bottom: 50px;
        }
        
        /* é ­åƒæ¨£å¼ */
        .tier-avatar { 
            width: 55px; height: 55px; border-radius: 8px; object-fit: cover; cursor: grab; 
            border: 2px solid transparent; transition: transform 0.1s; 
            -webkit-user-select: none; user-select: none; 
            
            /* ğŸ”¥ æ–°å¢é€™ä¸€è¡Œï¼šç¦æ­¢ç€è¦½å™¨é è¨­çš„æ²å‹•è¡Œç‚ºï¼Œè®“ JS æ¥ç®¡æ‹–æ›³ */
            touch-action: none; 
        }
        .tier-avatar:active { cursor: grabbing; transform: scale(1.1); border-color: white; z-index: 100; }
        
        /* æ·±è‰²æ¨¡å¼ä¿®æ­£ */
        body.dark-mode .tier-pool { background: #2c2c2c; border-color: #555; }
        body.dark-mode #driver-view-tier h2 { color: #fff; }
        
        /* === æ–°å¢ï¼šTier List æ‹–æ›³æ¨£å¼ === */
        .tier-avatar.dragging {
            opacity: 0.5;
            border: 2px dashed #fff;
            transform: scale(1.1);
        }

        /* === ğŸ“· ç›¸ç°¿åŠŸèƒ½å°ˆç”¨æ¨£å¼ (Instagram é¢¨æ ¼) === */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* å¼·åˆ¶åˆ†ç‚º 3 ç›´æ¬„ */
            gap: 3px; /* ç…§ç‰‡ä¹‹é–“çš„é–“è·ï¼Œæ¨¡å½· IG çš„çª„é–“è· */
            margin-top: 15px;
            width: 100%;
        }

        .photo-grid-item {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1; /* ğŸ”¥ é—œéµï¼šå¼·åˆ¶æ­£æ–¹å½¢æ¯”ä¾‹ */
            background-color: #f0f0f0;
            overflow: hidden;
            cursor: pointer;
        }

        .photo-grid-img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* ğŸ”¥ é—œéµï¼šå¡«æ»¿æ­£æ–¹å½¢ä½†ä¸è®Šå½¢ (æœƒè£åˆ‡) */
            transition: transform 0.2s;
            display: block;
        }

        /* æŒ‰å£“æ™‚çš„ç¸®æ”¾æ•ˆæœ */
        .photo-grid-item:active .photo-grid-img {
            transform: scale(0.95);
            opacity: 0.8;
        }

        /* === ğŸ” å¤§åœ–ç€è¦½å™¨æ¨£å¼ === */
        .photo-viewer-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .photo-viewer-img {
            max-width: 100%;
            max-height: 75vh; /* é™åˆ¶é«˜åº¦ï¼Œç•™ç©ºé–“çµ¦æŒ‰éˆ• */
            object-fit: contain; /* ä¿æŒåŸåœ–æ¯”ä¾‹å®Œæ•´é¡¯ç¤º */
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            border-radius: 4px;
        }

        /* --- 1. åˆ—è¡¨é ä¿®å¾© --- */
        .actor-grid {
            /* é€™è£¡ä¸å¯ä»¥åŠ  !importantï¼Œå› ç‚ºè¦è®“ JS æ§åˆ¶é¡¯ç¤º/éš±è— */
            display: grid; 
        
            /* åªæœ‰é€™è£¡è¦å¼·åˆ¶ï¼Œç¢ºä¿ä¸€æ’ä¸‰å€‹ */
            grid-template-columns: repeat(3, minmax(0, 1fr)) !important;
            gap: 15px 10px !important;
            width: 100% !important;
            padding-bottom: 40px;
            align-items: start;
        }

            /* ä¿®æ­£å¡ç‰‡è¡Œç‚º */
            .actor-card {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            width: 100% !important;
            position: relative;
            overflow: hidden;
        }

        /* 3. ä¿®æ­£é ­åƒï¼šå¼·åˆ¶æ­£æ–¹å½¢åœ“æ¡†ï¼Œç¢ºä¿ä¸è®Šå½¢ */
        .actor-avatar {
            width: 100% !important;
            aspect-ratio: 1 / 1 !important; 
            border-radius: 50% !important;
            object-fit: cover !important;
            background-color: #f0f0f0;
            border: 2px solid white !important;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-bottom: 6px !important;
            display: block !important;
        }

        /* ä¿®æ­£åˆ—è¡¨åå­— (éé•·çœç•¥) */
        .actor-name {
            font-size: 13px !important;
            font-weight: 600 !important;
            text-align: center !important;
            color: #333;
            width: 100% !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            margin-top: 2px;
            padding: 0 4px;
       }

        /* ä¿®æ­£åˆ—è¡¨åå­— (éé•·çœç•¥) */
        .actor-name {
            font-size: 13px !important;
            font-weight: 600 !important;
            text-align: center !important;
            color: #333;
            width: 100% !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            margin-top: 2px;
            padding: 0 4px;
        }

        /* ä¿®æ­£åˆ—è¡¨åå­— (éé•·çœç•¥) */
        .actor-name {
            font-size: 13px !important;
            font-weight: 600 !important;
            text-align: center !important;
            color: #333;
            width: 100% !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            margin-top: 2px;
            padding: 0 4px;
        }

        /* è©³æƒ…é çš„å¤§å¡ç‰‡ */
        .detail-profile {
            display: flex !important;
            flex-direction: column !important;
            align-items: center !important;
            text-align: center !important;
            width: 100% !important;
            background: #fff; /* ç¢ºä¿èƒŒæ™¯æ˜¯ç™½çš„ */
            border-radius: 20px;
            padding: 30px 20px !important;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            position: relative;
        }

        /* è©³æƒ…é çš„å¤§é ­åƒ */
        .detail-avatar {
            width: 120px !important;  /* å›ºå®šå¤§å°ºå¯¸ */
            height: 120px !important;
            border-radius: 50% !important;
            object-fit: cover !important;
            border: 4px solid white !important;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15) !important;
            margin-bottom: 15px !important;
            display: block !important;
            background-color: #eee;
        }

        /* è©³æƒ…é çš„å¤§åå­— */
        .detail-name {
            font-size: 22px !important;
            font-weight: 800 !important;
            margin-bottom: 8px !important;
            color: #333;
            width: 100%;
            word-break: break-word; /* åå­—å¤ªé•·å¯ä»¥æ›è¡Œ */
            line-height: 1.2;
        }

        /* è©³æƒ…é çš„ç°¡ä»‹æ–‡å­— */
        .detail-bio {
            font-size: 14px !important;
            color: #666;
            line-height: 1.6 !important;
            max-width: 90%;
        }
    
        /* æ·±è‰²æ¨¡å¼é©é… */
        body.dark-mode .actor-name, 
        body.dark-mode .detail-name { color: #fff !important; }
        body.dark-mode .detail-profile { background: #1e1e1e !important; }
    
        /* === V2 ä¿®æ­£åŒ…çµæŸ === */


    </style>
</head>
<body>

    <main id="app-container">
        <!-- Home -->
        <section id="home" class="active">
            <div class="btn-settings" onclick="goToSettings()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
            </div>
            <div class="hero-section">
                <h1 id="welcome-text" style="font-size:18px; color:#555; margin-bottom:10px;">Helloï¼Œå¸¥å“¥</h1>
                <div class="hero-label">è·é›¢ä¸Šæ¬¡ç™¼å°„å·²é</div>
                <div id="hero-timer-display" class="hero-timer">--<small style="font-size:16px;">å¤©</small></div>
                <!-- Dynamic Message -->
                <div id="home-message">CuteCumber éš¨æ™‚å¾…å‘½ã€‚</div>
            </div>
            <div id="duo-stage" class="duo-stage">
                <div id="char-angel" class="character" onclick="tapMascot('angel')">
                    <div class="bubble" id="angel-msg">...</div>
                    <div class="avatar-wrapper">
                        <div class="avatar">ğŸ˜‡</div>
                        <div class="halo"></div>
                    </div>
                    <div class="char-name">å°å¤©ä½¿</div>
                </div>

                <div class="vs-icon">VS</div>

                <div id="char-demon" class="character" onclick="tapMascot('demon')">
                    <div class="bubble" id="demon-msg">...</div>
                    <div class="avatar-wrapper">
                        <div class="avatar">ğŸ˜ˆ</div>
                        <div class="fire"></div>
                    </div>
                    <div class="char-name">å°æƒ¡é­”</div>
                </div>
            </div>
            <div class="stats-metrics">
                <div class="metric-card">
                    <div class="metric-title">ğŸ“… æœ¬æœˆæˆ°ç¸¾</div>
                    <div class="metric-value"><span id="month-count-display">0</span> <span class="metric-unit">æ¬¡</span></div>
                </div>
                <div class="metric-card">
                    <div class="metric-title">ğŸ”¥ ç›®å‰é€£æ“Š</div>
                    <div class="metric-value"><span id="home-streak-display">0</span> <span class="metric-unit">å¤©</span></div>
                </div>
            </div>

            <div class="recent-list-header">è¿‘æœŸæ´»å‹•</div>
            <div id="recent-list-container"></div>
        </section>

        <!-- Record -->
        <section id="record">
            <h1>æ–°å¢ç´€éŒ„</h1>
            <form id="record-form">
                <div class="form-group"><label class="form-label">æ™‚é–“</label><input type="datetime-local" id="input-timestamp" class="form-control" required></div>
                <div class="form-group"><label class="form-label">æ¨¡å¼</label><select id="input-type" class="form-control"><option value="è‡ªæ…°">ğŸ–ï¸ è‡ªæ…°</option><option value="åšæ„›">ğŸ‘¨â€â¤ï¸â€ğŸ‘¨ åšæ„›</option><option value="å¤¢éº">ğŸ’¤ å¤¢éº</option></select></div>
                <div class="form-group"><label class="form-label">åœ°é»</label><input type="text" id="input-location" class="form-control" value="è‡¥å®¤" list="location-list"></div>
                <div id="section-masturbation">
                    <div class="form-group" style="position:relative;">
                        <label class="form-label">What makes you cum? ğŸ‘¨ (æ¼”å“¡)</label>
                        <input type="text" id="input-actor-search" class="form-control" placeholder="æœå°‹ä¸¦é»æ“ŠåŠ å…¥..." autocomplete="off">
                        <div id="selected-actors-box" class="selected-tags-container"></div>
                        <div id="actor-suggestions" class="suggestions-dropdown"></div>
                    </div>
                    <div class="form-group" style="position:relative;">
                        <label class="form-label">What makes you cum? ğŸ¥ (å½±ç‰‡)</label>
                        <input type="text" id="input-video-search" class="form-control" placeholder="æœå°‹å½±ç‰‡..." autocomplete="off">
                        <input type="hidden" id="input-video-data">
                        <div id="video-suggestions" class="suggestions-dropdown"></div>
                    </div>
                </div>

                <div id="section-sex" style="display:none;">
                    <div class="form-group" style="position:relative;">
                        <label class="form-label">æ€§å¤¥ä¼´ (Sexual Partners)</label>
                        <div style="display:flex; gap:8px; margin-bottom:8px; align-items: stretch;">
                            <div style="display:flex; flex-direction:column; gap:6px; flex:1;">
                                <input type="text" id="input-partner-name" class="form-control" placeholder="è¼¸å…¥åå­—..." autocomplete="off">
                                <input type="url" id="input-partner-url" class="form-control" placeholder="https:// (è²¼ä¸Šç…§ç‰‡é€£çµ)" style="font-size:12px; padding:8px;">
                            </div>
                            <div style="display:flex; flex-direction:column; gap:6px; width:50px;">
                                <label for="input-partner-photo" class="btn-base btn-outline" style="height:100%; padding:0; display:flex; align-items:center; justify-content:center; margin:0;">ğŸ“</label>
                                <input type="file" id="input-partner-photo" accept="image/*" style="display:none">
                                <button type="button" class="btn-base btn-primary" onclick="addPartnerToState('new')" style="height:100%; padding:0; display:flex; align-items:center; justify-content:center; margin:0;">+</button>
                            </div>
                        </div>
                        <img id="preview-partner-photo" style="width:40px; height:40px; border-radius:50%; object-fit:cover; display:none; margin-bottom:8px; border:2px solid var(--color-primary);">
                        
                        <div id="selected-partners-box" class="selected-tags-container"></div>
                        <div id="partner-suggestions" class="suggestions-dropdown"></div>
                    </div>
                </div>
                <div class="form-group"><label class="form-label">å‚™è¨» (é¸å¡«)</label><textarea id="input-note" class="form-control"></textarea></div>
                <div class="form-group"><label class="form-label">ç…§ç‰‡ (é¸å¡«)</label><label for="input-photo" class="photo-upload-label">ğŸ“· é¸æ“‡ç…§ç‰‡</label><input type="file" id="input-photo" accept="image/*" style="display:none"><img id="preview-photo" class="photo-preview"></div>
                <button type="submit" class="btn-base btn-accent" style="width:100%">ç™¼å°„ç¢ºèªï¼ğŸš€</button>
            </form>
        </section>

        <!-- Diary -->
        <section id="diary">
            <h1>æ—¥è¨˜</h1>
            <div class="view-toggle"><button class="toggle-btn active" onclick="switchDiaryView('calendar')">ğŸ“… æ—¥æ›†æ¨¡å¼</button><button class="toggle-btn" onclick="switchDiaryView('list')">ğŸ“ åˆ—è¡¨æ¨¡å¼</button></div>
            <div id="diary-view-calendar" style="display:block;"><div class="calendar-header"><button class="calendar-nav-btn" onclick="changeMonth(-1)">â€¹</button><div class="calendar-title" id="calendar-title">YYYY/MM</div><button class="calendar-nav-btn" onclick="changeMonth(1)">â€º</button></div><div class="calendar-grid"><div class="weekday-label">æ—¥</div><div class="weekday-label">ä¸€</div><div class="weekday-label">äºŒ</div><div class="weekday-label">ä¸‰</div><div class="weekday-label">å››</div><div class="weekday-label">äº”</div><div class="weekday-label">å…­</div><div id="calendar-days-container" style="display:contents"></div></div></div>
            <div id="diary-view-list" style="display:none;">
                 <!-- Diary Search Bar -->
                <div id="diary-search-bar" class="search-container" style="margin-bottom: 15px;">
                    <input type="text" id="diary-search-input" class="search-input" placeholder="ğŸ” æœå°‹å‚™è¨»ã€åœ°é»æˆ–é¡å‹..." oninput="filterDiary()">
                </div>
                <div id="diary-list-content"></div>
            </div>
        </section>

        <!-- Stats -->
        <section id="stats">
            <h1>æ•¸æ“š</h1>
            <div class="view-toggle stats-toggle-container">
                <button class="toggle-btn active" onclick="switchStatsView('charts')">ğŸ“Š åœ–è¡¨åˆ†æ</button>
                <button class="toggle-btn" onclick="switchStatsView('achievements')">ğŸ† æˆå°±çç« </button>
            </div>
            <!-- View 1: Charts -->
            <div id="stats-view-charts">
                <div id="stats-content" style="display:none;">
                    <div class="stats-metrics">
                        <div class="metric-card" style="grid-column: span 2; background: linear-gradient(135deg, var(--color-card-bg) 0%, rgba(118, 200, 70, 0.05) 100%); border-color: var(--color-primary);">
                            <div class="metric-title" style="font-size:13px; color:var(--color-primary);">ğŸ† æ­·å²ç¸½è¨ˆ</div>
                            <div class="metric-value" style="font-size:3rem;"><span id="stat-total">0</span><span class="metric-unit">æ¬¡</span></div>
                        </div>

                        <div class="metric-card"><div class="metric-title">ğŸ“… ä»Šå¹´ç´¯ç©</div><div class="metric-value"><span id="stat-year">0</span><span class="metric-unit">æ¬¡</span></div></div>
                        <div class="metric-card"><div class="metric-title">ğŸ”¥ æœ€é•·é€£æ“Š</div><div class="metric-value"><span id="stat-streak">0</span><span class="metric-unit">å¤©</span></div></div>
                        <div class="metric-card"><div class="metric-title">ğŸ§˜ æœ€é•·ç¦æ…¾</div><div class="metric-value"><span id="stat-abstinence">0</span><span class="metric-unit">å¤©</span></div></div>
                        
                        <div class="metric-card"><div class="metric-title">ğŸ–ï¸ è‡ªæ…°ç¸½è¨ˆ</div><div class="metric-value"><span id="stat-type-m">0</span><span class="metric-unit">æ¬¡</span></div></div>
                        <div class="metric-card"><div class="metric-title">ğŸ‘¨â€â¤ï¸â€ğŸ‘¨ åšæ„›ç¸½è¨ˆ</div><div class="metric-value"><span id="stat-type-s">0</span><span class="metric-unit">æ¬¡</span></div></div>
                        <div class="metric-card"><div class="metric-title">ğŸ’¤ å¤¢éºç¸½è¨ˆ</div><div class="metric-value"><span id="stat-type-w">0</span><span class="metric-unit">æ¬¡</span></div></div>
                    </div>
                    <div class="chart-container"><div class="section-header">ç”Ÿç†é€±æœŸåˆ†æ</div><canvas id="weeklyChart"></canvas></div>
                    <div id="yearly-stats-container"><div class="section-header" style="margin-top:30px;">ğŸ“œ æ­·å¹´æˆ°ç¸¾å›é¡§</div><div id="yearly-list"></div></div>
                    
                    <div id="favorites-stats-container" style="margin-top:30px;">
                        <div class="section-header" style="font-size:18px; color:var(--color-accent); border-left-color:var(--color-accent); margin-bottom:20px;">
                            â˜ï¸ é›²ç«¯æƒ…äºº
                        </div>

                        <div class="rank-section">
                            <div class="section-header" style="font-size:14px; border-left:none; padding-left:0; color:#888;">ğŸ† æœ€æ„›è‡¨å¹¸ (Top Actors)</div>
                            <div id="top-actors-list" class="rank-list"></div>
                        </div>
                        <div class="rank-section">
                            <div class="section-header" style="font-size:14px; border-left:none; padding-left:0; color:#888;">ğŸ“¼ å¿…çœ‹ç¶“å…¸ (Top Videos)</div>
                            <div id="top-videos-list" class="rank-list"></div>
                        </div>
                    </div>
                    <div id="partners-stats-container" style="margin-top:30px;">
                        <div class="section-header" style="font-size:18px; color:#E91E63; border-left-color:#E91E63; margin-bottom:20px;">
                            ğŸ‘¨ æœ€ä½³æˆ°å‹
                        </div>

                        <div class="rank-section">
                            <div id="top-partners-list" class="rank-list"></div>
                        </div>
                    </div>
                    <div class="rank-section" style="margin-top:20px;">
                            <div class="section-header" style="font-size:14px; border-left:none; padding-left:0; color:#888;">ğŸŒ åœ‹æ°‘å¤–äº¤ (Diplomacy Map)</div>
                            <div id="map-wrapper" style="position:relative; width:100%; height:350px; border-radius:12px; overflow:hidden; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.05);">
                
                <div id="map-scroll-container" style="width:100%; height:100%; overflow:auto; -webkit-overflow-scrolling:touch;">
                    <div id="diplomacy-map" style="width:100%; height:100%;"></div>
                </div>

                <div class="map-controls" style="position:absolute; bottom:15px; right:15px; display:flex; flex-direction:column; gap:8px; z-index:100;">
                    <button class="btn-base" onclick="updateMapZoom(0.5)" style="width:36px; height:36px; padding:0; background:rgba(255,255,255,0.95); box-shadow:0 2px 8px rgba(0,0,0,0.2); color:#333; font-weight:900; font-size:18px; border:1px solid #eee;">+</button>
                    <button class="btn-base" onclick="updateMapZoom(-0.5)" style="width:36px; height:36px; padding:0; background:rgba(255,255,255,0.95); box-shadow:0 2px 8px rgba(0,0,0,0.2); color:#333; font-weight:900; font-size:18px; border:1px solid #eee;">-</button>
                </div>
            </div>
                        </div>
                </div>
                <div id="stats-empty" class="empty-stats"><div style="font-size:40px;margin-bottom:10px;">ğŸ“‰</div><p>ç´¯ç©ä¸€é»æ•¸æ“šå†ä¾†å§ï¼</p></div>
            </div>
            <!-- View 2: Achievements -->
            <div id="stats-view-achievements" style="display:none;">
                <div id="ach-list-container"></div>
            </div>
        </section>

        <!-- Driver -->
        <section id="driver" class="tab-content">
        <div id="driver-view-list" class="view-container active">
            
            <div class="driver-header" style="flex-direction:column; align-items:flex-start; gap:10px; margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                    <h1 style="color:var(--color-accent);margin:0;">æ”¶è—æ«ƒ</h1>
                    
                    <div style="display:flex; align-items:center;">
                         <button id="driver-dice-btn" class="btn-base btn-gold" onclick="rollTheDice()" style="padding:8px 12px; font-size:16px; margin-right:8px;">ğŸ²</button>
                         <button class="btn-base btn-primary" onclick="openTierList()" style="padding:8px 12px; font-size:16px; background:#444;">ğŸ†</button>
                    </div>
                </div>
                
                <div class="view-toggle" style="width:100%;">
                    <button class="toggle-btn active" onclick="switchDriverMode('actor')">â˜ï¸ é›²ç«¯æƒ…äºº</button>
                    <button class="toggle-btn" onclick="switchDriverMode('partner')">ğŸ’ æ€§å¤¥ä¼´</button>
                </div>
            </div>

            <div id="driver-action-bar" style="display:flex; justify-content:flex-end; margin-bottom:10px;">
                <button class="btn-base btn-primary" onclick="openAddActorForm()" style="font-size:13px;padding:8px 12px;">+ æ–°å¢æ¼”å“¡</button>
            </div>

            <div id="driver-search-bar" style="display:flex; align-items:center; background:#fff; padding:10px 15px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.05); margin-bottom:10px; border:1px solid #eee;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2" style="margin-right:10px;"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <input type="text" id="driver-search-input" placeholder="æœå°‹å§“åã€ç‰¹å¾µ..." oninput="filterDriverList()" style="border:none; outline:none; font-size:16px; width:100%; background:transparent; color:#333;">
            </div>

            <div class="filter-bar" style="display:flex; justify-content:flex-end; margin-bottom:15px;">
                <select id="driver-sort-select" class="form-control" onchange="filterDriverList()" style="width:auto; padding-right:30px; margin:0; font-size:14px;">
                    <option value="updated">ğŸ•’ æœ€å¾Œæ›´æ–°</option>
                    <option value="name">ğŸ”¤ å§“å (A-Z)</option>
                    <option value="count">ğŸ¬ å½±ç‰‡æ•¸é‡</option>
                </select>
            </div>

            <div id="actor-grid" class="actor-grid"></div>
            <div id="partner-grid" class="actor-grid" style="display:none;"></div>
            
            <div id="empty-msg" class="empty-state" style="display:none;">
                <div style="font-size:40px;margin-bottom:10px;">ğŸ•¸ï¸</div>
                <div style="color:#999;">æ‰¾ä¸åˆ°ç¬¦åˆçš„è³‡æ–™</div>
            </div>
        </div>
        <div id="driver-view-detail" class="view-container">
                <div style="margin-bottom:15px;">
                    <button class="btn-base btn-outline" onclick="showDriverList()" style="width:auto; padding:8px 12px; display:inline-flex; align-items:center; gap:5px;">
                        <span>â€¹</span> è¿”å›åˆ—è¡¨
                    </button>
                </div>
                
                <div id="detail-profile-container"></div>

                <div id="detail-action-bar" style="margin-top:15px; display:flex; justify-content:flex-end; gap:10px;"></div>

                <div class="section-header" style="margin-top:20px; font-size:15px; border-left-color:var(--color-accent);">
                    ğŸ“¼ æ”¶è—å½±ç‰‡
                </div>
                <div id="video-list-container" class="video-list-container"></div>
                <div class="section-header" style="margin-top:30px; font-size:15px; border-left-color:var(--color-primary);">
                    ğŸ“· å¯«çœŸç›¸ç°¿
                </div>
                <div id="photo-list-container" class="photo-grid"></div>
                <div style="height:50px;"></div> 
            </div>
            <div id="driver-view-detail" class="view-container">
            </div>

        <div id="driver-view-tier" class="view-container">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <button class="btn-base btn-outline" onclick="closeTierList()" style="width:auto; padding:8px 12px;">â€¹ è¿”å›åˆ—è¡¨</button>
                <h2 style="margin:0; font-size:18px; color:#333;">ğŸ† æ’è¡Œæ¦œ</h2>
                <div style="width:40px;"></div>
            </div>
            
            <div id="tier-container" class="tier-wrapper">
                <div class="tier-row"><div class="tier-label s-tier">S</div><div class="tier-content" ondrop="drop(event, 'S')" ondragover="allowDrop(event)"></div></div>
                <div class="tier-row"><div class="tier-label a-tier">A</div><div class="tier-content" ondrop="drop(event, 'A')" ondragover="allowDrop(event)"></div></div>
                <div class="tier-row"><div class="tier-label b-tier">B</div><div class="tier-content" ondrop="drop(event, 'B')" ondragover="allowDrop(event)"></div></div>
                <div class="tier-row"><div class="tier-label c-tier">C</div><div class="tier-content" ondrop="drop(event, 'C')" ondragover="allowDrop(event)"></div></div>
                <div class="tier-row"><div class="tier-label d-tier">D</div><div class="tier-content" ondrop="drop(event, 'D')" ondragover="allowDrop(event)"></div></div>
            </div>

            <div class="section-header" style="margin-top:20px; font-size:14px; color:#888;">å¾…åˆ†é¡ (æœªåˆ†ç´š)</div>
            <div id="tier-pool" class="tier-pool" ondrop="drop(event, 'unranked')" ondragover="allowDrop(event)"></div>
            <div style="text-align:center; color:#aaa; font-size:12px; margin-top:-40px; margin-bottom: 20px;">é•·æŒ‰é ­åƒå³å¯ç§»å‹•</div>
        </div>
    </section>

    <section id="settings">
        <div class="settings-header">
                <button class="btn-close" style="width:36px;height:36px;" onclick="exitSettings()">â€¹</button>
                <h1 style="margin:0;">å€‹äººè¨­å®š</h1>
            </div>

            <!-- Card 1: User Profile -->
            <div class="settings-card">
                <div class="settings-title">ä½¿ç”¨è€…è³‡è¨Š</div>
                <div class="form-group">
                    <label class="form-label">è€å¸æ©Ÿä»£è™Ÿ</label>
                    <input type="text" id="setting-nickname" class="form-control" placeholder="å¸¥å“¥">
                </div>
                <div class="form-group">
                    <label class="form-label">ç”Ÿæ—¥</label>
                    <input type="date" id="setting-birthday" class="form-control">
                </div>
                <button class="btn-base btn-primary" style="width:100%" onclick="saveUserProfile()">ğŸ’¾ å„²å­˜å€‹äººè³‡æ–™</button>
            </div>

            <!-- Card 2: Security (New) -->
            <div class="settings-card">
                <div class="settings-title">å®‰å…¨æ€§</div>
                <div class="form-group" style="display:flex; justify-content:space-between; align-items:center;">
                    <label class="form-label" style="margin:0;">ğŸ”’ å•Ÿå‹•å¯†ç¢¼é–</label>
                    <label class="switch">
                        <input type="checkbox" id="passcode-toggle" onchange="togglePasscodeSwitch()">
                        <span class="slider round"></span>
                    </label>
                </div>
                <button id="btn-change-passcode" class="btn-base btn-outline" style="width:100%; display:none;" onclick="startChangePasscode()">ä¿®æ”¹å¯†ç¢¼</button>
            </div>

            <!-- Card 3: App Settings -->
            <div class="settings-card">
                <div class="settings-title">å¤–è§€</div>
                <div class="form-group" style="display:flex; justify-content:space-between; align-items:center;">
                    <label class="form-label" style="margin:0;">ğŸŒ™ æ·±è‰²æ¨¡å¼</label>
                    <label class="switch">
                        <input type="checkbox" id="dark-mode-toggle" onchange="toggleDarkMode()">
                        <span class="slider round"></span>
                    </label>
                </div>
            </div>

            <!-- Card 4: Data Management -->
            <div class="settings-card">
                <div class="settings-title">è³‡æ–™ç®¡ç†</div>
                <p class="settings-desc">æ‰€æœ‰è³‡æ–™éƒ½å„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ã€‚è«‹å®šæœŸåŒ¯å‡ºå‚™ä»½ï¼Œä»¥å…è³‡æ–™éºå¤±ã€‚</p>
                <div style="display:flex; flex-direction:column; gap:10px;">
                    <button class="btn-base btn-outline" style="margin-top:10px;" onclick="checkStorageUsage()">ğŸ’¾ æª¢æŸ¥ç›®å‰å®¹é‡</button>
                    <button class="btn-base btn-outline" onclick="exportData()">ğŸ“¤ åŒ¯å‡ºå‚™ä»½ (JSON)</button>
                    <button class="btn-base btn-outline" onclick="document.getElementById('import-file').click()">ğŸ“¥ åŒ¯å…¥å‚™ä»½ (JSON)</button>
                    <input type="file" id="import-file" accept=".json" style="display:none" onchange="importData(this)">
                    <button class="btn-base btn-danger" style="margin-top:10px;" onclick="resetData()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
                </div>
            </div>
            <div style="text-align:center; color:#aaa; font-size:12px; margin-top:20px;">CuteCumber v5.7<br>Made with â¤ï¸</div>
        </section>
    </main>

    <!-- System Modal -->
    <div id="system-modal" class="modal-overlay">
        <div class="system-modal-content">
            <h3 class="system-modal-title" id="sys-title">æç¤º</h3>
            <div class="system-modal-msg" id="sys-msg"></div>
            <div class="system-modal-actions" id="sys-actions"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="achievement-modal" class="modal-overlay"><div class="unlock-modal-content"><div class="unlock-icon-wrapper"><span id="unlock-icon">ğŸ†</span></div><div class="unlock-title" id="unlock-title">æˆå°±è§£é–</div><div class="unlock-msg" id="unlock-msg"></div><button class="btn-base btn-gold" style="width:100%" onclick="closeAchievementModal()">æ”¶ä¸‹æ¦®è€€</button><div class="unlock-confetti"></div></div></div>
    <div id="achievement-detail-modal" class="modal-overlay bottom-sheet">
        <div class="modal-content-bottom">
            <div class="detail-header" style="border:none;"><button class="btn-close" style="margin-left:auto;" onclick="closeAchDetailModal()">Ã—</button></div>
            <div style="text-align:center; margin-bottom:20px;">
                <div style="font-size:60px; margin-bottom:10px;" id="ad-icon"></div>
                <div style="font-size:24px; font-weight:800; color:#d48806;" id="ad-title"></div>
                <div style="font-size:14px; color:#999; margin-top:5px;" id="ad-desc"></div>
            </div>
            <div class="ach-info-row"><span class="ach-info-label">é”æˆæ—¥æœŸ</span><span id="ad-date"></span></div>
            <div class="ach-info-desc" id="ad-msg"></div>
        </div>
    </div>
    
    <!-- Random Picker Modal -->
    <div id="random-modal" class="modal-overlay">
        <div class="unlock-modal-content" style="max-width: 300px;">
            <div style="text-align:right; width:100%; margin-bottom:-20px;">
                <button class="btn-close" onclick="closeRandomModal()" style="display:inline-flex;">Ã—</button>
            </div>
            <div class="unlock-title" style="margin-top:20px; font-size:16px; color:#888;">å‘½é‹çš„é¸æ“‡æ˜¯...</div>
            <div id="random-result-container" style="margin: 20px 0;">
            </div>
            <button id="btn-random-go" class="btn-base btn-primary" style="width:100%">å‰å¾€æŸ¥çœ‹ ğŸš€</button>
        </div>
    </div>

    <!-- Edit Record Modal -->
    <div id="edit-record-modal" class="modal-overlay bottom-sheet">
        <div class="modal-content-bottom">
            <h3 style="margin:0 0 20px 0;font-size:20px;">ç·¨è¼¯ç´€éŒ„</h3>
            <form id="edit-record-form">
                <div class="form-group"><label class="form-label">æ™‚é–“</label><input type="datetime-local" id="edit-timestamp" class="form-control" required></div>
                <div class="form-group"><label class="form-label">æ¨¡å¼</label><select id="edit-type" class="form-control"><option value="è‡ªæ…°">ğŸ–ï¸ è‡ªæ…° (DIY)</option><option value="åšæ„›">ğŸ’ åšæ„› (Sex)</option><option value="å¤¢éº">ğŸ’¤ å¤¢éº (Wet Dream)</option></select></div>
                <div class="form-group"><label class="form-label">åœ°é»</label><input type="text" id="edit-location" class="form-control" list="location-list"></div>
                <div id="edit-section-masturbation">
                    <div class="form-group" style="position:relative;">
                        <label class="form-label">What makes you cum? ğŸ‘¨ (æ¼”å“¡)</label>
                        <input type="text" id="edit-actor-search" class="form-control" placeholder="æœå°‹ä¸¦åŠ å…¥..." autocomplete="off">
                        <div id="edit-selected-actors-box" class="selected-tags-container"></div>
                        <div id="edit-actor-suggestions" class="suggestions-dropdown"></div>
                    </div>
                    <div class="form-group" style="position:relative;">
                        <label class="form-label">What makes you cum? ğŸ¥ (å½±ç‰‡)</label>
                        <input type="text" id="edit-video-search" class="form-control" placeholder="æœå°‹å½±ç‰‡..." autocomplete="off">
                        <input type="hidden" id="edit-video-data">
                        <div id="edit-video-suggestions" class="suggestions-dropdown"></div>
                    </div>
                </div>

                <div id="edit-section-sex" style="display:none;">
                    <div class="form-group" style="position:relative;">
                        <label class="form-label">æ€§å¤¥ä¼´ (Sexual Partners)</label>
                        <div style="display:flex; gap:8px; margin-bottom:8px; align-items: stretch;">
                            <div style="display:flex; flex-direction:column; gap:6px; flex:1;">
                                <input type="text" id="edit-input-partner-name" class="form-control" placeholder="è¼¸å…¥åå­—..." autocomplete="off">
                                <input type="url" id="edit-input-partner-url" class="form-control" placeholder="https:// (è²¼ä¸Šç…§ç‰‡é€£çµ)" style="font-size:12px; padding:8px;">
                            </div>
                            <div style="display:flex; flex-direction:column; gap:6px; width:50px;">
                                <label for="edit-input-partner-photo" class="btn-base btn-outline" style="height:100%; padding:0; display:flex; align-items:center; justify-content:center; margin:0;">ğŸ“</label>
                                <input type="file" id="edit-input-partner-photo" accept="image/*" style="display:none">
                                <button type="button" class="btn-base btn-primary" onclick="addPartnerToState('edit')" style="height:100%; padding:0; display:flex; align-items:center; justify-content:center; margin:0;">+</button>
                            </div>
                        </div>
                        <img id="edit-preview-partner-photo" style="width:40px; height:40px; border-radius:50%; object-fit:cover; display:none; margin-bottom:8px; border:2px solid var(--color-primary);">
                        
                        <div id="edit-selected-partners-box" class="selected-tags-container"></div>
                        <div id="edit-partner-suggestions" class="suggestions-dropdown"></div>
                    </div>
                </div>
                <div class="form-group"><label class="form-label">å‚™è¨»</label><textarea id="edit-note" class="form-control"></textarea></div>
                <div class="form-group"><label class="form-label">ç…§ç‰‡</label><label for="edit-input-photo" class="photo-upload-label">ğŸ“· æ›´æ›/ä¸Šå‚³ç…§ç‰‡</label><input type="file" id="edit-input-photo" accept="image/*" style="display:none"><img id="edit-preview-photo" class="photo-preview"></div>
                <div style="display:flex;gap:10px;margin-top:20px;"><button type="button" class="btn-base" style="background:#eee;color:#666;flex:1" onclick="closeEditModal()">å–æ¶ˆ</button><button type="submit" class="btn-base btn-primary" style="flex:1">å„²å­˜è®Šæ›´</button></div>
            </form>
        </div>
    </div>

    <div id="detail-modal" class="modal-overlay bottom-sheet"><div class="modal-content-bottom"><div style="display:flex;justify-content:space-between;margin-bottom:15px;"><span id="detail-date-time" style="font-size:18px;font-weight:800;"></span><button class="btn-close" onclick="closeDetailModal()">Ã—</button></div><div id="detail-photo-container" style="margin-bottom:20px;border-radius:16px;overflow:hidden;display:none;"><img id="detail-photo" style="width:100%;"></div><div style="display:flex;gap:10px;margin-bottom:15px;"><span id="detail-type" style="background:var(--color-primary);color:white;padding:4px 10px;border-radius:6px;font-size:12px;font-weight:bold;"></span><span id="detail-location" style="color:#666;font-size:14px;"></span></div><div id="detail-note-box" style="background:white;padding:15px;border-radius:12px;border:1px solid #eee;color:#555;font-size:15px;line-height:1.6;margin-bottom:25px;white-space:pre-wrap;display:none;"></div><div id="detail-empty-note" style="color:#aaa;font-style:italic;margin-bottom:20px;display:none">ç„¡å‚™è¨»</div><div style="display:flex;gap:10px;"><button id="detail-edit-btn" class="btn-base" style="background:#eee;flex:1;color:#333">ç·¨è¼¯</button><button id="detail-delete-btn" class="btn-base btn-danger" style="flex:1;">åˆªé™¤</button></div></div></div>
    <div id="daily-list-modal" class="modal-overlay bottom-sheet"><div class="modal-content-bottom"><div style="display:flex;justify-content:space-between;margin-bottom:15px;"><span id="daily-list-date" style="font-size:18px;font-weight:800;"></span><button class="btn-close" onclick="closeDailyListModal()">Ã—</button></div><div style="color:#666;font-size:14px;margin-bottom:15px;">å…± <span id="daily-count" style="font-weight:bold;color:var(--color-primary)"></span> ç­†ç´€éŒ„</div><div id="daily-list-container" style="display:flex;flex-direction:column;gap:10px;"></div></div></div>
    <div id="actor-form-modal" class="modal-overlay bottom-sheet"><div class="modal-content-bottom"><h3 id="actor-form-title" style="margin:0 0 20px 0;font-size:20px;">å»ºç«‹æ–°æª”æ¡ˆ</h3><form id="actor-form"><div class="form-group"><label class="form-label">å§“å</label><input type="text" id="actor-name" class="form-control" required></div>
        <div class="form-group" style="background: rgba(0,0,0,0.03); padding: 10px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
    <div>
        <label class="form-label" style="margin-bottom: 2px;">æª”æ¡ˆé¡å‹</label>
        <div style="font-size: 12px; color: #888;" id="actor-type-desc">ğŸ‘¤ çœŸäººæ¼”å“¡</div>
    </div>
    <label class="switch">
        <input type="checkbox" id="actor-is-collection" onchange="toggleActorTypeLabel()">
        <span class="slider round"></span>
    </label>
</div>
        <div class="form-group"><label class="form-label">é ­åƒ (è²¼ç¶²å€ æˆ– ä¸Šå‚³)</label><input type="url" id="actor-avatar-url" class="form-control" placeholder="https://..."><label for="actor-file-input" class="photo-upload-label">ğŸ“ ä¸Šå‚³æœ¬åœ°åœ–ç‰‡</label><input type="file" id="actor-file-input" accept="image/*" style="display:none"><img id="actor-preview" class="photo-preview"></div><div class="form-group"><label class="form-label">å€‹äººç¶²ç«™ / X (Twitter)</label><input type="url" id="actor-website" class="form-control" placeholder="https://twitter.com/..."></div><div class="form-group" style="position:relative;"><label class="form-label">æ¨™ç±¤ (Hashtag)</label><input type="text" id="actor-tags" class="form-control" placeholder="#å·¨å±Œ #Daddy (ç”¨ç©ºç™½åˆ†éš”)" autocomplete="off"><div id="tag-suggestions" class="suggestions-dropdown"></div></div><div class="form-group"><label class="form-label">ç°¡ä»‹</label><textarea id="actor-bio" class="form-control" rows="5" placeholder="ç°¡ä»‹ (é¸å¡«)"></textarea></div><div style="display:flex;gap:10px;margin-top:20px;"><button type="button" class="btn-base" style="background:#eee;color:#666;flex:1" onclick="closeActorFormModal()">å–æ¶ˆ</button><button type="submit" id="actor-form-submit" class="btn-base btn-primary" style="flex:1">å„²å­˜</button></div></form></div></div>
    <div id="video-form-modal" class="modal-overlay bottom-sheet"><div class="modal-content-bottom"><h3 id="video-form-title" style="margin:0 0 20px 0;font-size:20px;">å½±ç‰‡è³‡è¨Š</h3><form id="video-form"><div class="form-group"><label class="form-label">æ¨™é¡Œ</label><input type="text" id="video-title" class="form-control" required></div><div class="form-group"><label class="form-label">é€£çµ</label><input type="url" id="video-url" class="form-control" placeholder="https://..." required></div><div class="form-group"><label class="form-label">å°é¢ (è²¼ç¶²å€ æˆ– ä¸Šå‚³)</label><input type="url" id="video-thumb-url" class="form-control" placeholder="https://..."><label for="video-file-input" class="photo-upload-label">ğŸ“ ä¸Šå‚³å°é¢åœ–</label><input type="file" id="video-file-input" accept="image/*" style="display:none"><img id="video-preview" class="photo-preview"></div><!-- Video Tags --><div class="form-group" style="position:relative;"><label class="form-label">æ¨™ç±¤ (Hashtag)</label><input type="text" id="video-tags" class="form-control" placeholder="#cum #bukkake (ç”¨ç©ºç™½åˆ†éš”)" autocomplete="off"><div id="video-tag-suggestions" class="suggestions-dropdown"></div></div><div class="form-group"><label class="form-label">å‚™è¨»</label><textarea id="video-note" class="form-control"></textarea></div><div style="display:flex;gap:10px;margin-top:20px;"><button type="button" class="btn-base" style="background:#eee;color:#666;flex:1" onclick="closeVideoFormModal()">å–æ¶ˆ</button><button type="submit" id="video-form-submit" class="btn-base btn-primary" style="flex:1">å„²å­˜</button></div></form></div></div>
    <div id="video-detail-modal" class="modal-overlay bottom-sheet"><div class="modal-content-bottom"><div style="display:flex;justify-content:flex-end;margin-bottom:10px;"><button class="btn-close" onclick="closeVideoDetail()">Ã—</button></div><div id="vid-detail-cover-box" class="vid-detail-cover-box" style="display:none"><img id="vid-detail-cover" class="vid-detail-cover"></div><div id="vid-detail-title" class="vid-detail-title"></div><div id="vid-detail-note" class="vid-detail-note" style="display:none"></div><div class="vid-actions"><button id="vid-btn-edit" class="btn-base" style="background:#eee;color:#333;">âœï¸ ç·¨è¼¯</button><button id="vid-btn-delete" class="btn-base btn-danger">ğŸ—‘ï¸ åˆªé™¤</button><button id="vid-btn-watch" class="btn-base btn-accent vid-main-action">ğŸš€ å‰å¾€è§€çœ‹</button></div></div></div>
    <div id="photo-form-modal" class="modal-overlay bottom-sheet">
        <div class="modal-content-bottom">
            <h3 style="margin:0 0 20px 0;font-size:20px;">æ–°å¢ç…§ç‰‡</h3>
            <form id="photo-form">
                <div class="form-group">
                    <label class="form-label">ç…§ç‰‡ä¾†æº</label>
                    <label for="album-file-input" class="photo-upload-label">ğŸ“ ä¸Šå‚³åœ–ç‰‡</label>
                    <input type="file" id="album-file-input" accept="image/*" style="display:none">
                    <input type="url" id="album-url-input" class="form-control" placeholder="æˆ–è²¼ä¸Šåœ–ç‰‡ç¶²å€ (https://...)" style="margin-top:10px;">
                    <img id="album-preview" class="photo-preview">
                </div>
                <div class="form-group">
                    <label class="form-label">èªªæ˜ (é¸å¡«)</label>
                    <input type="text" id="album-caption" class="form-control" placeholder="å‚™è¨»...">
                </div>
                <div style="display:flex;gap:10px;margin-top:20px;">
                    <button type="button" class="btn-base" style="background:#eee;color:#666;flex:1" onclick="document.getElementById('photo-form-modal').classList.remove('active')">å–æ¶ˆ</button>
                    <button type="submit" class="btn-base btn-primary" style="flex:1">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <div id="photo-view-modal" class="modal-overlay">
        <div class="modal-content-bottom" style="background:rgba(0,0,0,0.9); border-radius:0; height:100%; padding-top:safe-area-inset-top; display:flex; flex-direction:column; justify-content:center;">
            <div style="position:absolute; top:40px; right:20px; z-index:10;">
                <button class="btn-close" style="background:rgba(255,255,255,0.2); color:white;" onclick="document.getElementById('photo-view-modal').classList.remove('active')">Ã—</button>
            </div>
            <img id="pv-img" class="photo-viewer-img">
            <div id="pv-caption" style="color:white; text-align:center; margin-top:15px; font-size:16px; font-weight:bold;"></div>
            <div style="display:flex; gap:15px; margin-top:30px; justify-content:center;">
                <button id="pv-btn-delete" class="btn-base btn-danger" style="width:auto; padding:10px 30px;">ğŸ—‘ï¸ åˆªé™¤æ­¤ç…§ç‰‡</button>
            </div>
        </div>
    </div>
    <div id="partner-detail-modal" class="modal-overlay bottom-sheet">
        <div class="modal-content-bottom">
            <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
                <button class="btn-close" onclick="closePartnerDetail()">Ã—</button>
            </div>
            
            <div style="text-align:center; margin-bottom:20px;">
                <img id="pd-avatar" style="width:100px; height:100px; border-radius:50%; object-fit:cover; border:3px solid white; box-shadow:0 4px 15px rgba(0,0,0,0.1); margin-bottom:15px;">
                <div style="display:flex; align-items:center; justify-content:center; gap:8px;">
                    <div id="pd-name" style="font-size:22px; font-weight:800; color:#333;"></div>
                    <div id="pd-flag" style="font-size:22px;"></div>
                </div>
                <div id="pd-meta" style="font-size:13px; color:#888; margin-top:5px;"></div>
                <div id="pd-stats" style="margin-top:15px; display:inline-block; background:rgba(255,105,180,0.1); color:var(--color-accent); padding:6px 15px; border-radius:20px; font-weight:bold; font-size:14px;">
                    ç´¯ç©æ¬¡æ•¸ï¼š0 æ¬¡
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-bottom:25px;">
                <button class="btn-base" style="flex:1; background:#f0f0f0; color:#333;" onclick="openPartnerEditForm()">âœï¸ ç·¨è¼¯</button>
                <button class="btn-base btn-danger" style="flex:1;" onclick="deleteCurrentPartner()">ğŸ—‘ï¸ åˆªé™¤</button>
            </div>

            <div class="section-header" style="font-size:15px; margin-bottom:15px;">ğŸ“œ æˆ°å½¹ç´€éŒ„</div>
            <div id="pd-history-list" style="display:flex; flex-direction:column; gap:10px; max-height:300px; overflow-y:auto;"></div>
        </div>
    </div>

    <div id="partner-form-modal" class="modal-overlay bottom-sheet">
        <div class="modal-content-bottom">
            <h3 style="margin:0 0 20px 0;font-size:20px;">ç·¨è¼¯å¤¥ä¼´è³‡æ–™</h3>
            <form id="partner-edit-form">
                <div class="form-group"><label class="form-label">å§“å</label><input type="text" id="pf-name" class="form-control" required></div>
                <div class="form-group">
                    <label class="form-label">ç…§ç‰‡</label>
                    <div style="display:flex; gap:10px; align-items:center;">
                        <img id="pf-preview" class="photo-preview" style="width:60px; height:60px; display:block; object-fit:cover; border-radius:50%; margin:0;">
                        <div style="flex:1;">
                            <input type="url" id="pf-url" class="form-control" placeholder="è²¼ä¸Šç…§ç‰‡é€£çµ..." style="margin-bottom:5px;">
                            <label for="pf-file" class="btn-base btn-outline" style="padding:6px; font-size:12px; width:100%;">æˆ– ä¸Šå‚³æª”æ¡ˆ</label>
                            <input type="file" id="pf-file" accept="image/*" style="display:none">
                        </div>
                    </div>
                </div>
                <div class="form-group" style="position:relative;">
                    <label class="form-label">åœ‹ç± (æœå°‹)</label>
                    <input type="text" id="pf-nation-search" class="form-control" placeholder="è¼¸å…¥é—œéµå­— (å¦‚: å°ç£, Jap...)" autocomplete="off">
                    <input type="hidden" id="pf-nation-data"> <div id="pf-nation-suggestions" class="suggestions-dropdown"></div>
                </div>
                <div class="form-group"><label class="form-label">äººç¨® / å‚™è¨»</label><textarea id="pf-race" class="form-control" placeholder="ä¾‹å¦‚ï¼šæ‹‰ä¸è£”, æ··è¡€..."></textarea></div>
                
                <div style="display:flex;gap:10px;margin-top:20px;">
                    <button type="button" class="btn-base" style="background:#eee;color:#666;flex:1" onclick="document.getElementById('partner-form-modal').classList.remove('active')">å–æ¶ˆ</button>
                    <button type="submit" class="btn-base btn-primary" style="flex:1">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>
    <!-- Lock Screen -->
    <div id="lock-screen">
        <div class="lock-title" id="lock-title">è¼¸å…¥å¯†ç¢¼</div>
        <div class="lock-dots" id="lock-dots">
            <div class="lock-dot"></div><div class="lock-dot"></div><div class="lock-dot"></div><div class="lock-dot"></div>
        </div>
        <div class="keypad">
            <div class="key-btn" onclick="pressKey(1)">1</div><div class="key-btn" onclick="pressKey(2)">2</div><div class="key-btn" onclick="pressKey(3)">3</div>
            <div class="key-btn" onclick="pressKey(4)">4</div><div class="key-btn" onclick="pressKey(5)">5</div><div class="key-btn" onclick="pressKey(6)">6</div>
            <div class="key-btn" onclick="pressKey(7)">7</div><div class="key-btn" onclick="pressKey(8)">8</div><div class="key-btn" onclick="pressKey(9)">9</div>
            <div class="key-btn transparent" onclick="cancelPasscode()">å–æ¶ˆ</div><div class="key-btn" onclick="pressKey(0)">0</div><div class="key-btn transparent" onclick="deleteKey()">âŒ«</div>
        </div>
    </div>

    <nav id="tab-bar">
        <button class="tab-item active" data-target="home"><span class="tab-icon">ğŸ </span><span class="tab-label">é¦–é </span></button>
        <button class="tab-item" data-target="record"><span class="tab-icon">ğŸ¥’</span><span class="tab-label">ç´€éŒ„</span></button>
        <button class="tab-item" data-target="diary"><span class="tab-icon">ğŸ“–</span><span class="tab-label">æ—¥è¨˜</span></button>
        <button class="tab-item" data-target="stats"><span class="tab-icon">ğŸ“Š</span><span class="tab-label">æ•¸æ“š</span></button>
        <button class="tab-item" data-target="driver"><span class="tab-icon">ğŸ—„ï¸</span><span class="tab-label">æ”¶è—æ«ƒ</span></button>
    </nav>
    
    <datalist id="location-list"></datalist>

    <!-- PWA Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => {
                        console.log('SW registered!', reg);
                        // Optional: Check for updates
                        reg.onupdatefound = () => {
                            const installingWorker = reg.installing;
                            installingWorker.onstatechange = () => {
                                if (installingWorker.state === 'installed') {
                                    if (navigator.serviceWorker.controller) {
                                        console.log('New content is available; please refresh.');
                                    } else {
                                        console.log('Content is cached for offline use.');
                                    }
                                }
                            };
                        };
                    })
                    .catch(err => console.log('SW registration failed', err));
            });
        }
    </script>

    <script>
        const RECORD_KEY = 'cuteCumberData';
        const ACTOR_KEY = 'cuteCumberActors';
        const ACH_KEY = 'cuteCumberUnlocked';
        const PROFILE_KEY = 'cuteCumberProfile';
        
        let ejaculationRecords = [];
        let actorProfiles = [];
        let unlockedAchievements = [];
        let userProfile = { nickname: '', birthday: '' };
        
        let currentActorId = null;
        let editingActorId = null;
        let editingVideoId = null;
        let editingRecordId = null;
        
        let currentCalendarDate = new Date();
        let tempRecordPhoto = "";
        let tempActorAvatar = "";
        let tempVideoThumb = "";
        // --- Multi-Select Logic ---
        let tempActorsList = []; // [ {id, name}, ... ] (For Record Form)
        let editTempActorsList = []; // (For Edit Form)
        // --- Partner Logic ---
        let tempPartnerList = []; // [{name, photo}]
        let editTempPartnerList = [];
        let currentPartnerPhoto = ""; // æš«å­˜æ­£åœ¨è¼¸å…¥çš„é‚£ä½å¤¥ä¼´çš„ç…§ç‰‡
        const PARTNER_KEY = 'cuteCumberPartners';
        let partnerProfiles = [];
        let currentPartnerName = null; // ç”¨æ–¼ç·¨è¼¯/æŸ¥çœ‹è©³æƒ…
        
        // å®Œæ•´åœ‹å®¶åˆ—è¡¨ (æ¶µè“‹å…¨çƒä¸»è¦åœ‹å®¶èˆ‡åœ°å€ - å« ISO ä»£ç¢¼ç‰ˆ)
        const COUNTRY_LIST = [
            // --- æ±äº ---
            {n:"å°ç£",f:"ğŸ‡¹ğŸ‡¼",c:"TW"}, {n:"æ—¥æœ¬",f:"ğŸ‡¯ğŸ‡µ",c:"JP"}, {n:"éŸ“åœ‹",f:"ğŸ‡°ğŸ‡·",c:"KR"}, {n:"ä¸­åœ‹",f:"ğŸ‡¨ğŸ‡³",c:"CN"}, {n:"é¦™æ¸¯",f:"ğŸ‡­ğŸ‡°",c:"HK"}, {n:"æ¾³é–€",f:"ğŸ‡²ğŸ‡´",c:"MO"}, {n:"è’™å¤",f:"ğŸ‡²ğŸ‡³",c:"MN"}, {n:"åŒ—éŸ“",f:"ğŸ‡°ğŸ‡µ",c:"KP"},
            
            // --- æ±å—äº ---
            {n:"æ³°åœ‹",f:"ğŸ‡¹ğŸ‡­",c:"TH"}, {n:"è¶Šå—",f:"ğŸ‡»ğŸ‡³",c:"VN"}, {n:"è²å¾‹è³“",f:"ğŸ‡µğŸ‡­",c:"PH"}, {n:"é¦¬ä¾†è¥¿äº",f:"ğŸ‡²ğŸ‡¾",c:"MY"}, {n:"æ–°åŠ å¡",f:"ğŸ‡¸ğŸ‡¬",c:"SG"}, {n:"å°å°¼",f:"ğŸ‡®ğŸ‡©",c:"ID"}, 
            {n:"æŸ¬åŸ”å¯¨",f:"ğŸ‡°ğŸ‡­",c:"KH"}, {n:"ç·¬ç”¸",f:"ğŸ‡²ğŸ‡²",c:"MM"}, {n:"å¯®åœ‹",f:"ğŸ‡±ğŸ‡¦",c:"LA"}, {n:"æ±¶èŠ",f:"ğŸ‡§ğŸ‡³",c:"BN"}, {n:"æ±å¸æ±¶",f:"ğŸ‡¹ğŸ‡±",c:"TL"},
            
            // --- å—äº ---
            {n:"å°åº¦",f:"ğŸ‡®ğŸ‡³",c:"IN"}, {n:"å·´åŸºæ–¯å¦",f:"ğŸ‡µğŸ‡°",c:"PK"}, {n:"å­ŸåŠ æ‹‰",f:"ğŸ‡§ğŸ‡©",c:"BD"}, {n:"æ–¯é‡Œè˜­å¡",f:"ğŸ‡±ğŸ‡°",c:"LK"}, {n:"å°¼æ³Šçˆ¾",f:"ğŸ‡³ğŸ‡µ",c:"NP"}, {n:"ä¸ä¸¹",f:"ğŸ‡§ğŸ‡¹",c:"BT"}, {n:"é¦¬çˆ¾åœ°å¤«",f:"ğŸ‡²ğŸ‡»",c:"MV"},
            
            // --- ç¾æ´² (åŒ—ç¾/ä¸­ç¾/å—ç¾) ---
            {n:"ç¾åœ‹",f:"ğŸ‡ºğŸ‡¸",c:"US"}, {n:"åŠ æ‹¿å¤§",f:"ğŸ‡¨ğŸ‡¦",c:"CA"}, {n:"å¢¨è¥¿å“¥",f:"ğŸ‡²ğŸ‡½",c:"MX"}, {n:"å·´è¥¿",f:"ğŸ‡§ğŸ‡·",c:"BR"}, {n:"é˜¿æ ¹å»·",f:"ğŸ‡¦ğŸ‡·",c:"AR"}, {n:"æ™ºåˆ©",f:"ğŸ‡¨ğŸ‡±",c:"CL"}, 
            {n:"å“¥å€«æ¯”äº",f:"ğŸ‡¨ğŸ‡´",c:"CO"}, {n:"ç§˜é­¯",f:"ğŸ‡µğŸ‡ª",c:"PE"}, {n:"å§”å…§ç‘æ‹‰",f:"ğŸ‡»ğŸ‡ª",c:"VE"}, {n:"å„ç“œå¤š",f:"ğŸ‡ªğŸ‡¨",c:"EC"}, {n:"ç»åˆ©ç¶­äº",f:"ğŸ‡§ğŸ‡´",c:"BO"}, {n:"å·´æ‹‰åœ­",f:"ğŸ‡µğŸ‡¾",c:"PY"}, {n:"çƒæ‹‰åœ­",f:"ğŸ‡ºğŸ‡¾",c:"UY"},
            {n:"å¤å·´",f:"ğŸ‡¨ğŸ‡º",c:"CU"}, {n:"ç‰™è²·åŠ ",f:"ğŸ‡¯ğŸ‡²",c:"JM"}, {n:"å·´æ‹¿é¦¬",f:"ğŸ‡µğŸ‡¦",c:"PA"}, {n:"å“¥æ–¯å¤§é»åŠ ",f:"ğŸ‡¨ğŸ‡·",c:"CR"}, {n:"å¤šæ˜å°¼åŠ ",f:"ğŸ‡©ğŸ‡´",c:"DO"}, {n:"æµ·åœ°",f:"ğŸ‡­ğŸ‡¹",c:"HT"}, {n:"è²é‡Œæ–¯",f:"ğŸ‡§ğŸ‡¿",c:"BZ"},
            {n:"å®éƒ½æ‹‰æ–¯",f:"ğŸ‡­ğŸ‡³",c:"HN"}, {n:"è–©çˆ¾ç“¦å¤š",f:"ğŸ‡¸ğŸ‡»",c:"SV"}, {n:"å°¼åŠ æ‹‰ç“œ",f:"ğŸ‡³ğŸ‡®",c:"NI"}, {n:"ç“œåœ°é¦¬æ‹‰",f:"ğŸ‡¬ğŸ‡¹",c:"GT"},
            
            // --- æ­æ´² (è¥¿æ­/åŒ—æ­/å—æ­/æ±æ­) ---
            {n:"è‹±åœ‹",f:"ğŸ‡¬ğŸ‡§",c:"GB"}, {n:"æ³•åœ‹",f:"ğŸ‡«ğŸ‡·",c:"FR"}, {n:"å¾·åœ‹",f:"ğŸ‡©ğŸ‡ª",c:"DE"}, {n:"ç¾©å¤§åˆ©",f:"ğŸ‡®ğŸ‡¹",c:"IT"}, {n:"è¥¿ç­ç‰™",f:"ğŸ‡ªğŸ‡¸",c:"ES"}, {n:"è‘¡è„ç‰™",f:"ğŸ‡µğŸ‡¹",c:"PT"},
            {n:"è·è˜­",f:"ğŸ‡³ğŸ‡±",c:"NL"}, {n:"æ¯”åˆ©æ™‚",f:"ğŸ‡§ğŸ‡ª",c:"BE"}, {n:"ç‘å£«",f:"ğŸ‡¨ğŸ‡­",c:"CH"}, {n:"å¥§åœ°åˆ©",f:"ğŸ‡¦ğŸ‡¹",c:"AT"}, {n:"ç‘å…¸",f:"ğŸ‡¸ğŸ‡ª",c:"SE"}, {n:"æŒªå¨",f:"ğŸ‡³ğŸ‡´",c:"NO"}, {n:"èŠ¬è˜­",f:"ğŸ‡«ğŸ‡®",c:"FI"}, {n:"ä¸¹éº¥",f:"ğŸ‡©ğŸ‡°",c:"DK"}, {n:"å†°å³¶",f:"ğŸ‡®ğŸ‡¸",c:"IS"},
            {n:"æ„›çˆ¾è˜­",f:"ğŸ‡®ğŸ‡ª",c:"IE"}, {n:"å¸Œè‡˜",f:"ğŸ‡¬ğŸ‡·",c:"GR"}, {n:"åœŸè€³å…¶",f:"ğŸ‡¹ğŸ‡·",c:"TR"}, {n:"ä¿„ç¾…æ–¯",f:"ğŸ‡·ğŸ‡º",c:"RU"}, {n:"çƒå…‹è˜­",f:"ğŸ‡ºğŸ‡¦",c:"UA"}, {n:"æ³¢è˜­",f:"ğŸ‡µğŸ‡±",c:"PL"}, {n:"æ·å…‹",f:"ğŸ‡¨ğŸ‡¿",c:"CZ"}, {n:"åŒˆç‰™åˆ©",f:"ğŸ‡­ğŸ‡º",c:"HU"},
            {n:"ç¾…é¦¬å°¼äº",f:"ğŸ‡·ğŸ‡´",c:"RO"}, {n:"ä¿åŠ åˆ©äº",f:"ğŸ‡§ğŸ‡¬",c:"BG"}, {n:"å¡çˆ¾ç¶­äº",f:"ğŸ‡·ğŸ‡¸",c:"RS"}, {n:"å…‹ç¾…åŸƒè¥¿äº",f:"ğŸ‡­ğŸ‡·",c:"HR"}, {n:"æ–¯æ´›ä¼å…‹",f:"ğŸ‡¸ğŸ‡°",c:"SK"}, {n:"æ–¯æ´›ç¶­å°¼äº",f:"ğŸ‡¸ğŸ‡®",c:"SI"},
            {n:"æ„›æ²™å°¼äº",f:"ğŸ‡ªğŸ‡ª",c:"EE"}, {n:"æ‹‰è„«ç¶­äº",f:"ğŸ‡±ğŸ‡»",c:"LV"}, {n:"ç«‹é™¶å®›",f:"ğŸ‡±ğŸ‡¹",c:"LT"}, {n:"ç™½ä¿„ç¾…æ–¯",f:"ğŸ‡§ğŸ‡¾",c:"BY"}, {n:"ç›§æ£®å ¡",f:"ğŸ‡±ğŸ‡º",c:"LU"}, {n:"æ‘©ç´å“¥",f:"ğŸ‡²ğŸ‡¨",c:"MC"}, {n:"æ¢µè’‚å²¡",f:"ğŸ‡»ğŸ‡¦",c:"VA"}, {n:"é¦¬çˆ¾ä»–",f:"ğŸ‡²ğŸ‡¹",c:"MT"},
            
            // --- å¤§æ´‹æ´² ---
            {n:"æ¾³æ´²",f:"ğŸ‡¦ğŸ‡º",c:"AU"}, {n:"ç´è¥¿è˜­",f:"ğŸ‡³ğŸ‡¿",c:"NZ"}, {n:"æ–æ¿Ÿ",f:"ğŸ‡«ğŸ‡¯",c:"FJ"}, {n:"å·´å¸ƒäºç´å¹¾å…§äº",f:"ğŸ‡µğŸ‡¬",c:"PG"}, {n:"å¸›ç‰",f:"ğŸ‡µğŸ‡¼",c:"PW"}, {n:"é—œå³¶",f:"ğŸ‡¬ğŸ‡º",c:"GU"},
            
            // --- ä¸­äº/è¥¿äº (ä¸­æ±) ---
            {n:"æ²™çƒåœ°é˜¿æ‹‰ä¼¯",f:"ğŸ‡¸ğŸ‡¦",c:"SA"}, {n:"é˜¿è¯é…‹",f:"ğŸ‡¦ğŸ‡ª",c:"AE"}, {n:"ä¼Šæœ—",f:"ğŸ‡®ğŸ‡·",c:"IR"}, {n:"ä¼Šæ‹‰å…‹",f:"ğŸ‡®ğŸ‡¶",c:"IQ"}, {n:"ä»¥è‰²åˆ—",f:"ğŸ‡®ğŸ‡±",c:"IL"}, {n:"å¡é”",f:"ğŸ‡¶ğŸ‡¦",c:"QA"}, {n:"ç§‘å¨ç‰¹",f:"ğŸ‡°ğŸ‡¼",c:"KW"},
            {n:"ç´„æ—¦",f:"ğŸ‡¯ğŸ‡´",c:"JO"}, {n:"é»å·´å«©",f:"ğŸ‡±ğŸ‡§",c:"LB"}, {n:"é˜¿æ›¼",f:"ğŸ‡´ğŸ‡²",c:"OM"}, {n:"è‘‰é–€",f:"ğŸ‡¾ğŸ‡ª",c:"YE"}, {n:"å·´æ—",f:"ğŸ‡§ğŸ‡­",c:"BH"}, {n:"æ•˜åˆ©äº",f:"ğŸ‡¸ğŸ‡¾",c:"SY"}, {n:"äºå¡æ‹œç„¶",f:"ğŸ‡¦ğŸ‡¿",c:"AZ"}, {n:"å“ˆè–©å…‹",f:"ğŸ‡°ğŸ‡¿",c:"KZ"}, {n:"çƒèŒ²åˆ¥å…‹",f:"ğŸ‡ºğŸ‡¿",c:"UZ"},
            
            // --- éæ´² ---
            {n:"åŸƒåŠ",f:"ğŸ‡ªğŸ‡¬",c:"EG"}, {n:"å—é",f:"ğŸ‡¿ğŸ‡¦",c:"ZA"}, {n:"æ‘©æ´›å“¥",f:"ğŸ‡²ğŸ‡¦",c:"MA"}, {n:"å¥ˆåŠåˆ©äº",f:"ğŸ‡³ğŸ‡¬",c:"NG"}, {n:"è‚¯äº",f:"ğŸ‡°ğŸ‡ª",c:"KE"}, {n:"è¡£ç´¢æ¯”äº",f:"ğŸ‡ªğŸ‡¹",c:"ET"}, {n:"è¿¦ç´",f:"ğŸ‡¬ğŸ‡­",c:"GH"},
            {n:"å¦å°šå°¼äº",f:"ğŸ‡¹ğŸ‡¿",c:"TZ"}, {n:"é˜¿çˆ¾åŠåˆ©äº",f:"ğŸ‡©ğŸ‡¿",c:"DZ"}, {n:"çªå°¼è¥¿äº",f:"ğŸ‡¹ğŸ‡³",c:"TN"}, {n:"çƒå¹²é”",f:"ğŸ‡ºğŸ‡¬",c:"UG"}, {n:"å–€éº¥éš†",f:"ğŸ‡¨ğŸ‡²",c:"CM"}, {n:"å¡å…§åŠ çˆ¾",f:"ğŸ‡¸ğŸ‡³",c:"SN"}, {n:"è±¡ç‰™æµ·å²¸",f:"ğŸ‡¨ğŸ‡®",c:"CI"}, {n:"é¦¬é”åŠ æ–¯åŠ ",f:"ğŸ‡²ğŸ‡¬",c:"MG"}
        ];
        const DEFAULT_AVATAR = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23cccccc'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E`;
        let myChart = null;
        
        // --- Callbacks ---
        let sysConfirmCallback = null;
        let onAchievementClose = null;

        // --- Passcode Logic ---
        let passcodeBuffer = "";
        let passcodeMode = "UNLOCK"; // UNLOCK, SET, CONFIRM, DISABLE
        let tempPasscode = ""; // For confirmation step

        window.pressKey = function(num) {
            if (passcodeBuffer.length < 4) {
                passcodeBuffer += num;
                updateDots();
                if (passcodeBuffer.length === 4) {
                    setTimeout(checkPasscode, 100);
                }
            }
        };

        window.deleteKey = function() {
            passcodeBuffer = passcodeBuffer.slice(0, -1);
            updateDots();
        };
        
        window.cancelPasscode = function() {
            // åªæœ‰åœ¨è¨­å®šæ¨¡å¼ä¸‹å¯ä»¥å–æ¶ˆï¼Œè§£é–æ¨¡å¼ä¸‹ä¸èƒ½å–æ¶ˆ
            if (passcodeMode === 'SET' || passcodeMode === 'CONFIRM' || passcodeMode === 'DISABLE') {
                 closeLockScreen();
                 // å¦‚æœæ˜¯å–æ¶ˆè¨­å®šï¼ŒæŠŠé–‹é—œåˆ‡å›åŸæœ¬ç‹€æ…‹
                 const toggle = document.getElementById('passcode-toggle');
                 const hasPass = !!localStorage.getItem('cuteCumberPasscode');
                 if(toggle) toggle.checked = hasPass;
            }
        };

        function updateDots() {
            const dots = document.querySelectorAll('.lock-dot');
            dots.forEach((dot, idx) => {
                if (idx < passcodeBuffer.length) dot.classList.add('filled');
                else dot.classList.remove('filled');
            });
        }

        function showLockScreen(mode, title) {
            passcodeMode = mode;
            passcodeBuffer = "";
            updateDots();
            document.getElementById('lock-title').textContent = title;
            document.getElementById('lock-screen').classList.add('active');
            
            // æ§åˆ¶å–æ¶ˆæŒ‰éˆ•é¡¯ç¤º (è§£é–æ™‚ä¸èƒ½å–æ¶ˆ)
            const cancelBtn = document.querySelector('.key-btn.transparent'); 
            if(mode === 'UNLOCK') cancelBtn.style.visibility = 'hidden';
            else cancelBtn.style.visibility = 'visible';
        }

        function closeLockScreen() {
            document.getElementById('lock-screen').classList.remove('active');
            passcodeBuffer = "";
        }

        function checkPasscode() {
            const saved = localStorage.getItem('cuteCumberPasscode');
            
            if (passcodeMode === 'UNLOCK') {
                if (passcodeBuffer === saved) {
                    closeLockScreen();
                } else {
                    shakeLock();
                }
            } else if (passcodeMode === 'SET') {
                tempPasscode = passcodeBuffer;
                showLockScreen('CONFIRM', 'è«‹å†æ¬¡è¼¸å…¥ä»¥ç¢ºèª');
            } else if (passcodeMode === 'CONFIRM') {
                if (passcodeBuffer === tempPasscode) {
                    localStorage.setItem('cuteCumberPasscode', passcodeBuffer);
                    closeLockScreen();
                    updatePasscodeUI();
                    showAlert('å¯†ç¢¼é–å·²è¨­å®šï¼');
                } else {
                    showAlert('å¯†ç¢¼ä¸ç›¸ç¬¦ï¼Œè«‹é‡æ–°è¨­å®š');
                    showLockScreen('SET', 'è¨­å®šæ–°å¯†ç¢¼');
                }
            } else if (passcodeMode === 'DISABLE') {
                if (passcodeBuffer === saved) {
                    localStorage.removeItem('cuteCumberPasscode');
                    closeLockScreen();
                    updatePasscodeUI();
                    showAlert('å¯†ç¢¼é–å·²é—œé–‰');
                } else {
                    shakeLock();
                }
            }
        }

        function shakeLock() {
            const dots = document.getElementById('lock-dots');
            dots.style.animation = 'shake 0.3s';
            setTimeout(() => { 
                dots.style.animation = ''; 
                passcodeBuffer = ""; 
                updateDots(); 
            }, 300);
        }
        
        // UI Helpers
        window.togglePasscodeSwitch = function() {
            const toggle = document.getElementById('passcode-toggle');
            const hasPass = !!localStorage.getItem('cuteCumberPasscode');
            
            if (toggle.checked && !hasPass) {
                showLockScreen('SET', 'è¨­å®šæ–°å¯†ç¢¼');
            } else if (!toggle.checked && hasPass) {
                showLockScreen('DISABLE', 'è¼¸å…¥èˆŠå¯†ç¢¼ä»¥é—œé–‰');
            }
        };
        
        window.startChangePasscode = function() {
            showLockScreen('SET', 'è¨­å®šæ–°å¯†ç¢¼');
        };

        function updatePasscodeUI() {
            const hasPass = !!localStorage.getItem('cuteCumberPasscode');
            const toggle = document.getElementById('passcode-toggle');
            const changeBtn = document.getElementById('btn-change-passcode');
            if(toggle) toggle.checked = hasPass;
            if(changeBtn) changeBtn.style.display = hasPass ? 'block' : 'none';
        }

        // --- Random Picker Logic ---
        window.rollTheDice = function() {
            if (actorProfiles.length === 0) {
                showAlert("æ”¶è—æ«ƒæ˜¯ç©ºçš„ï¼Œå…ˆæ–°å¢ä¸€é»è³‡æ–™å§ï¼");
                return;
            }

            // éœ‡å‹•å›é¥‹
            if(navigator.vibrate) navigator.vibrate(50);

            // æ±ºå®šé¡å‹ (0: Actor, 1: Video)
            // å¦‚æœå®Œå…¨æ²’æœ‰å½±ç‰‡ï¼Œå¼·åˆ¶é¸ Actor
            const allVideos = actorProfiles.flatMap(a => a.videos || []);
            let type = (Math.random() > 0.5 && allVideos.length > 0) ? 'video' : 'actor';

            const container = document.getElementById('random-result-container');
            const goBtn = document.getElementById('btn-random-go');
            let resultHtml = '';

            if (type === 'actor') {
                // éš¨æ©Ÿé¸äºº
                const actor = actorProfiles[Math.floor(Math.random() * actorProfiles.length)];
                const img = actor.avatar || DEFAULT_AVATAR;
                resultHtml = `
                    <img src="${img}" style="width:100px; height:100px; border-radius:50%; object-fit:cover; margin:0 auto 15px auto; border:3px solid white; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
                    <div style="font-size:20px; font-weight:bold; color:var(--color-text);">${actor.name}</div>
                    <div style="font-size:13px; color:#888; margin-top:5px;">(äººç‰©æª”æ¡ˆ)</div>
                `;
                goBtn.onclick = () => {
                    closeRandomModal();
                    showDriverDetail(actor.id);
                };
            } else {
                // éš¨æ©Ÿé¸å½±ç‰‡
                // å…ˆéš¨æ©Ÿé¸ä¸€å€‹æœ‰å½±ç‰‡çš„äººç‰©
                const actorsWithVideos = actorProfiles.filter(a => a.videos && a.videos.length > 0);
                const actor = actorsWithVideos[Math.floor(Math.random() * actorsWithVideos.length)];
                const video = actor.videos[Math.floor(Math.random() * actor.videos.length)];
                
                let imgHtml = '<div style="width:100%; height:120px; background:#eee; border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:40px;">ğŸ¬</div>';
                if(video.thumbnail) {
                    imgHtml = `<img src="${video.thumbnail}" style="width:100%; height:120px; object-fit:cover; border-radius:12px; border:1px solid #eee;">`;
                }

                resultHtml = `
                    ${imgHtml}
                    <div style="font-size:16px; font-weight:bold; color:var(--color-text); margin-top:15px; line-height:1.3;">${video.title}</div>
                    <div style="font-size:12px; color:var(--color-primary); margin-top:5px;">ä¸»æ¼”: ${actor.name}</div>
                `;
                goBtn.onclick = () => {
                    closeRandomModal();
                    // ç›´æ¥æ‰“é–‹å½±ç‰‡è©³æƒ…
                    // æ³¨æ„ï¼šé€™è£¡éœ€è¦åˆ‡æ›åˆ°è©²äººç‰©çš„è©³æƒ…é ï¼Œä¸¦æ‰“é–‹å½±ç‰‡ Modal
                    showDriverDetail(actor.id);
                    setTimeout(() => {
                        openVideoDetail(actor.id, video.id);
                    }, 300);
                };
            }

            container.innerHTML = resultHtml;
            document.getElementById('random-modal').classList.add('active');
        };

        window.closeRandomModal = function() {
            document.getElementById('random-modal').classList.remove('active');
        };

        const ACHIEVEMENTS_DATA = [
            // Category A: Count (å–®äººå‰¯æœ¬)
            { id: 'count_1', icon: 'ğŸ£', title: 'åˆå‡ºèŒ…å»¬', desc: 'ç”¨æˆ¶é¦–æ¬¡ç´€éŒ„', msg: 'æ­¡è¿ä½ ï¼Œè€å¸æ©Ÿã€‚', type: 'count', thres: 1, category: 'A', catTitle: 'å–®äººå‰¯æœ¬' },
            { id: 'count_50', icon: 'ğŸ¼', title: 'é¤Šæ¨‚å¤š', desc: 'ç´¯è¨ˆè‡ªæ…° 50 æ¬¡', msg: 'æ­å–œï¼Œä½ å·²ç¶“ç”Ÿç”¢äº†ä¸€ç“¶é¤Šæ¨‚å¤šçš„é‡ã€‚', type: 'count', thres: 50, category: 'A', catTitle: 'å–®äººå‰¯æœ¬' },
            { id: 'count_100', icon: 'ğŸ§»', title: 'è¡›ç”Ÿç´™æ®ºæ‰‹', desc: 'ç´¯è¨ˆè‡ªæ…° 100 æ¬¡', msg: 'åœ°çƒä¸Šçš„æ¨¹æœ¨æ­£åœ¨ç‚ºä½ å“­æ³£ã€‚', type: 'count', thres: 100, category: 'A', catTitle: 'å–®äººå‰¯æœ¬' },
            { id: 'count_300', icon: 'âš’ï¸', title: 'æ–¯å·´é”çš„é€†è¥²', desc: 'ç´¯è¨ˆè‡ªæ…° 300 æ¬¡', msg: '300 ç™¼çš„æ„å¿—ï¼ä»Šæ™šï¼ŒåºŠé‚Šä¸€æˆ°å†æˆ°ï¼', type: 'count', thres: 300, category: 'A', catTitle: 'å–®äººå‰¯æœ¬' },
            { id: 'count_500', icon: 'ğŸ¤–', title: 'ç„¡æƒ…çš„ç™¼å°„æ©Ÿå™¨', desc: 'ç´¯è¨ˆè‡ªæ…° 500 æ¬¡', msg: 'ä½ å·²ç¶“æ²’æœ‰æ„Ÿæƒ…ï¼Œå…¨æ˜¯æŠ€å·§ã€‚', type: 'count', thres: 500, category: 'A', catTitle: 'å–®äººå‰¯æœ¬' },
            { id: 'count_1000', icon: 'ğŸ’ª', title: 'å‚³èªªä¸­çš„éº’éºŸè‡‚', desc: 'ç´¯è¨ˆè‡ªæ…° 1000 æ¬¡', msg: 'ä½ çš„æ…£ç”¨æ‰‹å·²ç¶“è¶…è¶Šäº†äººé¡æ¥µé™ï¼Œå¯ä»¥æ“Šç©¿é‹¼æ¿äº†å§ï¼Ÿ', type: 'count', thres: 1000, category: 'A', catTitle: 'å–®äººå‰¯æœ¬' },
            
            // Category B: Special Dates (ç‰¹åˆ¥çš„ä¸€å¤©)
            { id: 'special_bday', icon: 'ğŸ‚', title: 'ç¨è‡ªå¹è Ÿç‡­', desc: 'ç”Ÿæ—¥ç•¶å¤©è‡ªæ…°', msg: 'è¨±å€‹é¡˜å§...ç„¶å¾Œè¦ªæ‰‹å¯¦ç¾å®ƒã€‚ç¥ä½ ç”Ÿæ—¥å¿«æ¨‚ï¼', type: 'special', isBday: true, category: 'B', catTitle: 'ç‰¹åˆ¥çš„ä¸€å¤©' },
            { id: 'special_newyear', icon: 'ğŸ†', title: 'æ¶é ­é¦™', desc: 'Happy New Yearã€‚', msg: 'é›–ç„¶æ²’æœ‰ç…™ç«ï¼Œä½†ä½ è‡ªå·±æ”¾äº†ä¸€ç™¼æ…¶ç¥ã€‚å¥½çš„é–‹å§‹æ˜¯æˆåŠŸçš„ä¸€åŠï¼Ÿ', type: 'special', date: '01-01', category: 'B', catTitle: 'ç‰¹åˆ¥çš„ä¸€å¤©' },
            { id: 'special_leap', icon: 'ğŸ—¡ï¸', title: 'å››å¹´ç£¨ä¸€åŠ', desc: 'åœ¨ 2/29 è‡ªæ…°', msg: 'é¤Šå…µåƒæ—¥ï¼Œç”¨åœ¨ä¸€æ™‚ã€‚é€™ä¸€ç™¼ï¼Œè·¨è¶Šäº†å¥§æ—åŒ¹å…‹çš„é€±æœŸã€‚', type: 'special', date: '02-29', category: 'B', catTitle: 'ç‰¹åˆ¥çš„ä¸€å¤©' },
            { id: 'special_val', icon: 'ğŸ’”', title: 'å­¤å‚²çš„ç‹¼', desc: 'åœ¨æƒ…äººç¯€è‡ªæ…°', msg: 'é€™ä¸€å¤©ï¼Œæ‰‹æ˜¯ä½ æœ€å¥½çš„æƒ…äººã€‚', type:'special' , date:'02-14' , category:'B' , catTitle:'ç‰¹åˆ¥çš„ä¸€å¤©'},
            { id: 'special_halloween', icon: 'ğŸƒ', title: 'è¬è–å¤œçš„å­¤ç¨', desc: 'åœ¨è¬è–ç¯€è‡ªæ…°', msg: 'ç”¨é›™æ‰‹å¥½å¥½æ—è›‹ä¸€ä¸‹ã€‚', type:'special' , date:'10-31' , category:'B' , catTitle:'ç‰¹åˆ¥çš„ä¸€å¤©'},
            { id: 'special_xmas', icon: 'ğŸ„', title: 'ç™½è‰²è–èª•ç¯€', desc: 'åœ¨è–èª•ç¯€(å¹³å®‰å¤œ)è‡ªæ…°', msg: 'Jingle bells, Jingle balls... å³ä½¿ä¸ä¸‹é›ªï¼Œä½ ä¹Ÿå‰µé€ äº†è‡ªå·±çš„ç¾æ™¯ã€‚', type: 'special', dates: ['12-24', '12-25'], category: 'B', catTitle: 'å¤©æ™‚åœ°åˆ©' },
            { id: 'special_nye', icon: 'ğŸ§¹', title: 'å¹´çµ‚å¤§æƒé™¤', desc: 'åœ¨è·¨å¹´å¤œè‡ªæ…°', msg: 'èˆŠçš„ä¸å»ï¼Œæ–°çš„ä¸ä¾†ã€‚æŠŠä»Šå¹´çš„ç…©æƒ±ï¼ˆå’Œåº«å­˜ï¼‰é€šé€šæ¸…ç©ºï¼Œæº–å‚™è¿æ¥æ˜å¹´å§ï¼', type: 'special', date: '12-31', category: 'B', catTitle: 'ç‰¹åˆ¥çš„ä¸€å¤©' },

            // Category C: Abstinence (è‹¦è¡Œåƒ§æ¨¡å¼)
            { id: 'abs_3', icon: 'ğŸ¤', title: 'å¿ä¸€æ™‚é¢¨å¹³æµªéœ', desc: 'é€£çºŒ 3 å¤©æœªç™¼', msg: 'æ‰ä¸‰å¤©è€Œå·²ï¼Œä¸è¦éœ²å‡ºé‚£éº¼ç—›è‹¦çš„è¡¨æƒ…ã€‚', type: 'abs', thres: 3, category: 'C', catTitle: 'è‹¦è¡Œåƒ§æ¨¡å¼' },
            { id: 'abs_5', icon: 'ğŸ¥›', title: 'ç…‰ä¹³å¤§äº¨', desc: 'é€£çºŒ 5 å¤©æœªç™¼', msg: 'äº”å¤©äº†ï¼Œä½ çš„ç‰›å¥¶æ˜¯ä¸æ˜¯å·²ç¶“ç©æ»¿äº†', type: 'abs', thres: 5, category: 'C', catTitle: 'è‹¦è¡Œåƒ§æ¨¡å¼' },
            { id: 'abs_7', icon: 'ğŸ§˜', title: 'ä¸€é€±ç¦ªå¸«', desc: 'é€£çºŒ 7 å¤©æœªç™¼', msg: 'ä¸€é€±æœªç™¼ï¼Œä½ çš„æ„å¿—åŠ›é–‹å§‹å±•ç¾ã€‚', type: 'abs', thres: 7, category: 'C', catTitle: 'è‹¦è¡Œåƒ§æ¨¡å¼' },
            { id: 'abs_14', icon: 'ğŸ§™', title: 'é­”æ³•å¸«å­¸å¾’', desc: 'é€£çºŒ 14 å¤©æœªç™¼', msg: 'å…©é€±é”æˆï¼æ“šèªªä¿æŒåˆ°30å¤©å°±èƒ½æˆç‚ºé­”æ³•å¸«ã€‚', type: 'abs', thres: 14, category: 'C', catTitle: 'è‹¦è¡Œåƒ§æ¨¡å¼' },
            { id: 'abs_30', icon: 'âœ¨', title: 'å¤§è³¢è€…', desc: 'é€£çºŒ 30 å¤©æœªç™¼', msg: '', type:'abs' , thres:'30' , category:'C' , catTitle:'è‹¦è¡Œåƒ§æ¨¡å¼' },
            // Category D: Streak (ç«åŠ›å…¨é–‹)
            { id: 'streak_3', icon: 'ğŸ”¥', title: 'ä¸çŸ¥ç–²å€¦', desc: 'é€£çºŒ 3 å¤©ç´€éŒ„', msg: 'é€£çºŒä¸‰å¤©ï¼Œçœ‹ä¾†å°ä½ ä¾†èªªå¤ªå®¹æ˜“äº†ã€‚', type: 'streak', thres: 3, category: 'D', catTitle: 'ç«åŠ›å…¨é–‹' },
            { id: 'streak_5', icon: 'ğŸ‚', title: 'ç²¾åŠ›éå‰©', desc: 'é€£çºŒ 5 å¤©ç´€éŒ„', msg: 'é€±ä¸€åˆ°é€±äº”å…¨å‹¤æ‰“å¡ï¼Œé€™æ¯…åŠ›è¦æ˜¯ç”¨åœ¨å·¥ä½œä¸Šå°±å¥½äº†ã€‚', type: 'streak', thres: 5, category: 'D', catTitle: 'ç«åŠ›å…¨é–‹' },
            { id: 'streak_7', icon: 'ğŸ¸', title: 'å¤œå¤œç¬™æ­Œ', desc: 'é€£çºŒ 7 å¤©ç´€éŒ„', msg: 'ä¸€é€±ä¸ƒå¤©ç„¡ä¼‘ï¼Œèº«é«”æŒºä¸éŒ¯çš„ï¼', type: 'streak', thres: 7, category: 'D', catTitle: 'ç«åŠ›å…¨é–‹' },
            { id: 'streak_14', icon: 'ğŸŒ', title: 'äºŒå‘¨ç›®', desc: 'é€£çºŒ 14 å¤©ç´€éŒ„', msg: 'å…©é€±äº†... å…„å¼Ÿï¼Œè¨˜å¾—è£œå……æ°´åˆ†ï¼Œåƒé»é¦™è•‰ï¼Ÿ', type: 'streak', thres: 14, category: 'D', catTitle: 'ç«åŠ›å…¨é–‹' },
            { id: 'streak_30', icon: 'ğŸ§‘â€ğŸ“', title: 'å…¨å‹¤ç', desc: 'é€£çºŒ 30 å¤©ç´€éŒ„', msg: 'é€£çºŒä¸€å€‹æœˆï¼Ÿï¼æ­å–œç²å¾—å…¨å‹¤çï¼', type: 'streak', thres: 30, category: 'D', catTitle: 'ç«åŠ›å…¨é–‹' },

            // Category E: Human Connection (äººèˆ‡äººçš„é€£çµ) - NEW
            { id: 'sex_1', icon: 'ğŸ¤“', title: 'ç¤¾äº¤æ¨¡å¼', desc: 'ç´¯è¨ˆåšæ„› 1 æ¬¡', msg: 'äººèˆ‡äººçš„é€£çµå¾ä»Šå¤©é–‹å§‹ã€‚', type: 'sex_count', thres: 1, category: 'E', catTitle: 'äººèˆ‡äººçš„é€£çµ' },
            { id: 'sex_10', icon: 'ğŸ”°', title: 'å¯¦ç¿’é§•é§›', desc: 'ç´¯è¨ˆåšæ„› 10 æ¬¡', msg: 'è¨˜å¾—ç¹«å¥½å®‰å…¨å¸¶ï¼Œæ³¨æ„è¡Œè»Šå®‰å…¨ã€‚', type: 'sex_count', thres: 10, category: 'E', catTitle: 'äººèˆ‡äººçš„é€£çµ' },
            { id: 'sex_100', icon: 'âš”ï¸', title: 'ç™¾äººæ–¬...å—ï¼Ÿ', desc: 'ç´¯è¨ˆåšæ„› 100 æ¬¡', msg: 'ç´¯ç©äº†ä¸€ç™¾å ´æˆ°å½¹ã€‚ä¸ç®¡å°æ‰‹æ˜¯åŒä¸€å€‹é‚„æ˜¯ä¸€ç™¾å€‹ï¼Œä½ éƒ½æ˜¯è‹±é›„ã€‚', type: 'sex_count', thres: 100, category: 'E', catTitle: 'äººèˆ‡äººçš„é€£çµ' },
            { id: 'sex_loyalty', icon: 'ğŸ´', title: 'å°ˆæƒ…ç¨®é¦¬', desc: 'ç´¯è¨ˆèˆ‡åŒä¸€ä½æ€§å¤¥ä¼´è¶…é 10 æ¬¡', msg: 'å¼±æ°´ä¸‰åƒï¼Œä½ åªå–ä¸€ç“¢... ç„¶å¾Œç‹‚å–çŒ›å–ã€‚çœŸæ„›ç„¡èª¤ï¼', type: 'sex_same_partner', thres: 11, category: 'E', catTitle: 'äººèˆ‡äººçš„é€£çµ' },
            { id: 'sex_harem', icon: 'â±ï¸', title: 'æ™‚é–“ç®¡ç†å¤§å¸«', desc: 'ç´¯è¨ˆ 10 ä½ä¸åŒçš„æ€§å¤¥ä¼´', msg: 'ä½ çš„é€šè¨ŠéŒ„æ˜¯ä¸æ˜¯å¾ˆç²¾å½©ï¼Ÿè¨˜å¾—ä¸è¦å«éŒ¯åå­—ï¼Œé€™æ˜¯éä¾†äººçš„å»ºè­°ã€‚', type: 'sex_unique_partners', thres: 10, category: 'E', catTitle: 'äººèˆ‡äººçš„é€£çµ' },
            { id: 'sex_diplomat', icon: 'ğŸŒ', title: 'åœ‹æ°‘å¤–äº¤å®˜', desc: 'ç´¯è¨ˆ 10 å€‹ä¸åŒåœ‹ç±çš„æ€§å¤¥ä¼´', msg: 'è‡´åŠ›æ–¼ä¿ƒé€²è·¨åœ‹æ–‡åŒ–çš„ã€æ·±å…¥ã€äº¤æµï¼Œè«¾è²çˆ¾å’Œå¹³çæ‡‰è©²é ’çµ¦ä½ ã€‚', type: 'sex_unique_nations', thres: 10, category: 'E', catTitle: 'äººèˆ‡äººçš„é€£çµ' }
        ];

        // --- 2. Core Helper Functions (Moved to Global Scope) ---
        /* === å¼·åŠ›å£“ç¸®ç‰ˆ (ç‚ºäº†çœç©ºé–“ï¼š300px / 0.4ç•«è³ª) === */
window.compressImage = function(f) {
    return new Promise((res, rej) => {
        const r = new FileReader();
        r.readAsDataURL(f);
        r.onload = e => {
            const i = new Image();
            i.src = e.target.result;
            i.onload = () => {
                const c = document.createElement('canvas');
                
                // ğŸ“‰ æ”¹å‹• 1ï¼šæœ€å¤§é‚Šé•·å¾ 600 æ”¹ç‚º 300 (å¤§å¹…æ¸›å°‘åƒç´ )
                let w = i.width, h = i.height, m = 300; 
                
                if (w > h) {
                    if (w > m) { h *= m / w; w = m; }
                } else {
                    if (h > m) { w *= m / h; h = m; }
                }
                
                c.width = w;
                c.height = h;
                const x = c.getContext('2d');
                x.drawImage(i, 0, 0, w, h);
                
                // ğŸ“‰ æ”¹å‹• 2ï¼šJPG å£“ç¸®ç‡å¾ 0.6 æ”¹ç‚º 0.4 (çŠ§ç‰²ç•«è³ªæ›ç©ºé–“)
                res(c.toDataURL('image/jpeg', 0.4));
            };
            i.onerror = rej;
        };
        r.onerror = rej;
    });
};
        window.setupImageUpload = function(id,pid,cb){const el=document.getElementById(id);if(el)el.addEventListener('change',async(e)=>{if(e.target.files[0]){try{const b64=await compressImage(e.target.files[0]);const p=document.getElementById(pid);p.src=b64;p.classList.add('show');if(cb)cb(b64);}catch(err){showAlert("åœ–ç‰‡å¤±æ•—");}}});}
        window.getNowInputValue = function(){const n=new Date();n.setMinutes(n.getMinutes()-n.getTimezoneOffset());return n.toISOString().slice(0,16);}
        window.getRelativeTime = function(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffInSeconds = Math.floor((now - past) / 1000);
            if (diffInSeconds < 60) return 'å‰›å‰›';
            const diffInMinutes = Math.floor(diffInSeconds / 60);
            if (diffInMinutes < 60) return `${diffInMinutes} åˆ†é˜å‰`;
            const diffInHours = Math.floor(diffInMinutes / 60);
            if (diffInHours < 24) return `${diffInHours} å°æ™‚å‰`;
            const diffInDays = Math.floor(diffInHours / 24);
            if (diffInDays < 7) return `${diffInDays} å¤©å‰`;
            return past.toLocaleDateString();
        }

        // --- 3. System Modal Functions (Global) ---
        window.showAlert = function(msg) {
            document.getElementById('sys-title').textContent = "æç¤º";
            document.getElementById('sys-msg').textContent = msg;
            const acts = document.getElementById('sys-actions');
            acts.innerHTML = `<button class="btn-base btn-primary" onclick="closeSystemModal()" style="flex:1">ç¢ºå®š</button>`;
            document.getElementById('system-modal').classList.add('active');
        }

        window.showConfirm = function(msg, onYes) {
            document.getElementById('sys-title').textContent = "ç¢ºèª";
            document.getElementById('sys-msg').textContent = msg;
            const acts = document.getElementById('sys-actions');
            sysConfirmCallback = onYes;
            acts.innerHTML = `<button class="btn-base" onclick="closeSystemModal()" style="background:#eee;color:#666;flex:1">å–æ¶ˆ</button><button class="btn-base btn-danger" onclick="confirmSystemModal()" style="flex:1">ç¢ºå®š</button>`;
            document.getElementById('system-modal').classList.add('active');
        }

        window.confirmSystemModal = function() {
            const cb = sysConfirmCallback;
            // Clear callback first
            sysConfirmCallback = null; 
            closeSystemModal();
            // Use setTimeout to ensure the first modal closes before any new action
            if(cb) setTimeout(cb, 100); 
        }

        window.closeSystemModal = function() {
            document.getElementById('system-modal').classList.remove('active');
        }

        // --- 4. Data Logic & Saving (Global) ---
        window.loadAllData = function() {
            try { ejaculationRecords = JSON.parse(localStorage.getItem(RECORD_KEY)) || []; } catch(e) { ejaculationRecords = []; }
            try { actorProfiles = JSON.parse(localStorage.getItem(ACTOR_KEY)) || []; } catch(e) { actorProfiles = []; }
            try { partnerProfiles = JSON.parse(localStorage.getItem(PARTNER_KEY)) || []; } catch(e) { partnerProfiles = []; }
            try { 
                let rawAch = JSON.parse(localStorage.getItem(ACH_KEY));
                if (rawAch && rawAch.length > 0 && typeof rawAch[0] === 'string') {
                    unlockedAchievements = rawAch.map(id => ({ id: id, date: 'æœªçŸ¥æ—¥æœŸ' }));
                    saveAchData();
                } else {
                    unlockedAchievements = rawAch || [];
                }
            } catch(e) { unlockedAchievements = []; }
            try { userProfile = JSON.parse(localStorage.getItem(PROFILE_KEY)) || { nickname: '', birthday: '' }; } catch(e) { userProfile = { nickname: '', birthday: '' }; }
            
            const savedDarkMode = localStorage.getItem('cuteCumberDarkMode');
            const toggleEl = document.getElementById('dark-mode-toggle');
            if (savedDarkMode === 'true') {
                document.body.classList.add('dark-mode');
                if(toggleEl) toggleEl.checked = true;
            } else {
                document.body.classList.remove('dark-mode');
                if(toggleEl) toggleEl.checked = false;
            }
            updateProfileUI();
            updateLocationSuggestions();
            updatePasscodeUI();
            // å¦‚æœæœ‰è¨­å¯†ç¢¼ï¼Œå•Ÿå‹•æ™‚é–å®š
            if (localStorage.getItem('cuteCumberPasscode')) {
                showLockScreen('UNLOCK', 'è«‹è¼¸å…¥å¯†ç¢¼');
            }
        }
        function saveRecordData() { 
            localStorage.setItem(RECORD_KEY, JSON.stringify(ejaculationRecords)); 
            updateLocationSuggestions();
        }
        function saveActorData() { localStorage.setItem(ACTOR_KEY, JSON.stringify(actorProfiles)); }
        function savePartnerData() { localStorage.setItem(PARTNER_KEY, JSON.stringify(partnerProfiles)); }
        function saveAchData() { localStorage.setItem(ACH_KEY, JSON.stringify(unlockedAchievements)); }
        
        window.saveUserProfile = function() {
            userProfile.nickname = document.getElementById('setting-nickname').value;
            userProfile.birthday = document.getElementById('setting-birthday').value;
            localStorage.setItem(PROFILE_KEY, JSON.stringify(userProfile));
            updateProfileUI();
            checkAchievements();
            showAlert('å€‹äººè³‡æ–™å·²æ›´æ–°');
        }

        window.updateLocationSuggestions = function() {
            const listObj = document.getElementById('location-list');
            if (!listObj) return;
            
            // 1. çµ±è¨ˆæ‰€æœ‰åœ°é»å‡ºç¾æ¬¡æ•¸
            const locationCounts = {};
            ejaculationRecords.forEach(r => {
                if (r.location) {
                    const loc = r.location.trim();
                    if (loc) locationCounts[loc] = (locationCounts[loc] || 0) + 1;
                }
            });

            // 2. è½‰ç‚ºé™£åˆ—ä¸¦ä¾ç…§é »ç‡æ’åº (ç”±é«˜åˆ°ä½)
            const sortedLocations = Object.keys(locationCounts).sort((a, b) => locationCounts[b] - locationCounts[a]);

            // 3. åŠ å…¥é è¨­é¸é … (å¦‚æœæ­·å²ç´€éŒ„æ²’æœ‰ï¼Œç¢ºä¿æœ‰åŸºæœ¬é¸é …)
            const defaultLocs = ['è‡¥å®¤', 'å»æ‰€', 'æµ´å®¤', 'é£¯åº—'];
            defaultLocs.forEach(d => {
                if (!sortedLocations.includes(d)) sortedLocations.push(d);
            });

            // 4. æ¸²æŸ“åˆ° datalist
            listObj.innerHTML = sortedLocations.map(loc => `<option value="${loc}"></option>`).join('');
        };

        function updateProfileUI() {
            const greeting = userProfile.nickname ? `Helloï¼Œ${userProfile.nickname}` : `Helloï¼Œå¸¥å“¥`;
            document.getElementById('welcome-text').textContent = greeting;
            document.getElementById('setting-nickname').value = userProfile.nickname || '';
            document.getElementById('setting-birthday').value = userProfile.birthday || '';
        }

        window.toggleDarkMode = function() {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('cuteCumberDarkMode', isDark);
            if(document.getElementById('stats-view-charts').style.display === 'block') {
                calculateStats(); // Redraw chart
            }
        }

        // --- 5. Stats & Charts (Global) ---
        function renderChart(data) { 
            const ctx = document.getElementById('weeklyChart').getContext('2d'); 
            if (myChart) myChart.destroy(); 
            // Detect dark mode from body class
            const isDark = document.body.classList.contains('dark-mode');
            const tickColor = isDark ? '#cccccc' : '#666666';
            const gridColor = isDark ? '#444444' : '#eeeeee';
            myChart = new Chart(ctx, { 
                type: 'bar', 
                data: { 
                    labels: ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'], 
                    datasets: [{ data: data, backgroundColor: 'rgba(118, 200, 70, 0.8)', borderColor: '#76C846', borderWidth: 1, borderRadius: 4 }] 
                }, 
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1, color: tickColor }, grid: { color: gridColor } }, x: { grid: { display: false }, ticks: { color: tickColor } } } } 
            }); 
        }

        window.calculateStats = function() {
            // 1. ç©ºè³‡æ–™æª¢æŸ¥
            if (ejaculationRecords.length === 0) { 
                document.getElementById('stats-empty').style.display = 'block'; 
                document.getElementById('stats-content').style.display = 'none'; 
                return; 
            } else { 
                document.getElementById('stats-empty').style.display = 'none'; 
                document.getElementById('stats-content').style.display = 'block'; 
            }

            // 2. è³‡æ–™æ’åº (èˆŠ -> æ–°)
            const sorted = [...ejaculationRecords].sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            // 3. åŸºç¤è¨ˆæ•¸
            document.getElementById('stat-total').textContent = sorted.length;
            const countM = sorted.filter(r => r.type === 'è‡ªæ…°').length;
            const countS = sorted.filter(r => r.type === 'åšæ„›').length;
            const countW = sorted.filter(r => r.type === 'å¤¢éº').length;
            document.getElementById('stat-type-m').textContent = countM;
            document.getElementById('stat-type-s').textContent = countS;
            document.getElementById('stat-type-w').textContent = countW;
            // ç¹ªè£½åœ‹æ°‘å¤–äº¤åœ°åœ–
            setTimeout(() => {
                if(window.renderDiplomacyMap) window.renderDiplomacyMap();
            }, 100);
            // 4. ä»Šå¹´ç´¯ç©
            const thisYearStr = new Date().getFullYear().toString();
            document.getElementById('stat-year').textContent = sorted.filter(r => r.timestamp.startsWith(thisYearStr)).length;
            
            // 5. æ­·å²æœ€é•·é€£æ“Š
            const sortedDatesAsc = [...new Set(sorted.map(r => r.timestamp.split('T')[0]))].sort((a, b) => a.localeCompare(b));
            let maxStreak = 0;
            let tempStreak = 0;
            if (sortedDatesAsc.length > 0) {
                maxStreak = 1; tempStreak = 1;
                for(let i = 1; i < sortedDatesAsc.length; i++) {
                    const prev = new Date(sortedDatesAsc[i-1]);
                    const curr = new Date(sortedDatesAsc[i]);
                    const diffDays = Math.round((curr - prev) / (1000 * 60 * 60 * 24));
                    if (diffDays === 1) tempStreak++;
                    else tempStreak = 1;
                    if (tempStreak > maxStreak) maxStreak = tempStreak;
                }
            }
            document.getElementById('stat-streak').textContent = maxStreak;

            // 6. æœ€é•·ç¦æ…¾ (âœ¨ V5 æ–°å¹´ç‰¹èµ¦ç‰ˆï¼š2026èµ·ç®—ï¼Œä¿¡ä»»å¹´åˆè£œç™» âœ¨)
            let maxAbstinence = 0;
            const DAY_MS = 1000 * 60 * 60 * 24;
            
            if (sorted.length > 1) {
                for (let i = 0; i < sorted.length - 1; i++) {
                    const older = sorted[i];
                    const newer = sorted[i+1];
                    const gapDays = (new Date(newer.timestamp) - new Date(older.timestamp)) / DAY_MS;

                    // å–å¾—å¹´ä»½èˆ‡è£œç™»ç‹€æ…‹
                    const olderYear = new Date(older.timestamp).getFullYear();
                    const isOlderBackfill = Math.abs(older.id - new Date(older.timestamp).getTime()) > DAY_MS;

                    // é‚è¼¯ä¿®æ­£ï¼š
                    // 1. å¦‚æœæ˜¯ 2025 (å«) ä»¥å‰çš„ç´€éŒ„ -> ä¸€å¾‹ä¸è¨ˆç®— (åˆ‡å‰²éå»)
                    // 2. å¦‚æœæ˜¯ 2026 (å«) ä»¥å¾Œçš„ç´€éŒ„ -> å…¨éƒ¨ä¿¡ä»»ï¼(åŒ…å«æ‚¨ 1/1-1/9 çš„è£œç™»)
                    
                    if (olderYear >= 2026) {
                        // 2026 æ–°æ™‚ä»£ï¼šä¿¡ä»»æ‰€æœ‰è³‡æ–™
                        if (gapDays > maxAbstinence) maxAbstinence = gapDays;
                    } else {
                        // èˆŠæ™‚ä»£ï¼šåªæœ‰éè£œç™»çš„æ‰ç®— (ä½†åŸºæœ¬ä¸Šæ‚¨å¸Œæœ›èˆŠçš„éƒ½ä¸è¦ç®—ï¼Œæ‰€ä»¥é€™è£¡æœƒè‡ªç„¶éæ¿¾æ‰æ–·å±¤)
                        if (!isOlderBackfill) {
                           if (gapDays > maxAbstinence) maxAbstinence = gapDays;
                        }
                    }
                }
            }
            
            // è¨ˆç®—ã€Œæœ€å¾Œä¸€æ¬¡åˆ°ç¾åœ¨ã€
            if (sorted.length > 0) {
                const lastRec = sorted[sorted.length-1];
                const lastDate = new Date(lastRec.timestamp);
                const lastYear = lastDate.getFullYear();
                const now = new Date();
                const diffCurrent = (now - lastDate) / DAY_MS;
                const isLastBackfill = Math.abs(lastRec.id - lastDate.getTime()) > DAY_MS;
                
                // åŒæ¨£é‚è¼¯ï¼š2026 å¹´ä»¥å¾Œçš„æœ€å¾Œä¸€ç­†ï¼Œå°±ç®—æ˜¯è£œç™»çš„ä¹Ÿç®—æœ‰æ•ˆç¦æ…¾
                if (lastYear >= 2026) {
                    if (diffCurrent > maxAbstinence) maxAbstinence = diffCurrent;
                } else {
                    if (!isLastBackfill) {
                        if (diffCurrent > maxAbstinence) maxAbstinence = diffCurrent;
                    }
                }
            }
            document.getElementById('stat-abstinence').textContent = Math.floor(maxAbstinence);

            // 7. åœ–è¡¨èˆ‡å…¶ä»–
            const counts = [0,0,0,0,0,0,0]; 
            sorted.forEach(r => {
                const day = new Date(r.timestamp).getDay();
                counts[day]++;
            }); 
            renderChart(counts);

            const yearlyCounts = {}; 
            sorted.forEach(r => { 
                const y = r.timestamp.substring(0, 4);
                yearlyCounts[y] = (yearlyCounts[y] || 0) + 1; 
            });
            const yearlyArray = Object.keys(yearlyCounts).map(y => ({ year: y, count: yearlyCounts[y] })); 
            yearlyArray.sort((a, b) => b.year - a.year);
            
            const maxYearCount = Math.max(...yearlyArray.map(y => y.count), 1);
            const yList = document.getElementById('yearly-list'); 
            yList.innerHTML = '';
            yearlyArray.forEach(item => { 
                const percentage = (item.count / maxYearCount) * 100; 
                const div = document.createElement('div'); 
                div.className = 'year-item'; 
                div.innerHTML = `<div class="year-info"><span>${item.year}å¹´</span><span>${item.count} æ¬¡</span></div><div class="year-bar-bg"><div class="year-bar-fill" style="width: ${percentage}%"></div></div>`; 
                yList.appendChild(div); 
            });
            
            calculateFavorites(); 
        }
        // --- Google Map Logic (ä¿®å¾©ç‰ˆ) ---
        let isGoogleChartsLoaded = false;
        try {
            google.charts.load('current', {
                'packages':['geochart'],
            });
            google.charts.setOnLoadCallback(() => { 
                isGoogleChartsLoaded = true; 
                // å¦‚æœè¼‰å…¥å®Œæˆæ™‚ï¼Œä½¿ç”¨è€…å‰›å¥½åœ¨æ•¸æ“šé ï¼Œå°±é †ä¾¿ç•«ä¸€ä¸‹
                if(document.getElementById('stats').classList.contains('active')) {
                    setTimeout(window.renderDiplomacyMap, 100);
                }
            });
        } catch(e) { console.log('Google Charts blocked'); }
        // --- åœ°åœ–ç¸®æ”¾æ§åˆ¶é‚è¼¯ ---
        let currentMapScale = 1;

        window.updateMapZoom = function(delta) {
            // 1. è¨ˆç®—æ–°çš„ç¸®æ”¾æ¯”ä¾‹ (é™åˆ¶åœ¨ 1å€ ~ 4å€ ä¹‹é–“)
            currentMapScale += delta;
            if (currentMapScale < 1) currentMapScale = 1;
            if (currentMapScale > 4) currentMapScale = 4;

            // 2. èª¿æ•´åœ°åœ–å®¹å™¨çš„å¯¦éš›å¤§å° (ç™¾åˆ†æ¯”)
            const mapDiv = document.getElementById('diplomacy-map');
            if (mapDiv) {
                mapDiv.style.width = (currentMapScale * 100) + '%';
                mapDiv.style.height = (currentMapScale * 100) + '%';
            }

            // 3. å¼·åˆ¶é‡ç¹ªåœ°åœ– (è®“ Google Chart é©æ‡‰æ–°çš„å¤§å°ï¼Œä¿æŒæ¸…æ™°åº¦)
            if (window.renderDiplomacyMap) {
                window.renderDiplomacyMap();
            }
        };
        window.renderDiplomacyMap = function() {
            // 1. åŸºæœ¬æª¢æŸ¥
            if (!isGoogleChartsLoaded || !window.partnerProfiles) return;
            
            // 2. æª¢æŸ¥å®¹å™¨æ˜¯å¦å¯è¦‹ (é—œéµä¿®å¾©ï¼šå¦‚æœåœ¨éš±è—ç‹€æ…‹ä¸‹ç¹ªè£½æœƒè®Šç©ºç™½)
            const mapContainer = document.getElementById('diplomacy-map');
            if (!mapContainer || mapContainer.offsetParent === null) return;

            // 3. çµ±è¨ˆå„åœ‹äººæ•¸ (è½‰æ›ç‚º ISO ä»£ç¢¼)
            const nationCounts = {};
            let hasData = false;

            partnerProfiles.forEach(p => {
                if (p.nation && p.nation.n) {
                    const name = p.nation.n;
                    const match = COUNTRY_LIST.find(country => country.n === name);
                    let code = match ? match.c : name;
                    if (name === 'å°ç£') code = 'TW'; 
                    
                    nationCounts[code] = (nationCounts[code] || 0) + 1;
                    hasData = true;
                }
            });

            // 4. æº–å‚™æ•¸æ“š
            const dataArray = [['Country', 'Partners']];
            Object.keys(nationCounts).forEach(code => {
                dataArray.push([code, nationCounts[code]]);
            });

            // å¦‚æœå®Œå…¨æ²’è³‡æ–™ï¼Œå°±ä¸è¦ç•«ï¼Œæˆ–è€…ç•«ç©ºåœ°åœ–
            // Google Charts è‡³å°‘éœ€è¦ Header row
            
            const data = google.visualization.arrayToDataTable(dataArray);

            const options = {
                backgroundColor: '#ffffff', 
                datalessRegionColor: '#f5f5f5',
                defaultColor: '#f5f5f5',
                colorAxis: {colors: ['#F8BBD0', '#E91E63']}, 
                tooltip: {textStyle: {color: '#333'}, showColorCode: true},
                legend: 'none',
                displayMode: 'regions', 
                keepAspectRatio: true,
                // ä¿®å¾©ï¼šåŠ ä¸Š width/height '100%' ç¢ºä¿å¡«æ»¿
                width: '100%',
                height: '100%'
            };

            const chart = new google.visualization.GeoChart(mapContainer);
            chart.draw(data, options);
        };

        // å„ªåŒ–è·³è½‰é‚è¼¯ (è§£æ±ºæ•¸æ“šé é»æ“Šç„¡åæ‡‰)
        window.jumpToTarget = function(target) {
            // 1. é—œé–‰æ‰€æœ‰ Modal
            closeDetailModal(); 
            document.getElementById('achievement-modal').classList.remove('active');
            
            // 2. åˆ‡æ›åˆ°åº•éƒ¨ "Driver" åˆ†é 
            const driverTab = document.querySelector('.tab-item[data-target="driver"]');
            if(driverTab) driverTab.click();
            
            // 3. å»¶é²åŸ·è¡Œï¼Œç­‰å¾… Tab åˆ‡æ›å‹•ç•«å®Œæˆ
            setTimeout(() => {
                if (target.type === 'partner') {
                    // åˆ‡æ›åˆ°æ€§å¤¥ä¼´æ¨¡å¼ -> æ‰“é–‹è©³æƒ…
                    if(window.switchDriverMode) window.switchDriverMode('partner');
                    setTimeout(() => {
                        if(window.showPartnerDetail) window.showPartnerDetail(target.name);
                    }, 50);
                    
                } else if (target.type === 'actor') {
                    // åˆ‡æ›åˆ°é›²ç«¯æƒ…äººæ¨¡å¼ -> æ‰“é–‹è©³æƒ…
                    if(window.switchDriverMode) window.switchDriverMode('actor');
                    setTimeout(() => {
                        if(window.showDriverDetail) showDriverDetail(target.id);
                    }, 50);
                    
                } else if (target.type === 'video') {
                    // åˆ‡æ›åˆ°é›²ç«¯æƒ…äººæ¨¡å¼ -> æ‰“é–‹è©³æƒ… -> æ‰“é–‹å½±ç‰‡
                    if(window.switchDriverMode) window.switchDriverMode('actor');
                    setTimeout(() => {
                        if(window.showDriverDetail) showDriverDetail(target.parentId);
                        setTimeout(() => {
                            if(window.openVideoDetail) openVideoDetail(target.parentId, target.id);
                        }, 300); // ç­‰å¾…è©³æƒ…é æ¸²æŸ“
                    }, 50);
                }
            }, 100);
        };
        function calculateFavorites() {
            // æ–°ç‰ˆçµ±è¨ˆé‚è¼¯ï¼šåŒæ™‚æ”¯æ´å¤šä½æ¼”å“¡ + å½±ç‰‡ + æ€§å¤¥ä¼´
            const actorCounts = {}; 
            const videoCounts = {};
            const partnerCounts = {}; // æ–°å¢ï¼šæ€§å¤¥ä¼´è¨ˆæ•¸

            ejaculationRecords.forEach(r => {
                // 1. çµ±è¨ˆæ€§å¤¥ä¼´
                if (r.partners && Array.isArray(r.partners)) {
                    r.partners.forEach(p => {
                        partnerCounts[p.name] = (partnerCounts[p.name] || 0) + 1;
                    });
                }

                // 2. çµ±è¨ˆæ¼”å“¡èˆ‡å½±ç‰‡ (åŸæœ¬çš„é‚è¼¯)
                const relatedActorIds = new Set();
                if (r.usedActors && r.usedActors.length > 0) {
                    r.usedActors.forEach(a => relatedActorIds.add(a.id));
                }
                if (r.usedVideo) {
                    videoCounts[r.usedVideo.id] = (videoCounts[r.usedVideo.id] || 0) + 1;
                    if (r.usedVideo.parentId) relatedActorIds.add(r.usedVideo.parentId);
                }
                if (r.target) {
                    if (r.target.type === 'actor') {
                        relatedActorIds.add(r.target.id);
                    } else if (r.target.type === 'video') {
                        videoCounts[r.target.id] = (videoCounts[r.target.id] || 0) + 1;
                        if (r.target.parentId) relatedActorIds.add(r.target.parentId);
                    }
                }
                relatedActorIds.forEach(id => {
                    actorCounts[id] = (actorCounts[id] || 0) + 1;
                });
            });

            // --- æ•´ç†è³‡æ–™ ---

            // A. æ€§å¤¥ä¼´æ’è¡Œæ¦œ
            const partnerStats = [];
            Object.keys(partnerCounts).forEach(name => {
                // å˜—è©¦å¾ partnerProfiles æ‰¾é ­åƒ
                const profile = partnerProfiles.find(p => p.name === name);
                const count = partnerCounts[name];
                
                // ğŸ’¡ éæ¿¾é‚è¼¯ï¼šå¦‚æœæ‚¨è¦ºå¾—ã€Œåªç´„1æ¬¡ã€çš„æ²’æ„ç¾©ï¼Œå¯ä»¥åœ¨é€™è£¡æŠŠä¸‹ä¸€è¡Œè§£é–‹è¨»è§£ï¼š
                // if (count < 2) return; 

                partnerStats.push({
                    data: { name: name }, // å‚³éåå­—ä¾›è·³è½‰ä½¿ç”¨
                    type: 'partner',
                    count: count,
                    name: name,
                    img: (profile && profile.photo) ? profile.photo : "" // å¦‚æœæœ‰æª”æ¡ˆå°±ç”¨ç…§ç‰‡
                });
            });

            // B. æ¼”å“¡æ’è¡Œæ¦œ
            const actorsStats = [];
            actorProfiles.forEach(a => {
                // ğŸ”¥ éæ¿¾æ‰åˆè¼¯ (isCollection ç‚º true è€…ä¸åŠ å…¥æ’è¡Œæ¦œ)
                if (a.isCollection) return; 

                const count = actorCounts[a.id] || 0;
                if (count > 0) {
                actorsStats.push({ 
                data: a, type: 'actor', count: count, name: a.name, img: a.avatar || DEFAULT_AVATAR 
             });
         }
    });

            // C. å½±ç‰‡æ’è¡Œæ¦œ
            const videosStats = [];
            actorProfiles.forEach(a => {
                if (a.videos) {
                    a.videos.forEach(v => {
                        const vCount = videoCounts[v.id] || 0;
                        if (vCount > 0) {
                            videosStats.push({ 
                                data: { ...v, parentId: a.id }, type: 'video', count: vCount, name: v.title, img: v.thumbnail || "" 
                            });
                        }
                    });
                }
            });

            // æ’åº (æ¬¡æ•¸å¤š -> å°‘)
            partnerStats.sort((a,b) => b.count - a.count);
            actorsStats.sort((a,b) => b.count - a.count);
            videosStats.sort((a,b) => b.count - a.count);

            // æ¸²æŸ“
            renderRankList('top-partners-list', partnerStats); // æ–°å¢
            renderRankList('top-actors-list', actorsStats);
            renderRankList('top-videos-list', videosStats);
        }
        function renderRankList(containerId, list) {
            const el = document.getElementById(containerId);
            el.innerHTML = '';
            if (list.length === 0) {
                el.innerHTML = '<div style="color:#999;font-size:13px;text-align:center;padding:10px;">å°šç„¡è³‡æ–™</div>';
                return;
            }

            const max = list[0].count;
            // é è¨­é¡¯ç¤ºå‰ 5 ç­†
            const initialShow = list.slice(0, 5);
            const hiddenItems = list.slice(5);

            initialShow.forEach((item, idx) => {
                el.appendChild(createRankItem(item, idx, max));
            });

            if (hiddenItems.length > 0) {
                const btn = document.createElement('button');
                btn.className = 'btn-show-more';
                btn.textContent = `ğŸ”½ é¡¯ç¤ºå…¨éƒ¨ (é‚„æœ‰ ${hiddenItems.length} ä½)`;
                btn.onclick = () => {
                    hiddenItems.forEach((item, idx) => {
                        // idx + 5 å› ç‚ºæ˜¯æ¥çºŒçš„æ’å
                        el.appendChild(createRankItem(item, idx + 5, max));
                    });
                    btn.remove(); // ç§»é™¤æŒ‰éˆ•
                };
                el.appendChild(btn); // æŒ‰éˆ•æ”¾åœ¨æœ€å¾Œ
            }
        }

        function createRankItem(item, idx, max) {
            const div = document.createElement('div');
            div.className = 'rank-item';
            // ä¿®æ­£ï¼šåŠ å…¥ name åƒæ•¸ï¼Œè®“æ€§å¤¥ä¼´è·³è½‰èƒ½æŠ“åˆ°åå­—
            div.onclick = () => jumpToTarget({ 
                type: item.type, 
                id: item.data.id, 
                parentId: item.data.parentId,
                name: item.data.name // é—œéµï¼šå‚³éåå­—
            });
            
            const rankClass = idx < 3 ? `top-${idx+1}` : '';
            const imgClass = item.type === 'video' ? 'video-type' : '';
            const imgHtml = item.img ? `<img src="${item.img}" class="rank-img ${imgClass}">` : `<div class="rank-img ${imgClass}" style="background:#eee;display:flex;align-items:center;justify-content:center;">${item.type==='actor'?'ğŸ‘¤':'ğŸ¬'}</div>`;
            const percent = (item.count / max) * 100;

            div.innerHTML = `
                <div class="rank-num ${rankClass}">${idx + 1}</div>
                ${imgHtml}
                <div class="rank-info">
                    <div class="rank-name">${item.name}</div>
                    <div class="rank-bar-bg"><div class="rank-bar-fill" style="width:${percent}%"></div></div>
                </div>
                <div class="rank-count">${item.count}æ¬¡</div>
            `;
            return div;
        }

        window.switchStatsView = function(view) {
            const c = document.getElementById('stats-view-charts');
            const a = document.getElementById('stats-view-achievements');
            const btns = document.querySelectorAll('.stats-toggle-container .toggle-btn');
            if(view==='charts'){
                c.style.display='block'; a.style.display='none';
                btns[0].classList.add('active'); btns[1].classList.remove('active');
                calculateStats();
            } else {
                c.style.display='none'; a.style.display='block';
                btns[0].classList.remove('active'); btns[1].classList.add('active');
                renderAchievements();
            }
        };

        window.goToSettings = function() {
            document.querySelectorAll('section.active').forEach(el => el.classList.remove('active'));
            document.getElementById('settings').classList.add('active');
            document.body.classList.add('hide-tabs');
        };

        window.exitSettings = function() {
            document.getElementById('settings').classList.remove('active');
            document.getElementById('home').classList.add('active');
            document.body.classList.remove('hide-tabs');
            updateHomeDisplay();
        };

        window.exportData = function() {
            const data = {
                records: ejaculationRecords,
                actors: actorProfiles,
                achievements: unlockedAchievements,
                profile: userProfile,
                version: '5.7',
                date: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cutecumber_backup_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        };

        window.importData = function(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.records) localStorage.setItem(RECORD_KEY, JSON.stringify(data.records));
                    if (data.actors) localStorage.setItem(ACTOR_KEY, JSON.stringify(data.actors));
                    if (data.achievements) localStorage.setItem(ACH_KEY, JSON.stringify(data.achievements));
                    if (data.profile) localStorage.setItem(PROFILE_KEY, JSON.stringify(data.profile));
                    showAlert('è³‡æ–™é‚„åŸæˆåŠŸï¼æ‡‰ç”¨ç¨‹å¼å°‡é‡æ–°å•Ÿå‹•ã€‚');
                    setTimeout(() => location.reload(), 1500);
                } catch (err) {
                    showAlert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•é‚„åŸã€‚');
                }
            };
            reader.readAsText(file);
        };

        window.resetData = function() {
            showConfirm('è­¦å‘Šï¼šé€™å°‡æœƒåˆªé™¤æ‰€æœ‰ç´€éŒ„ã€è€å¸æ©Ÿæ”¶è—å’Œæˆå°±ï¼', () => {
                showConfirm('å†æ¬¡ç¢ºèªï¼šçœŸçš„è¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿç„¡æ³•å¾©åŸï¼', () => {
                    localStorage.clear();
                    location.reload();
                });
            });
        };
/* === æª¢æŸ¥ localStorage å®¹é‡åŠŸèƒ½ === */
window.checkStorageUsage = function() {
    let total = 0;
    for (let x in localStorage) {
        if (localStorage.hasOwnProperty(x)) {
            // è¨ˆç®—å­—ä¸²é•·åº¦ * 2 (å› ç‚º JS å­—ä¸²æ˜¯ UTF-16ï¼Œæ¯å€‹å­—ä½” 2 bytes)
            total += (localStorage[x].length * 2);
        }
    }
    
    // æ›ç®—å–®ä½
    let kb = (total / 1024).toFixed(2);
    let mb = (total / 1024 / 1024).toFixed(2);
    
    // 5MB = 5120 KB
    let percent = ((total / (5 * 1024 * 1024)) * 100).toFixed(1);
    
    let msg = `ç›®å‰ä½¿ç”¨é‡ï¼š${kb} KB (${mb} MB)\n`;
    msg += `ç´„ä½” 5MB ä¸Šé™çš„ï¼š${percent}%\n\n`;
    
    if (total > 4 * 1024 * 1024) {
        msg += "âš ï¸ å®¹é‡å¿«æ»¿äº†ï¼Œå»ºè­°å‚™ä»½å¾Œæ¸…ç©ºéƒ¨åˆ†è³‡æ–™ï¼";
    } else {
        msg += "âœ… å®¹é‡éå¸¸å……è¶³ï¼";
    }
    
    showAlert(msg);
};
        // --- Achievements Logic (V5ï¼šæ–°å¹´ç‰¹èµ¦ + è‡ªå‹•å›æ”¶æ©Ÿåˆ¶) ---
        function checkAchievements(onFinished) {
            const sorted = [...ejaculationRecords].sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp));
            const count = sorted.length;
            
            const masturbationRecords = sorted.filter(r => r.type === 'è‡ªæ…°');
            const masturbationCount = masturbationRecords.length;
            const masturbationDates = masturbationRecords.map(r=>{const d=new Date(r.timestamp);return `${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;});
            const bday = userProfile.birthday ? userProfile.birthday.slice(5) : null; 

            // æ€§å¤¥ä¼´çµ±è¨ˆ
            const sexRecords = sorted.filter(r => r.type === 'åšæ„›');
            const sexCount = sexRecords.length;
            const partnerCounts = {}; 
            const uniquePartners = new Set();
            sexRecords.forEach(r => {
                if(r.partners && Array.isArray(r.partners)) {
                    r.partners.forEach(p => {
                        partnerCounts[p.name] = (partnerCounts[p.name] || 0) + 1;
                        uniquePartners.add(p.name);
                    });
                }
            });
            let maxSamePartnerCount = 0;
            Object.values(partnerCounts).forEach(c => { if(c > maxSamePartnerCount) maxSamePartnerCount = c; });
            const uniqueNations = new Set();
            if (window.partnerProfiles) {
                uniquePartners.forEach(name => {
                    const profile = partnerProfiles.find(p => p.name === name);
                    if (profile && profile.nation && profile.nation.n) uniqueNations.add(profile.nation.n);
                });
            }
            const uniqueNationCount = uniqueNations.size;
            
            // --- ç¦æ…¾è¨ˆç®— (V5ï¼šæ–°å¹´ç‰¹èµ¦ç‰ˆ - èˆ‡æ•¸æ“šé é‚è¼¯åŒæ­¥) ---
            let maxAbs = 0;
            const DAY_MS = 86400000;
            if(sorted.length > 0){
                for(let i=0; i<sorted.length-1; i++){
                    const older = sorted[i];
                    const newer = sorted[i+1];
                    const gapDays = (new Date(newer.timestamp) - new Date(older.timestamp)) / DAY_MS;
                    
                    const olderYear = new Date(older.timestamp).getFullYear();
                    const isOlderBackfill = Math.abs(older.id - new Date(older.timestamp).getTime()) > DAY_MS;

                    // é‚è¼¯ï¼š2026 é–‹å§‹å…¨é¢ä¿¡ä»»ï¼Œ2025 ä»¥å‰åš´æ ¼å°æ®ºè£œç™»
                    if (olderYear >= 2026) {
                        if(gapDays > maxAbs) maxAbs = gapDays;
                    } else {
                        if (!isOlderBackfill) {
                            if(gapDays > maxAbs) maxAbs = gapDays;
                        }
                    }
                }
                
                // æœ€å¾Œä¸€æ¬¡åˆ°ç¾åœ¨
                const lastRec = sorted[sorted.length-1];
                const lastYear = new Date(lastRec.timestamp).getFullYear();
                const isLastBackfill = Math.abs(lastRec.id - new Date(lastRec.timestamp).getTime()) > DAY_MS;
                const diffNow = (new Date() - new Date(lastRec.timestamp)) / DAY_MS;
                
                if (lastYear >= 2026) {
                    if(diffNow > maxAbs) maxAbs = diffNow;
                } else {
                    if (!isLastBackfill) {
                        if(diffNow > maxAbs) maxAbs = diffNow;
                    }
                }
            }
            // ------------------------------------

            // --- ç¸±æ…¾é€£æ“Šè¨ˆç®— ---
            let maxStreak = 0;
            if (sorted.length > 0) {
                const uniqueDates = [...new Set(sorted.map(r => r.timestamp.split('T')[0]))].sort(); 
                let currentStreak = 0;
                if (uniqueDates.length > 0) {
                    maxStreak = 1; currentStreak = 1;
                    for (let i = 1; i < uniqueDates.length; i++) {
                        const prev = new Date(uniqueDates[i-1]);
                        const curr = new Date(uniqueDates[i]);
                        const diff = Math.round((curr - prev) / DAY_MS);
                        if (diff === 1) currentStreak++; else currentStreak = 1;
                        if (currentStreak > maxStreak) maxStreak = currentStreak;
                    }
                }
            }

            // ==========================================
            // ğŸ”¥ é—œéµä¿®æ­£ï¼šæˆå°±å›æ”¶æ©Ÿåˆ¶ (Auto-Relock) ğŸ”¥
            // ==========================================
            const originalLength = unlockedAchievements.length;
            unlockedAchievements = unlockedAchievements.filter(u => {
                const achData = ACHIEVEMENTS_DATA.find(a => a.id === u.id);
                if (!achData) return true; // æœªçŸ¥æˆå°±ä¿ç•™

                // æª¢æŸ¥ã€è‹¦è¡Œåƒ§æ¨¡å¼ (Category C)ã€‘
                // å¦‚æœç›®å‰çš„æœ€é•·ç¦æ…¾å¤©æ•¸ (maxAbs) å·²ç¶“ä¸é”æ¨™äº†ï¼Œå°±ç„¡æƒ…ç§»é™¤ï¼
                if (achData.type === 'abs') {
                    return maxAbs >= achData.thres;
                }
                return true; // å…¶ä»–é¡å‹æš«ä¸å›æ”¶
            });

            // å¦‚æœæœ‰æˆå°±è¢«å›æ”¶ï¼Œå„²å­˜è®Šæ›´ä¸¦åˆ·æ–°ä»‹é¢
            if (unlockedAchievements.length !== originalLength) {
                saveAchData();
                if(document.getElementById('stats-view-achievements').style.display === 'block') {
                    renderAchievements(); // å¼·åˆ¶åˆ·æ–°åˆ—è¡¨é¡¯ç¤ºä¸Šé–ç‹€æ…‹
                }
            }
            // ==========================================

            let newUnlock = false;
            const unlockedIDs = unlockedAchievements.map(u => u.id); 
            let firstUnlockAch = null;

            // é€™è£¡è¨˜å¾—åŠ å…¥ 'E' é¡åˆ¥
            const categories = ['A', 'B', 'C', 'D', 'E'];

            ACHIEVEMENTS_DATA.forEach(ach => {
                if(unlockedIDs.includes(ach.id)) return; 
                let pass = false;
                
                if(ach.type==='count') {
                    if (ach.id === 'count_1') { if (count >= ach.thres) pass = true; } 
                    else { if (masturbationCount >= ach.thres) pass = true; }
                }
                if(ach.type==='abs' && maxAbs>=ach.thres) pass=true;
                if(ach.type==='streak' && maxStreak >= ach.thres) pass = true;
                if(ach.type==='special') {
                    if(ach.date && masturbationDates.includes(ach.date)) pass=true;
                    if(ach.dates && ach.dates.some(d=>masturbationDates.includes(d))) pass=true;
                    if(ach.isBday && bday && masturbationDates.includes(bday)) pass=true;
                }
                // æ€§å¤¥ä¼´æˆå°±
                if(ach.type==='sex_count' && sexCount >= ach.thres) pass = true;
                if(ach.type==='sex_same_partner' && maxSamePartnerCount >= ach.thres) pass = true;
                if(ach.type==='sex_unique_partners' && uniquePartners.size >= ach.thres) pass = true;
                if(ach.type==='sex_unique_nations' && uniqueNationCount >= ach.thres) pass = true;

                if(pass) {
                    const todayStr = new Date().toLocaleDateString();
                    unlockedAchievements.push({ id: ach.id, date: todayStr });
                    unlockedIDs.push(ach.id);
                    if (!firstUnlockAch) firstUnlockAch = ach; 
                    newUnlock = true;
                }
            });

            if(newUnlock) saveAchData();
            
            if(document.getElementById('stats-view-achievements').style.display === 'block') {
                renderAchievements(); 
            }

            if (firstUnlockAch) {
                onAchievementClose = onFinished;
                showUnlockModal(firstUnlockAch);
                return true; 
            } else {
                return false; 
            }
        }

        function renderAchievements() {
            const container = document.getElementById('ach-list-container'); 
            container.innerHTML='';
            // ä¿®æ­£ï¼šåŠ å…¥ 'E' é¡åˆ¥
            const categories = ['A', 'B', 'C', 'D', 'E'];
            const unlockedIDs = unlockedAchievements.map(u => u.id);

            categories.forEach(cat => {
                const items = ACHIEVEMENTS_DATA.filter(a => a.category === cat);
                if(items.length === 0) return;
                const titleDiv = document.createElement('div');
                titleDiv.className = 'ach-category-title';
                titleDiv.textContent = items[0].catTitle;
                container.appendChild(titleDiv);
                const gridDiv = document.createElement('div');
                gridDiv.className = 'ach-grid';
                items.forEach(ach => {
                    const unlockedObj = unlockedAchievements.find(u => u.id === ach.id);
                    const unlocked = !!unlockedObj;
                    const div = document.createElement('div');
                    div.className = `ach-card ${unlocked ? 'unlocked' : 'locked'}`;
                    const title = unlocked ? ach.title : '???';
                    div.innerHTML = `<div class="ach-icon">${ach.icon}</div><div class="ach-title">${title}</div>`;
                    div.onclick = () => {
                        if(unlocked) showAchievementDetail(ach, unlockedObj.date);
                        else showAlert(`ğŸ”’ ä¸Šé–çš„æˆå°±\n\næç¤ºï¼š${ach.desc}`);
                    };
                    gridDiv.appendChild(div);
                });
                container.appendChild(gridDiv);
            });
        }

        function showAchievementDetail(ach, date) {
            document.getElementById('ad-icon').textContent = ach.icon;
            document.getElementById('ad-title').textContent = ach.title;
            document.getElementById('ad-desc').textContent = ach.desc;
            document.getElementById('ad-date').textContent = date || 'æœªçŸ¥';
            document.getElementById('ad-msg').textContent = `"${ach.msg}"`;
            document.getElementById('achievement-detail-modal').classList.add('active');
        }
        window.closeAchDetailModal = function() { document.getElementById('achievement-detail-modal').classList.remove('active'); };

        function showUnlockModal(ach) {
            document.getElementById('unlock-icon').textContent = ach.icon;
            document.getElementById('unlock-title').textContent = `æˆå°±è§£é–ï¼š${ach.title}`;
            document.getElementById('unlock-msg').textContent = ach.msg;
            document.getElementById('achievement-modal').classList.add('active');
            if(navigator.vibrate) navigator.vibrate([100,50,100]);
        }
        window.closeAchievementModal = function() { 
            document.getElementById('achievement-modal').classList.remove('active');
            if(onAchievementClose) {
                onAchievementClose();
                onAchievementClose = null;
            }
        };

        // è¼”åŠ©å‡½å¼ï¼šå¾é™£åˆ—ä¸­éš¨æ©ŸæŒ‘é¸ä¸€å¥
        function pickRandom(messages) {
            return messages[Math.floor(Math.random() * messages.length)];
        }

        // --- Home Logic (V2.0: è£åˆ¤èˆ‡æ•™ç·´æ¨¡å¼) ---
        function getHomeMessage() {
            // 0. æ–°æ‰‹æˆ–æ˜¯æ¸…ç©ºè³‡æ–™ç‹€æ…‹
            if (ejaculationRecords.length === 0) {
                return pickRandom([
                    "CuteCumber ç³»çµ±å°±ç·’ï¼Œç­‰å¾…ä½ çš„ç¬¬ä¸€æ¬¡ç™¼å°„ã€‚",
                    "é€™è£¡é‚„å¾ˆä¹¾æ·¨ï¼Œä¾†é»ä»€éº¼å¡«æ»¿å®ƒå§ï¼Ÿ",
                    "æº–å‚™å¥½é–‹å§‹ç´€éŒ„ä½ çš„å¥åº·æ—…ç¨‹äº†å—ï¼Ÿ"
                ]);
            }

            const sorted = [...ejaculationRecords].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            const lastRecord = sorted[0];
            const lastTime = new Date(lastRecord.timestamp);
            const now = new Date();
            
            // æ™‚é–“å·®è¨ˆç®—
            const diffMs = now - lastTime;
            const diffHours = diffMs / (1000 * 60 * 60);
            const diffDays = diffMs / (1000 * 60 * 60 * 24);

            // ä»Šæ—¥çµ±è¨ˆ
            const todayStr = now.toDateString();
            const todayCount = sorted.filter(r => new Date(r.timestamp).toDateString() === todayStr).length;

            // --- 1. é«˜é »è­¦å ± (CD æ™‚é–“éçŸ­) ---
            if (sorted.length >= 2) {
                const prevTime = new Date(sorted[1].timestamp);
                const gapBetweenLastTwo = (lastTime - prevTime) / (1000 * 60 * 60); // å°æ™‚
                
                // å…©ç™¼é–“éš”å°æ–¼ 1 å°æ™‚
                if (gapBetweenLastTwo < 1) {
                    return pickRandom([
                        "é–“éš”ä¸åˆ°ä¸€å°æ™‚ï¼Ÿï¼ä½ çš„è³¢è€…æ¨¡å¼å†·å»æ™‚é–“ä¹Ÿå¤ªçŸ­äº†å§ã€‚",
                        "ç«åŠ›å±•ç¤ºï¼Ÿå…„å¼Ÿï¼Œä½ çš„æ§ç®¡ä¸æœƒéç†±å—ï¼Ÿ",
                        "å¤ªçŒ›äº†... ç”Ÿç”¢éšŠçš„é©¢éƒ½æ²’ä½ é€™éº¼å‹¤å‹ã€‚",
                        "æ³¨æ„èº«é«”å•Šï¼Œé€™ç¨®é »ç‡æ˜¯æƒ³æŒ‘æˆ°äººé«”æ¥µé™å—ï¼Ÿ"
                    ]);
                }
            }

            // --- 2. ç¦æ…¾çå‹µ (å¾ˆä¹…æ²’åš) ---
            // è¶…é 7 å¤©
            if (diffDays > 7) {
                return pickRandom([
                    `å·²ç¶“ ${Math.floor(diffDays)} å¤©æ²’å‹•éœäº†ï¼Œä½ çš„æ„å¿—åŠ›å …å¦‚ç£çŸ³ï¼`,
                    "é€™å°±æ˜¯å‚³èªªä¸­çš„ã€Œå„²å­˜æŸ¥å…‹æ‹‰ã€å—ï¼Ÿæ„Ÿè¦ºéš¨æ™‚èƒ½ç™¼å¤§æ‹›ã€‚",
                    "èº«é«”æ­£åœ¨é€²è¡Œæ·±åº¦æ·¨åŒ–ï¼Œå°å¤©ä½¿ç‚ºä½ æ„Ÿåˆ°é©•å‚²ã€‚",
                    "å¤ªä¹…æ²’ç”¨æœƒç”Ÿé½å–”... é–‹ç©ç¬‘çš„ï¼Œä¿æŒé€™è‚¡æ°£å‹¢ï¼"
                ]);
            }
            // è¶…é 3 å¤©
            if (diffDays > 3) {
                return pickRandom([
                    "ä¸‰å¤©æœªç™¼ï¼Œé€™ä»½å¿è€åŠ›å€¼å¾—å˜‰è¨±ã€‚",
                    "é©åº¦ç¦æ…¾æœ‰åŠ©æ–¼æå‡å°ˆæ³¨åŠ›ï¼Œä½ ç¾åœ¨æ„Ÿè¦ºå¦‚ä½•ï¼Ÿ",
                    "å°æƒ¡é­”æ­£åœ¨è§’è½ç•«åœˆåœˆï¼Œå› ç‚ºä½ éƒ½ä¸ç†å®ƒã€‚"
                ]);
            }

            // --- 3. æ¨¡å¼åµæ¸¬ (å¦‚æœæ˜¯åšæ„›æˆ–å¤¢éº) ---
            // å¦‚æœæœ€å¾Œä¸€æ¬¡æ˜¯ã€Œåšæ„›ã€
            if (lastRecord.type === 'åšæ„›') {
                return pickRandom([
                    "äººèˆ‡äººçš„é€£çµé”æˆï¼èº«å¿ƒæ‡‰è©²éƒ½å¾ˆæ»¿è¶³å§ï¼Ÿ",
                    "æ­å–œè€çˆºï¼Œè³€å–œè€çˆºã€‚è¨˜å¾—å¤šå–æ°´è£œå……é«”åŠ›ã€‚",
                    "å¯¦æˆ°ç¶“é©— +1ï¼Œé€™æ¯”è‡ªå·±ä¾†æœ‰æ„æ€å¤šäº†å°å§ï¼Ÿ",
                    "çœ‹ä¾†ä½ æœ‰å€‹æ„‰å¿«çš„æ™‚å…‰ï¼ŒCuteCumber ç‚ºä½ é»è®šã€‚"
                ]);
            }
            // å¦‚æœæœ€å¾Œä¸€æ¬¡æ˜¯ã€Œå¤¢éºã€
            if (lastRecord.type === 'å¤¢éº') {
                return pickRandom([
                    "éè‡ªé¡˜çš„é‡‹æ”¾... å¤¢è£¡ç™¼ç”Ÿäº†ä»€éº¼å¥½äº‹ï¼Ÿ",
                    "é›–ç„¶æœ‰é»æ„å¤–ï¼Œä½†é€™ä¹Ÿæ˜¯èº«é«”å¥åº·çš„è­‰æ˜ã€‚",
                    "è¨˜å¾—æ›æ´—å…§è¤²èˆ‡åºŠå–®ï¼Œé€™æ˜¯ç³»çµ±å”¯ä¸€èƒ½çµ¦çš„å»ºè­°ã€‚"
                ]);
            }

            // --- 4. å–®æ—¥æ¬¡æ•¸ (éé‡æé†’) ---
            if (todayCount >= 4) {
                return "ä¸€å¤©å››æ¬¡ï¼Ÿï¼è«‹ç«‹åˆ»åœæ­¢æ“ä½œä¸¦å»ç¡è¦ºï¼Œé€™æ˜¯å‘½ä»¤ï¼";
            }
            if (todayCount === 3) {
                return pickRandom([
                    "ä¸€æ—¥ä¸‰çœå¾èº«... ä½ æ˜¯ä¸æ˜¯ã€Œçœã€å¤ªå¤šæ¬¡äº†ï¼Ÿ",
                    "è«‹ç«‹åˆ»è£œå……ç‰¡è £ã€é‹…ç‰‡æˆ–é¦™è•‰ï¼Œèº«é«”è¦é¡§å•Šï¼",
                    "ä»Šå¤©çš„é¡åº¦å·²ç¶“åš´é‡è¶…æ”¯äº†ï¼Œä¸”æ…¢ï¼"
                ]);
            }
            if (todayCount === 2) {
                return pickRandom([
                    "æ¢…é–‹äºŒåº¦ï¼ä»Šå¤©ç²¾ç¥å¾ˆå¥½å–”ï¼Ÿ",
                    "å¥½äº‹æˆé›™ï¼Œä½†å·®ä¸å¤šè©²ä¼‘æ¯å›‰ã€‚",
                    "ç¬¬äºŒç™¼äº†ï¼Œæ³¨æ„éåº¦æ‘©æ“¦å¯èƒ½æœƒç ´çš®ï¼ˆè²¼å¿ƒæé†’ï¼‰ã€‚"
                ]);
            }

            // --- 5. ç‰¹æ®Šæ™‚æ®µåµæ¸¬ ---
            const h = lastTime.getHours(); // é€™æ˜¯å–ã€Œæœ€å¾Œä¸€æ¬¡ç´€éŒ„ã€çš„æ™‚é–“ï¼Œä¸æ˜¯ç¾åœ¨æ™‚é–“
            const isTodayRecord = lastTime.toDateString() === todayStr;

            if (isTodayRecord) {
                // åˆä¼‘æ™‚é–“ (12-13)
                if (h >= 12 && h < 14) {
                    return pickRandom([
                        "åˆä¼‘æ™‚é–“ä¹Ÿä¸æ”¾éï¼Ÿæ™‚é–“ç®¡ç†å¤§å¸«å°±æ˜¯ä½ ã€‚",
                        "é£½æš–æ€æ·«æ…¾... å¤äººèª ä¸æ¬ºæˆ‘ã€‚",
                        "ä¸­åˆä¾†ä¸€ç™¼ï¼Œä¸‹åˆä¸Šç­æ›´æœ‰ç²¾ç¥ï¼ˆæˆ–æ˜¯æ›´æƒ³ç¡ï¼‰ï¼Ÿ"
                    ]);
                }
                // æ™¨å‹ƒ (6-9)
                if (h >= 6 && h < 9) {
                    return pickRandom([
                        "ä¸€æ—¥ä¹‹è¨ˆåœ¨æ–¼æ™¨...å‹ƒï¼Ÿçœ‹ä¾†ä½ é†’å¾—å¾ˆå¾¹åº•ã€‚",
                        "æ—©å®‰ï¼ç”¨é€™ç¨®æ–¹å¼å–šé†’èº«é«”ä¹Ÿæ˜¯ä¸€ç¨®é¸æ“‡ã€‚",
                        "æ™¨é–“é‹å‹•æœ‰ç›Šèº«å¿ƒå¥åº·ï¼Œé›–ç„¶é€™é‹å‹•æœ‰é»ç‰¹åˆ¥ã€‚"
                    ]);
                }
                // æ·±å¤œ (1-4)
                if (h >= 1 && h < 5) {
                    return pickRandom([
                        "å‡Œæ™¨é‚„ä¸ç¡... æ˜¯åœ¨é‡‹æ”¾å£“åŠ›é‚„æ˜¯å–®ç´”å¤±çœ ï¼Ÿ",
                        "å¤œæ·±äººéœï¼Œæ­£æ˜¯å°»æ§æ™‚ã€‚æ—©é»ä¼‘æ¯å§ã€‚",
                        "é€™å€‹æ™‚é–“é»ï¼Œå…¨ä¸–ç•Œéƒ½ç¡äº†ï¼Œåªæœ‰ä½ å’Œä½ çš„æ‰‹é†’è‘—ã€‚"
                    ]);
                }
            }

            // --- 6. é€±æœ«æˆ°å£« (é€±æœ«ä¸”æœ‰ç´€éŒ„) ---
            const day = now.getDay();
            if ((day === 0 || day === 6) && todayCount >= 1) {
                return pickRandom([
                    "å¹³æ—¥é¤Šç”Ÿï¼Œé€±æœ«å¾€æ­»è£¡å°»ï¼",
                    "é€±æœ«å°±æ˜¯æ”¾ç¸±çš„æ™‚å€™ï¼Œäº«å—ä½ çš„å‡æœŸã€‚",
                    "Happy Weekend! å¿«æ¨‚çš„æ–¹å¼æœ‰å¾ˆå¤šç¨®ï¼Œä½ é¸æ“‡äº†é€™ä¸€ç¨®ã€‚"
                ]);
            }

            // --- 7. é è¨­å¾…æ©Ÿè¨Šæ¯ (å¦‚æœä¸Šé¢éƒ½æ²’è§¸ç™¼) ---
            if (todayCount > 0) {
                return pickRandom([
                    "ä»Šå¤©å·²ç¶“æ‰“å¡éäº†ï¼Œä¿æŒå¿ƒæƒ…æ„‰å¿«ã€‚",
                    "å°„å¾Œä¸ç†ï¼Ÿåˆ¥å¿˜äº†ç´€éŒ„ä¸€ä¸‹å¿ƒæƒ…å‚™è¨»ã€‚",
                    "èº«é«”æ„Ÿåˆ°æ”¾é¬†äº†å—ï¼Ÿé€™æ‰æ˜¯æœ€é‡è¦çš„ã€‚",
                    "CuteCumber éš¨æ™‚å¾…å‘½ï¼ŒæœŸå¾…ä½ çš„ä¸‹ä¸€æ¬¡æ•¸æ“šã€‚"
                ]);
            }

            // å®Œå…¨æ²’å‹•éœçš„é è¨­
            return pickRandom([
                "ä»Šå¤©é‚„æ²’å‹•éœå‘¢ï¼Œæ­£åœ¨è“„åŠ›ä¸­ï¼Ÿ",
                "æš´é¢¨é›¨å‰çš„å¯§éœ...",
                "å°æƒ¡é­”åœ¨è ¢è ¢æ¬²å‹•ï¼Œå°å¤©ä½¿åœ¨é–‰ç›®é¤Šç¥ã€‚",
                "æº–å‚™å¥½éš¨æ™‚è¨˜éŒ„ä½ çš„ç²¾å½©æ™‚åˆ»ã€‚"
            ]);
        }

        function updateHomeDisplay() {
            const t = document.getElementById('hero-timer-display');
            if (ejaculationRecords.length === 0) {
                t.innerHTML = '<span style="font-size:24px;">å°šæœªé–‹å§‹ç´€éŒ„</span>';
                document.getElementById('home-message').textContent = getHomeMessage();
            } else {
                const s = [...ejaculationRecords].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)), d = new Date().getTime() - new Date(s[0].timestamp).getTime();
                if (d < 0) {
                    t.innerHTML = '00<small>åˆ†</small>';
                } else {
                    const da = Math.floor(d / 86400000), ho = Math.floor((d % 86400000) / 3600000), mi = Math.floor((d % 3600000) / 60000);
                    let h = '';
                    if (da > 0) h += `${da}<small>å¤©</small>${ho}<small>æ™‚</small>`;
                    else if (ho > 0) h += `${ho}<small>æ™‚</small>${mi}<small>åˆ†</small>`;
                    else h += `${mi}<small>åˆ†</small>`;
                    t.innerHTML = h;
                }
                document.getElementById('home-message').textContent = getHomeMessage();
            }
            const n = new Date();
            document.getElementById('month-count-display').textContent = ejaculationRecords.filter(r => new Date(r.timestamp).getMonth() === n.getMonth()).length;
            const rc = document.getElementById('recent-list-container'), rs = [...ejaculationRecords].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).slice(0, 3);
            rc.innerHTML = rs.length ? '' : '<div style="text-align:center;padding:20px;color:#ccc;">æš«ç„¡ç´€éŒ„</div>';
            
            const typeEmoji = { 'è‡ªæ…°': 'ğŸ†', 'åšæ„›': 'ğŸ‘', 'å¤¢éº': 'ğŸ’¤' };
            const weekdays = ['é€±æ—¥','é€±ä¸€','é€±äºŒ','é€±ä¸‰','é€±å››','é€±äº”','é€±å…­'];

            rs.forEach(r => {
                const dateObj = new Date(r.timestamp);
                const md = `${(dateObj.getMonth() + 1).toString().padStart(2, '0')}/${dateObj.getDate().toString().padStart(2, '0')}`;
                const relTime = getRelativeTime(r.timestamp);
                const emoji = typeEmoji[r.type] || 'ğŸ¥’';
                const loc = r.location || 'æœªçŸ¥';

                const div = document.createElement('div');
                div.className = 'recent-card';
                div.innerHTML = `<div class="recent-icon-box">${emoji}</div><div class="recent-info"><div class="recent-date">${md}</div><div class="recent-meta">${relTime}</div></div><div class="recent-location">ğŸ“ ${loc}</div>`;
                rc.appendChild(div);
            });
            
            // --- ä¿®æ­£å¾Œçš„ã€Œç›®å‰é€£æ“Šã€è¨ˆç®—é‚è¼¯ (V2) ---
            // 1. ç›´æ¥åˆ‡å­—ä¸²æ‹¿æ—¥æœŸ (YYYY-MM-DD)ï¼Œé¿å…æ™‚å€è½‰æ›èª¤å·®
            const uniqueDates = [...new Set(ejaculationRecords.map(r => r.timestamp.split('T')[0]))]
                .sort((a, b) => b.localeCompare(a)); // é™åºï¼šæ–° -> èˆŠ

            let currentStreak = 0;

            if (uniqueDates.length > 0) {
                // å–å¾—ã€Œä½¿ç”¨è€…ç•¶åœ°ã€çš„ä»Šå¤©èˆ‡æ˜¨å¤©æ—¥æœŸå­—ä¸²
                const now = new Date();
                const offset = now.getTimezoneOffset() * 60000; // åˆ†é˜è½‰æ¯«ç§’
                const localNow = new Date(now.getTime() - offset);
                
                const todayStr = localNow.toISOString().split('T')[0];
                const yesterday = new Date(localNow.getTime() - 86400000);
                const yesterdayStr = yesterday.toISOString().split('T')[0];
                
                const latestDate = uniqueDates[0];

                // åªæœ‰ç•¶æœ€æ–°ç´€éŒ„æ˜¯ã€Œä»Šå¤©ã€æˆ–ã€Œæ˜¨å¤©ã€æ™‚ï¼Œæ‰è¦–ç‚ºé€£æ“Šæœ‰æ•ˆ
                if (latestDate === todayStr || latestDate === yesterdayStr) {
                    currentStreak = 1; // è‡³å°‘æœ‰ 1 å¤©
                    
                    for (let i = 0; i < uniqueDates.length - 1; i++) {
                        const d1 = new Date(uniqueDates[i]);     // è¼ƒæ–°
                        const d2 = new Date(uniqueDates[i+1]);   // è¼ƒèˆŠ (å‰ä¸€ç­†)
                        
                        // è¨ˆç®—å¤©æ•¸å·®
                        const diffTime = Math.abs(d1 - d2);
                        const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

                        if (diffDays === 1) {
                            currentStreak++;
                        } else {
                            break; // ä¸­æ–·
                        }
                    }
                }
            }
            
            document.getElementById('home-streak-display').textContent = currentStreak;
        }

        window.switchDiaryView = function(v) {
            const c = document.getElementById('diary-view-calendar'), l = document.getElementById('diary-view-list'), b = document.querySelectorAll('.view-toggle .toggle-btn');
            if (v === 'calendar') {
                c.style.display = 'block';
                l.style.display = 'none';
                b[0].classList.add('active');
                b[1].classList.remove('active');
                renderCalendar();
            } else {
                c.style.display = 'none';
                l.style.display = 'block';
                b[0].classList.remove('active');
                b[1].classList.add('active');
                renderDiaryList();
            }
        };

        window.changeMonth = function(o) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + o);
            renderCalendar();
        };

        function renderCalendar() {
            const y = currentCalendarDate.getFullYear(), m = currentCalendarDate.getMonth();
            document.getElementById('calendar-title').textContent = `${y} å¹´ ${m + 1} æœˆ`;
            
            const fd = new Date(y, m, 1).getDay();
            const dim = new Date(y, m + 1, 0).getDate();
            const c = document.getElementById('calendar-days-container');
            
            c.innerHTML = '';
            
            const t = new Date();
            const isCm = t.getFullYear() === y && t.getMonth() === m;

            // å¡«è£œæœˆåˆçš„ç©ºç™½
            for (let i = 0; i < fd; i++) c.appendChild(document.createElement('div'));

            // ç”¢ç”Ÿæ—¥æœŸæ ¼å­
            for (let d = 1; d <= dim; d++) {
                const cell = document.createElement('div');
                cell.className = 'calendar-day';
                
                // æ¨™è¨˜ä»Šå¤©
                if (isCm && d === t.getDate()) cell.classList.add('today');

                // æ‰¾å‡ºé€™å¤©çš„æ‰€æœ‰ç´€éŒ„
                const dr = ejaculationRecords.filter(r => {
                    const rd = new Date(r.timestamp);
                    return rd.getFullYear() === y && rd.getMonth() === m && rd.getDate() === d;
                });

                // æ±ºå®šé¡¯ç¤ºå…§å®¹èˆ‡é¡è‰²
                if (dr.length > 0) {
                    // å„ªå…ˆç´šé‚è¼¯ï¼šåšæ„› > å¤¢éº > è‡ªæ…°æ¬¡æ•¸
                    const hasSex = dr.some(r => r.type === 'åšæ„›');
                    const hasWet = dr.some(r => r.type === 'å¤¢éº');
                    const count = dr.length;

                    if (hasSex) {
                        cell.classList.add('type-sex'); // ç²‰ç´…è‰²
                    } else if (hasWet) {
                        cell.classList.add('type-wet'); // æ·ºè—è‰²
                    } else {
                        // ç´”è‡ªæ…°ï¼šæ ¹æ“šæ¬¡æ•¸æ±ºå®šç¶ è‰²æ·±æ·º
                        if (count >= 3) cell.classList.add('level-3');      // æ·±ç¶ 
                        else if (count === 2) cell.classList.add('level-2'); // ä¸­ç¶ 
                        else cell.classList.add('level-1');                  // æ·ºç¶ 
                    }

                    // é»æ“Šäº‹ä»¶
                    cell.onclick = () => dr.length === 1 ? openDetailModal(dr[0].id) : openDailyListModal(y, m, d, dr);
                }
                
                // å¡«å…¥æ—¥æœŸæ•¸å­— (ä¸å†é¡¯ç¤ºé»é»)
                cell.innerHTML = `<span>${d}</span>`;
                c.appendChild(cell);
            }
        }

        // å®šç¾© filterDiary è®“ HTML çš„ oninput å¯ä»¥å‘¼å«
        window.filterDiary = function() {
            renderDiaryList();
        };

        // æ¸²æŸ“æ—¥è¨˜åˆ—è¡¨ (ä¿®å¾©ç‰ˆï¼šè‡ªå‹•è®€å–å¤¥ä¼´æœ€æ–°ç…§ç‰‡)
        window.renderDiaryList = function() {
            const c = document.getElementById('diary-list-content');
            c.innerHTML = '';
            
            // å–å¾—æœå°‹é—œéµå­—
            const searchInput = document.getElementById('diary-search-input'); 
            const term = searchInput ? searchInput.value.trim().toLowerCase() : "";

            if (ejaculationRecords.length === 0) {
                c.innerHTML = '<div style="text-align:center;padding:60px 20px;color:#999;">ğŸƒ ç™½ç´™ä¸€å¼µ</div>';
                return;
            }

            // 1. å…ˆæ’åº (æ–° -> èˆŠ)
            let list = [...ejaculationRecords].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            // 2. å†éæ¿¾ (å¦‚æœæœ‰é—œéµå­—)
            if (term) {
                list = list.filter(r => {
                    let content = (r.type || "") + (r.location || "") + (r.note || "");
                    if (r.partners) content += r.partners.map(p => p.name).join(" ");
                    if (r.usedActors) content += r.usedActors.map(a => a.name).join(" ");
                    if (r.target && r.target.type === 'actor') content += r.target.name;
                    if (r.usedVideo) content += r.usedVideo.title;
                    if (r.target && r.target.type === 'video') content += r.target.name;
                    return content.toLowerCase().includes(term);
                });
            }

            if (list.length === 0) {
                c.innerHTML = '<div style="text-align:center;padding:40px;color:#ccc;">æ‰¾ä¸åˆ°ç¬¦åˆçš„ç´€éŒ„ ğŸ¢</div>';
                return;
            }

            // 3. æ¸²æŸ“åˆ—è¡¨
            list.forEach(r => {
                const dateObj = new Date(r.timestamp);
                const md = `${dateObj.getMonth() + 1}/${dateObj.getDate()}`;
                const t = `${dateObj.getHours().toString().padStart(2, '0')}:${dateObj.getMinutes().toString().padStart(2, '0')}`;
                
                // --- åœ–ç‰‡é‚è¼¯ä¿®æ­£ (å„ªå…ˆé †åº: ç´€éŒ„åœ– > å¤¥ä¼´åœ–(å«æœ€æ–°æª”æ¡ˆåæŸ¥) > å½±ç‰‡åœ– > æ¼”å“¡åœ–) ---
                let displayImg = r.photo; 

                if (!displayImg) {
                    // A. å¦‚æœæ˜¯åšæ„›ï¼Œå„ªå…ˆé¡¯ç¤ºå¤¥ä¼´ç…§ç‰‡
                    if (r.type === 'åšæ„›' && r.partners && r.partners.length > 0) {
                        // 1. å…ˆçœ‹ç´€éŒ„ç•¶ä¸‹æœ‰æ²’æœ‰å­˜ç…§ç‰‡
                        let pWithPhoto = r.partners.find(p => p.photo);
                        if (pWithPhoto) {
                            displayImg = pWithPhoto.photo;
                        } 
                        
                        // 2. å¦‚æœç´€éŒ„è£¡æ²’ç…§ç‰‡ï¼Œå»ã€Œæ”¶è—æ«ƒ (partnerProfiles)ã€æŸ¥æœ€æ–°ç…§ç‰‡ [é—œéµä¿®å¾©]
                        if (!displayImg && window.partnerProfiles) {
                            // éæ­·é€™ç­†ç´€éŒ„çš„æ‰€æœ‰å¤¥ä¼´
                            for (let p of r.partners) {
                                // åœ¨æ”¶è—æ«ƒæ‰¾é€™å€‹åå­—
                                const profile = window.partnerProfiles.find(pf => pf.name === p.name);
                                if (profile && profile.photo) {
                                    displayImg = profile.photo;
                                    break; // æ‰¾åˆ°ä¸€å¼µå°±ç”¨ï¼Œç„¶å¾Œåœæ­¢
                                }
                            }
                        }
                    }
                    
                    // B. å½±ç‰‡
                    if (!displayImg && r.usedVideo) {
                         const owner = actorProfiles.find(a => a.id === r.usedVideo.parentId);
                         if (owner && owner.videos) {
                             const v = owner.videos.find(v => v.id === r.usedVideo.id);
                             if (v && v.thumbnail) displayImg = v.thumbnail;
                         }
                    } 
                    
                    // C. æ¼”å“¡
                    if (!displayImg && r.usedActors && r.usedActors.length > 0) {
                        const firstActor = actorProfiles.find(a => a.id === r.usedActors[0].id);
                        if (firstActor && firstActor.avatar) displayImg = firstActor.avatar;
                    }
                    
                    // D. èˆŠè³‡æ–™å…¼å®¹
                    if (!displayImg && r.target) {
                         const actorId = r.target.type === 'actor' ? r.target.id : r.target.parentId;
                         const actor = actorProfiles.find(a => a.id === actorId);
                         if (actor) {
                             if (r.target.type === 'video' && actor.videos) {
                                 const v = actor.videos.find(v => v.id === r.target.id);
                                 if (v && v.thumbnail) displayImg = v.thumbnail;
                                 else displayImg = actor.avatar;
                             } else { displayImg = actor.avatar; }
                         }
                    }
                }

                let ph = '<div class="photo-placeholder">ğŸ“·</div>'; 
                if (displayImg && displayImg !== "") {
                    ph = `<img src="${displayImg}" class="photo-thumbnail" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">`;
                    ph += `<div class="photo-placeholder" style="display:none;">ğŸ“·</div>`; 
                }

                // æº–å‚™æ€§å¤¥ä¼´è³‡è¨Šå­—ä¸²
                let partnerInfo = "";
                if (r.type === 'åšæ„›' && r.partners && r.partners.length > 0) {
                    const namesHtml = r.partners.map(p => 
                        `<span style="cursor:pointer; text-decoration:underline; margin:0 2px; font-weight:bold;" onclick="navigateToPartner(event, '${p.name}')">${p.name}</span>`
                    ).join(', ');
                    
                    partnerInfo = `<span style="font-size:12px; font-weight:normal; color:var(--color-primary); margin-left:6px;">with ${namesHtml}</span>`;
                }

                const d = document.createElement('div');
                d.className = 'diary-card';
                d.onclick = () => openDetailModal(r.id);
                
                d.innerHTML = `<div class="diary-left"><div class="diary-date-box"><span class="diary-day">${md}</span><span class="diary-time">${t}</span></div>${ph}<div class="diary-content"><div class="diary-title">${r.type}${partnerInfo}</div><div class="diary-meta">ğŸ“ ${r.location}</div></div></div><div class="action-group"><button class="btn-icon delete" onclick="event.stopPropagation();deleteRecord(${r.id})"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div>`;
                c.appendChild(d);
            });
        };

        window.deleteRecord = function(id) {
            showConfirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿä¸€æ—¦åˆªé™¤å°‡ç„¡æ³•å¾©åŸã€‚', () => {
                ejaculationRecords = ejaculationRecords.filter(r => r.id !== id);
                saveRecordData();
                // Check if filter is active
                const searchInput = document.getElementById('diary-search-input');
                if(searchInput && searchInput.value.trim() !== '') {
                    window.filterDiary();
                } else {
                    renderDiaryList();
                }
                renderCalendar();
                updateHomeDisplay();
                calculateStats();
                checkAchievements();
            });
        };

        window.openDetailModal = function(id) {
            const r = ejaculationRecords.find(x => x.id === id);
            if (!r) return;
            const d = new Date(r.timestamp);
            document.getElementById('detail-date-time').textContent = `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()} ${d.getHours()}:${d.getMinutes().toString().padStart(2, '0')}`;
            
            // é¡¯ç¤ºç…§ç‰‡
            const pc = document.getElementById('detail-photo-container');
            if (r.photo) {
                document.getElementById('detail-photo').src = r.photo;
                pc.style.display = 'block';
            } else {
                pc.style.display = 'none';
            }
            
            document.getElementById('detail-type').textContent = r.type;
            document.getElementById('detail-location').textContent = r.location;
            
            // é¡¯ç¤ºå‚™è¨»
            const nb = document.getElementById('detail-note-box'), en = document.getElementById('detail-empty-note');
            if (r.note) {
                nb.textContent = r.note;
                nb.style.display = 'block';
                en.style.display = 'none';
            } else {
                nb.style.display = 'none';
                en.style.display = 'block';
            }

            // --- é€£çµæŒ‰éˆ•å€å¡Šæ¸…ç† (æ¸…é™¤èˆŠçš„æŒ‰éˆ•) ---
            const existingLinks = document.querySelectorAll('.detail-dynamic-link');
            existingLinks.forEach(el => el.remove());

            const contentBottom = document.querySelector('#detail-modal .modal-content-bottom');
            const actionGroup = contentBottom.querySelector('.detail-actions') || contentBottom.lastElementChild;

            // --- A. é¡¯ç¤ºæ€§å¤¥ä¼´ (Sex) ---
            if (r.type === 'åšæ„›' && r.partners && r.partners.length > 0) {
                const partnerDiv = document.createElement('div');
                partnerDiv.className = 'detail-dynamic-link'; // æ¨™è¨˜ä»¥ä¾¿ä¸‹æ¬¡æ¸…é™¤
                partnerDiv.style.marginBottom = '15px';
                
                const title = document.createElement('div');
                title.textContent = 'ğŸ’ æ€§å¤¥ä¼´ï¼š';
                title.style.fontWeight = 'bold';
                title.style.color = 'var(--color-accent)';
                title.style.marginBottom = '8px';
                partnerDiv.appendChild(title);

                const container = document.createElement('div');
                container.style.display = 'flex';
                container.style.flexWrap = 'wrap';
                container.style.gap = '8px';

                r.partners.forEach(p => {
                    const chip = document.createElement('div');
                    chip.className = 'selected-tag-chip';
                    chip.style.background = 'rgba(255, 105, 180, 0.1)';
                    chip.style.color = '#333';
                    chip.style.cursor = 'default';
                    
                    let imgHtml = '';
                    if(p.photo) imgHtml = `<img src="${p.photo}" style="width:24px;height:24px;border-radius:50%;object-fit:cover;">`;
                    else imgHtml = '<span style="font-size:16px">ğŸ‘¤</span>';

                    chip.innerHTML = `${imgHtml} ${p.name}`;
                    container.appendChild(chip);
                });
                partnerDiv.appendChild(container);

                if (actionGroup) contentBottom.insertBefore(partnerDiv, actionGroup);
            }

            // --- B. é¡¯ç¤ºé…èœé€£çµ (Masturbation) ---
            // å„ªå…ˆé †åºï¼šå½±ç‰‡ (usedVideo) > æ¼”å“¡ (usedActors) > èˆŠè³‡æ–™ (target)
            let targetBtnData = null;

            if (r.usedVideo) {
                targetBtnData = {
                    type: 'video',
                    icon: 'ğŸ¬',
                    name: r.usedVideo.title,
                    jumpTarget: { type: 'video', id: r.usedVideo.id, parentId: r.usedVideo.parentId }
                };
            } else if (r.usedActors && r.usedActors.length > 0) {
                // å¦‚æœæœ‰å¤šå€‹æ¼”å“¡ï¼Œåªé¡¯ç¤ºç¬¬ä¸€å€‹
                targetBtnData = {
                    type: 'actor',
                    icon: 'ğŸ‘¤',
                    name: r.usedActors[0].name + (r.usedActors.length > 1 ? ` ç­‰ ${r.usedActors.length} äºº` : ''),
                    jumpTarget: { type: 'actor', id: r.usedActors[0].id }
                };
            } else if (r.target && r.target.id) {
                // å…¼å®¹èˆŠè³‡æ–™
                targetBtnData = {
                    type: r.target.type,
                    icon: r.target.type === 'actor' ? 'ğŸ‘¤' : 'ğŸ¬',
                    name: r.target.name || 'æœªçŸ¥',
                    jumpTarget: r.target
                };
            }

            // å¦‚æœæœ‰æ‰¾åˆ°é…èœè³‡æ–™ï¼Œå»ºç«‹é»‘è‰²æŒ‰éˆ•
            if (targetBtnData) {
                const linkBtn = document.createElement('button');
                linkBtn.className = 'btn-base detail-dynamic-link';
                linkBtn.style.cssText = 'background:#333; color:white; width:100%; margin-bottom:15px; display:flex; align-items:center; justify-content:center; gap:8px;';
                linkBtn.innerHTML = `<span>${targetBtnData.icon}</span> é…èœï¼š${targetBtnData.name}`;
                linkBtn.onclick = () => jumpToTarget(targetBtnData.jumpTarget);
                
                if (actionGroup) contentBottom.insertBefore(linkBtn, actionGroup);
            }
            // ---------------------------

            document.getElementById('detail-edit-btn').onclick = () => {
                closeDetailModal();
                openEditRecordModal(r.id);
            };
            document.getElementById('detail-delete-btn').onclick = () => {
                showConfirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿä¸€æ—¦åˆªé™¤å°‡ç„¡æ³•å¾©åŸã€‚', () => {
                    deleteRecordInternal(r.id);
                    closeDetailModal();
                    closeDailyListModal();
                });
            };
            document.getElementById('detail-modal').classList.add('active');
        };
        
        window.jumpToTarget = function(target) {
            // 1. æš´åŠ›é—œé–‰æ‰€æœ‰ Modal (åŒ…å«è©³æƒ…é ã€æ—¥æ›†æ¸…å–®ã€æˆå°±è¦–çª—ç­‰)
            document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('active'));
            
            // 2. åˆ‡æ› Tab åˆ°æ”¶è—æ«ƒ
            const driverTab = document.querySelector('.tab-item[data-target="driver"]');
            if(driverTab) driverTab.click();
            
            // 3. åŸ·è¡Œè·³è½‰
            setTimeout(() => {
                if (target.type === 'partner') {
                    // æ€§å¤¥ä¼´æ¨¡å¼
                    if(window.switchDriverMode) window.switchDriverMode('partner');
                    setTimeout(() => {
                        if(window.showPartnerDetail) window.showPartnerDetail(target.name);
                    }, 100);
                    
                } else if (target.type === 'actor') {
                    // é›²ç«¯æƒ…äººæ¨¡å¼
                    if(window.switchDriverMode) window.switchDriverMode('actor');
                    showDriverDetail(target.id);
                    
                } else if (target.type === 'video') {
                    // å½±ç‰‡æ¨¡å¼
                    if(window.switchDriverMode) window.switchDriverMode('actor');
                    showDriverDetail(target.parentId);
                    setTimeout(() => {
                        openVideoDetail(target.parentId, target.id);
                    }, 300);
                }
            }, 100); // çµ¦ä¸€é»æ™‚é–“è®“ Tab åˆ‡æ›å‹•ç•«å®Œæˆ
        };

        function deleteRecordInternal(id) {
            ejaculationRecords = ejaculationRecords.filter(r => r.id !== id);
            saveRecordData();
            // Refresh diary list if active
            const searchInput = document.getElementById('diary-search-input');
            if(searchInput && searchInput.value.trim() !== '') {
                window.filterDiary();
            } else {
                renderDiaryList();
            }
            renderCalendar();
            updateHomeDisplay();
            calculateStats();
            checkAchievements();
        }

        window.closeDetailModal = function() {
            document.getElementById('detail-modal').classList.remove('active');
        };

        window.openEditRecordModal = function(id) {
            const r = ejaculationRecords.find(x => x.id === id);
            if (!r) return;
            editingRecordId = id;
            document.getElementById('edit-timestamp').value = r.timestamp;
            document.getElementById('edit-type').value = r.type;
            document.getElementById('edit-location').value = r.location;
            // Restore Partners
            editTempPartnerList = [];
            if (r.partners) {
                editTempPartnerList = [...r.partners];
            }
            renderPartnerTags('edit');
            updateFormVisibility('edit-'); // ç¢ºä¿æ­£ç¢ºé¡¯ç¤ºæ¬„ä½
            document.getElementById('edit-note').value = r.note || '';
            
            // Restore Actors
            editTempActorsList = [];
            if (r.usedActors) {
                editTempActorsList = [...r.usedActors];
            } else if (r.target && r.target.type === 'actor') {
                // å…¼å®¹èˆŠè³‡æ–™
                editTempActorsList = [{ id: r.target.id, name: r.target.name }];
            }
            window['render_editTempActorsList']();

            // Restore Video
            if (r.usedVideo) {
                document.getElementById('edit-video-search').value = r.usedVideo.title;
                document.getElementById('edit-video-data').value = JSON.stringify(r.usedVideo);
            } else if (r.target && r.target.type === 'video') {
                // å…¼å®¹èˆŠè³‡æ–™
                const vObj = { id: r.target.id, title: r.target.name, parentId: r.target.parentId };
                document.getElementById('edit-video-search').value = vObj.title;
                document.getElementById('edit-video-data').value = JSON.stringify(vObj);
            } else {
                document.getElementById('edit-video-search').value = "";
                document.getElementById('edit-video-data').value = "";
            }

            tempRecordPhoto = r.photo || "";
            const p = document.getElementById('edit-preview-photo');
            if (tempRecordPhoto) { p.src = tempRecordPhoto; p.classList.add('show'); } 
            else { p.src = ""; p.classList.remove('show'); }
            document.getElementById('edit-record-modal').classList.add('active');
        };

        window.closeEditModal = function() {
            document.getElementById('edit-record-modal').classList.remove('active');
            editingRecordId = null;
        };

        window.openDailyListModal = function(y, m, d, rs) {
            document.getElementById('daily-list-date').textContent = `${m + 1}/${d}`;
            document.getElementById('daily-count').textContent = rs.length;
            
            const c = document.getElementById('daily-list-container');
            c.innerHTML = ''; // é—œéµä¿®å¾©ï¼šå…ˆæ¸…ç©ºèˆŠè³‡æ–™ï¼
            
            rs.forEach(r => {
                const dateObj = new Date(r.timestamp);
                const t = `${dateObj.getHours().toString().padStart(2, '0')}:${dateObj.getMinutes().toString().padStart(2, '0')}`;
                
                // æº–å‚™é¡¯ç¤ºå…§å®¹
                let contentInfo = r.type; // é è¨­é¡¯ç¤ºé¡å‹
                
                // å¦‚æœæ˜¯åšæ„›ï¼Œé¡¯ç¤ºå¤¥ä¼´åå­—
                if (r.type === 'åšæ„›' && r.partners && r.partners.length > 0) {
                     const namesHtml = r.partners.map(p => 
                        `<span style="cursor:pointer; text-decoration:underline; margin:0 2px;" onclick="navigateToPartner(event, '${p.name}')">${p.name}</span>`
                     ).join(', ');
                     contentInfo += ` <span style="color:var(--color-primary);font-size:12px;">(with ${namesHtml})</span>`;
                }
                
                // å¦‚æœæœ‰é…èœ (å½±ç‰‡/æ¼”å“¡)ï¼Œé¡¯ç¤ºå‡ºä¾†
                if (r.usedVideo) {
                    contentInfo += ` <span style="color:#888;font-size:12px;">ğŸ¬ ${r.usedVideo.title}</span>`;
                } else if (r.usedActors && r.usedActors.length > 0) {
                    contentInfo += ` <span style="color:#888;font-size:12px;">ğŸ‘¤ ${r.usedActors[0].name}</span>`;
                }

                const i = document.createElement('div');
                i.className = 'diary-card';
                i.style.padding = '12px'; //ç¨å¾®èª¿æ•´é–“è·
                i.onclick = () => openDetailModal(r.id);
                
                i.innerHTML = `
                    <div class="diary-left">
                        <div style="font-weight:bold; margin-right:15px; color:#333; min-width:40px;">${t}</div>
                        <div style="flex:1; overflow:hidden; text-overflow:ellipsis;">${contentInfo}</div>
                    </div>
                    <div style="color:#ccc;">â€º</div>
                `;
                c.appendChild(i);
            });
            
            document.getElementById('daily-list-modal').classList.add('active');
        };

        window.closeDailyListModal = function() {
            document.getElementById('daily-list-modal').classList.remove('active');
        };

        window.openAddActorForm = function() {
            editingActorId = null;
            tempActorAvatar = "";
            document.getElementById('actor-form-title').textContent = "å»ºç«‹æ–°æª”æ¡ˆ";
            document.getElementById('actor-form').reset();
            document.getElementById('actor-is-collection').checked = false; // é è¨­ç‚ºçœŸäºº
            toggleActorTypeLabel();
            
            // ç¢ºä¿ tags æ¬„ä½æ¸…ç©º
            document.getElementById('actor-tags').value = "";
            
            document.getElementById('actor-preview').src = "";
            document.getElementById('actor-preview').classList.remove('show');
            document.getElementById('actor-form-modal').classList.add('active');
        };

        window.openEditActorForm = function() {
            if (!currentActorId) return;
            const a = actorProfiles.find(x => x.id === currentActorId);
            editingActorId = currentActorId;
            document.getElementById('actor-form-title').textContent = "ç·¨è¼¯æª”æ¡ˆè³‡æ–™";
            document.getElementById('actor-name').value = a.name;
            document.getElementById('actor-bio').value = a.bio || "";
            document.getElementById('actor-website').value = a.website || "";
            document.getElementById('actor-is-collection').checked = a.isCollection || false;
            toggleActorTypeLabel();

            // æ–°å¢ï¼šè®€å– tags è½‰ç‚ºå­—ä¸² (ä»¥ç©ºç™½åˆ†éš”)
            document.getElementById('actor-tags').value = (a.tags || []).join(' ');

            tempActorAvatar = a.avatar || "";
            const p = document.getElementById('actor-preview'), u = document.getElementById('actor-avatar-url');
            if (tempActorAvatar.startsWith('data:')) {
                p.src = tempActorAvatar;
                p.classList.add('show');
                u.value = "";
            } else if (tempActorAvatar.startsWith('http')) {
                p.src = tempActorAvatar;
                p.classList.add('show');
                u.value = tempActorAvatar;
            } else {
                p.src = "";
                p.classList.remove('show');
                u.value = "";
            }
            document.getElementById('actor-form-modal').classList.add('active');
        };

        window.closeActorFormModal = function() {
            document.getElementById('actor-form-modal').classList.remove('active');
        };

        window.openVideoFormModal = function(vid = null) {
            const f = document.getElementById('video-form');
            f.reset();
            editingVideoId = vid;
            tempVideoThumb = "";
            const p = document.getElementById('video-preview'), u = document.getElementById('video-thumb-url');
            
            // ç¢ºä¿æ¸…ç©º tags æ¬„ä½
            document.getElementById('video-tags').value = "";

            if (vid) {
                const a = actorProfiles.find(x => x.id === currentActorId), v = a.videos.find(x => x.id === vid);
                document.getElementById('video-form-title').textContent = "ç·¨è¼¯å½±ç‰‡";
                document.getElementById('video-title').value = v.title;
                document.getElementById('video-url').value = v.url;
                document.getElementById('video-note').value = v.note || "";
                
                // æ–°å¢ï¼šè®€å– tags è½‰å­—ä¸²
                document.getElementById('video-tags').value = (v.tags || []).join(' ');

                tempVideoThumb = v.thumbnail || "";
                if (tempVideoThumb.startsWith('data:')) {
                    p.src = tempVideoThumb;
                    p.classList.add('show');
                } else if (tempVideoThumb.startsWith('http')) {
                    p.src = tempVideoThumb;
                    p.classList.add('show');
                    u.value = tempVideoThumb;
                } else {
                    p.src = "";
                    p.classList.remove('show');
                }
            } else {
                document.getElementById('video-form-title').textContent = "æ–°å¢å½±ç‰‡";
                p.src = "";
                p.classList.remove('show');
            }
            document.getElementById('video-form-modal').classList.add('active');
        };

        window.closeVideoFormModal = function() {
            document.getElementById('video-form-modal').classList.remove('active');
        };
// --- Partner Logic Extensions ---

        // 1. åŒæ­¥åŠŸèƒ½ï¼šå¾ç´€éŒ„ä¸­ "æ’ˆå–" å¤¥ä¼´å»ºç«‹æª”æ¡ˆ (ä¿®å¾©ç‰ˆ)
        window.syncPartnersFromRecords = function() {
            // ç¢ºä¿ partnerProfiles å·²åˆå§‹åŒ–
            if (!window.partnerProfiles) {
                try { 
                    window.partnerProfiles = JSON.parse(localStorage.getItem(PARTNER_KEY)) || []; 
                } catch(e) { 
                    window.partnerProfiles = []; 
                }
            }

            const seenPartners = {}; // key: name, val: photo

            // æƒææ‰€æœ‰ç´€éŒ„
            ejaculationRecords.forEach(r => {
                if (r.partners && Array.isArray(r.partners)) {
                    r.partners.forEach(p => {
                        // å¦‚æœé€™ç­†ç´€éŒ„æœ‰ç…§ç‰‡ï¼Œå„ªå…ˆä½¿ç”¨
                        if (!seenPartners[p.name]) {
                            seenPartners[p.name] = p.photo;
                        } else if (!seenPartners[p.name] && p.photo) {
                            seenPartners[p.name] = p.photo;
                        }
                    });
                }
            });

            let changed = false;
            Object.keys(seenPartners).forEach(name => {
                let profile = partnerProfiles.find(p => p.name === name);
                
                if (!profile) {
                    // ç™¼ç¾æ–°å¤¥ä¼´ -> å»ºç«‹æª”æ¡ˆ
                    partnerProfiles.push({
                        id: Date.now() + Math.random(),
                        name: name,
                        photo: seenPartners[name] || "",
                        nation: null, 
                        race: "",
                        lastUpdated: Date.now()
                    });
                    changed = true;
                } else {
                    // æ—¢æœ‰å¤¥ä¼´ -> æª¢æŸ¥æ˜¯å¦éœ€è¦è£œç…§ç‰‡æˆ–æ›´æ–°æ™‚é–“
                    let needUpdate = false;
                    if (!profile.photo && seenPartners[name]) {
                        profile.photo = seenPartners[name];
                        needUpdate = true;
                    }
                    // ç¢ºä¿æœ‰ lastUpdated æ¬„ä½
                    if (!profile.lastUpdated) {
                        profile.lastUpdated = profile.id;
                        needUpdate = true;
                    }

                    if (needUpdate) {
                        profile.lastUpdated = Date.now();
                        changed = true;
                    }
                }
            });

            if (changed) {
                savePartnerData(); // å¯«å…¥ localStorage
            }
        };
// --- å‚³é€é–€ï¼šå¾æ—¥è¨˜/æ—¥æ›†è·³è½‰åˆ°å¤¥ä¼´è©³æƒ… (éœ¸é“ä¿®æ­£ç‰ˆ) ---
        window.navigateToPartner = function(e, name) {
            if(e) {
                e.stopPropagation();
                e.preventDefault();
            }
            
            // 1. æš´åŠ›é—œé–‰æ‰€æœ‰å¯èƒ½æ“‹è·¯çš„ Modal (æ—¥è¨˜è©³æƒ…ã€æ—¥æ›†æ¸…å–®ã€ç·¨è¼¯é ...)
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.classList.remove('active');
            });

            // 2. åˆ‡æ›åˆ°åº•éƒ¨ "Driver" åˆ†é 
            const driverTab = document.querySelector('.tab-item[data-target="driver"]');
            if(driverTab) driverTab.click();

            // 3. å»¶é²åŸ·è¡Œï¼šç¢ºä¿åˆ†é åˆ‡æ›å¾Œï¼Œä»‹é¢å·²æº–å‚™å¥½
            setTimeout(() => {
                // åˆ‡æ›åˆ°æ€§å¤¥ä¼´æ¨¡å¼
                if(window.switchDriverMode) window.switchDriverMode('partner');
                
                // å†å»¶é²ä¸€é»é»æ‰“é–‹è©³æƒ…ï¼Œç¢ºä¿åˆ—è¡¨å·²æ¸²æŸ“
                setTimeout(() => {
                    if(window.showPartnerDetail) window.showPartnerDetail(name);
                }, 100);
            }, 50);
        };
        // 2. åˆ‡æ›æ¨¡å¼ (é›²ç«¯æƒ…äºº vs æ€§å¤¥ä¼´) - ä¿®æ­£ç‰ˆ
        window.switchDriverMode = function(mode) {
            const btns = document.querySelectorAll('.driver-header .toggle-btn');
            const actGrid = document.getElementById('actor-grid');
            const parGrid = document.getElementById('partner-grid');
            const actionBar = document.getElementById('driver-action-bar');
            const diceBtn = document.getElementById('driver-dice-btn'); 
            const sortSelect = document.getElementById('driver-sort-select'); 

            // é˜²å‘†æ©Ÿåˆ¶ï¼šå¦‚æœæ‰¾ä¸åˆ°å®¹å™¨ï¼Œå°±ä¸­æ–·ä»¥å…å ±éŒ¯
            if(!actGrid || !parGrid) return;

            if (mode === 'actor') {
                // --- â˜ï¸ é›²ç«¯æƒ…äººæ¨¡å¼ ---
                btns[0].classList.add('active'); btns[1].classList.remove('active');
                
                // é—œéµï¼šé¡¯ç¤ºé›²ç«¯æƒ…äººï¼Œéš±è—æ€§å¤¥ä¼´
                actGrid.style.display = 'grid'; 
                parGrid.style.display = 'none';
                
                // é¡¯ç¤ºéª°å­
                if(diceBtn) diceBtn.style.display = 'block';

                // è¨­å®šé›²ç«¯æƒ…äººæ’åº
                if(sortSelect) {
                    sortSelect.innerHTML = `
                        <option value="updated">ğŸ•’ æœ€å¾Œæ›´æ–° (é è¨­)</option>
                        <option value="name">ğŸ”¤ å§“å (A-Z)</option>
                        <option value="count">ğŸ¬ å½±ç‰‡æ•¸é‡ (å¤šåˆ°å°‘)</option>
                    `;
                }
                if(actionBar) actionBar.innerHTML = `<button class="btn-base btn-primary" onclick="openAddActorForm()" style="font-size:13px;padding:8px 12px;">+ æ–°å¢æ¼”å“¡</button>`;
                
                renderActorList();
                filterDriverList(); 

            } else {
                // --- ğŸ’ æ€§å¤¥ä¼´æ¨¡å¼ ---
                btns[0].classList.remove('active'); btns[1].classList.add('active');
                
                // é—œéµï¼šéš±è—é›²ç«¯æƒ…äººï¼Œé¡¯ç¤ºæ€§å¤¥ä¼´
                actGrid.style.display = 'none'; 
                parGrid.style.display = 'grid';
                
                // éš±è—éª°å­
                if(diceBtn) diceBtn.style.display = 'none';

                // è¨­å®šæ€§å¤¥ä¼´æ’åº
                if(sortSelect) {
                    sortSelect.innerHTML = `
                        <option value="partner_updated">ğŸ•’ æœ€å¾Œæ›´æ–° (é è¨­)</option>
                        <option value="partner_name">ğŸ”¤ å§“å (A-Z)</option>
                        <option value="partner_nation">ğŸŒ åœ‹ç±</option>
                        <option value="partner_count">ğŸ”¥ æ€§æ„›æ¬¡æ•¸</option>
                    `;
                }
                if(actionBar) actionBar.innerHTML = `<button class="btn-base btn-accent" onclick="showAlert('åªè¦åœ¨ã€Œç´€éŒ„ã€é é¢æ–°å¢åšæ„›ç´€éŒ„ï¼Œ\\nå¤¥ä¼´å°±æœƒè‡ªå‹•å‡ºç¾åœ¨é€™è£¡å›‰ï¼')" style="font-size:13px;padding:8px 12px;opacity:0.8;">å¦‚ä½•æ–°å¢ï¼Ÿ</button>`;
                
                // å‘¼å«æ¸²æŸ“ (é€™æ­¥æœ€é‡è¦ï¼Œè³‡æ–™æ‰æœƒå‡ºä¾†)
                renderPartnerGrid();
            }
        };
 
        // åˆ‡æ›é–‹é—œæ™‚æ”¹è®Šæ–‡å­—é¡¯ç¤º
window.toggleActorTypeLabel = function() {
    const isColl = document.getElementById('actor-is-collection').checked;
    const label = document.getElementById('actor-type-desc');
    if (label) {
        if (isColl) {
            label.textContent = 'ğŸ“‚ å½±ç‰‡åˆè¼¯ / ä¸»é¡Œ / ä»£ç¨±';
            label.style.color = 'var(--color-primary)';
            label.style.fontWeight = 'bold';
        } else {
            label.textContent = 'ğŸ‘¤ çœŸäººæ¼”å“¡';
            label.style.color = '#888';
            label.style.fontWeight = 'normal';
        }
    }
};

        // 2. æ¸²æŸ“å¤¥ä¼´åˆ—è¡¨ (V2 æ™ºæ…§æ’åºç‰ˆ)
        window.renderPartnerGrid = function() {
            // 1. å¼·åˆ¶åŒæ­¥è³‡æ–™
            if(window.syncPartnersFromRecords) window.syncPartnersFromRecords(); 
            
            const c = document.getElementById('partner-grid');
            if(!c) return;
            c.innerHTML = '';
            
            // 2. è®€å–ä»‹é¢è¨­å®š
            const sortSelect = document.getElementById('driver-sort-select');
            const sortType = sortSelect ? sortSelect.value : 'partner_updated';
            const searchInput = document.getElementById('driver-search-input');
            const term = searchInput ? searchInput.value.trim().toLowerCase() : '';

            // 3. çµ±è¨ˆæ•¸æ“š (æ¬¡æ•¸ & æœ€å¾Œæˆ°å½¹æ™‚é–“)
            const stats = {};      // è¨˜éŒ„æ¬¡æ•¸
            const lastActive = {}; // è¨˜éŒ„æœ€å¾Œä¸€æ¬¡ç™¼ç”Ÿçš„æ™‚é–“ (Timestamp)

            ejaculationRecords.forEach(r => {
                if(r.partners && Array.isArray(r.partners)) {
                    // å–å¾—é€™ç­†ç´€éŒ„çš„æ™‚é–“
                    const recordTime = new Date(r.timestamp).getTime();
                    
                    r.partners.forEach(p => {
                        // ç´¯åŠ æ¬¡æ•¸
                        stats[p.name] = (stats[p.name]||0) + 1;
                        
                        // æ›´æ–°è©²å¤¥ä¼´çš„ã€Œæœ€å¾Œæˆ°å½¹æ™‚é–“ã€ (å–æœ€å¤§å€¼)
                        if (!lastActive[p.name] || recordTime > lastActive[p.name]) {
                            lastActive[p.name] = recordTime;
                        }
                    });
                }
            });

            // 4. è¤‡è£½ä¸¦åŸ·è¡Œæ’åº
            let sorted = [...partnerProfiles];

            sorted.sort((a, b) => {
                if (sortType === 'partner_name') {
                    // ğŸ”¤ å§“åæ’åº (A-Z)
                    return a.name.localeCompare(b.name, 'zh-Hant');
                    
                } else if (sortType === 'partner_nation') {
                    // ğŸŒ åœ‹ç±æ’åº (æœ‰åœ‹ç±çš„åœ¨å‰ï¼Œæ²’åœ‹ç±çš„åœ¨å¾Œ)
                    if (a.nation && !b.nation) return -1;
                    if (!a.nation && b.nation) return 1;
                    if (!a.nation && !b.nation) return 0;
                    return a.nation.n.localeCompare(b.nation.n, 'zh-Hant');
                    
                } else if (sortType === 'partner_count') {
                    // ğŸ”¥ æ¬¡æ•¸æ’åº (å¤š -> å°‘)
                    return (stats[b.name]||0) - (stats[a.name]||0);
                    
                } else {
                    // ğŸ•’ æœ€å¾Œæ›´æ–° (é è¨­) - æ”¹ç‚ºã€Œæœ€è¿‘æˆ°å½¹æ™‚é–“ã€
                    // å¦‚æœæœ‰ç´€éŒ„æ™‚é–“å°±ç”¨ç´€éŒ„æ™‚é–“ï¼Œæ²’æœ‰å°±ç”¨æª”æ¡ˆå»ºç«‹æ™‚é–“
                    const timeA = lastActive[a.name] || a.lastUpdated || a.id || 0;
                    const timeB = lastActive[b.name] || b.lastUpdated || b.id || 0;
                    return timeB - timeA; // æ–° -> èˆŠ
                }
            });

            // 5. æœå°‹éæ¿¾
            if (term) {
                sorted = sorted.filter(p => {
                    const nameMatch = p.name.toLowerCase().includes(term);
                    const nationMatch = p.nation ? p.nation.n.includes(term) : false;
                    const raceMatch = p.race ? p.race.toLowerCase().includes(term) : false;
                    return nameMatch || nationMatch || raceMatch;
                });
            }

            // 6. é¡¯ç¤ºç©ºç‹€æ…‹
            if (sorted.length === 0) {
                c.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#999;padding:40px;">å°šç„¡ç¬¦åˆçš„æ€§å¤¥ä¼´ç´€éŒ„<br><small>å»æ–°å¢ä¸€ç­†ã€Œåšæ„›ã€ç´€éŒ„ï¼Œ<br>é€™è£¡å°±æœƒè‡ªå‹•å»ºç«‹æª”æ¡ˆå›‰ï¼</small></div>';
                return;
            }

            // 7. ç”¢ç”Ÿå¡ç‰‡
            sorted.forEach(p => {
                const count = stats[p.name] || 0;
                const d = document.createElement('div');
                d.className = 'actor-card'; 
                d.onclick = () => showPartnerDetail(p.name);
                const s = p.photo || DEFAULT_AVATAR;
                const flag = p.nation ? p.nation.f : '';
                
                d.innerHTML = `
                    <div style="position:relative; width:100%;">
                        <img src="${s}" class="actor-avatar" style="border-color:var(--color-accent);" onerror="this.src='${DEFAULT_AVATAR}'">
                        <div style="position:absolute; bottom:10px; right:0; font-size:24px; text-shadow:0 2px 5px rgba(0,0,0,0.2); filter:drop-shadow(0 0 2px rgba(255,255,255,0.8));">${flag}</div>
                    </div>
                    <span class="actor-name">${p.name}</span>
                    <span style="font-size:11px; color:#999;">${count} æ¬¡</span>
                `;
                c.appendChild(d);
            });
        };

        // 4. å¤¥ä¼´è©³æƒ…
        window.showPartnerDetail = function(name) {
            currentPartnerName = name;
            const p = partnerProfiles.find(x => x.name === name);
            if(!p) return;

            // çµ±è¨ˆæ•¸æ“š
            const history = ejaculationRecords.filter(r => r.partners && r.partners.some(pa => pa.name === name));
            history.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

            document.getElementById('pd-avatar').src = p.photo || DEFAULT_AVATAR;
            document.getElementById('pd-name').textContent = p.name;
            document.getElementById('pd-flag').textContent = p.nation ? p.nation.f : '';
            document.getElementById('pd-meta').textContent = (p.nation ? p.nation.n : 'åœ‹ç±æœªè©³') + (p.race ? ` Â· ${p.race}` : '');
            document.getElementById('pd-stats').textContent = `ç´¯ç©æ¬¡æ•¸ï¼š${history.length} æ¬¡`;

            const list = document.getElementById('pd-history-list');
            list.innerHTML = '';
            history.forEach(r => {
                const d = new Date(r.timestamp);
                const dateStr = `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()}`;
                const div = document.createElement('div');
                div.className = 'diary-card'; // é‡ç”¨æ¨£å¼
                div.style.padding = '10px';
                div.style.minHeight = 'auto';
                div.onclick = () => { closePartnerDetail(); openDetailModal(r.id); };
                div.innerHTML = `<div style="font-weight:bold; color:#555;">${dateStr}</div><div style="font-size:13px; color:#888;">${r.location || 'æœªçŸ¥åœ°é»'}</div>`;
                list.appendChild(div);
            });

            document.getElementById('partner-detail-modal').classList.add('active');
        };
        window.closePartnerDetail = () => document.getElementById('partner-detail-modal').classList.remove('active');

        // 5. ç·¨è¼¯å¤¥ä¼´èˆ‡åœ‹ç±æœå°‹
        // åˆªé™¤å¤¥ä¼´åŠŸèƒ½ (å¼·åŠ›ç‰ˆï¼šé€£åŒæ­·å²ç´€éŒ„çš„é—œè¯ä¸€èµ·ç§»é™¤)
        window.deleteCurrentPartner = function() {
            if(!currentPartnerName) return;
            
            showConfirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${currentPartnerName}ã€å—ï¼Ÿ\n\næ³¨æ„ï¼šé€™å°‡æœƒå¾æ‰€æœ‰æ­·å²ç´€éŒ„ä¸­ç§»é™¤é€™ä½å¤¥ä¼´çš„åå­—ï¼ˆç´€éŒ„æœ¬èº«æœƒä¿ç•™ï¼‰ã€‚`, () => {
                
                // 1. å¾æ‰€æœ‰æ­·å²ç´€éŒ„ä¸­ã€Œè§£é™¤é—œè¯ã€ (é˜²æ­¢è‡ªå‹•åŒæ­¥æ™‚å¾©æ´»)
                let recordModified = false;
                ejaculationRecords.forEach(r => {
                    if (r.partners && Array.isArray(r.partners)) {
                        const originalLen = r.partners.length;
                        // éæ¿¾æ‰é€™å€‹äºº
                        r.partners = r.partners.filter(p => p.name !== currentPartnerName);
                        
                        if(r.partners.length !== originalLen) recordModified = true;
                    }
                });
                if(recordModified) saveRecordData();

                // 2. åˆªé™¤å¤¥ä¼´æª”æ¡ˆ
                partnerProfiles = partnerProfiles.filter(p => p.name !== currentPartnerName);
                savePartnerData();

                // 3. é—œé–‰è¦–çª—ä¸¦æ›´æ–°ä»‹é¢
                closePartnerDetail();
                renderPartnerGrid();
                
                // å¦‚æœåœ¨æ•¸æ“šé ï¼Œä¹Ÿè¦åˆ·æ–°ä¸€ä¸‹
                if(window.calculateStats) window.calculateStats();
                
                showAlert('å¤¥ä¼´è³‡æ–™å·²åˆªé™¤ï¼Œæ­·å²é—œè¯å·²è§£é™¤ã€‚');
            });
        };
        window.openPartnerEditForm = function() {
            const p = partnerProfiles.find(x => x.name === currentPartnerName);
            if(!p) return;
            document.getElementById('partner-detail-modal').classList.remove('active'); // æš«æ™‚é—œé–‰è©³æƒ…
            
            document.getElementById('pf-name').value = p.name;
            document.getElementById('pf-url').value = "";
            document.getElementById('pf-file').value = "";
            document.getElementById('pf-preview').src = p.photo || DEFAULT_AVATAR;
            
            document.getElementById('pf-race').value = p.race || "";
            
            // è¨­å®šåœ‹ç±
            if(p.nation) {
                document.getElementById('pf-nation-search').value = p.nation.n;
                document.getElementById('pf-nation-data').value = JSON.stringify(p.nation);
            } else {
                document.getElementById('pf-nation-search').value = "";
                document.getElementById('pf-nation-data').value = "";
            }

            document.getElementById('partner-form-modal').classList.add('active');
        };

        // åœ‹ç±æœå°‹é‚è¼¯
        function setupCountrySearch() {
            const input = document.getElementById('pf-nation-search');
            const hidden = document.getElementById('pf-nation-data');
            const list = document.getElementById('pf-nation-suggestions');
            
            input.addEventListener('input', () => {
                const term = input.value.trim().toLowerCase();
                if(!term) { list.style.display = 'none'; return; }
                
                const matches = COUNTRY_LIST.filter(c => c.n.includes(term) || c.f.includes(term));
                if(matches.length > 0) {
                    list.innerHTML = matches.map(c => `
                        <div class="suggestion-item" onclick='selectCountry(${JSON.stringify(c)})'>
                            <span style="font-size:18px;margin-right:8px;">${c.f}</span> ${c.n}
                        </div>
                    `).join('');
                    list.style.display = 'block';
                } else { list.style.display = 'none'; }
            });

            window.selectCountry = (c) => {
                input.value = c.n;
                hidden.value = JSON.stringify(c);
                list.style.display = 'none';
            };
        }
        window.showDriverList = function() {
            document.getElementById('driver-view-list').classList.add('active');
            document.getElementById('driver-view-detail').classList.remove('active');
            currentActorId = null;
            renderActorList();
        };

        window.showDriverDetail = function(id) {
            currentActorId = id;
            document.getElementById('driver-view-list').classList.remove('active');
            document.getElementById('driver-view-detail').classList.add('active');
            renderActorDetail();
            document.getElementById('app-container').scrollTo(0, 0);
        };

        window.renderActorList = function() {
            const c = document.getElementById('actor-grid');
            c.innerHTML = '';
            
            // Search Logic
            const searchInput = document.getElementById('driver-search-input');
            const term = searchInput ? searchInput.value.trim().toLowerCase() : '';
            // çµ±ä¸€çš„ç¯©é¸å…¥å£ (æœå°‹æ¡†è¼¸å…¥ æˆ– æ’åºæ”¹è®Šæ™‚ å‘¼å«)
        window.filterDriverList = function() {
            const btns = document.querySelectorAll('.driver-header .toggle-btn');
            // æª¢æŸ¥ç¾åœ¨æ˜¯å“ªå€‹æ¨¡å¼äº®èµ· (Active)
            const isActorMode = btns[0].classList.contains('active');
            
            if (isActorMode) {
                renderActorList(); // å‘¼å«é›²ç«¯æƒ…äººæ¸²æŸ“ (å…§éƒ¨æœƒå»è®€å–æœå°‹æ¡†)
            } else {
                renderPartnerGrid(); // å‘¼å«æ€§å¤¥ä¼´æ¸²æŸ“ (å…§éƒ¨æœƒå»è®€å–æœå°‹æ¡†)
            }
        };
            // Sort Logic
            const sortType = document.getElementById('driver-sort-select') ? document.getElementById('driver-sort-select').value : 'updated';
            
            actorProfiles.sort((a, b) => {
                if (sortType === 'name') {
                    return a.name.localeCompare(b.name, 'zh-Hant');
                } else if (sortType === 'count') {
                    return (b.videos ? b.videos.length : 0) - (a.videos ? a.videos.length : 0);
                } else {
                    // Default: updated
                    const timeA = a.lastUpdated || a.id;
                    const timeB = b.lastUpdated || b.id;
                    return timeB - timeA;
                }
            });
            
            // Save sorted order so it persists
            saveActorData();

            let filtered = actorProfiles;
            if (term) {
                filtered = actorProfiles.filter(a => {
                    const nameMatch = (a.name || '').toLowerCase().includes(term);
                    const bioMatch = (a.bio || '').toLowerCase().includes(term);
                    // æœå°‹äººç‰© tags
                    const actorTagMatch = (a.tags || []).some(t => t.toLowerCase().includes(term));
                    // æ–°å¢ï¼šDeep Search - æœå°‹äººç‰©åº•ä¸‹çš„ã€Œå½±ç‰‡æ¨™é¡Œã€æˆ–ã€Œå½±ç‰‡æ¨™ç±¤ã€
                    const videoMatch = (a.videos || []).some(v => 
                        (v.title && v.title.toLowerCase().includes(term)) ||
                        (v.tags && v.tags.some(vt => vt.toLowerCase().includes(term)))
                    );

                    return nameMatch || bioMatch || actorTagMatch || videoMatch;
                });
            }

            if (filtered.length === 0) {
                 if (actorProfiles.length === 0) {
                     c.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#999;padding:40px;">ç„¡äººç‰©è³‡æ–™</div>';
                 } else {
                     c.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:#999;padding:40px;">æ‰¾ä¸åˆ°ç›¸é—œçš„äººç‰© ğŸ˜¯</div>';
                 }
                return;
            }

            filtered.forEach(a => {
                const d = document.createElement('div');
                d.className = 'actor-card';
                d.onclick = () => showDriverDetail(a.id);
                const s = a.avatar || DEFAULT_AVATAR;
                d.innerHTML = `<img src="${s}" class="actor-avatar" onerror="this.src='${DEFAULT_AVATAR}'"><span class="actor-name">${a.name}</span>`;
                c.appendChild(d);
            });
        };

        window.renderActorDetail = function() {
            if (!currentActorId) return;
            const a = actorProfiles.find(x => x.id === currentActorId);
            if (!a) {
                showDriverList();
                return;
            }
            
            // Tags HTML
            let tagsHtml = '';
            if (a.tags && a.tags.length > 0) {
                tagsHtml = '<div style="margin-top:10px; display:flex; flex-wrap:wrap; justify-content:center;">' + 
                    a.tags.map(t => `<span class="actor-tag" onclick="searchByTag('${t}')">${t}</span>`).join('') + 
                    '</div>';
            }

            // Link HTML
            let linkHtml = '';
            if (a.website) {
                let safeUrl = a.website;
                if (!/^https?:\/\//i.test(safeUrl)) safeUrl = 'https://' + safeUrl;
                linkHtml = `
                    <a href="${safeUrl}" target="_blank" rel="noopener noreferrer" 
                       class="btn-base" 
                       style="background-color:#000; color:white; margin-top:15px; display:inline-flex; align-items:center; gap:6px; text-decoration:none; padding:8px 16px; border-radius:20px; font-size:13px;">
                        <span>ğŸ”—</span> å‰å¾€å€‹äººä¸»é  / X
                    </a>
                `;
            }

            const p = document.getElementById('detail-profile-container');
            const s = a.avatar || DEFAULT_AVATAR;
            
            p.innerHTML = `<div class="btn-edit-profile" onclick="openEditActorForm()"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></div><img src="${s}" class="detail-avatar" onerror="this.src='${DEFAULT_AVATAR}'"><div class="detail-name">${a.name}</div><div class="detail-bio">${a.bio || 'å°šç„¡ç°¡ä»‹'}</div>${tagsHtml}${linkHtml}`;
            
            // --- ä¿®æ”¹ï¼šæ¸²æŸ“æŒ‰éˆ•åˆ°å°ˆå±¬å€å¡Š (Moved Up) ---
            const actionContainer = document.getElementById('detail-action-bar');
            if (actionContainer) {
                actionContainer.innerHTML = `
                    <button class="btn-base btn-accent" onclick="openVideoFormModal()" style="font-size:13px; padding:8px 14px;">ğŸ¥ æ–°å¢å½±ç‰‡</button>
                    <button class="btn-base btn-primary" onclick="openPhotoFormModal()" style="font-size:13px; padding:8px 14px;">ğŸ“· æ–°å¢ç…§ç‰‡</button>
                `;
            }

            // --- æ¸²æŸ“å½±ç‰‡åˆ—è¡¨ ---
            const vc = document.getElementById('video-list-container');
            vc.innerHTML = '';
            // (åŸæœ¬é€™è£¡æœƒæ’å…¥ actionsDivï¼Œç¾åœ¨ä¸éœ€è¦äº†ï¼Œç›´æ¥é–‹å§‹æ¸²æŸ“å½±ç‰‡)

            // 2. æ¸²æŸ“å½±ç‰‡åˆ—è¡¨ (ä¿æŒåŸæ¨£)
            if (!a.videos || a.videos.length === 0) {
                const emptyMsg = document.createElement('div');
                emptyMsg.style.textAlign = 'center';
                emptyMsg.style.color = '#ccc';
                emptyMsg.style.padding = '10px';
                emptyMsg.textContent = 'å°šç„¡å½±ç‰‡';
                vc.appendChild(emptyMsg);
            } else {
                a.videos.forEach(v => {
                    // (é€™æ®µåŸæœ‰çš„å½±ç‰‡æ¸²æŸ“ç¨‹å¼ç¢¼ä¿æŒä¸è®Šï¼Œç‚ºç¯€çœç¯‡å¹…çœç•¥ï¼Œè«‹ä¿ç•™ä½ åŸæœ¬çš„...)
                    let vTagsHtml = '';
                    if (v.tags && v.tags.length > 0) {
                        vTagsHtml = '<div style="margin-top:4px;">' + 
                            v.tags.map(t => `<span class="video-tag" onclick="event.stopPropagation(); searchByTag('${t}')">${t}</span>`).join('') + 
                            '</div>';
                    }
                    const c = document.createElement('div');
                    c.className = 'video-card';
                    c.onclick = () => openVideoDetail(a.id, v.id);
                    if (!v.id) v.id = Date.now() + Math.random();
                    let th = `<div class="video-thumb-placeholder">ğŸ¬</div>`;
                    if (v.thumbnail) th = `<img src="${v.thumbnail}" class="video-thumb-img" onerror="this.parentElement.innerHTML='<div class=\\'video-thumb-placeholder\\'>ğŸ¬</div>'">`;
                    c.innerHTML = `<div class="video-thumb-box">${th}</div><div class="video-card-info"><div class="video-card-title">${v.title}</div><div class="video-card-note">${v.note || ''}</div>${vTagsHtml}</div><div style="color:#ccc;align-self:center;">â€º</div>`;
                    vc.appendChild(c);
                });
            }

            // 3. æ¸²æŸ“ç›¸ç°¿åˆ—è¡¨ (æ–°å¢éƒ¨åˆ†)
            const pc = document.getElementById('photo-list-container');
            pc.innerHTML = ''; // æ¸…ç©ºèˆŠå…§å®¹
            
            if (a.photos && a.photos.length > 0) {
                // ååºæ’åˆ—ï¼Œæ–°ç…§ç‰‡åœ¨å‰é¢
                [...a.photos].reverse().forEach(photo => {
                    const item = document.createElement('div');
                    item.className = 'photo-grid-item';
                    item.onclick = () => openPhotoViewer(photo.id);
                    item.innerHTML = `<img src="${photo.url}" class="photo-grid-img" loading="lazy">`;
                    pc.appendChild(item);
                });
            } else {
                pc.innerHTML = '<div style="grid-column:1/-1; text-align:center; color:#ccc; padding:20px; font-size:13px;">å°šç„¡ç…§ç‰‡</div>';
            }
            // --- ä¿®æ”¹çµæŸ ---
        };

        window.deleteCurrentActor = function() {
            if(!currentActorId) return;
            showConfirm('ç¢ºå®šè¦ç§»é™¤é€™ä½äººç‰©å—ï¼Ÿ\næ‰€æœ‰çš„ç°¡ä»‹èˆ‡å½±ç‰‡æ”¶è—éƒ½æœƒä¸€ä½µæ¶ˆå¤±ã€‚', () => {
                actorProfiles = actorProfiles.filter(a => a.id !== currentActorId);
                saveActorData();
                showDriverList();
            });
        };
        
        // æ–°å¢ Tag æœå°‹å‡½å¼
        window.searchByTag = function(tag) {
            showDriverList(); // è¿”å›åˆ—è¡¨
            const input = document.getElementById('driver-search-input');
            if(input) {
                input.value = tag; // å¡«å…¥ tag
                renderActorList(); // è§¸ç™¼æœå°‹
            }
        };

        window.openVideoDetail = function(aid, vid, toggle = true) {
            const a = actorProfiles.find(x => x.id === aid), v = a.videos.find(x => x.id === vid);
            if (!v) return;
            // è™•ç†æ¨™é¡Œ + Tags
            let tagsHtml = '';
            if (v.tags && v.tags.length > 0) {
                tagsHtml = '<div style="margin-bottom:12px;">' + 
                    v.tags.map(t => `<span class="actor-tag" style="font-size:11px; margin-right:4px;">${t}</span>`).join('') + 
                    '</div>';
            }
            document.getElementById('vid-detail-title').innerHTML = v.title + tagsHtml;

            const n = document.getElementById('vid-detail-note');
            if (v.note) {
                n.textContent = v.note;
                n.style.display = 'block';
            } else {
                n.style.display = 'none';
            }
            const c = document.getElementById('vid-detail-cover-box');
            if (v.thumbnail) {
                document.getElementById('vid-detail-cover').src = v.thumbnail;
                c.style.display = 'flex';
            } else {
                c.style.display = 'none';
            }
            document.getElementById('vid-btn-watch').onclick = () => {
                let u = v.url;
                if (!/^https?:\/\//i.test(u)) u = 'https://' + u;
                window.open(u, '_blank', 'noopener,noreferrer');
            };
            document.getElementById('vid-btn-edit').onclick = () => {
                closeVideoDetail();
                openVideoFormModal(v.id);
            };
            document.getElementById('vid-btn-delete').onclick = () => {
                showConfirm('ç¢ºå®šè¦åˆªé™¤é€™éƒ¨å½±ç‰‡å—ï¼Ÿ', () => {
                    a.videos = a.videos.filter(x => x.id !== v.id);
                    saveActorData();
                    renderActorDetail();
                    closeVideoDetail();
                });
            };
            if (toggle) document.getElementById('video-detail-modal').classList.add('active');
        };

        window.closeVideoDetail = function() {
            document.getElementById('video-detail-modal').classList.remove('active');
        };
        // --- Partner Management System ---
        function updateFormVisibility(prefix = '') {
            const typeVal = document.getElementById(prefix === 'edit-' ? 'edit-type' : 'input-type').value;
            const secMast = document.getElementById(prefix === 'edit-' ? 'edit-section-masturbation' : 'section-masturbation');
            const secSex = document.getElementById(prefix === 'edit-' ? 'edit-section-sex' : 'section-sex');
            
            if (typeVal === 'è‡ªæ…°') {
                secMast.style.display = 'block';
                secSex.style.display = 'none';
            } else if (typeVal === 'åšæ„›') {
                secMast.style.display = 'none';
                secSex.style.display = 'block';
            } else {
                // å¤¢éºæˆ–å…¶ä»–ï¼šå…¨éƒ¨éš±è—
                secMast.style.display = 'none';
                secSex.style.display = 'none';
            }
        }

        function setupPartnerInput(mode) {
            // mode: 'new' or 'edit'
            const prefix = mode === 'new' ? '' : 'edit-';
            const inputName = document.getElementById(prefix + 'input-partner-name');
            const inputUrl = document.getElementById(prefix + 'input-partner-url'); // æ–°å¢
            const inputPhoto = document.getElementById(prefix + 'input-partner-photo');
            const imgPreview = document.getElementById(prefix + 'preview-partner-photo');
            const list = document.getElementById(prefix + 'partner-suggestions');

            // 1. æœ¬åœ°æª”æ¡ˆä¸Šå‚³ç›£è½
            inputPhoto.addEventListener('change', async (e) => {
                if(e.target.files[0]){
                    try {
                        const b64 = await compressImage(e.target.files[0]);
                        currentPartnerPhoto = b64;
                        imgPreview.src = b64;
                        imgPreview.style.display = 'block';
                        // å¦‚æœæœ‰ä¸Šå‚³æª”æ¡ˆï¼Œæ¸…ç©º URL æ¬„ä½ä»¥å…æ··æ·†
                        if(inputUrl) inputUrl.value = '';
                    } catch(err) { showAlert("åœ–ç‰‡è™•ç†å¤±æ•—"); }
                }
            });

            // 2. ç¶²å€è¼¸å…¥ç›£è½ (æ–°å¢)
            if (inputUrl) {
                inputUrl.addEventListener('input', () => {
                    const url = inputUrl.value.trim();
                    if (url) {
                        currentPartnerPhoto = url;
                        imgPreview.src = url;
                        imgPreview.style.display = 'block';
                        // æ¸…ç©ºæª”æ¡ˆ input (é›–ç„¶è¦–è¦ºä¸Šçœ‹ä¸åˆ°ï¼Œä½†é‚è¼¯ä¸Šé‡ç½®)
                        inputPhoto.value = ''; 
                    }
                });
            }

            // 3. æ­·å²ç´€éŒ„è‡ªå‹•å®Œæˆ (Autocomplete)
            inputName.addEventListener('input', () => {
                const term = inputName.value.trim().toLowerCase();
                if(term.length === 0) { list.style.display = 'none'; return; }

                const allPartners = new Set();
                ejaculationRecords.forEach(r => {
                    if(r.partners) {
                        r.partners.forEach(p => allPartners.add(p.name));
                    }
                });
                
                const matches = Array.from(allPartners).filter(n => n.toLowerCase().includes(term));
                
                if(matches.length > 0) {
                    list.innerHTML = matches.map(name => 
                        `<div class="suggestion-item" onclick="selectPartnerSuggestion('${name}', '${mode}')">ğŸ’ ${name}</div>`
                    ).join('');
                    list.style.display = 'block';
                } else {
                    list.style.display = 'none';
                }
            });

            document.addEventListener('click', (e) => {
                if(e.target !== inputName && e.target !== list) list.style.display = 'none';
            });
        }

        window.addPartnerToState = function(mode) {
            const prefix = mode === 'new' ? '' : 'edit-';
            const nameInput = document.getElementById(prefix + 'input-partner-name');
            const urlInput = document.getElementById(prefix + 'input-partner-url'); // æ–°å¢
            const name = nameInput.value.trim();
            
            if(!name) { showAlert('è«‹è¼¸å…¥å¤¥ä¼´åå­—'); return; }
            
            // å¦‚æœ currentPartnerPhoto æ˜¯ç©ºçš„ï¼Œä½† URL æ¬„ä½æœ‰å€¼ï¼Œå°±ç”¨ URL (é›™é‡ä¿éšª)
            if (!currentPartnerPhoto && urlInput && urlInput.value.trim()) {
                currentPartnerPhoto = urlInput.value.trim();
            }

            const newP = { name: name, photo: currentPartnerPhoto };
            
            if(mode === 'new') {
                tempPartnerList.push(newP);
                renderPartnerTags('new');
            } else {
                editTempPartnerList.push(newP);
                renderPartnerTags('edit');
            }
            
            // Reset Input
            nameInput.value = '';
            if(urlInput) urlInput.value = ''; // æ¸…ç©º URL
            currentPartnerPhoto = "";
            document.getElementById(prefix + 'preview-partner-photo').style.display = 'none';
            document.getElementById(prefix + 'input-partner-photo').value = ""; 
        };

        window.selectPartnerSuggestion = function(name, mode) {
            const prefix = mode === 'new' ? '' : 'edit-';
            document.getElementById(prefix + 'input-partner-name').value = name;
            document.getElementById(prefix + 'partner-suggestions').style.display = 'none';
            // å˜—è©¦å¾æ­·å²ç´€éŒ„æ‰¾é€™äººçš„èˆŠç…§ç‰‡ (é¸å¡«)
            const history = ejaculationRecords.find(r => r.partners && r.partners.find(p => p.name === name && p.photo));
            if(history) {
                const p = history.partners.find(x => x.name === name);
                if(p && p.photo) {
                    currentPartnerPhoto = p.photo;
                    const img = document.getElementById(prefix + 'preview-partner-photo');
                    img.src = p.photo;
                    img.style.display = 'block';
                }
            }
        };

        window.addPartnerToState = function(mode) {
            const prefix = mode === 'new' ? '' : 'edit-';
            const nameInput = document.getElementById(prefix + 'input-partner-name');
            const name = nameInput.value.trim();
            
            if(!name) { showAlert('è«‹è¼¸å…¥å¤¥ä¼´åå­—'); return; }
            
            const newP = { name: name, photo: currentPartnerPhoto };
            
            if(mode === 'new') {
                tempPartnerList.push(newP);
                renderPartnerTags('new');
            } else {
                editTempPartnerList.push(newP);
                renderPartnerTags('edit');
            }
            
            // Reset Input
            nameInput.value = '';
            currentPartnerPhoto = "";
            document.getElementById(prefix + 'preview-partner-photo').style.display = 'none';
            document.getElementById(prefix + 'input-partner-photo').value = ""; // clear file
        };

        window.renderPartnerTags = function(mode) {
            const prefix = mode === 'new' ? '' : 'edit-';
            const container = document.getElementById(prefix === '' ? 'selected-partners-box' : 'edit-selected-partners-box');
            const arr = mode === 'new' ? tempPartnerList : editTempPartnerList;
            
            container.innerHTML = arr.map((p, idx) => `
                <div class="selected-tag-chip" style="background: rgba(255, 105, 180, 0.15); color: var(--color-accent);">
                    ${p.photo ? `<img src="${p.photo}" style="width:20px;height:20px;border-radius:50%;object-fit:cover;">` : 'ğŸ‘¤'}
                    ${p.name}
                    <span class="remove-tag" onclick="removePartner(${idx}, '${mode}')">Ã—</span>
                </div>
            `).join('');
        };

        window.removePartner = function(idx, mode) {
            if(mode === 'new') {
                tempPartnerList.splice(idx, 1);
                renderPartnerTags('new');
            } else {
                editTempPartnerList.splice(idx, 1);
                renderPartnerTags('edit');
            }
        };
        // --- New Split Search Logic ---
        
        // 1. æ¼”å“¡æœå°‹èˆ‡ç®¡ç† (æ”¯æ´å¤šé¸)
        function setupActorSelector(inputId, suggestionId, containerId, listVarName) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(suggestionId);
            const container = document.getElementById(containerId);
            
            if (!input || !list) return;

            // æ¸²æŸ“å·²é¸æ“‡çš„æ¨™ç±¤
            window['render_' + listVarName] = function() {
                const arr = (listVarName === 'tempActorsList') ? tempActorsList : editTempActorsList;
                container.innerHTML = arr.map(a => `
                    <div class="selected-tag-chip">
                        ${a.name}
                        <span class="remove-tag" onclick="removeActorFromList('${a.id}', '${listVarName}')">Ã—</span>
                    </div>
                `).join('');
            };

            input.addEventListener('input', () => {
                const term = input.value.trim().toLowerCase();
                if (term.length === 0) { list.style.display = 'none'; return; }

                // æ’é™¤å·²ç¶“é¸éçš„äºº
                const currentList = (listVarName === 'tempActorsList') ? tempActorsList : editTempActorsList;
                const currentIds = currentList.map(x => x.id);

                const matches = actorProfiles.filter(a => 
                    a.name.toLowerCase().includes(term) && !currentIds.includes(a.id)
                );

                if (matches.length > 0) {
                    list.innerHTML = matches.map(a => 
                        `<div class="suggestion-item" data-id="${a.id}" data-name="${a.name}">ğŸ‘¤ ${a.name}</div>`
                    ).join('');
                    list.style.display = 'block';

                    Array.from(list.children).forEach(div => {
                        div.onclick = () => {
                            const actor = { id: parseFloat(div.dataset.id), name: div.dataset.name };
                            if (listVarName === 'tempActorsList') tempActorsList.push(actor);
                            else editTempActorsList.push(actor);
                            
                            window['render_' + listVarName](); // æ›´æ–°ç•«é¢
                            input.value = ''; // æ¸…ç©ºè¼¸å…¥æ¡†
                            list.style.display = 'none';
                        };
                    });
                } else { list.style.display = 'none'; }
            });
            
            // é»æ“Šå¤–éƒ¨é—œé–‰
            document.addEventListener('click', (e) => {
                if (e.target !== input && e.target !== list) list.style.display = 'none';
            });
        }

        window.removeActorFromList = function(id, listVarName) {
            const targetId = parseFloat(id);
            if (listVarName === 'tempActorsList') {
                tempActorsList = tempActorsList.filter(a => a.id !== targetId);
                window['render_tempActorsList']();
            } else {
                editTempActorsList = editTempActorsList.filter(a => a.id !== targetId);
                window['render_editTempActorsList']();
            }
        };

        // 2. å½±ç‰‡æœå°‹ (å–®é¸)
        function setupVideoSelector(inputId, suggestionId, hiddenId) {
            const input = document.getElementById(inputId);
            const list = document.getElementById(suggestionId);
            const hidden = document.getElementById(hiddenId);

            input.addEventListener('input', () => {
                const term = input.value.trim().toLowerCase();
                if (term.length === 0) { list.style.display = 'none'; return; }

                const matches = [];
                actorProfiles.forEach(a => {
                    if (a.videos) {
                        a.videos.forEach(v => {
                            if (v.title.toLowerCase().includes(term)) {
                                matches.push({ ...v, parentName: a.name, parentId: a.id });
                            }
                        });
                    }
                });

                if (matches.length > 0) {
                    list.innerHTML = matches.map(v => 
                        `<div class="suggestion-item" data-json='${JSON.stringify(v)}'>ğŸ¬ ${v.title} <small style="color:#aaa;">(${v.parentName})</small></div>`
                    ).join('');
                    list.style.display = 'block';

                    Array.from(list.children).forEach(div => {
                        div.onclick = () => {
                            const vData = JSON.parse(div.getAttribute('data-json'));
                            input.value = vData.title;
                            hidden.value = JSON.stringify({ id: vData.id, title: vData.title, parentId: vData.parentId });
                            list.style.display = 'none';
                        };
                    });
                } else { list.style.display = 'none'; }
            });

            document.addEventListener('click', (e) => {
                if (e.target !== input && e.target !== list) list.style.display = 'none';
            });
        }
        
        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            loadAllData(); updateHomeDisplay();
            setInterval(() => { if(document.getElementById('home').classList.contains('active')) updateHomeDisplay(); }, 60000);
            
            /// Setup New Selectors
        setupActorSelector('input-actor-search', 'actor-suggestions', 'selected-actors-box', 'tempActorsList');
        setupVideoSelector('input-video-search', 'video-suggestions', 'input-video-data');

        setupActorSelector('edit-actor-search', 'edit-actor-suggestions', 'edit-selected-actors-box', 'editTempActorsList');
        setupVideoSelector('edit-video-search', 'edit-video-suggestions', 'edit-video-data');
// Setup Partner Inputs
            setupPartnerInput('new');
            setupPartnerInput('edit');
            
            // Listen to Type Change
            const typeSelect = document.getElementById('input-type');
            const editTypeSelect = document.getElementById('edit-type');
            
            typeSelect.addEventListener('change', () => updateFormVisibility(''));
            editTypeSelect.addEventListener('change', () => updateFormVisibility('edit-'));
            
            // Init Visibility
            updateFormVisibility('');
            const tabs = document.querySelectorAll('.tab-item'); const sections = document.querySelectorAll('section');
            const timeInput = document.getElementById('input-timestamp'); timeInput.value = getNowInputValue();
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    tabs.forEach(t => t.classList.remove('active')); sections.forEach(s => s.classList.remove('active'));
                    tab.classList.add('active'); const targetId = tab.getAttribute('data-target'); document.getElementById(targetId).classList.add('active'); document.getElementById('app-container').scrollTo(0, 0);
                    if(targetId==='home') updateHomeDisplay(); 
                    if(targetId==='diary'){renderCalendar();renderDiaryList();}
                    if(targetId==='driver') showDriverList();
                    if(targetId==='stats') { calculateStats(); checkAchievements(); } 
                    if(targetId==='record'){ timeInput.value = getNowInputValue(); tempRecordPhoto=""; document.getElementById('preview-photo').classList.remove('show'); document.getElementById('input-photo').value=""; }
                });
            });
            
            document.getElementById('record-form').addEventListener('submit', (e) => { 
                e.preventDefault(); 
                
                // Get Video Data
                const vidJson = document.getElementById('input-video-data').value;
                let videoObj = null;
                if(vidJson) { try { videoObj = JSON.parse(vidJson); } catch(e){} }
                
                // Get Actors Data (Clone array)
                const actorsArr = [...tempActorsList];
                const partnersArr = [...tempPartnerList];
                ejaculationRecords.unshift({ 
                    id: Date.now(), 
                    timestamp: document.getElementById('input-timestamp').value, 
                    type: document.getElementById('input-type').value, 
                    location: document.getElementById('input-location').value, 
                    note: document.getElementById('input-note').value, 
                    photo: tempRecordPhoto,
                    // æ–°è³‡æ–™çµæ§‹ï¼šåˆ†é–‹å­˜
                    usedActors: actorsArr,
                    usedVideo: videoObj,partners: partnersArr
                }); 
                saveRecordData(); 
                
                const hasUnlocked = checkAchievements(() => { showAlert('ç´€éŒ„æˆåŠŸ ğŸ’¦'); });
                if (!hasUnlocked) { showAlert('ç´€éŒ„æˆåŠŸ ğŸ’¦'); }
                
                e.target.reset(); 
                // Clear fields
                tempActorsList = []; window['render_tempActorsList']();
                tempPartnerList = []; renderPartnerTags('new'); updateFormVisibility('');
                document.getElementById('input-video-data').value = "";
                document.getElementById('input-timestamp').value = getNowInputValue();
                tempRecordPhoto=""; document.getElementById('preview-photo').classList.remove('show'); document.querySelector('.tab-item[data-target="home"]').click(); 
            });
            
            document.getElementById('edit-record-form').addEventListener('submit', (e) => { 
                e.preventDefault(); 
                if(!editingRecordId)return; 
                const r = ejaculationRecords.find(rc=>rc.id===editingRecordId); 
                if(r){ 
                    r.timestamp=document.getElementById('edit-timestamp').value; 
                    r.type=document.getElementById('edit-type').value; 
                    r.location=document.getElementById('edit-location').value; 
                    r.note=document.getElementById('edit-note').value; 
                    r.photo=tempRecordPhoto; 
                    
                    // Update New Fields
                    const vidJson = document.getElementById('edit-video-data').value;
                    if(vidJson) { try { r.usedVideo = JSON.parse(vidJson); } catch(e){ r.usedVideo = null; } }
                    else if(document.getElementById('edit-video-search').value === "") { r.usedVideo = null; }
                    
                    r.usedActors = [...editTempActorsList];
                    r.partners = [...editTempPartnerList];
                    // æ¸…é™¤èˆŠæ ¼å¼ä»¥å…æ··æ·†
                    delete r.target;

                    saveRecordData(); renderDiaryList(); renderCalendar(); updateHomeDisplay(); checkAchievements(); closeEditModal(); showAlert('å·²æ›´æ–°'); 
                } 
            });
            
            document.getElementById('actor-form').addEventListener('submit', (e) => { 
                e.preventDefault(); 
                const name = document.getElementById('actor-name').value; 
                const bio = document.getElementById('actor-bio').value; 
                const website = document.getElementById('actor-website').value;

                // æ–°å¢ï¼šè™•ç† tags å­—ä¸²è½‰é™£åˆ—ï¼Œè‡ªå‹•è£œä¸Š #
                const isCollection = document.getElementById('actor-is-collection').checked;

                const tagsStr = document.getElementById('actor-tags').value;
                const tags = tagsStr.split(/[\s,]+/) // ç”¨ç©ºç™½æˆ–é€—è™Ÿåˆ‡åˆ†
                    .filter(t => t.trim() !== '')    // éæ¿¾ç©ºå­—ä¸²
                    .map(t => t.startsWith('#') ? t : '#' + t); // è£œä¸Š #

                const urlVal = document.getElementById('actor-avatar-url').value; 
                let finalAvatar = (urlVal && urlVal.trim()!=="") ? urlVal : tempActorAvatar; 
                
                if (editingActorId) { 
                    const actor = actorProfiles.find(a => a.id === editingActorId); 
                    if (actor) { 
                        actor.name = name; 
                        actor.avatar = finalAvatar; 
                        actor.bio = bio; 
                        actor.website = website; // å„²å­˜ website
                        actor.tags = tags; // å„²å­˜ tags
                        actor.isCollection = isCollection;
                        actor.lastUpdated = Date.now(); // æ›´æ–°æ™‚é–“
                        saveActorData(); renderActorDetail(); renderActorList(); 
                    } 
                } else { 
                    // æ–°å¢ tags: tags
                    actorProfiles.unshift({ 
            id: Date.now(), 
            lastUpdated: Date.now(), 
            name, 
            avatar: finalAvatar, 
            bio, 
            website, 
            tags: tags, 
            videos: [],
            isCollection: isCollection // å­˜å…¥
        }); 
        saveActorData(); renderActorList(); 
    } 
    closeActorFormModal();
            });

            document.getElementById('video-form').addEventListener('submit', (e) => { 
                e.preventDefault(); 
                const title = document.getElementById('video-title').value; 
                const url = document.getElementById('video-url').value; 
                const note = document.getElementById('video-note').value; 
                const urlVal = document.getElementById('video-thumb-url').value; 
                let finalThumb = (urlVal && urlVal.trim()!=="") ? urlVal : tempVideoThumb; 
                const actor = actorProfiles.find(a => a.id === currentActorId); 
                
                // æ›´æ–°è©²äººç‰©çš„æœ€å¾Œæ›´æ–°æ™‚é–“
                actor.lastUpdated = Date.now();

                // æ–°å¢ï¼šè™•ç† tags å­—ä¸²è½‰é™£åˆ—
                const tagsStr = document.getElementById('video-tags').value;
                const tags = tagsStr.split(/[\s,]+/).filter(t => t.trim() !== '').map(t => t.startsWith('#') ? t : '#' + t);

                if (editingVideoId) { 
                    const v = actor.videos.find(v => v.id === editingVideoId); 
                    if (v) { 
                        v.title = title; 
                        v.url = url; 
                        v.thumbnail = finalThumb; 
                        v.note = note; 
                        v.tags = tags;
                    } 
                    
                    setTimeout(() => {
                        openVideoDetail(currentActorId, editingVideoId, true);
                    }, 100);
                } else { 
                    actor.videos.push({ id: Date.now(), title, url, thumbnail: finalThumb, note, tags }); 
                } 
                saveActorData(); 
                renderActorDetail(); 
                closeVideoFormModal(); 
            });

            // --- Hashtag Autocomplete Logic (Actor) ---
            setupCountrySearch(); // å•Ÿå‹•åœ‹ç±æœå°‹

            // å¤¥ä¼´ç·¨è¼¯è¡¨å–®é€å‡º
            document.getElementById('partner-edit-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const p = partnerProfiles.find(x => x.name === currentPartnerName);
                if(!p) return;

                // æ›´æ–°åå­— (è‹¥æ”¹åï¼Œé—œè¯çš„ç´€éŒ„æš«ä¸é€£å‹•ï¼Œé€™æœƒæ¯”è¼ƒè¤‡é›œï¼Œé€™è£¡åƒ…æ›´æ–°æª”æ¡ˆ)
                // å»ºè­°ï¼šç°¡å–®èµ·è¦‹ï¼Œé€™è£¡å…ˆä¸å…è¨±æ”¹åå­—ï¼Œæˆ–è€…æ”¹åå¾Œåªæ›´æ–°æª”æ¡ˆé¡¯ç¤º
                const newName = document.getElementById('pf-name').value; 
                
                // è™•ç†ç…§ç‰‡
                const urlVal = document.getElementById('pf-url').value;
                const fileInput = document.getElementById('pf-file');
                let finalPhoto = p.photo;
                
                if (fileInput.files[0]) {
                    try { finalPhoto = await compressImage(fileInput.files[0]); } catch(e){}
                } else if (urlVal) {
                    finalPhoto = urlVal;
                }

                // è™•ç†åœ‹ç±
                const nationData = document.getElementById('pf-nation-data').value;
                const nation = nationData ? JSON.parse(nationData) : null;

                // æ›´æ–°
                p.name = newName;
                p.photo = finalPhoto;
                p.nation = nation;
                p.race = document.getElementById('pf-race').value;
                
                // å¦‚æœæ”¹äº†åå­—ï¼Œæ›´æ–° currentPartnerName ä»¥ä¾¿é‡é–‹ Modal
                currentPartnerName = newName;

                savePartnerData();
                document.getElementById('partner-form-modal').classList.remove('active');
                showPartnerDetail(newName); // å›åˆ°è©³æƒ…é 
                renderPartnerGrid(); // æ›´æ–°åˆ—è¡¨
            });
            
            // é è¦½åœ–ç›£è½
            document.getElementById('pf-url').addEventListener('input', (e) => {
                if(e.target.value) document.getElementById('pf-preview').src = e.target.value;
            });
            document.getElementById('pf-file').addEventListener('change', async (e) => {
                if(e.target.files[0]) {
                    const b64 = await compressImage(e.target.files[0]);
                    document.getElementById('pf-preview').src = b64;
                }
            });
            const tagInput = document.getElementById('actor-tags');
            const tagList = document.getElementById('tag-suggestions');

            function getCommonTags() {
                const counts = {};
                // é è¨­æ¨™ç±¤
                counts['#Daddy'] = 1; 
                counts['#å·¨å±Œ'] = 1;
                
                actorProfiles.forEach(a => {
                    if (a.tags) {
                        a.tags.forEach(t => counts[t] = (counts[t] || 0) + 1);
                    }
                });
                return Object.keys(counts).sort((a,b) => counts[b] - counts[a]);
            }

            function renderTagSuggestions(matches, currentWord) {
                tagList.innerHTML = matches.map(tag => `<div class="suggestion-item">${tag}</div>`).join('');
                
                Array.from(tagList.children).forEach(div => {
                    div.onclick = () => {
                        const fullTag = div.textContent;
                        const val = tagInput.value;
                        const cursor = tagInput.selectionStart;
                        const textBefore = val.slice(0, cursor);
                        const textAfter = val.slice(cursor);
                        const lastSpaceIndex = textBefore.lastIndexOf(' ');
                        const prefix = textBefore.slice(0, lastSpaceIndex + 1);
                        const newValue = prefix + fullTag + ' ' + textAfter;
                        
                        tagInput.value = newValue;
                        tagList.style.display = 'none';
                        tagInput.focus();
                    };
                });
            }

            if (tagInput && tagList) {
                tagInput.addEventListener('input', () => {
                    const val = tagInput.value;
                    const cursorPosition = tagInput.selectionStart;
                    const textBeforeCursor = val.slice(0, cursorPosition);
                    const words = textBeforeCursor.split(/\s+/);
                    const currentWord = words[words.length - 1];

                    if (currentWord.trim().length > 0) {
                        const allTags = getCommonTags();
                        const matches = allTags.filter(t => 
                            t.toLowerCase().includes(currentWord.toLowerCase()) || 
                            t.replace('#','').toLowerCase().includes(currentWord.toLowerCase())
                        );

                        if (matches.length > 0) {
                            renderTagSuggestions(matches, currentWord);
                            tagList.style.display = 'block';
                        } else {
                            tagList.style.display = 'none';
                        }
                    } else {
                        tagList.style.display = 'none';
                    }
                });

                document.addEventListener('click', (e) => {
                    if (e.target !== tagInput && e.target !== tagList) {
                        tagList.style.display = 'none';
                    }
                });
            }

            // --- Video Hashtag Logic ---
            function getVideoCommonTags() {
                const counts = { '#cum': 1, '#bukkake': 1 }; // é è¨­å€¼
                actorProfiles.forEach(a => {
                    if (a.videos) {
                        a.videos.forEach(v => {
                            if (v.tags) v.tags.forEach(t => counts[t] = (counts[t] || 0) + 1);
                        });
                    }
                });
                return Object.keys(counts).sort((a,b) => counts[b] - counts[a]);
            }

            const vidTagInput = document.getElementById('video-tags');
            const vidTagList = document.getElementById('video-tag-suggestions');

            if (vidTagInput && vidTagList) {
                vidTagInput.addEventListener('input', () => {
                    const val = vidTagInput.value;
                    const cursor = vidTagInput.selectionStart;
                    const textBefore = val.slice(0, cursor);
                    const words = textBefore.split(/\s+/);
                    const currentWord = words[words.length - 1];

                    if (currentWord.trim().length > 0) {
                        const allTags = getVideoCommonTags();
                        const matches = allTags.filter(t => 
                            t.toLowerCase().includes(currentWord.toLowerCase()) || 
                            t.replace('#','').toLowerCase().includes(currentWord.toLowerCase())
                        );
                        
                        if (matches.length > 0) {
                            vidTagList.innerHTML = matches.map(tag => `<div class="suggestion-item">${tag}</div>`).join('');
                            vidTagList.style.display = 'block';
                            
                            Array.from(vidTagList.children).forEach(div => {
                                div.onclick = () => {
                                    const fullTag = div.textContent;
                                    const currentVal = vidTagInput.value;
                                    const currentCursor = vidTagInput.selectionStart;
                                    const txtBefore = currentVal.slice(0, currentCursor);
                                    const txtAfter = currentVal.slice(currentCursor);
                                    const lastSpace = txtBefore.lastIndexOf(' ');
                                    const prefix = txtBefore.slice(0, lastSpace + 1);
                                    vidTagInput.value = prefix + fullTag + ' ' + txtAfter;
                                    vidTagList.style.display = 'none';
                                    vidTagInput.focus();
                                };
                            });
                        } else { vidTagList.style.display = 'none'; }
                    } else { vidTagList.style.display = 'none'; }
                });

                document.addEventListener('click', (e) => {
                    if (e.target !== vidTagInput && e.target !== vidTagList) {
                        vidTagList.style.display = 'none';
                    }
                });
            }
        });
        /* --- Tier List Logic (æ’è¡Œæ¦œåŠŸèƒ½) --- */
    let currentTierMode = 'actor'; 

    // 1. é–‹å•Ÿæ’è¡Œæ¦œ
    window.openTierList = function() {
        // åˆ¤æ–·ç›®å‰æ˜¯ã€Œé›²ç«¯æƒ…äººã€é‚„æ˜¯ã€Œæ€§å¤¥ä¼´ã€æ¨¡å¼
        const btns = document.querySelectorAll('.driver-header .toggle-btn');
        // å¦‚æœç¬¬äºŒé¡†æŒ‰éˆ•æœ‰ activeï¼Œä»£è¡¨æ˜¯ Partner æ¨¡å¼
        const isPartner = btns[1] && btns[1].classList.contains('active');
        
        currentTierMode = isPartner ? 'partner' : 'actor';
        
        // åˆ‡æ›ç•«é¢ï¼šéš±è—åˆ—è¡¨ï¼Œé¡¯ç¤ºæ’è¡Œæ¦œ
        document.getElementById('driver-view-list').classList.remove('active');
        document.getElementById('driver-view-detail').classList.remove('active');
        document.getElementById('driver-view-tier').classList.add('active');
        
        // æ›´æ–°æ¨™é¡Œ
        document.querySelector('#driver-view-tier h2').textContent = 
            currentTierMode === 'actor' ? 'â˜ï¸ æƒ…äººæ’è¡Œæ¦œ' : 'ğŸ’ å¤¥ä¼´æ’è¡Œæ¦œ';

        renderTierList();
    };

    // 2. é—œé–‰æ’è¡Œæ¦œ
    window.closeTierList = function() {
        document.getElementById('driver-view-tier').classList.remove('active');
        document.getElementById('driver-view-list').classList.add('active');
    };

    // 3. æ¸²æŸ“æ’è¡Œæ¦œç•«é¢ (ä¿®æ­£ç‰ˆï¼šä¾ç…§ tierOrder å¼·åˆ¶æ’åº)
    window.renderTierList = function() {
        document.querySelectorAll('.tier-content').forEach(el => el.innerHTML = '');
        const pool = document.getElementById('tier-pool');
        if(pool) pool.innerHTML = '';

        let data = currentTierMode === 'actor' ? actorProfiles : partnerProfiles;
        
        // å¦‚æœæ˜¯å¤¥ä¼´æ¨¡å¼ï¼Œå…ˆåŒæ­¥è³‡æ–™
        if(currentTierMode === 'partner' && window.syncPartnersFromRecords) window.syncPartnersFromRecords();

        // ğŸ”¥ é—œéµä¿®æ­£ï¼šæ¸²æŸ“å‰ï¼Œå…ˆä¾ç…§ tierOrder æ’å¥½éšŠï¼
        // é€™æ¨£å°±ç®—åˆ—è¡¨æ¨¡å¼æŠŠè³‡æ–™æ´—äº‚äº†ï¼Œé€™è£¡ä¹ŸæœƒæŠŠå®ƒæ’å›ä¾†
        data.sort((a, b) => {
            const orderA = (a.tierOrder !== undefined) ? a.tierOrder : 99999;
            const orderB = (b.tierOrder !== undefined) ? b.tierOrder : 99999;
            return orderA - orderB;
        });

        data.forEach(item => {
            const tier = item.tier || 'unranked';
            const img = item.avatar || item.photo || DEFAULT_AVATAR;
            const id = currentTierMode === 'actor' ? item.id : item.name;

            const imgEl = document.createElement('img');
            imgEl.src = img;
            imgEl.className = 'tier-avatar';
            imgEl.draggable = true; 
            imgEl.dataset.tid = id;

            // --- é›»è…¦ç‰ˆäº‹ä»¶ ---
            imgEl.ondragstart = (e) => drag(e, id);
            
            // --- æ‰‹æ©Ÿç‰ˆè§¸æ§äº‹ä»¶ ---
            imgEl.addEventListener('touchstart', (e) => handleMobileTouchStart(e, imgEl), {passive: false});
            imgEl.addEventListener('touchmove', (e) => handleMobileTouchMove(e), {passive: false});
            imgEl.addEventListener('touchend', (e) => handleMobileTouchEnd(e), {passive: false});

            // é»æ“ŠæŸ¥çœ‹è³‡è¨Š (å–®é»)
            imgEl.onclick = () => showAlert(`é€™æ˜¯ï¼š${item.name}`);
            
            // é•·æŒ‰é¸å–® (æ‰‹æ©Ÿç‰ˆè¼”åŠ©)
            imgEl.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showTierSelectModal(id);
            });

            if (['S','A','B','C','D'].includes(tier)) {
                const map = {'S':0, 'A':1, 'B':2, 'C':3, 'D':4};
                const container = document.querySelectorAll('.tier-content')[map[tier]];
                if(container) container.appendChild(imgEl);
            } else {
                if(pool) pool.appendChild(imgEl);
            }
        });
    };

    // --- æ‹–æ›³åŠŸèƒ½å„ªåŒ– (æ”¯æ´å·¦å³äº’æ›èˆ‡æ’å…¥) ---
    
    let draggedId = null;

    window.allowDrop = function(ev) { 
        ev.preventDefault(); 
    };

    window.drag = function(ev, id) { 
        draggedId = id; 
        ev.dataTransfer.setData("text", id);
        // åŠ å…¥è¦–è¦ºæ•ˆæœ
        setTimeout(() => ev.target.classList.add('dragging'), 0);
    };

    // ç›£è½æ‹–æ›³çµæŸï¼Œç§»é™¤è¦–è¦ºæ•ˆæœ
    document.addEventListener('dragend', (e) => {
        if(e.target.classList && e.target.classList.contains('tier-avatar')) {
            e.target.classList.remove('dragging');
        }
    });

    // ğŸ”¥ è¨ˆç®—æ’å…¥ä½ç½®çš„æ ¸å¿ƒå‡½å¼
    function getDragAfterElement(container, x) {
        const draggableElements = [...container.querySelectorAll('.tier-avatar:not(.dragging)')];

        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const boxCenter = box.left + box.width / 2;
            const offset = x - boxCenter;

            // è² æ•¸ä»£è¡¨æ»‘é¼ åœ¨å…ƒç´ å·¦é‚Šï¼Œå–æœ€å¤§çš„è² æ•¸(æœ€æ¥è¿‘ 0)
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    // ğŸ”¥ è¦†å¯« Drop å‡½å¼
    window.drop = function(ev, targetTierStr) { 
        ev.preventDefault(); 
        
        // 1. æ‰¾å‡ºæ­£ç¢ºçš„å®¹å™¨
        let container = ev.target;
        // å¦‚æœæ”¾é–‹æ™‚æ¸¸æ¨™åœ¨åœ–ç‰‡ä¸Šï¼Œè¦å¾€ä¸Šæ‰¾çˆ¶å®¹å™¨
        if (!container.classList.contains('tier-content') && !container.classList.contains('tier-pool')) {
            container = container.closest('.tier-content') || container.closest('.tier-pool');
        }
        if (!container) return;

        // 2. åŸ·è¡Œè¦–è¦ºæ’å…¥ (InsertBefore)
        const afterElement = getDragAfterElement(container, ev.clientX);
        const draggingImg = document.querySelector('.dragging');
        
        if (!draggingImg) return;

        if (afterElement == null) {
            container.appendChild(draggingImg);
        } else {
            container.insertBefore(draggingImg, afterElement);
        }

        // 3. é‡å»ºè³‡æ–™ (Rebuild Data)
        rebuildAndSaveTierData();
    };

    // ğŸ”¥ æ ¹æ“šç•«é¢é †åºï¼Œæ›´æ–°è³‡æ–™åº« (ä¿®æ­£ç‰ˆï¼šåŠ å…¥é †åºç·¨è™Ÿ)
    function rebuildAndSaveTierData() {
        const rows = document.querySelectorAll('.tier-content, .tier-pool');
        let newDataList = [];
        let sourceList = currentTierMode === 'actor' ? actorProfiles : partnerProfiles;

        // ä¾åºæƒæ S, A, B, C, D, Pool
        rows.forEach(row => {
            // åˆ¤æ–·ç­‰ç´š
            let rank = 'unranked';
            const label = row.previousElementSibling; 
            if (label && label.classList.contains('tier-label')) {
                rank = label.textContent.trim(); 
            }

            // å–å¾—è©²åˆ—æ‰€æœ‰åœ–ç‰‡ ID
            const imgs = row.querySelectorAll('.tier-avatar');
            imgs.forEach(img => {
                const id = img.dataset.tid;
                let item = null;
                // æ¯”å°è³‡æ–™
                if (currentTierMode === 'actor') {
                    item = sourceList.find(x => x.id == id);
                } else {
                    item = sourceList.find(x => x.name === id);
                }

                if (item) {
                    item.tier = rank; // æ›´æ–°ç­‰ç´š
                    
                    // ğŸ”¥ é—œéµä¿®æ­£ï¼šçµ¦å®ƒä¸€å€‹é †åºç·¨è™Ÿï¼Œè¨˜ä½å®ƒåœ¨éšŠä¼è£¡çš„ç¬¬å¹¾å€‹
                    item.tierOrder = newDataList.length; 
                    
                    newDataList.push(item); // ä¾ç…§è¦–è¦ºé †åºåŠ å…¥
                }
            });
        });

        // é˜²å‘†ï¼šå¦‚æœæœ‰è³‡æ–™æ²’è¢«é¡¯ç¤ºå‡ºä¾†ï¼Œè£œåœ¨æœ€å¾Œé¢
        if (newDataList.length < sourceList.length) {
             sourceList.forEach(oldItem => {
                 const exists = currentTierMode === 'actor' 
                    ? newDataList.find(x => x.id == oldItem.id)
                    : newDataList.find(x => x.name == oldItem.name);
                 if(!exists) {
                     // æ²’è¢«æ’åˆ°çš„ï¼Œç·¨è™Ÿè¨­å¤§ä¸€é»ï¼Œæ’åœ¨æœ€å¾Œ
                     oldItem.tierOrder = 99999;
                     newDataList.push(oldItem);
                 }
             });
        }

        // å­˜å›å…¨åŸŸè®Šæ•¸ä¸¦å¯«å…¥ LocalStorage
        if (currentTierMode === 'actor') {
            actorProfiles = newDataList;
            saveActorData();
        } else {
            partnerProfiles = newDataList;
            savePartnerData();
        }
    }

    // æ›´æ–°å–®ä¸€è³‡æ–™ (çµ¦æ‰‹æ©Ÿç‰ˆé•·æŒ‰é¸å–®ä½¿ç”¨)
    function updateTierData(id, targetTier) {
        let dataList = currentTierMode === 'actor' ? actorProfiles : partnerProfiles;
        let item = null;
        
        if (currentTierMode === 'actor') {
            item = dataList.find(x => x.id == id);
        } else {
            item = dataList.find(x => x.name === id);
        }

        if (item) {
            item.tier = targetTier;
            renderTierList(); 
            saveTierList(true);
        }
    }
    // === ğŸ”¥ æ‰‹æ©Ÿç‰ˆè§¸æ§æ‹–æ›³é‚è¼¯ (Mobile Touch Drag Logic) ===

    let mobileDragItem = null; // æ­£åœ¨è¢«æ‹–æ›³çš„ç‰©ä»¶
    let mobileTouchTimer = null; // é•·æŒ‰è¨ˆæ™‚å™¨
    let isMobileDragging = false; // æ˜¯å¦é€²å…¥æ‹–æ›³æ¨¡å¼

    function handleMobileTouchStart(e, el) {
        // 1. åˆå§‹åŒ–ç‹€æ…‹
        isMobileDragging = false;
        mobileDragItem = el;
        
        // 2. è¨­å®šé•·æŒ‰åµæ¸¬ (é•·æŒ‰ 200ms å¾Œé–‹å§‹æ‹–æ›³ï¼Œé¿å…èª¤è§¸æ²å‹•)
        mobileTouchTimer = setTimeout(() => {
            isMobileDragging = true;
            if(navigator.vibrate) navigator.vibrate(50); // éœ‡å‹•å›é¥‹
            el.classList.add('dragging'); // åŠ å…¥è¦–è¦ºæ•ˆæœ
        }, 200);
    }

    function handleMobileTouchMove(e) {
        // å¦‚æœé‚„æ²’é€²å…¥æ‹–æ›³æ¨¡å¼ (æ‰‹æŒ‡å‰›æ”¾ä¸Šå»é‚„æ²’é•·æŒ‰)ï¼Œå°±å…è¨±ç•«é¢æ²å‹•
        if (!isMobileDragging) {
            // å¦‚æœæ‰‹æŒ‡ç§»å‹•äº†ï¼Œä»£è¡¨ä½¿ç”¨è€…æƒ³æ²å‹•é é¢ï¼Œå–æ¶ˆé•·æŒ‰è¨ˆæ™‚
            clearTimeout(mobileTouchTimer);
            return; 
        }

        // --- é€²å…¥æ‹–æ›³æ¨¡å¼ ---
        e.preventDefault(); // ğŸ”¥ é—œéµï¼šç¦æ­¢ç•«é¢æ²å‹•ï¼Œè®“æ‰‹æŒ‡å°ˆå¿ƒæ‹–æ›³åœ–ç‰‡

        const touch = e.touches[0]; // å–å¾—ç¬¬ä¸€æ ¹æ‰‹æŒ‡çš„ä½ç½®
        
        // 1. æ‰¾å‡ºæ‰‹æŒ‡ç›®å‰æŒ‡åˆ°çš„ä½ç½®ä¸‹é¢æ˜¯ä»€éº¼å®¹å™¨
        // æˆ‘å€‘å…ˆæš«æ™‚æŠŠæ­£åœ¨æ‹–æ›³çš„åœ–ç‰‡éš±è—ä¸€ä¸‹ï¼Œä¸ç„¶ elementFromPoint æœƒä¸€ç›´æŠ“åˆ°åœ–ç‰‡è‡ªå·±
        mobileDragItem.style.display = 'none'; 
        let elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
        mobileDragItem.style.display = 'block'; // é¦¬ä¸Šé¡¯ç¤ºå›ä¾†

        if (!elementBelow) return;

        // 2. åˆ¤æ–·æ‰‹æŒ‡æ˜¯å¦åœ¨ã€Œç­‰ç´šåˆ— (tier-content)ã€æˆ–ã€Œå¾…åˆ†é¡å€ (tier-pool)ã€ä¸Šæ–¹
        let container = elementBelow.closest('.tier-content') || elementBelow.closest('.tier-pool');
        
        if (container) {
            // 3. ä½¿ç”¨æˆ‘å€‘ä¹‹å‰å¯«å¥½çš„ getDragAfterElement ç®—æ³•ä¾†è¨ˆç®—æ’å…¥é»
            const afterElement = getDragAfterElement(container, touch.clientX);
            
            if (afterElement == null) {
                container.appendChild(mobileDragItem); // æ’åœ¨æœ€å¾Œ
            } else {
                // åªæœ‰ç•¶ä½ç½®çœŸçš„ä¸åŒæ™‚æ‰æ’å…¥ï¼Œæ¸›å°‘é–ƒçˆ
                if (afterElement !== mobileDragItem.nextSibling) {
                    container.insertBefore(mobileDragItem, afterElement);
                }
            }
        }
    }

    function handleMobileTouchEnd(e) {
        // æ¸…é™¤è¨ˆæ™‚å™¨
        clearTimeout(mobileTouchTimer);

        // å¦‚æœå‰›å‰›æ˜¯åœ¨æ‹–æ›³ç‹€æ…‹
        if (isMobileDragging && mobileDragItem) {
            mobileDragItem.classList.remove('dragging');
            
            // ğŸ”¥ æ‹–æ›³çµæŸï¼Œé¦¬ä¸Šå­˜æª”
            rebuildAndSaveTierData();
        }

        // é‡ç½®è®Šæ•¸
        mobileDragItem = null;
        isMobileDragging = false;
    }
    // --- å„²å­˜åŠŸèƒ½ ---
    window.saveTierList = function(silent = false) {
        if (currentTierMode === 'actor') saveActorData();
        else savePartnerData();
        if(!silent) showAlert('æ’è¡Œæ¦œå·²å„²å­˜ï¼');
    };

    // --- æ‰‹æ©Ÿç‰ˆæ“ä½œ (é•·æŒ‰è·³å‡ºé¸å–®) ---
    // å›  iPhone å°ç¶²é æ‹–æ›³æ”¯æ´åº¦ä¸ä½³ï¼Œæ”¹ç”¨é•·æŒ‰é¸å–®æœ€ç©©å®š
    let touchTimer = null;
    function handleTouchStart(e, id) {
        // é•·æŒ‰ 0.5 ç§’å¾Œè§¸ç™¼
        touchTimer = setTimeout(() => {
            showTierSelectModal(id);
        }, 500);
    }
    // å¦‚æœæ‰‹æ”¾é–‹ï¼Œå°±å–æ¶ˆè¨ˆæ™‚
    document.addEventListener('touchend', () => clearTimeout(touchTimer));

    function showTierSelectModal(id) {
        const tiers = ['S', 'A', 'B', 'C', 'D', 'unranked'];
        const btns = tiers.map(t => 
            `<button class="btn-base" onclick="updateTierData('${id}', '${t}');closeSystemModal()" style="margin:2px;width:45%;display:inline-block;background:#eee;">${t==='unranked'?'ğŸ‘‡ ç§»å›ä¸‹æ–¹':t+' ç´š'}</button>`
        ).join('');
        
        document.getElementById('sys-title').textContent = "ç§»å‹•åˆ°å“ªå€‹ç­‰ç´šï¼Ÿ";
        document.getElementById('sys-msg').innerHTML = ""; 
        document.getElementById('sys-actions').innerHTML = `<div style="text-align:center;">${btns}</div>`;
        document.getElementById('system-modal').classList.add('active');
    }
    // === ğŸ˜‡ å¤©ä½¿èˆ‡æƒ¡é­” ğŸ˜ˆ äº’å‹•ç³»çµ± ===

        const ANGEL_LINES = {
            winning: [ // ç¦æ…¾æ™‚èªªçš„è©±
                "èº«é«”æ­£åœ¨æ·¨åŒ–ï¼Œæ„Ÿè¦ºåˆ°äº†å—ï¼Ÿ",
                "å¿è€æ˜¯ç¾å¾·ï¼Œä½ çš„æ„å¿—åŠ›å¾ˆå¼·ï¼",
                "æŠŠç²¾åŠ›ç”¨åœ¨å‰å¤§çš„äº‹æƒ…ä¸Šå§ã€‚",
                "åˆ¥ç†éš”å£é‚£å€‹ç´…è‰²çš„å‚¢ä¼™ã€‚",
                "ä½ çš„æ‰‹æ˜¯ç”¨ä¾†æ”¹è®Šä¸–ç•Œçš„ï¼Œä¸æ˜¯å°»æ§ã€‚",
                "ä¿æŒæ¸…é†’ï¼Œé é›¢èª˜æƒ‘ã€‚",
                "ä½ å¯ä»¥æˆç‚ºé­”æ³•å¸«çš„ï¼"
            ],
            losing: [ // ç¸±æ…¾æ™‚çš„ç„¡å¥ˆ
                "å”‰...åˆç ´åŠŸäº†ã€‚",
                "ç¥å•Šï¼Œè«‹åŸè«’é€™å€‹äºº...",
                "åˆ¥è®“è‰²æ…¾æ‰“ç ´ä½ å…§å¿ƒçš„å¹³éœå‘€...",
                "è‰²å³æ˜¯ç©ºï¼Œç©ºå³æ˜¯è‰²å•Šæ–½ä¸»ã€‚",
                "ä½ éœ€è¦è–æ°´æ´—æ»Œä¸€ä¸‹å¿ƒéˆã€‚"
            ]
        };

        const DEMON_LINES = {
            winning: [ // ç¸±æ…¾æ™‚èªªçš„è©±
                "é€™å°±æ˜¯æ´»è‘—çš„æ„Ÿè¦ºï¼çˆ½ï¼",
                "å†ä¾†ä¸€ç™¼ï¼Ÿåæ­£æ²’äººçŸ¥é“ã€‚",
                "æ‰“ç ´ç´€éŒ„å°±æ˜¯ç¾åœ¨ï¼",
                "ç¦æ…¾å¤šç„¡èŠï¼Œå¿«æ´»æ‰æ˜¯çœŸç†ã€‚",
                "å˜¿å˜¿ï¼Œæˆ‘å°±çŸ¥é“ä½ å¿ä¸ä½ã€‚",
                "ä½ çš„æ”¶è—æ«ƒè£¡æœ‰æ–°æ±è¥¿äº†å§ï¼Ÿ",
                "ä»Šæ™š... å¾ˆæ¼«é•·å–”ğŸ˜ˆ"
            ],
            losing: [ // ç¦æ…¾æ™‚çš„æŒ‘æ’¥
                "ä½ ä¸æ‚¶å—ï¼Ÿæˆ‘å¥½æ‚¶ã€‚",
                "ä½ çš„æ‰‹åœ¨å‘¼å–šä½ ...",
                "åˆ¥è£äº†ï¼Œå…¶å¯¦ä½ å¾ˆæƒ³è¦ã€‚",
                "å·²ç¶“ç©å¾ˆå¤šäº†ï¼Œå¿«ä¾†ä¸€ç™¼å§ï¼",
                "å¶çˆ¾æ”¾é¬†ä¸€ä¸‹åˆä¸æœƒæ€æ¨£ã€‚",
                "åªè¦ä¸€ç™¼ï¼Œç…©æƒ±å…¨æ¶ˆå–”ã€‚"
            ]
        };

        // æ›´æ–°å‰ç¥¥ç‰©ç‹€æ…‹ (æ¯æ¬¡å›åˆ°é¦–é ã€æ–°å¢ç´€éŒ„å¾Œå‘¼å«)
        function updateMascots() {
            const angelEl = document.getElementById('char-angel');
            const demonEl = document.getElementById('char-demon');
            const angelMsg = document.getElementById('angel-msg');
            const demonMsg = document.getElementById('demon-msg');
            
            if(!angelEl || !demonEl) return;

            // 1. è¨ˆç®—è·é›¢ä¸Šæ¬¡çš„æ™‚é–“ (å°æ™‚)
            let hoursSince = 9999;
            if (ejaculationRecords.length > 0) {
                const sorted = [...ejaculationRecords].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                const lastTime = new Date(sorted[0].timestamp);
                const now = new Date();
                hoursSince = (now - lastTime) / (1000 * 60 * 60);
            }

            // 2. åˆ¤æ–·èª°æ˜¯è´å®¶ (è¨­å®šé–¾å€¼ï¼š14å°æ™‚)
            // < 14å°æ™‚: æƒ¡é­”è´ (å‰›ç™¼å°„ä¸ä¹…)
            // > 14å°æ™‚: å¤©ä½¿è´ (æ­£åœ¨ç¦æ…¾)
            const THRESHOLD_HOURS = 14;
            const isDemonTime = hoursSince < THRESHOLD_HOURS;

            if (isDemonTime) {
                // ğŸ˜ˆ æƒ¡é­”å›åˆ
                demonEl.className = 'character winning';
                angelEl.className = 'character'; // å¤©ä½¿è®Šæš—
                
                // è¨­å®šå°è©±
                setRandomText(demonMsg, DEMON_LINES.winning);
                setRandomText(angelMsg, ANGEL_LINES.losing);
                
            } else {
                // ğŸ˜‡ å¤©ä½¿å›åˆ
                angelEl.className = 'character winning';
                demonEl.className = 'character'; // æƒ¡é­”è®Šæš—
                
                // è¨­å®šå°è©±
                setRandomText(angelMsg, ANGEL_LINES.winning);
                setRandomText(demonMsg, DEMON_LINES.losing);
            }
        }

        function setRandomText(el, array) {
            // éš¨æ©Ÿé¸ä¸€å¥ï¼Œä½†é¿å…è·Ÿä¸Šæ¬¡å®Œå…¨ä¸€æ¨£ (ç°¡æ˜“ç‰ˆ)
            const text = array[Math.floor(Math.random() * array.length)];
            el.textContent = text;
        }

        // é»æ“Šäº’å‹•åŠŸèƒ½ï¼šé»æ“Šè§’è‰²æ™‚å¼·åˆ¶æ›ä¸€å¥è©±ä¸¦é¡¯ç¤ºæ°£æ³¡
        window.tapMascot = function(type) {
            const el = document.getElementById(`char-${type}`);
            const msgEl = document.getElementById(`${type}-msg`);
            
            // åˆ¤æ–·ç›®å‰æ˜¯èª°çš„å›åˆï¼Œæ±ºå®šè¦è¬›ä»€éº¼é¡å‹çš„å¹¹è©±
            const isWinning = el.classList.contains('winning');
            let textArray = [];

            if (type === 'angel') {
                textArray = isWinning ? ANGEL_LINES.winning : ANGEL_LINES.losing;
            } else {
                textArray = isWinning ? DEMON_LINES.winning : DEMON_LINES.losing;
            }
            
            // æ›å¥è©±
            setRandomText(msgEl, textArray);
            
            // å¼·åˆ¶é¡¯ç¤ºæ°£æ³¡å‹•ç•«
            el.classList.remove('talking');
            void el.offsetWidth; // trigger reflow
            el.classList.add('talking');
            
            // 2ç§’å¾Œæ”¶èµ·æ°£æ³¡ (å¦‚æœæ˜¯è´å®¶ï¼Œæ°£æ³¡æœ¬ä¾†å°±æœƒäº®è‘—ï¼Œå°±ä¸éœ€è¦æ”¶èµ·)
            if (!isWinning) {
                setTimeout(() => {
                    el.classList.remove('talking');
                }, 2000);
            }
        };

        // ç‚ºäº†è®“å°è©±æœ‰é»è®ŠåŒ–ï¼Œæ¯æ¬¡é€²å…¥é¦–é æ™‚ï¼Œé™¤äº†åŸæœ¬çš„ updateHomeDisplayï¼Œä¹Ÿè¦æ›´æ–°å‰ç¥¥ç‰©
        // æˆ‘å€‘åˆ©ç”¨ä¸€å€‹ setInterval æˆ–è€… hook åˆ° updateHomeDisplay
        const _originalUpdateHome = window.updateHomeDisplay;
        window.updateHomeDisplay = function() {
            _originalUpdateHome(); // åŸ·è¡ŒåŸæœ¬çš„é‚è¼¯
            updateMascots();       // åŸ·è¡Œå‰ç¥¥ç‰©é‚è¼¯
        };
        
        /* === ç›¸ç°¿åŠŸèƒ½é‚è¼¯ (New) === */
        let tempAlbumPhoto = ""; // æš«å­˜ä¸Šå‚³çš„ç…§ç‰‡

        // 1. é–‹å•Ÿæ–°å¢ç…§ç‰‡è¦–çª—
        window.openPhotoFormModal = function() {
            document.getElementById('photo-form').reset();
            tempAlbumPhoto = "";
            document.getElementById('album-preview').src = "";
            document.getElementById('album-preview').classList.remove('show');
            document.getElementById('album-url-input').value = "";
            document.getElementById('photo-form-modal').classList.add('active');
        };

        // 2. ç›£è½ç…§ç‰‡ä¸Šå‚³ (åŒ…å«æª”æ¡ˆèˆ‡ç¶²å€)
        document.addEventListener('DOMContentLoaded', () => {
            // æª”æ¡ˆä¸Šå‚³
            const fileInput = document.getElementById('album-file-input');
            if(fileInput) {
                fileInput.addEventListener('change', async (e) => {
                    if(e.target.files[0]) {
                        try {
                            const b64 = await compressImage(e.target.files[0]);
                            tempAlbumPhoto = b64;
                            const p = document.getElementById('album-preview');
                            p.src = b64;
                            p.classList.add('show');
                            document.getElementById('album-url-input').value = ""; // æ¸…ç©ºç¶²å€æ¬„
                        } catch(err) { showAlert("åœ–ç‰‡è™•ç†å¤±æ•—"); }
                    }
                });
            }
            // ç¶²å€è¼¸å…¥
            const urlInput = document.getElementById('album-url-input');
            if(urlInput) {
                urlInput.addEventListener('input', (e) => {
                    const val = e.target.value.trim();
                    if(val) {
                        tempAlbumPhoto = val;
                        const p = document.getElementById('album-preview');
                        p.src = val;
                        p.classList.add('show');
                    }
                });
            }

            // è¡¨å–®é€å‡º
            const form = document.getElementById('photo-form');
            if(form) {
                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    if(!tempAlbumPhoto) { showAlert('è«‹é¸æ“‡ç…§ç‰‡æˆ–è¼¸å…¥ç¶²å€'); return; }
                    
                    const caption = document.getElementById('album-caption').value;
                    const actor = actorProfiles.find(a => a.id === currentActorId);
                    
                    if(actor) {
                        if(!actor.photos) actor.photos = [];
                        actor.photos.push({
                            id: Date.now(),
                            url: tempAlbumPhoto,
                            caption: caption,
                            date: new Date().toISOString()
                        });
                        actor.lastUpdated = Date.now();
                        saveActorData();
                        renderActorDetail(); // é‡æ–°æ¸²æŸ“é é¢
                        document.getElementById('photo-form-modal').classList.remove('active');
                        showAlert('ç…§ç‰‡å·²æ–°å¢ ğŸ“·');
                    }
                });
            }
        });

        // 3. æŸ¥çœ‹å¤§åœ–
        let currentViewingPhotoId = null;
        window.openPhotoViewer = function(pid) {
            const actor = actorProfiles.find(a => a.id === currentActorId);
            if(!actor || !actor.photos) return;
            const p = actor.photos.find(x => x.id === pid);
            if(!p) return;

            currentViewingPhotoId = pid;
            document.getElementById('pv-img').src = p.url;
            document.getElementById('pv-caption').textContent = p.caption || "";
            
            // ç¶å®šåˆªé™¤æŒ‰éˆ•
            document.getElementById('pv-btn-delete').onclick = () => {
                showConfirm('ç¢ºå®šè¦åˆªé™¤é€™å¼µç…§ç‰‡å—ï¼Ÿ', () => {
                    actor.photos = actor.photos.filter(x => x.id !== pid);
                    saveActorData();
                    renderActorDetail();
                    document.getElementById('photo-view-modal').classList.remove('active');
                });
            };

            document.getElementById('photo-view-modal').classList.add('active');
        };
    
    </script>
</body>
</html>